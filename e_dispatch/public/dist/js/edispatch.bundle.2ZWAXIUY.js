(()=>{var Qt=Object.create;var lt=Object.defineProperty;var Zt=Object.getOwnPropertyDescriptor;var $t=Object.getOwnPropertyNames;var ei=Object.getPrototypeOf,ti=Object.prototype.hasOwnProperty;var ii=(a,r)=>()=>(r||a((r={exports:{}}).exports,r),r.exports);var ri=(a,r,u,_)=>{if(r&&typeof r=="object"||typeof r=="function")for(let v of $t(r))!ti.call(a,v)&&v!==u&&lt(a,v,{get:()=>r[v],enumerable:!(_=Zt(r,v))||_.enumerable});return a};var ni=(a,r,u)=>(u=a!=null?Qt(ei(a)):{},ri(r||!a||!a.__esModule?lt(u,"default",{value:a,enumerable:!0}):u,a));var qt=ii((it,Jt)=>{(function(a,r){typeof it=="object"&&typeof Jt!="undefined"?r(it):typeof define=="function"&&define.amd?define(["exports"],r):r(((a=typeof globalThis!="undefined"?globalThis:a||self).Dynamsoft=a.Dynamsoft||{},a.Dynamsoft.DCP={}))})(it,function(a){"use strict";let r=typeof self=="undefined",u=" is not allowed to change after `createInstance` or `loadWasm` is called.",_=!r&&document.currentScript&&(document.currentScript.getAttribute("data-license")||document.currentScript.getAttribute("data-productKeys")||document.currentScript.getAttribute("data-licenseKey")||document.currentScript.getAttribute("data-handshakeCode")||document.currentScript.getAttribute("data-organizationID"))||"",v=!r&&document.currentScript&&document.currentScript.getAttribute("data-sessionPassword")||"",S=fe=>{if(fe==null)fe=[];else{fe=fe instanceof Array?[...fe]:[fe];for(let J=0;J<fe.length;++J){if(!r){let le=document.createElement("a");le.href=fe[J],fe[J]=le.href}fe[J].endsWith("/")||(fe[J]+="/")}}return fe},m=(()=>{if(!r&&document.currentScript){let fe=document.currentScript.src,J=fe.indexOf("?");if(J!=-1)fe=fe.substring(0,J);else{let le=fe.indexOf("#");le!=-1&&(fe=fe.substring(0,le))}return fe.substring(0,fe.lastIndexOf("/")+1)}return"./"})(),w,E,x,A,D;if(typeof navigator!="undefined"&&(w=navigator,E=w.userAgent,x=w.platform,A=w.mediaDevices),!r){let fe={init:function(){this.browser=this.searchString(this.dataBrowser)||"unknownBrowser",this.version=this.searchVersion(E)||this.searchVersion(w.appVersion)||0,this.OS=this.searchString(this.dataOS)||"unknownOS",this.OS=="Linux"&&E.indexOf("Windows NT")!=-1&&(this.OS="HarmonyOS")},searchString:function(J){for(let le=0;le<J.length;le++){let g=J[le].string,pe=J[le].prop;if(this.versionSearchString=J[le].versionSearch||J[le].identity,g){if(g.indexOf(J[le].subString)!=-1)return J[le].identity}else if(pe)return J[le].identity}},searchVersion:function(J){let le=J.indexOf(this.versionSearchString);if(le!=-1)return parseFloat(J.substring(le+this.versionSearchString.length+1))},dataBrowser:[{string:E,subString:"Edge",identity:"Edge"},{string:E,subString:"OPR",identity:"OPR"},{string:E,subString:"Chrome",identity:"Chrome"},{string:w.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{string:E,subString:"Firefox",identity:"Firefox"},{string:E,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"}],dataOS:[{string:E,subString:"HarmonyOS",identity:"HarmonyOS"},{string:E,subString:"Android",identity:"Android"},{string:E,subString:"iPhone",identity:"iPhone"},{string:x,subString:"Win",identity:"Windows"},{string:x,subString:"Mac",identity:"Mac"},{string:x,subString:"Linux",identity:"Linux"}]};fe.init(),D={browser:fe.browser,version:fe.version,OS:fe.OS}}r&&(D={browser:"ssr",version:0,OS:"ssr"});let I=typeof WebAssembly!="undefined"&&E&&!(/Safari/.test(E)&&!/Chrome/.test(E)&&/\(.+\s11_2_([2-6]).*\)/.test(E)),z=typeof Worker!="undefined",se=!(!A||!A.getUserMedia),ee=async()=>{let fe=!1;if(se)try{(await A.getUserMedia({video:!0})).getTracks().forEach(J=>{J.stop()}),fe=!0}catch(J){}return fe};D.browser==="Chrome"&&D.version>66||D.browser==="Safari"&&D.version>13||D.browser==="OPR"&&D.version>43||D.browser==="Edge"&&D.version;let q=fe=>fe&&typeof fe=="object"&&typeof fe.then=="function";var te,ce,K;a.EnumErrorCode=void 0,(te=a.EnumErrorCode||(a.EnumErrorCode={}))[te.DCP_OK=0]="DCP_OK",te[te.DCP_NULL_POINTER=-10002]="DCP_NULL_POINTER",te[te.DCP_LICENSE_INVALID=-10003]="DCP_LICENSE_INVALID",te[te.DCP_LICENSE_EXPIRED=-10004]="DCP_LICENSE_EXPIRED",te[te.DCP_INVALID_DATA=-90003]="DCP_INVALID_DATA",te[te.DCP_INVALID_KEY=-90004]="DCP_INVALID_KEY",te[te.DCP_NOT_VALID_VDS_TYPE=-90005]="DCP_NOT_VALID_VDS_TYPE",te[te.DCP_VDS_CHECK_FAILED=-90006]="DCP_VDS_CHECK_FAILED",te[te.DCP_VDS_INVALID_CER=-90007]="DCP_VDS_INVALID_CER",te[te.DCP_VDS_INVALID_SIGNATURE=-90008]="DCP_VDS_INVALID_SIGNATURE",te[te.DCP_VDS_CANNOT_OPEN_CERTIFICATE=-90009]="DCP_VDS_CANNOT_OPEN_CERTIFICATE",te[te.DCP_LICENSE_DOMAIN_NOT_MATCH=-10043]="DCP_LICENSE_DOMAIN_NOT_MATCH",te[te.DCP_AADHAAR_CHECK_FAILED=-90011]="DCP_AADHAAR_CHECK_FAILED",te[te.DCP_NOT_SUPPORTED_YET=-10006]="DCP_NOT_SUPPORTED_YET",te[te.DCP_NO_LICENSE=-2e4]="DCP_NO_LICENSE",te[te.DCP_LICENSE_SYNC_FAILED=-20003]="DCP_LICENSE_SYNC_FAILED",te[te.DCP_TRIAL_LICENSE=-20010]="DCP_TRIAL_LICENSE",te[te.DCP_FAILED_TO_REACH_DLS=-20200]="DCP_FAILED_TO_REACH_DLS",a.EnumCodeFormat=void 0,(ce=a.EnumCodeFormat||(a.EnumCodeFormat={}))[ce.CF_AUTO=0]="CF_AUTO",ce[ce.CF_DL_SOUTH_AFRICA=1]="CF_DL_SOUTH_AFRICA",ce[ce.CF_DL_AAMVA=2]="CF_DL_AAMVA",ce[ce.CF_ID_SOUTH_AFRICA=3]="CF_ID_SOUTH_AFRICA",ce[ce.CF_VIN=4]="CF_VIN",ce[ce.CF_VDS_NC=5]="CF_VDS_NC",ce[ce.CF_AADHAAR=6]="CF_AADHAAR";class Q{constructor(){this._instanceID=void 0,this._lastInnerParseDuration=0,this.bDestroyed=!1}static getVersion(){return this._version}static get license(){return this._license}static set license(J){((le,g)=>{let pe=le;if(!pe._pLoad.isEmpty)throw new Error("`license`"+u);pe._license=g})(Q,J)}static set sessionPassword(J){((le,g)=>{let pe=le;if(!pe._pLoad.isEmpty)throw new Error("`sessionPassword`"+u);pe._sessionPassword=g})(Q,J)}static get sessionPassword(){return this._sessionPassword}static async detectEnvironment(){return await(async()=>({wasm:I,worker:z,getUserMedia:se,camera:await ee(),browser:D.browser,version:D.version,OS:D.OS}))()}static get _bUseFullFeature(){return this.__bUseFullFeature}static set _bUseFullFeature(J){if(!this._pLoad.isEmpty)throw new Error("`_bUseFullFeature` is not allowed to change after `createInstance` or `loadWasm` is called.");Q.__bUseFullFeature=J}static get deviceFriendlyName(){return this._deviceFriendlyName}static set deviceFriendlyName(J){((le,g)=>{let pe=le;if(!pe._pLoad.isEmpty)throw new Error("`deviceFriendlyName`"+u);pe._deviceFriendlyName=g||""})(Q,J)}static get engineResourcePath(){return this._engineResourcePath}static set engineResourcePath(J){if(!this._pLoad.isEmpty)throw new Error("`engineResourcePath` is not allowed to change after `createInstance` or `loadWasm` is called.");Q._engineResourcePath=(le=>{if(le==null&&(le="./"),!r){let g=document.createElement("a");g.href=le,le=g.href}return le.endsWith("/")||(le+="/"),le})(J)}static get licenseServer(){return this._licenseServer}static set licenseServer(J){((le,g)=>{let pe=le;if(!pe._pLoad.isEmpty)throw new Error("`licenseServer`"+u);pe._licenseServer=S(g)})(Q,J)}static async loadWasm(){if(this._pLoad.isEmpty){let{lt:J,l:le,ls:g,sp:pe,rmk:re}=(ne=>{let n=ne;if(n._pLoad.isEmpty){let i,s,l=n._license||"",e=JSON.parse(JSON.stringify(n._licenseServer)),t=n._sessionPassword,o=0;if(l.startsWith("t")||l.startsWith("f"))o=0;else if(l.length===0||l.startsWith("P")||l.startsWith("L")||l.startsWith("Y")||l.startsWith("A"))o=1;else{o=2;let d=l.indexOf(":");if(d!=-1&&(l=l.substring(d+1)),l.startsWith("DLS2")){let h=l.substring(4);try{h=atob(h)}catch(f){throw new Error("Format Error: The license string you specified is invalid, please check to make sure it is correct.")}let c=JSON.parse(h);if(l=c.handshakeCode?c.handshakeCode:c.organizationID?c.organizationID:"",typeof l=="number"&&(l=JSON.stringify(l)),e.length===0){let f=[];c.mainServerURL&&(f[0]=c.mainServerURL),c.standbyServerURL&&(f[1]=c.standbyServerURL),e=S(f)}!t&&c.sessionPassword&&(t=c.sessionPassword),i=c.remark}(l==="200001"||l.startsWith("200001-"))&&(e&&e.length||(l="")),l||(o=1)}if(o&&(globalThis.crypto||(s="Please upgrade your browser to support online key."),globalThis.crypto.subtle||(s="Require https to use online key in this browser.")),s){if(o!==1)throw new Error(s);o=0,console.warn(s),n._lastErrorCode=-1,n._lastErrorString=s}return o===1&&(l="",console.warn("Applying for a public trial license ...")),{lt:o,l,ls:e,sp:t,rmk:i}}throw new Error("Can't preprocess license again"+u)})(Q);this._pLoad.task=async(ne,n)=>{let i=Q.engineResourcePath+Q._workerName;Q.engineResourcePath.startsWith(location.origin)||(i=await fetch(i).then(s=>s.blob()).then(s=>URL.createObjectURL(s))),Q._dcpWorker=new Worker(i),Q._dcpWorker.onerror=s=>{let l=new Error(s.message);n(l)},Q._dcpWorker.onmessage=async s=>{let l=s.data?s.data:s;switch(l.type){case"log":Q._onLog&&Q._onLog(l.message);break;case"load":{l.message&&(l.message=l.message.replace("(https://www.dynamsoft.com/purchase-center/)","(https://www.dynamsoft.com/store/dynamsoft-code-parser/#javascript)"));let e,t=!1;J===1&&(t=!0),l.success?(Q._dcpWorker.onerror=null,Q._version=l.version+"(JS "+Q._jsVersion+"."+Q._jsEditVersion+")",Q._onLog&&Q._onLog("load dcp worker success"),l.message&&console.warn(l.message)):(e=new Error(l.message),e.stack=l.stack+`
`+e.stack,t||l.ltsErrorCode==111&&l.message.toLowerCase().indexOf("trial license")!=-1&&(t=!0)),t&&Q.showDialog(l.success?"warn":"error",l.message),l.success?ne():n(e);break}case"task":{let e=l.id,t=l.body;try{Q._taskCallbackMap.get(e)(t),Q._taskCallbackMap.delete(e)}catch(o){throw Q._taskCallbackMap.delete(e),o}break}default:Q._onLog&&Q._onLog(s)}},Q._dcpWorker.postMessage({type:"loadWasm",engineResourcePath:Q.engineResourcePath,bUseFullFeature:Q._bUseFullFeature,bd:Q._bWasmDebug,v:Q._jsVersion,brtk:!!J,bptk:J===1,l:le,dm:location.origin.startsWith("http")?location.origin:"https://localhost",os:D,fn:Q.deviceFriendlyName,ls:g,sp:pe,rmk:re})}}await this._pLoad}static async showDialog(J,le){await(async(g,pe,re)=>{if(!g._bNeverShowDialog)try{let ne=await fetch(g.engineResourcePath+"dls.license.dialog.html");if(!ne.ok)throw Error("Get license dialog fail. Network Error: "+ne.statusText);let n=await ne.text();if(!n.trim().startsWith("<"))throw Error("Get license dialog fail. Can't get valid HTMLElement.");let i=document.createElement("div");i.innerHTML=n;let s=[];for(let p=0;p<i.childElementCount;++p){let y=i.children[p];y instanceof HTMLStyleElement&&(s.push(y),document.head.append(y))}let l=i.childElementCount==1?i.children[0]:i;l.remove();let e,t,o,d,h,c=[l],f=l.children;for(let p of f)c.push(p);for(let p=0;p<c.length;++p)for(let y of c[p].children)c.push(y);for(let p of c)if(!e&&p.classList.contains("dls-license-mask"))e=p,p.addEventListener("click",y=>{if(p==y.target){l.remove();for(let b of s)b.remove()}});else if(!t&&p.classList.contains("dls-license-icon-close"))t=p,p.addEventListener("click",()=>{l.remove();for(let y of s)y.remove()});else if(!o&&p.classList.contains("dls-license-icon-error"))o=p,pe!="error"&&p.remove();else if(!d&&p.classList.contains("dls-license-icon-warn"))d=p,pe!="warn"&&p.remove();else if(!h&&p.classList.contains("dls-license-msg-content")){h=p;let y=re;for(;y;){let b=y.indexOf("["),C=y.indexOf("]",b),T=y.indexOf("(",C),O=y.indexOf(")",T);if(b==-1||C==-1||T==-1||O==-1){p.appendChild(new Text(y));break}b>0&&p.appendChild(new Text(y.substring(0,b)));let F=document.createElement("a"),B=y.substring(b+1,C);F.innerText=B;let H=y.substring(T+1,O);F.setAttribute("href",H),F.setAttribute("target","_blank"),p.appendChild(F),y=y.substring(O+1)}}document.body.appendChild(l)}catch(ne){g._onLog&&g._onLog(ne.message||ne)}})(this,J,le)}static async createInstanceInWorker(){return await Q.loadWasm(),await new Promise((J,le)=>{let g=Q._nextTaskID++;Q._taskCallbackMap.set(g,pe=>{if(pe.success)return J(pe.instanceID);{let re=new Error(pe.message);return re.stack=pe.stack+`
`+re.stack,le(re)}}),Q._dcpWorker.postMessage({type:"createInstance",id:g})})}static async createInstance(){let J=new Q;return J._instanceID=await Q.createInstanceInWorker(),J}async setCryptoPublicKey(J){if(this.bDestroyed)throw new Error('"CodeParser" instance has destroyed');if(!J||typeof J!="string")throw new Error("The public key must be rolled into a value of type string");return await new Promise((le,g)=>{let pe=Q._nextTaskID++;Q._taskCallbackMap.set(pe,re=>{if(re.success)return le();{let ne=new Error(re.message);return ne.stack=re.stack+`
`+ne.stack,g(ne)}}),Q._dcpWorker.postMessage({type:"setCryptoPublicKey",id:pe,instanceID:this._instanceID,key:J})})}async setCertificate(J){if(this.bDestroyed)throw new Error('"CodeParser" instance has destroyed');if(!(J&&(J instanceof Uint8Array||J instanceof ArrayBuffer||typeof J=="string")))throw new Error("`setCertificate` must pass in a Uint8Array, ArrayBuffer type value");let le;if(typeof J=="string"){let g=await new Promise((re,ne)=>{let n=new XMLHttpRequest;n.open("GET",J,!0),n.responseType="blob",n.send(),n.onloadend=async()=>{re(n.response)},n.onerror=()=>{ne(new Error("Network Error: "+n.statusText))}}),pe=new FileReader;await new Promise((re,ne)=>{pe.onload=re,pe.readAsArrayBuffer(g)}),le=new Uint8Array(pe.result)}return await new Promise((g,pe)=>{let re=Q._nextTaskID++;J instanceof ArrayBuffer&&(J=new Uint8Array(J));let ne=typeof J=="string"?le:J;Q._taskCallbackMap.set(re,n=>{if(n.success)return g();{let i=new Error(n.message);return i.stack=n.stack+`
`+i.stack,pe(i)}}),Q._dcpWorker.postMessage({type:"setCertificate",id:re,instanceID:this._instanceID,cer:ne})})}async setCodeFormat(J){if(this.bDestroyed)throw new Error('"CodeParser" instance has destroyed');if(J===void 0||!a.EnumCodeFormat.hasOwnProperty(J))throw new Error("`setCodeFormat` must pass in a value of type EnumCodeFormat");return await new Promise((le,g)=>{let pe=Q._nextTaskID++;Q._taskCallbackMap.set(pe,re=>{if(re.success)return le();{let ne=new Error(re.message);return ne.stack=re.stack+`
`+ne.stack,g(ne)}}),Q._dcpWorker.postMessage({type:"setCodeFormat",id:pe,instanceID:this._instanceID,format:J})})}async parseData(J){if(this.bDestroyed)throw new Error('"CodeParser" instance has destroyed');if(!(J&&(J instanceof Array||J instanceof Uint8Array||typeof J=="string")))throw new Error("`parseData` must pass in an Array or Uint8Array or string");return await new Promise((le,g)=>{let pe=Q._nextTaskID++;J instanceof Array&&(J=Uint8Array.from(J)),typeof J=="string"&&(J=Uint8Array.from(this._stringToUint8Array(J))),Q._taskCallbackMap.set(pe,async re=>{if(re.success){let ne=JSON.parse(re.parseReturn);return this._setDescription(ne),le(ne.result?ne.result:ne)}{let ne=new Error(re.message);return ne.stack=re.stack+`
`+ne.stack,g(ne)}}),Q._dcpWorker.postMessage({type:"parseData",id:pe,instanceID:this._instanceID,source:J})})}_stringToUint8Array(J){let le=[];for(let g=0;g<J.length;++g)le.push(J.charCodeAt(g));return le}_setDescription(J){if(J.description==="Unknown error."){for(let le in a.EnumErrorCode)if(a.EnumErrorCode[le]===J.exception){J.description=le;break}}}destroyContext(){if(Q._onLog&&Q._onLog("destroyContext()"),this.bDestroyed)return;this.bDestroyed=!0;let J=Q._nextTaskID++;Q._taskCallbackMap.set(J,le=>{if(!le.success){let g=new Error(le.message);throw g.stack=le.stack+`
`+g.stack,g}}),Q._dcpWorker.postMessage({type:"destroyContext",id:J,instanceID:this._instanceID})}}Q._jsVersion="1.1.0",Q._jsEditVersion="20220708",Q._version=`loading...(JS ${Q._jsVersion}.${Q._jsEditVersion})`,Q._license=_,Q._workerName=`dcp-${Q._jsVersion}.browser.worker.js`,Q._bWasmDebug=!1,Q._pLoad=new class extends Promise{constructor(fe){let J,le;super((g,pe)=>{J=g,le=pe}),this._s="pending",this.resolve=g=>{this.isPending&&(q(g)?this.task=g:(this._s="fulfilled",J(g)))},this.reject=g=>{this.isPending&&(this._s="rejected",le(g))},this.task=fe}get status(){return this._s}get isPending(){return this._s==="pending"}get isFulfilled(){return this._s==="fulfilled"}get isRejected(){return this._s==="rejected"}get task(){return this._task}set task(fe){let J;this._task=fe,q(fe)?J=fe:typeof fe=="function"&&(J=new Promise(fe)),J&&(async()=>{try{let le=await J;fe===this._task&&this.resolve(le)}catch(le){fe===this._task&&this.reject(le)}})()}get isEmpty(){return this._task==null}},Q._bNeverShowDialog=!1,Q._sessionPassword=v,Q.browserInfo=D,Q.__bUseFullFeature=!1,Q._deviceFriendlyName="",Q._taskCallbackMap=new Map,Q._nextTaskID=0,Q._engineResourcePath=m,Q._licenseServer=[],a.EnumResultInfoType=void 0,(K=a.EnumResultInfoType||(a.EnumResultInfoType={}))[K.RIT_DRIVER_LICENSE_AAMVA=0]="RIT_DRIVER_LICENSE_AAMVA",K[K.RIT_PERSONAL_ID=1]="RIT_PERSONAL_ID",K[K.RIT_VDSNC=2]="RIT_VDSNC",K[K.RIT_AADHAAR=3]="RIT_AADHAAR",K[K.RIT_DRIVER_LICENSE_SOUTH_AFRICA=4]="RIT_DRIVER_LICENSE_SOUTH_AFRICA",a.CodeParser=Q,Object.defineProperty(a,"__esModule",{value:!0})})});frappe.provide("frappe.customscan_qrcode");function si(a,r,u,_){a.prototype._pos=[0,0,0],a.prototype._orientation=[0,0,-1,0,1,0],a.prototype.stereo=function(S){var m=this;if(!m.ctx||!m.ctx.listener)return m;for(var w=m._howls.length-1;w>=0;w--)m._howls[w].stereo(S);return m},a.prototype.pos=function(S,m,w){var E=this;if(!E.ctx||!E.ctx.listener)return E;if(m=typeof m!="number"?E._pos[1]:m,w=typeof w!="number"?E._pos[2]:w,typeof S=="number")E._pos=[S,m,w],typeof E.ctx.listener.positionX!="undefined"?(E.ctx.listener.positionX.setTargetAtTime(E._pos[0],r.ctx.currentTime,.1),E.ctx.listener.positionY.setTargetAtTime(E._pos[1],r.ctx.currentTime,.1),E.ctx.listener.positionZ.setTargetAtTime(E._pos[2],r.ctx.currentTime,.1)):E.ctx.listener.setPosition(E._pos[0],E._pos[1],E._pos[2]);else return E._pos;return E},a.prototype.orientation=function(S,m,w,E,x,A){var D=this;if(!D.ctx||!D.ctx.listener)return D;var I=D._orientation;if(m=typeof m!="number"?I[1]:m,w=typeof w!="number"?I[2]:w,E=typeof E!="number"?I[3]:E,x=typeof x!="number"?I[4]:x,A=typeof A!="number"?I[5]:A,typeof S=="number")D._orientation=[S,m,w,E,x,A],typeof D.ctx.listener.forwardX!="undefined"?(D.ctx.listener.forwardX.setTargetAtTime(S,r.ctx.currentTime,.1),D.ctx.listener.forwardY.setTargetAtTime(m,r.ctx.currentTime,.1),D.ctx.listener.forwardZ.setTargetAtTime(w,r.ctx.currentTime,.1),D.ctx.listener.upX.setTargetAtTime(E,r.ctx.currentTime,.1),D.ctx.listener.upY.setTargetAtTime(x,r.ctx.currentTime,.1),D.ctx.listener.upZ.setTargetAtTime(A,r.ctx.currentTime,.1)):D.ctx.listener.setOrientation(S,m,w,E,x,A);else return I;return D},u.prototype.init=function(S){return function(m){var w=this;return w._orientation=m.orientation||[1,0,0],w._stereo=m.stereo||null,w._pos=m.pos||null,w._pannerAttr={coneInnerAngle:typeof m.coneInnerAngle!="undefined"?m.coneInnerAngle:360,coneOuterAngle:typeof m.coneOuterAngle!="undefined"?m.coneOuterAngle:360,coneOuterGain:typeof m.coneOuterGain!="undefined"?m.coneOuterGain:0,distanceModel:typeof m.distanceModel!="undefined"?m.distanceModel:"inverse",maxDistance:typeof m.maxDistance!="undefined"?m.maxDistance:1e4,panningModel:typeof m.panningModel!="undefined"?m.panningModel:"HRTF",refDistance:typeof m.refDistance!="undefined"?m.refDistance:1,rolloffFactor:typeof m.rolloffFactor!="undefined"?m.rolloffFactor:1},w._onstereo=m.onstereo?[{fn:m.onstereo}]:[],w._onpos=m.onpos?[{fn:m.onpos}]:[],w._onorientation=m.onorientation?[{fn:m.onorientation}]:[],S.call(this,m)}}(u.prototype.init),u.prototype.stereo=function(S,m){var w=this;if(!w._webAudio)return w;if(w._state!=="loaded")return w._queue.push({event:"stereo",action:function(){w.stereo(S,m)}}),w;var E=typeof r.ctx.createStereoPanner=="undefined"?"spatial":"stereo";if(typeof m=="undefined")if(typeof S=="number")w._stereo=S,w._pos=[S,0,0];else return w._stereo;for(var x=w._getSoundIds(m),A=0;A<x.length;A++){var D=w._soundById(x[A]);if(D)if(typeof S=="number")D._stereo=S,D._pos=[S,0,0],D._node&&(D._pannerAttr.panningModel="equalpower",(!D._panner||!D._panner.pan)&&v(D,E),E==="spatial"?typeof D._panner.positionX!="undefined"?(D._panner.positionX.setValueAtTime(S,r.ctx.currentTime),D._panner.positionY.setValueAtTime(0,r.ctx.currentTime),D._panner.positionZ.setValueAtTime(0,r.ctx.currentTime)):D._panner.setPosition(S,0,0):D._panner.pan.setValueAtTime(S,r.ctx.currentTime)),w._emit("stereo",D._id);else return D._stereo}return w},u.prototype.pos=function(S,m,w,E){var x=this;if(!x._webAudio)return x;if(x._state!=="loaded")return x._queue.push({event:"pos",action:function(){x.pos(S,m,w,E)}}),x;if(m=typeof m!="number"?0:m,w=typeof w!="number"?-.5:w,typeof E=="undefined")if(typeof S=="number")x._pos=[S,m,w];else return x._pos;for(var A=x._getSoundIds(E),D=0;D<A.length;D++){var I=x._soundById(A[D]);if(I)if(typeof S=="number")I._pos=[S,m,w],I._node&&((!I._panner||I._panner.pan)&&v(I,"spatial"),typeof I._panner.positionX!="undefined"?(I._panner.positionX.setValueAtTime(S,r.ctx.currentTime),I._panner.positionY.setValueAtTime(m,r.ctx.currentTime),I._panner.positionZ.setValueAtTime(w,r.ctx.currentTime)):I._panner.setPosition(S,m,w)),x._emit("pos",I._id);else return I._pos}return x},u.prototype.orientation=function(S,m,w,E){var x=this;if(!x._webAudio)return x;if(x._state!=="loaded")return x._queue.push({event:"orientation",action:function(){x.orientation(S,m,w,E)}}),x;if(m=typeof m!="number"?x._orientation[1]:m,w=typeof w!="number"?x._orientation[2]:w,typeof E=="undefined")if(typeof S=="number")x._orientation=[S,m,w];else return x._orientation;for(var A=x._getSoundIds(E),D=0;D<A.length;D++){var I=x._soundById(A[D]);if(I)if(typeof S=="number")I._orientation=[S,m,w],I._node&&(I._panner||(I._pos||(I._pos=x._pos||[0,0,-.5]),v(I,"spatial")),typeof I._panner.orientationX!="undefined"?(I._panner.orientationX.setValueAtTime(S,r.ctx.currentTime),I._panner.orientationY.setValueAtTime(m,r.ctx.currentTime),I._panner.orientationZ.setValueAtTime(w,r.ctx.currentTime)):I._panner.setOrientation(S,m,w)),x._emit("orientation",I._id);else return I._orientation}return x},u.prototype.pannerAttr=function(){var S=this,m=arguments,w,E,x;if(!S._webAudio)return S;if(m.length===0)return S._pannerAttr;if(m.length===1)if(typeof m[0]=="object")w=m[0],typeof E=="undefined"&&(w.pannerAttr||(w.pannerAttr={coneInnerAngle:w.coneInnerAngle,coneOuterAngle:w.coneOuterAngle,coneOuterGain:w.coneOuterGain,distanceModel:w.distanceModel,maxDistance:w.maxDistance,refDistance:w.refDistance,rolloffFactor:w.rolloffFactor,panningModel:w.panningModel}),S._pannerAttr={coneInnerAngle:typeof w.pannerAttr.coneInnerAngle!="undefined"?w.pannerAttr.coneInnerAngle:S._coneInnerAngle,coneOuterAngle:typeof w.pannerAttr.coneOuterAngle!="undefined"?w.pannerAttr.coneOuterAngle:S._coneOuterAngle,coneOuterGain:typeof w.pannerAttr.coneOuterGain!="undefined"?w.pannerAttr.coneOuterGain:S._coneOuterGain,distanceModel:typeof w.pannerAttr.distanceModel!="undefined"?w.pannerAttr.distanceModel:S._distanceModel,maxDistance:typeof w.pannerAttr.maxDistance!="undefined"?w.pannerAttr.maxDistance:S._maxDistance,refDistance:typeof w.pannerAttr.refDistance!="undefined"?w.pannerAttr.refDistance:S._refDistance,rolloffFactor:typeof w.pannerAttr.rolloffFactor!="undefined"?w.pannerAttr.rolloffFactor:S._rolloffFactor,panningModel:typeof w.pannerAttr.panningModel!="undefined"?w.pannerAttr.panningModel:S._panningModel});else return x=S._soundById(parseInt(m[0],10)),x?x._pannerAttr:S._pannerAttr;else m.length===2&&(w=m[0],E=parseInt(m[1],10));for(var A=S._getSoundIds(E),D=0;D<A.length;D++)if(x=S._soundById(A[D]),x){var I=x._pannerAttr;I={coneInnerAngle:typeof w.coneInnerAngle!="undefined"?w.coneInnerAngle:I.coneInnerAngle,coneOuterAngle:typeof w.coneOuterAngle!="undefined"?w.coneOuterAngle:I.coneOuterAngle,coneOuterGain:typeof w.coneOuterGain!="undefined"?w.coneOuterGain:I.coneOuterGain,distanceModel:typeof w.distanceModel!="undefined"?w.distanceModel:I.distanceModel,maxDistance:typeof w.maxDistance!="undefined"?w.maxDistance:I.maxDistance,refDistance:typeof w.refDistance!="undefined"?w.refDistance:I.refDistance,rolloffFactor:typeof w.rolloffFactor!="undefined"?w.rolloffFactor:I.rolloffFactor,panningModel:typeof w.panningModel!="undefined"?w.panningModel:I.panningModel};var z=x._panner;z||(x._pos||(x._pos=S._pos||[0,0,-.5]),v(x,"spatial"),z=x._panner),z.coneInnerAngle=I.coneInnerAngle,z.coneOuterAngle=I.coneOuterAngle,z.coneOuterGain=I.coneOuterGain,z.distanceModel=I.distanceModel,z.maxDistance=I.maxDistance,z.refDistance=I.refDistance,z.rolloffFactor=I.rolloffFactor,z.panningModel=I.panningModel}return S},_.prototype.init=function(S){return function(){var m=this,w=m._parent;m._orientation=w._orientation,m._stereo=w._stereo,m._pos=w._pos,m._pannerAttr=w._pannerAttr,S.call(this),m._stereo?w.stereo(m._stereo):m._pos&&w.pos(m._pos[0],m._pos[1],m._pos[2],m._id)}}(_.prototype.init),_.prototype.reset=function(S){return function(){var m=this,w=m._parent;return m._orientation=w._orientation,m._stereo=w._stereo,m._pos=w._pos,m._pannerAttr=w._pannerAttr,m._stereo?w.stereo(m._stereo):m._pos?w.pos(m._pos[0],m._pos[1],m._pos[2],m._id):m._panner&&(m._panner.disconnect(0),m._panner=void 0,w._refreshBuffer(m)),S.call(this)}}(_.prototype.reset);var v=function(S,m){m=m||"spatial",m==="spatial"?(S._panner=r.ctx.createPanner(),S._panner.coneInnerAngle=S._pannerAttr.coneInnerAngle,S._panner.coneOuterAngle=S._pannerAttr.coneOuterAngle,S._panner.coneOuterGain=S._pannerAttr.coneOuterGain,S._panner.distanceModel=S._pannerAttr.distanceModel,S._panner.maxDistance=S._pannerAttr.maxDistance,S._panner.refDistance=S._pannerAttr.refDistance,S._panner.rolloffFactor=S._pannerAttr.rolloffFactor,S._panner.panningModel=S._pannerAttr.panningModel,typeof S._panner.positionX!="undefined"?(S._panner.positionX.setValueAtTime(S._pos[0],r.ctx.currentTime),S._panner.positionY.setValueAtTime(S._pos[1],r.ctx.currentTime),S._panner.positionZ.setValueAtTime(S._pos[2],r.ctx.currentTime)):S._panner.setPosition(S._pos[0],S._pos[1],S._pos[2]),typeof S._panner.orientationX!="undefined"?(S._panner.orientationX.setValueAtTime(S._orientation[0],r.ctx.currentTime),S._panner.orientationY.setValueAtTime(S._orientation[1],r.ctx.currentTime),S._panner.orientationZ.setValueAtTime(S._orientation[2],r.ctx.currentTime)):S._panner.setOrientation(S._orientation[0],S._orientation[1],S._orientation[2])):(S._panner=r.ctx.createStereoPanner(),S._panner.pan.setValueAtTime(S._stereo,r.ctx.currentTime)),S._panner.connect(S._node),S._paused||S._parent.pause(S._id,!0).play(S._id,!0)}}var st=function(){this.init()};st.prototype={init:function(){var a=this||$;return a._counter=1e3,a._html5AudioPool=[],a.html5PoolSize=10,a._codecs={},a._howls=[],a._muted=!1,a._volume=1,a._canPlayEvent="canplaythrough",a._navigator=typeof window!="undefined"&&window.navigator?window.navigator:null,a.masterGain=null,a.noAudio=!1,a.usingWebAudio=!0,a.autoSuspend=!0,a.ctx=null,a.autoUnlock=!0,a._setup(),a},volume:function(a){var r=this||$;if(a=parseFloat(a),r.ctx||Je(),typeof a!="undefined"&&a>=0&&a<=1){if(r._volume=a,r._muted)return r;r.usingWebAudio&&r.masterGain.gain.setValueAtTime(a,$.ctx.currentTime);for(var u=0;u<r._howls.length;u++)if(!r._howls[u]._webAudio)for(var _=r._howls[u]._getSoundIds(),v=0;v<_.length;v++){var S=r._howls[u]._soundById(_[v]);S&&S._node&&(S._node.volume=S._volume*a)}return r}return r._volume},mute:function(a){var r=this||$;r.ctx||Je(),r._muted=a,r.usingWebAudio&&r.masterGain.gain.setValueAtTime(a?0:r._volume,$.ctx.currentTime);for(var u=0;u<r._howls.length;u++)if(!r._howls[u]._webAudio)for(var _=r._howls[u]._getSoundIds(),v=0;v<_.length;v++){var S=r._howls[u]._soundById(_[v]);S&&S._node&&(S._node.muted=a?!0:S._muted)}return r},stop:function(){for(var a=this||$,r=0;r<a._howls.length;r++)a._howls[r].stop();return a},unload:function(){for(var a=this||$,r=a._howls.length-1;r>=0;r--)a._howls[r].unload();return a.usingWebAudio&&a.ctx&&typeof a.ctx.close!="undefined"&&(a.ctx.close(),a.ctx=null,Je()),a},codecs:function(a){return(this||$)._codecs[a.replace(/^x-/,"")]},_setup:function(){var a=this||$;if(a.state=a.ctx&&a.ctx.state||"suspended",a._autoSuspend(),!a.usingWebAudio)if(typeof Audio!="undefined")try{var r=new Audio;typeof r.oncanplaythrough=="undefined"&&(a._canPlayEvent="canplay")}catch(u){a.noAudio=!0}else a.noAudio=!0;try{var r=new Audio;r.muted&&(a.noAudio=!0)}catch(u){}return a.noAudio||a._setupCodecs(),a},_setupCodecs:function(){var a=this||$,r=null;try{r=typeof Audio!="undefined"?new Audio:null}catch(x){return a}if(!r||typeof r.canPlayType!="function")return a;var u=r.canPlayType("audio/mpeg;").replace(/^no$/,""),_=a._navigator?a._navigator.userAgent:"",v=_.match(/OPR\/([0-6].)/g),S=v&&parseInt(v[0].split("/")[1],10)<33,m=_.indexOf("Safari")!==-1&&_.indexOf("Chrome")===-1,w=_.match(/Version\/(.*?) /),E=m&&w&&parseInt(w[1],10)<15;return a._codecs={mp3:!!(!S&&(u||r.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!u,opus:!!r.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!r.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!r.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(r.canPlayType('audio/wav; codecs="1"')||r.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!r.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!r.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(r.canPlayType("audio/x-m4a;")||r.canPlayType("audio/m4a;")||r.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(r.canPlayType("audio/x-m4b;")||r.canPlayType("audio/m4b;")||r.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(r.canPlayType("audio/x-mp4;")||r.canPlayType("audio/mp4;")||r.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!E&&r.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!E&&r.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!r.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(r.canPlayType("audio/x-flac;")||r.canPlayType("audio/flac;")).replace(/^no$/,"")},a},_unlockAudio:function(){var a=this||$;if(!(a._audioUnlocked||!a.ctx)){a._audioUnlocked=!1,a.autoUnlock=!1,!a._mobileUnloaded&&a.ctx.sampleRate!==44100&&(a._mobileUnloaded=!0,a.unload()),a._scratchBuffer=a.ctx.createBuffer(1,1,22050);var r=function(u){for(;a._html5AudioPool.length<a.html5PoolSize;)try{var _=new Audio;_._unlocked=!0,a._releaseHtml5Audio(_)}catch(x){a.noAudio=!0;break}for(var v=0;v<a._howls.length;v++)if(!a._howls[v]._webAudio)for(var S=a._howls[v]._getSoundIds(),m=0;m<S.length;m++){var w=a._howls[v]._soundById(S[m]);w&&w._node&&!w._node._unlocked&&(w._node._unlocked=!0,w._node.load())}a._autoResume();var E=a.ctx.createBufferSource();E.buffer=a._scratchBuffer,E.connect(a.ctx.destination),typeof E.start=="undefined"?E.noteOn(0):E.start(0),typeof a.ctx.resume=="function"&&a.ctx.resume(),E.onended=function(){E.disconnect(0),a._audioUnlocked=!0,document.removeEventListener("touchstart",r,!0),document.removeEventListener("touchend",r,!0),document.removeEventListener("click",r,!0),document.removeEventListener("keydown",r,!0);for(var x=0;x<a._howls.length;x++)a._howls[x]._emit("unlock")}};return document.addEventListener("touchstart",r,!0),document.addEventListener("touchend",r,!0),document.addEventListener("click",r,!0),document.addEventListener("keydown",r,!0),a}},_obtainHtml5Audio:function(){var a=this||$;if(a._html5AudioPool.length)return a._html5AudioPool.pop();var r=new Audio().play();return r&&typeof Promise!="undefined"&&(r instanceof Promise||typeof r.then=="function")&&r.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(a){var r=this||$;return a._unlocked&&r._html5AudioPool.push(a),r},_autoSuspend:function(){var a=this;if(!(!a.autoSuspend||!a.ctx||typeof a.ctx.suspend=="undefined"||!$.usingWebAudio)){for(var r=0;r<a._howls.length;r++)if(a._howls[r]._webAudio){for(var u=0;u<a._howls[r]._sounds.length;u++)if(!a._howls[r]._sounds[u]._paused)return a}return a._suspendTimer&&clearTimeout(a._suspendTimer),a._suspendTimer=setTimeout(function(){if(!!a.autoSuspend){a._suspendTimer=null,a.state="suspending";var _=function(){a.state="suspended",a._resumeAfterSuspend&&(delete a._resumeAfterSuspend,a._autoResume())};a.ctx.suspend().then(_,_)}},3e4),a}},_autoResume:function(){var a=this;if(!(!a.ctx||typeof a.ctx.resume=="undefined"||!$.usingWebAudio))return a.state==="running"&&a.ctx.state!=="interrupted"&&a._suspendTimer?(clearTimeout(a._suspendTimer),a._suspendTimer=null):a.state==="suspended"||a.state==="running"&&a.ctx.state==="interrupted"?(a.ctx.resume().then(function(){a.state="running";for(var r=0;r<a._howls.length;r++)a._howls[r]._emit("resume")}),a._suspendTimer&&(clearTimeout(a._suspendTimer),a._suspendTimer=null)):a.state==="suspending"&&(a._resumeAfterSuspend=!0),a}};var $=new st,Ye=function(a){var r=this;if(!a.src||a.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}r.init(a)};Ye.prototype={init:function(a){var r=this;return $.ctx||Je(),r._autoplay=a.autoplay||!1,r._format=typeof a.format!="string"?a.format:[a.format],r._html5=a.html5||!1,r._muted=a.mute||!1,r._loop=a.loop||!1,r._pool=a.pool||5,r._preload=typeof a.preload=="boolean"||a.preload==="metadata"?a.preload:!0,r._rate=a.rate||1,r._sprite=a.sprite||{},r._src=typeof a.src!="string"?a.src:[a.src],r._volume=a.volume!==void 0?a.volume:1,r._xhr={method:a.xhr&&a.xhr.method?a.xhr.method:"GET",headers:a.xhr&&a.xhr.headers?a.xhr.headers:null,withCredentials:a.xhr&&a.xhr.withCredentials?a.xhr.withCredentials:!1},r._duration=0,r._state="unloaded",r._sounds=[],r._endTimers={},r._queue=[],r._playLock=!1,r._onend=a.onend?[{fn:a.onend}]:[],r._onfade=a.onfade?[{fn:a.onfade}]:[],r._onload=a.onload?[{fn:a.onload}]:[],r._onloaderror=a.onloaderror?[{fn:a.onloaderror}]:[],r._onplayerror=a.onplayerror?[{fn:a.onplayerror}]:[],r._onpause=a.onpause?[{fn:a.onpause}]:[],r._onplay=a.onplay?[{fn:a.onplay}]:[],r._onstop=a.onstop?[{fn:a.onstop}]:[],r._onmute=a.onmute?[{fn:a.onmute}]:[],r._onvolume=a.onvolume?[{fn:a.onvolume}]:[],r._onrate=a.onrate?[{fn:a.onrate}]:[],r._onseek=a.onseek?[{fn:a.onseek}]:[],r._onunlock=a.onunlock?[{fn:a.onunlock}]:[],r._onresume=[],r._webAudio=$.usingWebAudio&&!r._html5,typeof $.ctx!="undefined"&&$.ctx&&$.autoUnlock&&$._unlockAudio(),$._howls.push(r),r._autoplay&&r._queue.push({event:"play",action:function(){r.play()}}),r._preload&&r._preload!=="none"&&r.load(),r},load:function(){var a=this,r=null;if($.noAudio){a._emit("loaderror",null,"No audio support.");return}typeof a._src=="string"&&(a._src=[a._src]);for(var u=0;u<a._src.length;u++){var _,v;if(a._format&&a._format[u])_=a._format[u];else{if(v=a._src[u],typeof v!="string"){a._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}_=/^data:audio\/([^;,]+);/i.exec(v),_||(_=/\.([^.]+)$/.exec(v.split("?",1)[0])),_&&(_=_[1].toLowerCase())}if(_||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),_&&$.codecs(_)){r=a._src[u];break}}if(!r){a._emit("loaderror",null,"No codec support for selected audio sources.");return}return a._src=r,a._state="loading",window.location.protocol==="https:"&&r.slice(0,5)==="http:"&&(a._html5=!0,a._webAudio=!1),new qe(a),a._webAudio&&oi(a),a},play:function(a,r){var u=this,_=null;if(typeof a=="number")_=a,a=null;else{if(typeof a=="string"&&u._state==="loaded"&&!u._sprite[a])return null;if(typeof a=="undefined"&&(a="__default",!u._playLock)){for(var v=0,S=0;S<u._sounds.length;S++)u._sounds[S]._paused&&!u._sounds[S]._ended&&(v++,_=u._sounds[S]._id);v===1?a=null:_=null}}var m=_?u._soundById(_):u._inactiveSound();if(!m)return null;if(_&&!a&&(a=m._sprite||"__default"),u._state!=="loaded"){m._sprite=a,m._ended=!1;var w=m._id;return u._queue.push({event:"play",action:function(){u.play(w)}}),w}if(_&&!m._paused)return r||u._loadQueue("play"),m._id;u._webAudio&&$._autoResume();var E=Math.max(0,m._seek>0?m._seek:u._sprite[a][0]/1e3),x=Math.max(0,(u._sprite[a][0]+u._sprite[a][1])/1e3-E),A=x*1e3/Math.abs(m._rate),D=u._sprite[a][0]/1e3,I=(u._sprite[a][0]+u._sprite[a][1])/1e3;m._sprite=a,m._ended=!1;var z=function(){m._paused=!1,m._seek=E,m._start=D,m._stop=I,m._loop=!!(m._loop||u._sprite[a][2])};if(E>=I){u._ended(m);return}var se=m._node;if(u._webAudio){var ee=function(){u._playLock=!1,z(),u._refreshBuffer(m);var K=m._muted||u._muted?0:m._volume;se.gain.setValueAtTime(K,$.ctx.currentTime),m._playStart=$.ctx.currentTime,typeof se.bufferSource.start=="undefined"?m._loop?se.bufferSource.noteGrainOn(0,E,86400):se.bufferSource.noteGrainOn(0,E,x):m._loop?se.bufferSource.start(0,E,86400):se.bufferSource.start(0,E,x),A!==1/0&&(u._endTimers[m._id]=setTimeout(u._ended.bind(u,m),A)),r||setTimeout(function(){u._emit("play",m._id),u._loadQueue()},0)};$.state==="running"&&$.ctx.state!=="interrupted"?ee():(u._playLock=!0,u.once("resume",ee),u._clearTimer(m._id))}else{var q=function(){se.currentTime=E,se.muted=m._muted||u._muted||$._muted||se.muted,se.volume=m._volume*$.volume(),se.playbackRate=m._rate;try{var K=se.play();if(K&&typeof Promise!="undefined"&&(K instanceof Promise||typeof K.then=="function")?(u._playLock=!0,z(),K.then(function(){u._playLock=!1,se._unlocked=!0,r?u._loadQueue():u._emit("play",m._id)}).catch(function(){u._playLock=!1,u._emit("playerror",m._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),m._ended=!0,m._paused=!0})):r||(u._playLock=!1,z(),u._emit("play",m._id)),se.playbackRate=m._rate,se.paused){u._emit("playerror",m._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}a!=="__default"||m._loop?u._endTimers[m._id]=setTimeout(u._ended.bind(u,m),A):(u._endTimers[m._id]=function(){u._ended(m),se.removeEventListener("ended",u._endTimers[m._id],!1)},se.addEventListener("ended",u._endTimers[m._id],!1))}catch(Q){u._emit("playerror",m._id,Q)}};se.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(se.src=u._src,se.load());var te=window&&window.ejecta||!se.readyState&&$._navigator.isCocoonJS;if(se.readyState>=3||te)q();else{u._playLock=!0,u._state="loading";var ce=function(){u._state="loaded",q(),se.removeEventListener($._canPlayEvent,ce,!1)};se.addEventListener($._canPlayEvent,ce,!1),u._clearTimer(m._id)}}return m._id},pause:function(a){var r=this;if(r._state!=="loaded"||r._playLock)return r._queue.push({event:"pause",action:function(){r.pause(a)}}),r;for(var u=r._getSoundIds(a),_=0;_<u.length;_++){r._clearTimer(u[_]);var v=r._soundById(u[_]);if(v&&!v._paused&&(v._seek=r.seek(u[_]),v._rateSeek=0,v._paused=!0,r._stopFade(u[_]),v._node))if(r._webAudio){if(!v._node.bufferSource)continue;typeof v._node.bufferSource.stop=="undefined"?v._node.bufferSource.noteOff(0):v._node.bufferSource.stop(0),r._cleanBuffer(v._node)}else(!isNaN(v._node.duration)||v._node.duration===1/0)&&v._node.pause();arguments[1]||r._emit("pause",v?v._id:null)}return r},stop:function(a,r){var u=this;if(u._state!=="loaded"||u._playLock)return u._queue.push({event:"stop",action:function(){u.stop(a)}}),u;for(var _=u._getSoundIds(a),v=0;v<_.length;v++){u._clearTimer(_[v]);var S=u._soundById(_[v]);S&&(S._seek=S._start||0,S._rateSeek=0,S._paused=!0,S._ended=!0,u._stopFade(_[v]),S._node&&(u._webAudio?S._node.bufferSource&&(typeof S._node.bufferSource.stop=="undefined"?S._node.bufferSource.noteOff(0):S._node.bufferSource.stop(0),u._cleanBuffer(S._node)):(!isNaN(S._node.duration)||S._node.duration===1/0)&&(S._node.currentTime=S._start||0,S._node.pause(),S._node.duration===1/0&&u._clearSound(S._node))),r||u._emit("stop",S._id))}return u},mute:function(a,r){var u=this;if(u._state!=="loaded"||u._playLock)return u._queue.push({event:"mute",action:function(){u.mute(a,r)}}),u;if(typeof r=="undefined")if(typeof a=="boolean")u._muted=a;else return u._muted;for(var _=u._getSoundIds(r),v=0;v<_.length;v++){var S=u._soundById(_[v]);S&&(S._muted=a,S._interval&&u._stopFade(S._id),u._webAudio&&S._node?S._node.gain.setValueAtTime(a?0:S._volume,$.ctx.currentTime):S._node&&(S._node.muted=$._muted?!0:a),u._emit("mute",S._id))}return u},volume:function(){var a=this,r=arguments,u,_;if(r.length===0)return a._volume;if(r.length===1||r.length===2&&typeof r[1]=="undefined"){var v=a._getSoundIds(),S=v.indexOf(r[0]);S>=0?_=parseInt(r[0],10):u=parseFloat(r[0])}else r.length>=2&&(u=parseFloat(r[0]),_=parseInt(r[1],10));var m;if(typeof u!="undefined"&&u>=0&&u<=1){if(a._state!=="loaded"||a._playLock)return a._queue.push({event:"volume",action:function(){a.volume.apply(a,r)}}),a;typeof _=="undefined"&&(a._volume=u),_=a._getSoundIds(_);for(var w=0;w<_.length;w++)m=a._soundById(_[w]),m&&(m._volume=u,r[2]||a._stopFade(_[w]),a._webAudio&&m._node&&!m._muted?m._node.gain.setValueAtTime(u,$.ctx.currentTime):m._node&&!m._muted&&(m._node.volume=u*$.volume()),a._emit("volume",m._id))}else return m=_?a._soundById(_):a._sounds[0],m?m._volume:0;return a},fade:function(a,r,u,_){var v=this;if(v._state!=="loaded"||v._playLock)return v._queue.push({event:"fade",action:function(){v.fade(a,r,u,_)}}),v;a=Math.min(Math.max(0,parseFloat(a)),1),r=Math.min(Math.max(0,parseFloat(r)),1),u=parseFloat(u),v.volume(a,_);for(var S=v._getSoundIds(_),m=0;m<S.length;m++){var w=v._soundById(S[m]);if(w){if(_||v._stopFade(S[m]),v._webAudio&&!w._muted){var E=$.ctx.currentTime,x=E+u/1e3;w._volume=a,w._node.gain.setValueAtTime(a,E),w._node.gain.linearRampToValueAtTime(r,x)}v._startFadeInterval(w,a,r,u,S[m],typeof _=="undefined")}}return v},_startFadeInterval:function(a,r,u,_,v,S){var m=this,w=r,E=u-r,x=Math.abs(E/.01),A=Math.max(4,x>0?_/x:_),D=Date.now();a._fadeTo=u,a._interval=setInterval(function(){var I=(Date.now()-D)/_;D=Date.now(),w+=E*I,w=Math.round(w*100)/100,E<0?w=Math.max(u,w):w=Math.min(u,w),m._webAudio?a._volume=w:m.volume(w,a._id,!0),S&&(m._volume=w),(u<r&&w<=u||u>r&&w>=u)&&(clearInterval(a._interval),a._interval=null,a._fadeTo=null,m.volume(u,a._id),m._emit("fade",a._id))},A)},_stopFade:function(a){var r=this,u=r._soundById(a);return u&&u._interval&&(r._webAudio&&u._node.gain.cancelScheduledValues($.ctx.currentTime),clearInterval(u._interval),u._interval=null,r.volume(u._fadeTo,a),u._fadeTo=null,r._emit("fade",a)),r},loop:function(){var a=this,r=arguments,u,_,v;if(r.length===0)return a._loop;if(r.length===1)if(typeof r[0]=="boolean")u=r[0],a._loop=u;else return v=a._soundById(parseInt(r[0],10)),v?v._loop:!1;else r.length===2&&(u=r[0],_=parseInt(r[1],10));for(var S=a._getSoundIds(_),m=0;m<S.length;m++)v=a._soundById(S[m]),v&&(v._loop=u,a._webAudio&&v._node&&v._node.bufferSource&&(v._node.bufferSource.loop=u,u&&(v._node.bufferSource.loopStart=v._start||0,v._node.bufferSource.loopEnd=v._stop,a.playing(S[m])&&(a.pause(S[m],!0),a.play(S[m],!0)))));return a},rate:function(){var a=this,r=arguments,u,_;if(r.length===0)_=a._sounds[0]._id;else if(r.length===1){var v=a._getSoundIds(),S=v.indexOf(r[0]);S>=0?_=parseInt(r[0],10):u=parseFloat(r[0])}else r.length===2&&(u=parseFloat(r[0]),_=parseInt(r[1],10));var m;if(typeof u=="number"){if(a._state!=="loaded"||a._playLock)return a._queue.push({event:"rate",action:function(){a.rate.apply(a,r)}}),a;typeof _=="undefined"&&(a._rate=u),_=a._getSoundIds(_);for(var w=0;w<_.length;w++)if(m=a._soundById(_[w]),m){a.playing(_[w])&&(m._rateSeek=a.seek(_[w]),m._playStart=a._webAudio?$.ctx.currentTime:m._playStart),m._rate=u,a._webAudio&&m._node&&m._node.bufferSource?m._node.bufferSource.playbackRate.setValueAtTime(u,$.ctx.currentTime):m._node&&(m._node.playbackRate=u);var E=a.seek(_[w]),x=(a._sprite[m._sprite][0]+a._sprite[m._sprite][1])/1e3-E,A=x*1e3/Math.abs(m._rate);(a._endTimers[_[w]]||!m._paused)&&(a._clearTimer(_[w]),a._endTimers[_[w]]=setTimeout(a._ended.bind(a,m),A)),a._emit("rate",m._id)}}else return m=a._soundById(_),m?m._rate:a._rate;return a},seek:function(){var a=this,r=arguments,u,_;if(r.length===0)a._sounds.length&&(_=a._sounds[0]._id);else if(r.length===1){var v=a._getSoundIds(),S=v.indexOf(r[0]);S>=0?_=parseInt(r[0],10):a._sounds.length&&(_=a._sounds[0]._id,u=parseFloat(r[0]))}else r.length===2&&(u=parseFloat(r[0]),_=parseInt(r[1],10));if(typeof _=="undefined")return 0;if(typeof u=="number"&&(a._state!=="loaded"||a._playLock))return a._queue.push({event:"seek",action:function(){a.seek.apply(a,r)}}),a;var m=a._soundById(_);if(m)if(typeof u=="number"&&u>=0){var w=a.playing(_);w&&a.pause(_,!0),m._seek=u,m._ended=!1,a._clearTimer(_),!a._webAudio&&m._node&&!isNaN(m._node.duration)&&(m._node.currentTime=u);var E=function(){w&&a.play(_,!0),a._emit("seek",_)};if(w&&!a._webAudio){var x=function(){a._playLock?setTimeout(x,0):E()};setTimeout(x,0)}else E()}else if(a._webAudio){var A=a.playing(_)?$.ctx.currentTime-m._playStart:0,D=m._rateSeek?m._rateSeek-m._seek:0;return m._seek+(D+A*Math.abs(m._rate))}else return m._node.currentTime;return a},playing:function(a){var r=this;if(typeof a=="number"){var u=r._soundById(a);return u?!u._paused:!1}for(var _=0;_<r._sounds.length;_++)if(!r._sounds[_]._paused)return!0;return!1},duration:function(a){var r=this,u=r._duration,_=r._soundById(a);return _&&(u=r._sprite[_._sprite][1]/1e3),u},state:function(){return this._state},unload:function(){for(var a=this,r=a._sounds,u=0;u<r.length;u++)r[u]._paused||a.stop(r[u]._id),a._webAudio||(a._clearSound(r[u]._node),r[u]._node.removeEventListener("error",r[u]._errorFn,!1),r[u]._node.removeEventListener($._canPlayEvent,r[u]._loadFn,!1),r[u]._node.removeEventListener("ended",r[u]._endFn,!1),$._releaseHtml5Audio(r[u]._node)),delete r[u]._node,a._clearTimer(r[u]._id);var _=$._howls.indexOf(a);_>=0&&$._howls.splice(_,1);var v=!0;for(u=0;u<$._howls.length;u++)if($._howls[u]._src===a._src||a._src.indexOf($._howls[u]._src)>=0){v=!1;break}return Me&&v&&delete Me[a._src],$.noAudio=!1,a._state="unloaded",a._sounds=[],a=null,null},on:function(a,r,u,_){var v=this,S=v["_on"+a];return typeof r=="function"&&S.push(_?{id:u,fn:r,once:_}:{id:u,fn:r}),v},off:function(a,r,u){var _=this,v=_["_on"+a],S=0;if(typeof r=="number"&&(u=r,r=null),r||u)for(S=0;S<v.length;S++){var m=u===v[S].id;if(r===v[S].fn&&m||!r&&m){v.splice(S,1);break}}else if(a)_["_on"+a]=[];else{var w=Object.keys(_);for(S=0;S<w.length;S++)w[S].indexOf("_on")===0&&Array.isArray(_[w[S]])&&(_[w[S]]=[])}return _},once:function(a,r,u){var _=this;return _.on(a,r,u,1),_},_emit:function(a,r,u){for(var _=this,v=_["_on"+a],S=v.length-1;S>=0;S--)(!v[S].id||v[S].id===r||a==="load")&&(setTimeout(function(m){m.call(this,r,u)}.bind(_,v[S].fn),0),v[S].once&&_.off(a,v[S].fn,v[S].id));return _._loadQueue(a),_},_loadQueue:function(a){var r=this;if(r._queue.length>0){var u=r._queue[0];u.event===a&&(r._queue.shift(),r._loadQueue()),a||u.action()}return r},_ended:function(a){var r=this,u=a._sprite;if(!r._webAudio&&a._node&&!a._node.paused&&!a._node.ended&&a._node.currentTime<a._stop)return setTimeout(r._ended.bind(r,a),100),r;var _=!!(a._loop||r._sprite[u][2]);if(r._emit("end",a._id),!r._webAudio&&_&&r.stop(a._id,!0).play(a._id),r._webAudio&&_){r._emit("play",a._id),a._seek=a._start||0,a._rateSeek=0,a._playStart=$.ctx.currentTime;var v=(a._stop-a._start)*1e3/Math.abs(a._rate);r._endTimers[a._id]=setTimeout(r._ended.bind(r,a),v)}return r._webAudio&&!_&&(a._paused=!0,a._ended=!0,a._seek=a._start||0,a._rateSeek=0,r._clearTimer(a._id),r._cleanBuffer(a._node),$._autoSuspend()),!r._webAudio&&!_&&r.stop(a._id,!0),r},_clearTimer:function(a){var r=this;if(r._endTimers[a]){if(typeof r._endTimers[a]!="function")clearTimeout(r._endTimers[a]);else{var u=r._soundById(a);u&&u._node&&u._node.removeEventListener("ended",r._endTimers[a],!1)}delete r._endTimers[a]}return r},_soundById:function(a){for(var r=this,u=0;u<r._sounds.length;u++)if(a===r._sounds[u]._id)return r._sounds[u];return null},_inactiveSound:function(){var a=this;a._drain();for(var r=0;r<a._sounds.length;r++)if(a._sounds[r]._ended)return a._sounds[r].reset();return new qe(a)},_drain:function(){var a=this,r=a._pool,u=0,_=0;if(!(a._sounds.length<r)){for(_=0;_<a._sounds.length;_++)a._sounds[_]._ended&&u++;for(_=a._sounds.length-1;_>=0;_--){if(u<=r)return;a._sounds[_]._ended&&(a._webAudio&&a._sounds[_]._node&&a._sounds[_]._node.disconnect(0),a._sounds.splice(_,1),u--)}}},_getSoundIds:function(a){var r=this;if(typeof a=="undefined"){for(var u=[],_=0;_<r._sounds.length;_++)u.push(r._sounds[_]._id);return u}else return[a]},_refreshBuffer:function(a){var r=this;return a._node.bufferSource=$.ctx.createBufferSource(),a._node.bufferSource.buffer=Me[r._src],a._panner?a._node.bufferSource.connect(a._panner):a._node.bufferSource.connect(a._node),a._node.bufferSource.loop=a._loop,a._loop&&(a._node.bufferSource.loopStart=a._start||0,a._node.bufferSource.loopEnd=a._stop||0),a._node.bufferSource.playbackRate.setValueAtTime(a._rate,$.ctx.currentTime),r},_cleanBuffer:function(a){var r=this,u=$._navigator&&$._navigator.vendor.indexOf("Apple")>=0;if(!a.bufferSource)return r;if($._scratchBuffer&&a.bufferSource&&(a.bufferSource.onended=null,a.bufferSource.disconnect(0),u))try{a.bufferSource.buffer=$._scratchBuffer}catch(_){}return a.bufferSource=null,r},_clearSound:function(a){var r=/MSIE |Trident\//.test($._navigator&&$._navigator.userAgent);r||(a.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var qe=function(a){this._parent=a,this.init()};qe.prototype={init:function(){var a=this,r=a._parent;return a._muted=r._muted,a._loop=r._loop,a._volume=r._volume,a._rate=r._rate,a._seek=0,a._paused=!0,a._ended=!0,a._sprite="__default",a._id=++$._counter,r._sounds.push(a),a.create(),a},create:function(){var a=this,r=a._parent,u=$._muted||a._muted||a._parent._muted?0:a._volume;return r._webAudio?(a._node=typeof $.ctx.createGain=="undefined"?$.ctx.createGainNode():$.ctx.createGain(),a._node.gain.setValueAtTime(u,$.ctx.currentTime),a._node.paused=!0,a._node.connect($.masterGain)):$.noAudio||(a._node=$._obtainHtml5Audio(),a._errorFn=a._errorListener.bind(a),a._node.addEventListener("error",a._errorFn,!1),a._loadFn=a._loadListener.bind(a),a._node.addEventListener($._canPlayEvent,a._loadFn,!1),a._endFn=a._endListener.bind(a),a._node.addEventListener("ended",a._endFn,!1),a._node.src=r._src,a._node.preload=r._preload===!0?"auto":r._preload,a._node.volume=u*$.volume(),a._node.load()),a},reset:function(){var a=this,r=a._parent;return a._muted=r._muted,a._loop=r._loop,a._volume=r._volume,a._rate=r._rate,a._seek=0,a._rateSeek=0,a._paused=!0,a._ended=!0,a._sprite="__default",a._id=++$._counter,a},_errorListener:function(){var a=this;a._parent._emit("loaderror",a._id,a._node.error?a._node.error.code:0),a._node.removeEventListener("error",a._errorFn,!1)},_loadListener:function(){var a=this,r=a._parent;r._duration=Math.ceil(a._node.duration*10)/10,Object.keys(r._sprite).length===0&&(r._sprite={__default:[0,r._duration*1e3]}),r._state!=="loaded"&&(r._state="loaded",r._emit("load"),r._loadQueue()),a._node.removeEventListener($._canPlayEvent,a._loadFn,!1)},_endListener:function(){var a=this,r=a._parent;r._duration===1/0&&(r._duration=Math.ceil(a._node.duration*10)/10,r._sprite.__default[1]===1/0&&(r._sprite.__default[1]=r._duration*1e3),r._ended(a)),a._node.removeEventListener("ended",a._endFn,!1)}};var Me={},oi=function(a){var r=a._src;if(Me[r]){a._duration=Me[r].duration,ct(a);return}if(/^data:[^;]+;base64,/.test(r)){for(var u=atob(r.split(",")[1]),_=new Uint8Array(u.length),v=0;v<u.length;++v)_[v]=u.charCodeAt(v);ht(_.buffer,a)}else{var S=new XMLHttpRequest;S.open(a._xhr.method,r,!0),S.withCredentials=a._xhr.withCredentials,S.responseType="arraybuffer",a._xhr.headers&&Object.keys(a._xhr.headers).forEach(function(m){S.setRequestHeader(m,a._xhr.headers[m])}),S.onload=function(){var m=(S.status+"")[0];if(m!=="0"&&m!=="2"&&m!=="3"){a._emit("loaderror",null,"Failed loading audio file with status: "+S.status+".");return}ht(S.response,a)},S.onerror=function(){a._webAudio&&(a._html5=!0,a._webAudio=!1,a._sounds=[],delete Me[r],a.load())},ai(S)}},ai=function(a){try{a.send()}catch(r){a.onerror()}},ht=function(a,r){var u=function(){r._emit("loaderror",null,"Decoding audio data failed.")},_=function(v){v&&r._sounds.length>0?(Me[r._src]=v,ct(r,v)):u()};typeof Promise!="undefined"&&$.ctx.decodeAudioData.length===1?$.ctx.decodeAudioData(a).then(_).catch(u):$.ctx.decodeAudioData(a,_,u)},ct=function(a,r){r&&!a._duration&&(a._duration=r.duration),Object.keys(a._sprite).length===0&&(a._sprite={__default:[0,a._duration*1e3]}),a._state!=="loaded"&&(a._state="loaded",a._emit("load"),a._loadQueue())},Je=function(){if(!!$.usingWebAudio){try{typeof AudioContext!="undefined"?$.ctx=new AudioContext:typeof webkitAudioContext!="undefined"?$.ctx=new webkitAudioContext:$.usingWebAudio=!1}catch(v){$.usingWebAudio=!1}$.ctx||($.usingWebAudio=!1);var a=/iP(hone|od|ad)/.test($._navigator&&$._navigator.platform),r=$._navigator&&$._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),u=r?parseInt(r[1],10):null;if(a&&u&&u<9){var _=/safari/.test($._navigator&&$._navigator.userAgent.toLowerCase());$._navigator&&!_&&($.usingWebAudio=!1)}$.usingWebAudio&&($.masterGain=typeof $.ctx.createGain=="undefined"?$.ctx.createGainNode():$.ctx.createGain(),$.masterGain.gain.setValueAtTime($._muted?0:$._volume,$.ctx.currentTime),$.masterGain.connect($.ctx.destination)),$._setup()}};si(st,$,Ye,qe);var Fe=typeof self=="undefined",je,Ae,Ke,Ze,we;if(typeof navigator!="undefined"&&(je=navigator,Ae=je.userAgent,Ke=je.platform,Ze=je.mediaDevices),!Fe){let a={init:function(){this.browser=this.searchString(this.dataBrowser)||"unknownBrowser",this.version=this.searchVersion(Ae)||this.searchVersion(je.appVersion)||0,this.OS=this.searchString(this.dataOS)||"unknownOS",this.OS=="Linux"&&Ae.indexOf("Windows NT")!=-1&&(this.OS="HarmonyOS")},searchString:function(r){for(let u=0;u<r.length;u++){let _=r[u].string,v=r[u].prop;if(this.versionSearchString=r[u].versionSearch||r[u].identity,_){if(_.indexOf(r[u].subString)!=-1)return r[u].identity}else if(v)return r[u].identity}},searchVersion:function(r){let u=r.indexOf(this.versionSearchString);if(u!=-1)return parseFloat(r.substring(u+this.versionSearchString.length+1))},dataBrowser:[{string:Ae,subString:"Edge",identity:"Edge"},{string:Ae,subString:"OPR",identity:"OPR"},{string:Ae,subString:"Chrome",identity:"Chrome"},{string:je.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{string:Ae,subString:"Firefox",identity:"Firefox"},{string:Ae,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"}],dataOS:[{string:Ae,subString:"HarmonyOS",identity:"HarmonyOS"},{string:Ae,subString:"Android",identity:"Android"},{string:Ae,subString:"iPhone",identity:"iPhone"},{string:Ke,subString:"Win",identity:"Windows"},{string:Ke,subString:"Mac",identity:"Mac"},{string:Ke,subString:"Linux",identity:"Linux"}]};a.init(),we={browser:a.browser,version:a.version,OS:a.OS}}Fe&&(we={browser:"ssr",version:0,OS:"ssr"});var li=typeof WebAssembly!="undefined"&&Ae&&!(/Safari/.test(Ae)&&!/Chrome/.test(Ae)&&/\(.+\s11_2_([2-6]).*\)/.test(Ae)),hi=typeof Worker!="undefined",Gt=!(!Ze||!Ze.getUserMedia),ci=async()=>{let a=!1;if(Gt)try{(await Ze.getUserMedia({video:!0})).getTracks().forEach(r=>{r.stop()}),a=!0}catch(r){}return a};we.browser==="Chrome"&&we.version>66||we.browser==="Safari"&&we.version>13||we.browser==="OPR"&&we.version>43||we.browser==="Edge"&&we.version;var ui=(()=>{if(!Fe&&document.currentScript){let a=document.currentScript.src,r=a.indexOf("?");if(r!=-1)a=a.substring(0,r);else{let u=a.indexOf("#");u!=-1&&(a=a.substring(0,u))}return a.substring(0,a.lastIndexOf("/")+1)}return"./"})(),Xe=" is not allowed to change after `createInstance` or `loadWasm` is called.",di=!Fe&&document.currentScript&&(document.currentScript.getAttribute("data-license")||document.currentScript.getAttribute("data-productKeys")||document.currentScript.getAttribute("data-licenseKey")||document.currentScript.getAttribute("data-handshakeCode")||document.currentScript.getAttribute("data-organizationID"))||"",fi=!Fe&&document.currentScript&&document.currentScript.getAttribute("data-sessionPassword")||"",ut=a=>{if(a==null)a=[];else{a=a instanceof Array?[...a]:[a];for(let r=0;r<a.length;++r){if(!Fe){let u=document.createElement("a");u.href=a[r],a[r]=u.href}a[r].endsWith("/")||(a[r]+="/")}}return a},Te,$e,ot,Ue;(function(a){a[a.IPF_Binary=0]="IPF_Binary",a[a.IPF_BinaryInverted=1]="IPF_BinaryInverted",a[a.IPF_GrayScaled=2]="IPF_GrayScaled",a[a.IPF_NV21=3]="IPF_NV21",a[a.IPF_RGB_565=4]="IPF_RGB_565",a[a.IPF_RGB_555=5]="IPF_RGB_555",a[a.IPF_RGB_888=6]="IPF_RGB_888",a[a.IPF_ARGB_8888=7]="IPF_ARGB_8888",a[a.IPF_RGB_161616=8]="IPF_RGB_161616",a[a.IPF_ARGB_16161616=9]="IPF_ARGB_16161616",a[a.IPF_ABGR_8888=10]="IPF_ABGR_8888",a[a.IPF_ABGR_16161616=11]="IPF_ABGR_16161616",a[a.IPF_BGR_888=12]="IPF_BGR_888"})(Te||(Te={})),function(a){a[a.DBR_SYSTEM_EXCEPTION=1]="DBR_SYSTEM_EXCEPTION",a[a.DBR_SUCCESS=0]="DBR_SUCCESS",a[a.DBR_UNKNOWN=-1e4]="DBR_UNKNOWN",a[a.DBR_NO_MEMORY=-10001]="DBR_NO_MEMORY",a[a.DBR_NULL_REFERENCE=-10002]="DBR_NULL_REFERENCE",a[a.DBR_LICENSE_INVALID=-10003]="DBR_LICENSE_INVALID",a[a.DBR_LICENSE_EXPIRED=-10004]="DBR_LICENSE_EXPIRED",a[a.DBR_FILE_NOT_FOUND=-10005]="DBR_FILE_NOT_FOUND",a[a.DBR_FILETYPE_NOT_SUPPORTED=-10006]="DBR_FILETYPE_NOT_SUPPORTED",a[a.DBR_BPP_NOT_SUPPORTED=-10007]="DBR_BPP_NOT_SUPPORTED",a[a.DBR_INDEX_INVALID=-10008]="DBR_INDEX_INVALID",a[a.DBR_BARCODE_FORMAT_INVALID=-10009]="DBR_BARCODE_FORMAT_INVALID",a[a.DBR_CUSTOM_REGION_INVALID=-10010]="DBR_CUSTOM_REGION_INVALID",a[a.DBR_MAX_BARCODE_NUMBER_INVALID=-10011]="DBR_MAX_BARCODE_NUMBER_INVALID",a[a.DBR_IMAGE_READ_FAILED=-10012]="DBR_IMAGE_READ_FAILED",a[a.DBR_TIFF_READ_FAILED=-10013]="DBR_TIFF_READ_FAILED",a[a.DBR_QR_LICENSE_INVALID=-10016]="DBR_QR_LICENSE_INVALID",a[a.DBR_1D_LICENSE_INVALID=-10017]="DBR_1D_LICENSE_INVALID",a[a.DBR_DIB_BUFFER_INVALID=-10018]="DBR_DIB_BUFFER_INVALID",a[a.DBR_PDF417_LICENSE_INVALID=-10019]="DBR_PDF417_LICENSE_INVALID",a[a.DBR_DATAMATRIX_LICENSE_INVALID=-10020]="DBR_DATAMATRIX_LICENSE_INVALID",a[a.DBR_PDF_READ_FAILED=-10021]="DBR_PDF_READ_FAILED",a[a.DBR_PDF_DLL_MISSING=-10022]="DBR_PDF_DLL_MISSING",a[a.DBR_PAGE_NUMBER_INVALID=-10023]="DBR_PAGE_NUMBER_INVALID",a[a.DBR_CUSTOM_SIZE_INVALID=-10024]="DBR_CUSTOM_SIZE_INVALID",a[a.DBR_CUSTOM_MODULESIZE_INVALID=-10025]="DBR_CUSTOM_MODULESIZE_INVALID",a[a.DBR_RECOGNITION_TIMEOUT=-10026]="DBR_RECOGNITION_TIMEOUT",a[a.DBR_JSON_PARSE_FAILED=-10030]="DBR_JSON_PARSE_FAILED",a[a.DBR_JSON_TYPE_INVALID=-10031]="DBR_JSON_TYPE_INVALID",a[a.DBR_JSON_KEY_INVALID=-10032]="DBR_JSON_KEY_INVALID",a[a.DBR_JSON_VALUE_INVALID=-10033]="DBR_JSON_VALUE_INVALID",a[a.DBR_JSON_NAME_KEY_MISSING=-10034]="DBR_JSON_NAME_KEY_MISSING",a[a.DBR_JSON_NAME_VALUE_DUPLICATED=-10035]="DBR_JSON_NAME_VALUE_DUPLICATED",a[a.DBR_TEMPLATE_NAME_INVALID=-10036]="DBR_TEMPLATE_NAME_INVALID",a[a.DBR_JSON_NAME_REFERENCE_INVALID=-10037]="DBR_JSON_NAME_REFERENCE_INVALID",a[a.DBR_PARAMETER_VALUE_INVALID=-10038]="DBR_PARAMETER_VALUE_INVALID",a[a.DBR_DOMAIN_NOT_MATCHED=-10039]="DBR_DOMAIN_NOT_MATCHED",a[a.DBR_RESERVEDINFO_NOT_MATCHED=-10040]="DBR_RESERVEDINFO_NOT_MATCHED",a[a.DBR_AZTEC_LICENSE_INVALID=-10041]="DBR_AZTEC_LICENSE_INVALID",a[a.DBR_LICENSE_DLL_MISSING=-10042]="DBR_LICENSE_DLL_MISSING",a[a.DBR_LICENSEKEY_NOT_MATCHED=-10043]="DBR_LICENSEKEY_NOT_MATCHED",a[a.DBR_REQUESTED_FAILED=-10044]="DBR_REQUESTED_FAILED",a[a.DBR_LICENSE_INIT_FAILED=-10045]="DBR_LICENSE_INIT_FAILED",a[a.DBR_PATCHCODE_LICENSE_INVALID=-10046]="DBR_PATCHCODE_LICENSE_INVALID",a[a.DBR_POSTALCODE_LICENSE_INVALID=-10047]="DBR_POSTALCODE_LICENSE_INVALID",a[a.DBR_DPM_LICENSE_INVALID=-10048]="DBR_DPM_LICENSE_INVALID",a[a.DBR_FRAME_DECODING_THREAD_EXISTS=-10049]="DBR_FRAME_DECODING_THREAD_EXISTS",a[a.DBR_STOP_DECODING_THREAD_FAILED=-10050]="DBR_STOP_DECODING_THREAD_FAILED",a[a.DBR_SET_MODE_ARGUMENT_ERROR=-10051]="DBR_SET_MODE_ARGUMENT_ERROR",a[a.DBR_LICENSE_CONTENT_INVALID=-10052]="DBR_LICENSE_CONTENT_INVALID",a[a.DBR_LICENSE_KEY_INVALID=-10053]="DBR_LICENSE_KEY_INVALID",a[a.DBR_LICENSE_DEVICE_RUNS_OUT=-10054]="DBR_LICENSE_DEVICE_RUNS_OUT",a[a.DBR_GET_MODE_ARGUMENT_ERROR=-10055]="DBR_GET_MODE_ARGUMENT_ERROR",a[a.DBR_IRT_LICENSE_INVALID=-10056]="DBR_IRT_LICENSE_INVALID",a[a.DBR_MAXICODE_LICENSE_INVALID=-10057]="DBR_MAXICODE_LICENSE_INVALID",a[a.DBR_GS1_DATABAR_LICENSE_INVALID=-10058]="DBR_GS1_DATABAR_LICENSE_INVALID",a[a.DBR_GS1_COMPOSITE_LICENSE_INVALID=-10059]="DBR_GS1_COMPOSITE_LICENSE_INVALID",a[a.DBR_DOTCODE_LICENSE_INVALID=-10061]="DBR_DOTCODE_LICENSE_INVALID",a[a.DMERR_NO_LICENSE=-2e4]="DMERR_NO_LICENSE",a[a.DMERR_LICENSE_SYNC_FAILED=-20003]="DMERR_LICENSE_SYNC_FAILED",a[a.DMERR_TRIAL_LICENSE=-20010]="DMERR_TRIAL_LICENSE",a[a.DMERR_FAILED_TO_REACH_LTS=-20200]="DMERR_FAILED_TO_REACH_LTS"}($e||($e={})),function(a){a[a.IMRDT_IMAGE=1]="IMRDT_IMAGE",a[a.IMRDT_CONTOUR=2]="IMRDT_CONTOUR",a[a.IMRDT_LINESEGMENT=4]="IMRDT_LINESEGMENT",a[a.IMRDT_LOCALIZATIONRESULT=8]="IMRDT_LOCALIZATIONRESULT",a[a.IMRDT_REGIONOFINTEREST=16]="IMRDT_REGIONOFINTEREST",a[a.IMRDT_QUADRILATERAL=32]="IMRDT_QUADRILATERAL"}(ot||(ot={})),function(a){a[a.BF_ALL=4265607167]="BF_ALL",a[a.BF_ONED=3147775]="BF_ONED",a[a.BF_GS1_DATABAR=260096]="BF_GS1_DATABAR",a[a.BF_CODE_39=1]="BF_CODE_39",a[a.BF_CODE_128=2]="BF_CODE_128",a[a.BF_CODE_93=4]="BF_CODE_93",a[a.BF_CODABAR=8]="BF_CODABAR",a[a.BF_ITF=16]="BF_ITF",a[a.BF_EAN_13=32]="BF_EAN_13",a[a.BF_EAN_8=64]="BF_EAN_8",a[a.BF_UPC_A=128]="BF_UPC_A",a[a.BF_UPC_E=256]="BF_UPC_E",a[a.BF_INDUSTRIAL_25=512]="BF_INDUSTRIAL_25",a[a.BF_CODE_39_EXTENDED=1024]="BF_CODE_39_EXTENDED",a[a.BF_GS1_DATABAR_OMNIDIRECTIONAL=2048]="BF_GS1_DATABAR_OMNIDIRECTIONAL",a[a.BF_GS1_DATABAR_TRUNCATED=4096]="BF_GS1_DATABAR_TRUNCATED",a[a.BF_GS1_DATABAR_STACKED=8192]="BF_GS1_DATABAR_STACKED",a[a.BF_GS1_DATABAR_STACKED_OMNIDIRECTIONAL=16384]="BF_GS1_DATABAR_STACKED_OMNIDIRECTIONAL",a[a.BF_GS1_DATABAR_EXPANDED=32768]="BF_GS1_DATABAR_EXPANDED",a[a.BF_GS1_DATABAR_EXPANDED_STACKED=65536]="BF_GS1_DATABAR_EXPANDED_STACKED",a[a.BF_GS1_DATABAR_LIMITED=131072]="BF_GS1_DATABAR_LIMITED",a[a.BF_PATCHCODE=262144]="BF_PATCHCODE",a[a.BF_PDF417=33554432]="BF_PDF417",a[a.BF_QR_CODE=67108864]="BF_QR_CODE",a[a.BF_DATAMATRIX=134217728]="BF_DATAMATRIX",a[a.BF_AZTEC=268435456]="BF_AZTEC",a[a.BF_MAXICODE=536870912]="BF_MAXICODE",a[a.BF_MICRO_QR=1073741824]="BF_MICRO_QR",a[a.BF_MICRO_PDF417=524288]="BF_MICRO_PDF417",a[a.BF_GS1_COMPOSITE=2147483648]="BF_GS1_COMPOSITE",a[a.BF_MSI_CODE=1048576]="BF_MSI_CODE",a[a.BF_CODE_11=2097152]="BF_CODE_11",a[a.BF_NULL=0]="BF_NULL"}(Ue||(Ue={}));var dt=a=>a&&typeof a=="object"&&typeof a.then=="function",ft=we.OS=="iPhone"||we.OS=="Android"||we.OS=="HarmonyOS"?2048:4096,k=class{constructor(){this._instanceID=void 0,this._ifSaveOriginalImageInACanvas=!1,this.oriCanvas=null,this.oriCanvasData=null,this.canvas=null,this.bFilterRegionInJs=!1,this._region=null,this._timeStartDecode=null,this._timeEnterInnerDBR=null,this._timeGetMessage=null,this.decodeRecords={},this.bDestroyed=!1,this._lastErrorCode=0,this._lastErrorString="",this._lastInnerDecodeDuration=0,this.intervalTime=0,this._intervalGetVideoFrame=0,this.array_getFrameTimeCost=[],this.array_decodeFrameTimeCost=[],this._indexCurrentDecodingFrame=0,this._arrPolygons=[],this._bPauseScan=!1,this._intervalDetectVideoPause=1e3,this._soundSource="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAABQAAAkAAgICAgICAgICAgICAgICAgICAgKCgoKCgoKCgoKCgoKCgoKCgoKCgwMDAwMDAwMDAwMDAwMDAwMDAwMDg4ODg4ODg4ODg4ODg4ODg4ODg4P//////////////////////////AAAAAExhdmM1OC41NAAAAAAAAAAAAAAAACQEUQAAAAAAAAJAk0uXRQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/+MYxAANQAbGeUEQAAHZYZ3fASqD4P5TKBgocg+Bw/8+CAYBA4XB9/4EBAEP4nB9+UOf/6gfUCAIKyjgQ/Kf//wfswAAAwQA/+MYxAYOqrbdkZGQAMA7DJLCsQxNOij///////////+tv///3RWiZGBEhsf/FO/+LoCSFs1dFVS/g8f/4Mhv0nhqAieHleLy/+MYxAYOOrbMAY2gABf/////////////////usPJ66R0wI4boY9/8jQYg//g2SPx1M0N3Z0kVJLIs///Uw4aMyvHJJYmPBYG/+MYxAgPMALBucAQAoGgaBoFQVBUFQWDv6gZBUFQVBUGgaBr5YSgqCoKhIGg7+IQVBUFQVBoGga//SsFSoKnf/iVTEFNRTMu/+MYxAYAAANIAAAAADEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV",this.beepSound=new Ye({src:["data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAABQAAAkAAgICAgICAgICAgICAgICAgICAgKCgoKCgoKCgoKCgoKCgoKCgoKCgwMDAwMDAwMDAwMDAwMDAwMDAwMDg4ODg4ODg4ODg4ODg4ODg4ODg4P//////////////////////////AAAAAExhdmM1OC41NAAAAAAAAAAAAAAAACQEUQAAAAAAAAJAk0uXRQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/+MYxAANQAbGeUEQAAHZYZ3fASqD4P5TKBgocg+Bw/8+CAYBA4XB9/4EBAEP4nB9+UOf/6gfUCAIKyjgQ/Kf//wfswAAAwQA/+MYxAYOqrbdkZGQAMA7DJLCsQxNOij///////////+tv///3RWiZGBEhsf/FO/+LoCSFs1dFVS/g8f/4Mhv0nhqAieHleLy/+MYxAYOOrbMAY2gABf/////////////////usPJ66R0wI4boY9/8jQYg//g2SPx1M0N3Z0kVJLIs///Uw4aMyvHJJYmPBYG/+MYxAgPMALBucAQAoGgaBoFQVBUFQWDv6gZBUFQVBUGgaBr5YSgqCoKhIGg7+IQVBUFQVBoGga//SsFSoKnf/iVTEFNRTMu/+MYxAYAAANIAAAAADEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV"],onplayerror:(r,u)=>{console.warn(`Sound '${r}' playback failure: ${u}`)}}),this.bPlaySoundOnSuccessfulRead=!1,this.bVibrateOnSuccessfulRead=!1,this.vibrateDuration=300,this.captureAndDecodeInParallel=!0,this._dce=null,this._imgSource=null,this._maxCvsSideLength=ft,this._tempSolutionStatus="closed"}static get version(){return this._version}static get license(){return this._license}static set license(r){((u,_)=>{let v=u;if(!v._pLoad.isEmpty)throw new Error("`license`"+Xe);v._license=_})(k,r)}static get productKeys(){return this._license}static set productKeys(r){k.license=r}static get handshakeCode(){return this._license}static set handshakeCode(r){k.license=r}static get organizationID(){return this._license}static set organizationID(r){k.license=r}static set sessionPassword(r){((u,_)=>{let v=u;if(!v._pLoad.isEmpty)throw new Error("`sessionPassword`"+Xe);v._sessionPassword=_})(k,r)}static get sessionPassword(){return this._sessionPassword}static async detectEnvironment(){return await(async()=>({wasm:li,worker:hi,getUserMedia:Gt,camera:await ci(),browser:we.browser,version:we.version,OS:we.OS}))()}static get engineResourcePath(){return this._engineResourcePath}static set engineResourcePath(r){if(!this._pLoad.isEmpty)throw new Error("`engineResourcePath` is not allowed to change after `createInstance` or `loadWasm` is called.");k._engineResourcePath=(u=>{if(u==null&&(u="./"),!Fe){let _=document.createElement("a");_.href=u,u=_.href}return u.endsWith("/")||(u+="/"),u})(r)}static get licenseServer(){return this._licenseServer}static set licenseServer(r){((u,_)=>{let v=u;if(!v._pLoad.isEmpty)throw new Error("`licenseServer`"+Xe);v._licenseServer=ut(_)})(k,r)}static get deviceFriendlyName(){return this._deviceFriendlyName}static set deviceFriendlyName(r){((u,_)=>{let v=u;if(!v._pLoad.isEmpty)throw new Error("`deviceFriendlyName`"+Xe);v._deviceFriendlyName=_||""})(k,r)}static get _bUseFullFeature(){return this.__bUseFullFeature}static set _bUseFullFeature(r){if(!this._pLoad.isEmpty)throw new Error("`_bUseFullFeature` is not allowed to change after `createInstance` or `loadWasm` is called.");k.__bUseFullFeature=r}static isImageSource(r){return!(!r||typeof r!="object"||Array.isArray(r))&&"getImage"in r}static isDSImage(r){return!(!r||typeof r!="object"||Array.isArray(r))&&"data"in r&&"width"in r&&"height"in r&&"pixelFormat"in r}static isDCEFrame(r){return!(!r||typeof r!="object"||Array.isArray(r))&&"data"in r&&"region"in r&&"sx"in r&&"sy"in r&&"width"in r&&"height"in r&&"colorMode"in r&&"timeSpent"in r&&"timeStamp"in r&&"isCropped"in r&&"toCanvas"in r&&"_sWidth"in r&&"_sHeight"in r&&"_bUseWebGL"in r}get ifSaveOriginalImageInACanvas(){return this._ifSaveOriginalImageInACanvas}set ifSaveOriginalImageInACanvas(r){this._ifSaveOriginalImageInACanvas=r}getOriginalImageInACanvas(){return!this.oriCanvas&&this.oriCanvasData?this.oriCanvasData.toCanvas():this.oriCanvas}set region(r){this._region=r,this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0}get region(){return this._region}static isWasmLoaded(){return this._pLoad.isFulfilled}isContextDestroyed(){return this.bDestroyed}static get lastErrorCode(){return this._lastErrorCode}static get lastErrorString(){return this._lastErrorString}get lastErrorCode(){return this._lastErrorCode}get lastErrorString(){return this._lastErrorString}static get defaultUIElementURL(){var r;return(r=k._defaultUIElementURL)===null||r===void 0?void 0:r.replace("@engineResourcePath/",k.engineResourcePath)}static set defaultUIElementURL(r){k._defaultUIElementURL=r}static _fireHTTPSWarnning(){k.onWarning&&location&&location.protocol!=="https:"&&setTimeout(()=>{k.onWarning&&k.onWarning({id:2,message:"Not connected via SSL (HTTPS), the SDK may not work correctly."})},0)}get soundSource(){return this._soundSource}set soundSource(r){this._soundSource=r,this.beepSound=new Ye({src:[this._soundSource],onplayerror:(u,_)=>{console.warn(`Sound '${u}' playback failure: ${_}`)}})}get whenToPlaySoundforSuccessfulRead(){return this.bPlaySoundOnSuccessfulRead===!0?"frame":this.bPlaySoundOnSuccessfulRead?this.bPlaySoundOnSuccessfulRead:"never"}set whenToPlaySoundforSuccessfulRead(r){this.bPlaySoundOnSuccessfulRead=r!=="never"&&r}get whenToVibrateforSuccessfulRead(){return this.bVibrateOnSuccessfulRead===!0?"frame":this.bVibrateOnSuccessfulRead?this.bVibrateOnSuccessfulRead:"never"}set whenToVibrateforSuccessfulRead(r){this.bVibrateOnSuccessfulRead=r!=="never"&&r}set dce(r){this._dce=r}get dce(){return!this._dce||this._dce.isDisposed?null:this._dce}set maxCvsSideLength(r){this._maxCvsSideLength=r,this._dceControler&&this._dceControler.setDisiredValue(this,"maxCvsSideLength",r)}get maxCvsSideLength(){return this._maxCvsSideLength}async _registerDCEControler(){if(!this.dce)return;k._onLog&&k._onLog("_registerDCEControler()");let r=this.dce;this._dceControler=r._createControler();let u=this._dceControler;u.register(this),u.setDisiredValue(this,"refreshInterval",200),u.setDisiredValue(this,"maxCvsSideLength",this._maxCvsSideLength),this._styleIdBeforeVerification=this.dce.createDrawingStyle({fillStyle:"rgba(248,252,0,0.2)",strokeStyle:"transparent",paintMode:"strokeAndFill"});try{}catch(S){S.name==="ReferenceError"&&window&&(window.ResizeObserver=void 0)}let _=r.getUIElement(),v=this.dce.constructor;if(v._defaultUIElementURL==="@engineResourcePath/dce.ui.html")try{_?_===u._innerSetUI&&(await r.setUIElement(`${v.engineResourcePath}dce.ui.html`),u._innerSetUI=r.getUIElement()):(await r.setUIElement(`${v.engineResourcePath}dbr.ui.html`),u._innerSetUI=r.getUIElement())}catch(S){await r.setUIElement(v.defaultUIElementURL)}else _||await r.setUIElement(v.defaultUIElementURL);this.callbackCameraChange=()=>{this._drawResults(null),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0},this.callbackResolutionChange=()=>{this._drawResults(null),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0},this.callbackCameraClose=()=>{this.stopScanning(!0),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0,this._bPauseScan=!1},this.callbackSingleFrameAcquired=async S=>{let m=await this._decode_DCEFrame(S,{bCopyData:!1}),w=null;if(m&&m.length){let{sx:E,sy:x,width:A,height:D,_sWidth:I,_sHeight:z}=S;w=m.map(se=>({localizationResult:JSON.parse(JSON.stringify(se.localizationResult))})),k.recalculateResultLocation(w,E,x,I,z,A,D)}if(this._drawResults(w),await this.clearMapDecodeRecord(),this.onImageRead&&this.dce.isOpen()&&!this._bPauseScan){let E=this._cloneDecodeResults(m);this.onImageRead(E)}if(this.onUniqueRead&&this.dce.isOpen()&&!this._bPauseScan)for(let E of m)this.onUniqueRead(E.barcodeText,this._cloneDecodeResults(E))},r.on("cameraChange",this.callbackCameraChange),r.on("resolutionChange",this.callbackResolutionChange),r.on("cameraClose",this.callbackCameraClose),r.on("singleFrameAcquired",this.callbackSingleFrameAcquired)}_logoutDCEControler(){this.dce&&this._dceControler&&(k._onLog&&k._onLog("_logoutDCEControler()"),this._dceControler.logout(this),this.dce.off("cameraChange",this.callbackCameraChange),this.dce.off("resolutionChange",this.callbackResolutionChange),this.dce.off("cameraClose",this.callbackCameraClose),this.dce.off("singleFrameAcquired",this.callbackSingleFrameAcquired),this._dceControler=null,this.dce=null)}async setImageSource(r,u){if(r==null)return this._imgSource=null,this._logoutDCEControler(),void(this._drawingItemNamespace=null);if(r&&r.isCameraEnhancer)this.dce=r,await this._registerDCEControler(),this._imgSource=null;else{if(!k.isImageSource(r))throw new Error("Invalid value.");this._logoutDCEControler(),this._imgSource=r}u&&u.resultsHighlightBaseShapes&&(this._drawingItemNamespace=u.resultsHighlightBaseShapes)}static async loadWasm(){if(this._pLoad.isEmpty){let{lt:r,l:u,ls:_,sp:v,rmk:S}=(m=>{let w=m;if(w._pLoad.isEmpty){let E,x,A=w._license||"",D=JSON.parse(JSON.stringify(w._licenseServer)),I=w._sessionPassword,z=0;if(A.startsWith("t")||A.startsWith("f"))z=0;else if(A.length===0||A.startsWith("P")||A.startsWith("L")||A.startsWith("Y")||A.startsWith("A"))z=1;else{z=2;let se=A.indexOf(":");if(se!=-1&&(A=A.substring(se+1)),A.startsWith("DLS2")){let ee=A.substring(4);try{ee=atob(ee)}catch(te){throw new Error("Format Error: The license string you specified is invalid, please check to make sure it is correct.")}let q=JSON.parse(ee);if(A=q.handshakeCode?q.handshakeCode:q.organizationID?q.organizationID:"",typeof A=="number"&&(A=JSON.stringify(A)),D.length===0){let te=[];q.mainServerURL&&(te[0]=q.mainServerURL),q.standbyServerURL&&(te[1]=q.standbyServerURL),D=ut(te)}!I&&q.sessionPassword&&(I=q.sessionPassword),E=q.remark}(A==="200001"||A.startsWith("200001-"))&&(D&&D.length||(A="")),A||(z=1)}if(z&&(globalThis.crypto||(x="Please upgrade your browser to support online key."),globalThis.crypto.subtle||(x="Require https to use online key in this browser.")),x){if(z!==1)throw new Error(x);z=0,console.warn(x),w._lastErrorCode=-1,w._lastErrorString=x}return z===1&&(A="",console.warn("Applying for a public trial license ...")),{lt:z,l:A,ls:D,sp:I,rmk:E}}throw new Error("Can't preprocess license again"+Xe)})(k);this._pLoad.task=async(m,w)=>{let E=k.engineResourcePath+k._workerName;k.engineResourcePath.startsWith(location.origin)||(E=await fetch(E).then(x=>x.blob()).then(x=>URL.createObjectURL(x))),k._dbrWorker=new Worker(E),k._dbrWorker.onerror=x=>{let A=new Error(x.message);w(A)},k._dbrWorker.onmessage=async x=>{let A=x.data?x.data:x;switch(A.type){case"log":k._onLog&&k._onLog(A.message);break;case"load":{A.message&&(A.message=A.message.replace("(https://www.dynamsoft.com/purchase-center/)","(https://www.dynamsoft.com/store/dynamsoft-barcode-reader/#javascript)"));let D,I=!1;r===1&&(I=!0),A.success?(k._dbrWorker.onerror=null,k._version=A.version+"(JS "+k._jsVersion+"."+k._jsEditVersion+")",k._onLog&&k._onLog("load dbr worker success"),A.message&&console.warn(A.message)):(D=new Error(A.message),D.stack=A.stack+`
`+D.stack,I||A.ltsErrorCode==111&&A.message.toLowerCase().indexOf("trial license")!=-1&&(I=!0)),I&&k.showDialog(A.success?"warn":"error",A.message),A.success?m():w(D);break}case"task":{let D=A.id,I=A.body;try{k._taskCallbackMap.get(D)(I),k._taskCallbackMap.delete(D)}catch(z){throw k._taskCallbackMap.delete(D),z}break}default:k._onLog&&k._onLog(x)}},k._dbrWorker.postMessage({type:"loadWasm",engineResourcePath:k.engineResourcePath,bUseFullFeature:k._bUseFullFeature,bd:k._bWasmDebug,v:k._jsVersion,brtk:!!r,bptk:r===1,l:u,dm:location.origin.startsWith("http")?location.origin:"https://localhost",os:we,fn:k.deviceFriendlyName,ls:_,sp:v,rmk:S})}}await this._pLoad}static async showDialog(r,u){await(async(_,v,S)=>{if(!_._bNeverShowDialog)try{let m=await fetch(_.engineResourcePath+"dls.license.dialog.html");if(!m.ok)throw Error("Get license dialog fail. Network Error: "+m.statusText);let w=await m.text();if(!w.trim().startsWith("<"))throw Error("Get license dialog fail. Can't get valid HTMLElement.");let E=document.createElement("div");E.innerHTML=w;let x=[];for(let ce=0;ce<E.childElementCount;++ce){let K=E.children[ce];K instanceof HTMLStyleElement&&(x.push(K),document.head.append(K))}let A=E.childElementCount==1?E.children[0]:E;A.remove();let D,I,z,se,ee,q=[A],te=A.children;for(let ce of te)q.push(ce);for(let ce=0;ce<q.length;++ce)for(let K of q[ce].children)q.push(K);for(let ce of q)if(!D&&ce.classList.contains("dls-license-mask"))D=ce,ce.addEventListener("click",K=>{if(ce==K.target){A.remove();for(let Q of x)Q.remove()}});else if(!I&&ce.classList.contains("dls-license-icon-close"))I=ce,ce.addEventListener("click",()=>{A.remove();for(let K of x)K.remove()});else if(!z&&ce.classList.contains("dls-license-icon-error"))z=ce,v!="error"&&ce.remove();else if(!se&&ce.classList.contains("dls-license-icon-warn"))se=ce,v!="warn"&&ce.remove();else if(!ee&&ce.classList.contains("dls-license-msg-content")){ee=ce;let K=S;for(;K;){let Q=K.indexOf("["),fe=K.indexOf("]",Q),J=K.indexOf("(",fe),le=K.indexOf(")",J);if(Q==-1||fe==-1||J==-1||le==-1){ce.appendChild(new Text(K));break}Q>0&&ce.appendChild(new Text(K.substring(0,Q)));let g=document.createElement("a"),pe=K.substring(Q+1,fe);g.innerText=pe;let re=K.substring(J+1,le);g.setAttribute("href",re),g.setAttribute("target","_blank"),ce.appendChild(g),K=K.substring(le+1)}}document.body.appendChild(A)}catch(m){_._onLog&&_._onLog(m.message||m)}})(this,r,u)}static async createInstanceInWorker(r=!1){return await k.loadWasm(),await new Promise((u,_)=>{let v=k._nextTaskID++;k._taskCallbackMap.set(v,S=>{if(S.success)return u(S.instanceID);{let m=new Error(S.message);return m.stack=S.stack+`
`+m.stack,_(m)}}),k._dbrWorker.postMessage({type:"createInstance",id:v,bScanner:r})})}static async createInstance(){let r=new k;return r._instanceID=await k.createInstanceInWorker(),k._fireHTTPSWarnning(),r}async clearMapDecodeRecord(){return await new Promise((r,u)=>{let _=k._nextTaskID++;k._taskCallbackMap.set(_,v=>{if(v.success)return r();{let S=new Error(v.message);return S.stack=v.stack+`
`+S.stack,u(S)}}),k._dbrWorker.postMessage({type:"clearMapDecodeRecord",id:_,instanceID:this._instanceID})})}async decode(r){k._onLog&&k._onLog("decode(source: any)"),k._onLog&&(this._timeStartDecode=Date.now());{let u={};return!this.region||this.region instanceof Array||(u.region=JSON.parse(JSON.stringify(this.region))),r instanceof Blob?await this._decode_Blob(r,u):r instanceof ArrayBuffer?await this._decode_ArrayBuffer(r,u):r instanceof Uint8Array||r instanceof Uint8ClampedArray?await this._decode_Uint8Array(r,u):r instanceof HTMLImageElement||typeof ImageBitmap!="undefined"&&r instanceof ImageBitmap?await this._decode_Image(r,u):r instanceof HTMLCanvasElement?await this._decode_Canvas(r,u):r instanceof HTMLVideoElement?await this._decode_Video(r,u):typeof r=="string"?r.substring(0,11)=="data:image/"?await this._decode_Base64(r,u):await this._decode_Url(r,u):k.isDCEFrame(r)?(u.bCopyData=!0,await this._decode_DCEFrame(r,u)):k.isDSImage(r)?(u.bCopyData=!0,await this._decode_DSImage(r,u)):await Promise.reject(TypeError("'_decode(source, config)': Type of 'source' should be 'Blob', 'ArrayBuffer', 'Uint8Array', 'HTMLImageElement', 'HTMLCanvasElement', 'HTMLVideoElement', 'String(base64 with image mime)' or 'String(url)'."))}}async decodeBase64String(r){let u={};return!this.region||this.region instanceof Array||(u.region=JSON.parse(JSON.stringify(this.region))),this._decode_Base64(r,u)}async decodeUrl(r){let u={};return!this.region||this.region instanceof Array||(u.region=JSON.parse(JSON.stringify(this.region))),this._decode_Url(r,u)}async _decodeBuffer_Uint8Array(r,u,_,v,S,m){return await new Promise((w,E)=>{let x=k._nextTaskID++;k._taskCallbackMap.set(x,A=>{if(A.success){let D,I=k._onLog?Date.now():0;k._onLog&&k._onLog("worker return result: "+I),this._lastInnerDecodeDuration=A.duration;try{D=this._handleRetJsonString(A.decodeReturn)}catch(z){return E(z)}if(k._onLog){let z=Date.now();k._onLog("DBR getting message from worker timestamp: "+I),k._onLog("From DBR staring decoding to entering worker costs: "+(this._timeEnterInnerDBR-this._timeStartDecode)),k._onLog("From DBR entering worker to returning message from worker costs: "+(I-this._timeEnterInnerDBR)),k._onLog("Handling results from DBR worker costs: "+(z-I)),k._onLog("Total decoding image costs: "+(z-this._timeStartDecode))}return w(D)}{let D=new Error(A.message);return D.stack=A.stack+`
`+D.stack,E(D)}}),this._timeEnterInnerDBR=Date.now(),k._onLog&&k._onLog("Sending buffer to worker timestamp:"+this._timeEnterInnerDBR),k._dbrWorker.postMessage({type:"decodeBuffer",id:x,instanceID:this._instanceID,body:{buffer:r,width:u,height:_,stride:v,format:S,config:m}},[r.buffer]),k._onLog&&m&&m.timeStamp&&k._onLog("Delay of decoding image: "+(this._timeEnterInnerDBR-m.timeStamp))})}async _decodeBuffer_Blob(r,u,_,v,S,m){k._onLog&&k._onLog("_decodeBuffer_Blob(buffer,width,height,stride,format)");let w=r.arrayBuffer?await r.arrayBuffer():await new Promise((E,x)=>{let A=new FileReader;A.readAsArrayBuffer(r),A.onload=()=>{E(A.result)},A.onerror=()=>{x(A.error)}});return await this._decodeBuffer_Uint8Array(new Uint8Array(w),u,_,v,S,m)}async decodeBuffer(r,u,_,v,S,m){let w;return k._onLog&&k._onLog("decodeBuffer(buffer,width,height,stride,format)"),k._onLog&&(this._timeStartDecode=Date.now()),r instanceof Uint8Array||r instanceof Uint8ClampedArray?w=await this._decodeBuffer_Uint8Array(r,u,_,v,S,m):r instanceof ArrayBuffer?w=await this._decodeBuffer_Uint8Array(new Uint8Array(r),u,_,v,S,m):r instanceof Blob&&(w=await this._decodeBuffer_Blob(r,u,_,v,S,m)),w}async _decodeFileInMemory_Uint8Array(r){return await new Promise((u,_)=>{let v=k._nextTaskID++;k._taskCallbackMap.set(v,S=>{if(S.success){let m;this._lastInnerDecodeDuration=S.duration;try{m=this._handleRetJsonString(S.decodeReturn)}catch(w){return _(w)}return u(m)}{let m=new Error(S.message);return m.stack=S.stack+`
`+m.stack,_(m)}}),k._dbrWorker.postMessage({type:"decodeFileInMemory",id:v,instanceID:this._instanceID,body:{bytes:r}})})}async getRuntimeSettings(){return await new Promise((r,u)=>{let _=k._nextTaskID++;k._taskCallbackMap.set(_,v=>{if(v.success){let S=JSON.parse(v.results);return this.userDefinedRegion!=null&&(S.region=JSON.parse(JSON.stringify(this.userDefinedRegion))),r(S)}{let S=new Error(v.message);return S.stack=v.stack+`
`+S.stack,u(S)}}),k._dbrWorker.postMessage({type:"getRuntimeSettings",id:_,instanceID:this._instanceID})})}async updateRuntimeSettings(r){let u;if(typeof r=="string")if(r=="speed"){let _=await this.getRuntimeSettings();await this.resetRuntimeSettings(),u=await this.getRuntimeSettings(),u.barcodeFormatIds=_.barcodeFormatIds,u.barcodeFormatIds_2=_.barcodeFormatIds_2,u.region=_.region,u.deblurLevel=3,u.expectedBarcodesCount=0,u.localizationModes=[2,0,0,0,0,0,0,0]}else if(r=="balance"){let _=await this.getRuntimeSettings();await this.resetRuntimeSettings(),u=await this.getRuntimeSettings(),u.barcodeFormatIds=_.barcodeFormatIds,u.barcodeFormatIds_2=_.barcodeFormatIds_2,u.region=_.region,u.deblurLevel=5,u.expectedBarcodesCount=512,u.localizationModes=[2,16,0,0,0,0,0,0]}else if(r=="coverage"){let _=await this.getRuntimeSettings();await this.resetRuntimeSettings(),u=await this.getRuntimeSettings(),u.barcodeFormatIds=_.barcodeFormatIds,u.barcodeFormatIds_2=_.barcodeFormatIds_2,u.region=_.region}else if(r=="dense"){let _=await this.getRuntimeSettings();await this.resetRuntimeSettings(),this.maxCvsSideLength=4096,u=await this.getRuntimeSettings(),u.barcodeFormatIds=_.barcodeFormatIds,u.barcodeFormatIds_2=_.barcodeFormatIds_2,u.region=_.region,u.deblurLevel=9,u.expectedBarcodesCount=0,u.localizationModes=[2,8,0,0,0,0,0,0]}else if(r=="distance"){let _=await this.getRuntimeSettings();await this.resetRuntimeSettings(),this.maxCvsSideLength=4096,u=await this.getRuntimeSettings(),u.barcodeFormatIds=_.barcodeFormatIds,u.barcodeFormatIds_2=_.barcodeFormatIds_2,u.region=_.region,u.deblurLevel=3,u.expectedBarcodesCount=0,u.localizationModes=[2,8,0,0,0,0,0,0]}else u=JSON.parse(r);else{if(typeof r!="object")throw TypeError("'UpdateRuntimeSettings(settings)': Type of 'settings' should be 'string' or 'PlainObject'.");if(u=JSON.parse(JSON.stringify(r)),u.region instanceof Array){let _=u.region;[_.regionLeft,_.regionTop,_.regionLeft,_.regionBottom,_.regionMeasuredByPercentage].some(v=>v!==void 0)&&(u.region={regionLeft:_.regionLeft||0,regionTop:_.regionTop||0,regionRight:_.regionRight||0,regionBottom:_.regionBottom||0,regionMeasuredByPercentage:_.regionMeasuredByPercentage||0})}}if(!k._bUseFullFeature){if((u.barcodeFormatIds&~(Ue.BF_ONED|Ue.BF_QR_CODE|Ue.BF_PDF417|Ue.BF_DATAMATRIX))!=0||u.barcodeFormatIds_2!=0)throw Error("Some of the specified barcode formats are not supported in the compact version. Please try the full-featured version.");if(u.intermediateResultTypes!=0)throw Error("Intermediate results is not supported in the compact version. Please try the full-featured version.")}if(this.bFilterRegionInJs){let _=u.region;if(_ instanceof Array)throw Error("The `region` of type `Array` is only allowed in `BarcodeScanner`.");this.userDefinedRegion=JSON.parse(JSON.stringify(_)),(_.regionLeft||_.regionTop||_.regionRight||_.regionBottom||_.regionMeasuredByPercentage)&&(_.regionLeft||_.regionTop||_.regionRight!=100||_.regionBottom!=100||!_.regionMeasuredByPercentage)?this.region=_:this.region=null,u.region={regionLeft:0,regionTop:0,regionRight:0,regionBottom:0,regionMeasuredByPercentage:0}}else this.userDefinedRegion=null,this.region=null;return await new Promise((_,v)=>{let S=k._nextTaskID++;k._taskCallbackMap.set(S,m=>{if(m.success){try{this._handleRetJsonString(m.updateReturn)}catch(w){v(w)}return _()}{let w=new Error(m.message);return w.stack=m.stack+`
`+w.stack,v(w)}}),k._dbrWorker.postMessage({type:"updateRuntimeSettings",id:S,instanceID:this._instanceID,body:{settings:JSON.stringify(u)}})})}async resetRuntimeSettings(){return this.userDefinedRegion=null,this.region=null,this.maxCvsSideLength=ft,await new Promise((r,u)=>{let _=k._nextTaskID++;k._taskCallbackMap.set(_,v=>{if(v.success)return r();{let S=new Error(v.message);return S.stack=v.stack+`
`+S.stack,u(S)}}),k._dbrWorker.postMessage({type:"resetRuntimeSettings",id:_,instanceID:this._instanceID})})}async outputRuntimeSettingsToString(){if(!k._bUseFullFeature)throw Error("outputRuntimeSettingsToString() is not supported in the compact version. Please try the full-featured version.");return await new Promise((r,u)=>{let _=k._nextTaskID++;k._taskCallbackMap.set(_,v=>{if(v.success)return r(v.results);{let S=new Error(v.message);return S.stack=v.stack+`
`+S.stack,u(S)}}),k._dbrWorker.postMessage({type:"outputRuntimeSettingsToString",id:_,instanceID:this._instanceID})})}async initRuntimeSettingsWithString(r){if(!k._bUseFullFeature)throw Error("initRuntimeSettingsWithString() is not supported in the compact version. Please try the full-featured version.");if(typeof r=="string")r=r;else{if(typeof r!="object")throw TypeError("'initRuntimeSettingstWithString(settings)': Type of 'settings' should be 'string' or 'PlainObject'.");r=JSON.stringify(r)}return await new Promise((u,_)=>{let v=k._nextTaskID++;k._taskCallbackMap.set(v,S=>{if(S.success){try{this._handleRetJsonString(S.initReturn)}catch(m){_(m)}return u()}{let m=new Error(S.message);return m.stack=S.stack+`
`+m.stack,_(m)}}),k._dbrWorker.postMessage({type:"initRuntimeSettingsWithString",id:v,instanceID:this._instanceID,body:{settings:r}})})}async _decode_Blob(r,u){k._onLog&&k._onLog("_decode_Blob(blob: Blob)");let _=null,v=null;if(typeof createImageBitmap!="undefined")try{_=await createImageBitmap(r)}catch(m){}_||(v=await function(m){return new Promise((w,E)=>{let x=URL.createObjectURL(m),A=new Image;A.dbrObjUrl=x,A.src=x,A.onload=()=>{w(A)},A.onerror=D=>{E(new Error("Can't convert blob to image : "+(D instanceof Event?D.type:D)))}})}(r));let S=await this._decode_Image(_||v,u);return _&&_.close(),S}async _decode_ArrayBuffer(r,u){return await this._decode_Blob(new Blob([r]),u)}async _decode_Uint8Array(r,u){return await this._decode_Blob(new Blob([r]),u)}async _decode_Image(r,u){k._onLog&&k._onLog("_decode_Image(image: HTMLImageElement|ImageBitmap)"),u=u||{};let _,v,S=r instanceof HTMLImageElement?r.naturalWidth:r.width,m=r instanceof HTMLImageElement?r.naturalHeight:r.height,w=Math.max(S,m);if(w>this._maxCvsSideLength){let x=this._maxCvsSideLength/w;_=Math.round(S*x),v=Math.round(m*x)}else _=S,v=m;this.canvas||(this.canvas=document.createElement("canvas"));let E=this.canvas;return E.width===_&&E.height===v||(E.width=_,E.height=v),E.ctx2d||(E.ctx2d=E.getContext("2d")),E.ctx2d.drawImage(r,0,0,S,m,0,0,_,v),r.dbrObjUrl&&URL.revokeObjectURL(r.dbrObjUrl),await this._decode_Canvas(E,u)}async _decode_Canvas(r,u){if(k._onLog&&k._onLog("_decode_Canvas(canvas:HTMLCanvasElement)"),r.crossOrigin&&r.crossOrigin!="anonymous")throw"cors";if(r.width===0||r.height===0)throw Error("The width or height of the 'canvas' is 0.");this.ifSaveOriginalImageInACanvas&&(this.oriCanvas=r,this.oriCanvasData=null);let _=(r.ctx2d||r.getContext("2d")).getImageData(0,0,r.width,r.height).data;return await this._decodeBuffer_Uint8Array(_,r.width,r.height,4*r.width,Te.IPF_ABGR_8888,u)}async _decode_Video(r,u){if(k._onLog&&k._onLog("_decode_Video(video)"),!(r instanceof HTMLVideoElement))throw TypeError("'_decode_Video(video [, config] )': Type of 'video' should be 'HTMLVideoElement'.");if(r.crossOrigin&&r.crossOrigin!="anonymous")throw"cors";u=u||{};let _,v,S=r.videoWidth,m=r.videoHeight,w=Math.max(S,m);if(w>this._maxCvsSideLength){let x=this._maxCvsSideLength/w;_=Math.round(S*x),v=Math.round(m*x)}else _=S,v=m;this.canvas||(this.canvas=document.createElement("canvas"));let E=this.canvas;return E.width===_&&E.height===v||(E.width=_,E.height=v),E.ctx2d||(E.ctx2d=E.getContext("2d")),E.ctx2d.drawImage(r,0,0,S,m,0,0,_,v),await this._decode_Canvas(E,u)}async _decode_DCEFrame(r,u){if(k._onLog&&k._onLog("_decode_DCEFrame(dceFrame)"),!k.isDCEFrame(r))return[];let _=[];this.ifSaveOriginalImageInACanvas&&(this.oriCanvas=null,this.oriCanvasData={width:r.width,height:r.height,colorMode:r.colorMode,data:new Uint8Array(r.data),toCanvas:r.toCanvas});let{width:v,height:S,colorMode:m,timeStamp:w}=r,E;E=u&&u.bCopyData?new Uint8Array(r.data):r.data;let x=null;if(u?(x=JSON.parse(JSON.stringify(u)),x.timeStamp=w):x={timeStamp:w},m==="grey")_=await this._decodeBuffer_Uint8Array(E,v,S,v,Te.IPF_GrayScaled,x);else if(m==="rgba")_=await this._decodeBuffer_Uint8Array(E,v,S,4*v,Te.IPF_ABGR_8888,x);else{if(m!=="bgra")throw new Error(`Color mode '${m}' is not supported to decode.`);_=await this._decodeBuffer_Uint8Array(E,v,S,4*v,Te.IPF_ARGB_8888,x)}return _}async _decode_DSImage(r,u){if(k._onLog&&k._onLog("_decode_DSImage(dsImage)"),!k.isDSImage(r))return null;this.ifSaveOriginalImageInACanvas&&(this.oriCanvas=null,this.oriCanvasData={width:r.width,height:r.height,pixelFormat:r.pixelFormat.toLowerCase(),data:new Uint8Array(r.data),toCanvas:function(){let x=document.createElement("canvas"),A;switch(x.width=this.width,x.height=this.height,this.pixelFormat){case"grey":A=new Uint8ClampedArray(this.width*this.height*4);for(let I=0;I<A.length;I+=4)A[I]=this.data[I/4],A[I+1]=this.data[I/4],A[I+2]=this.data[I/4],A[I+3]=255;break;case"rgb":A=new Uint8ClampedArray(this.width*this.height*4);for(let I=0;I<A.length;I+=4)A[I]=this.data[I],A[I+1]=this.data[I+1],A[I+2]=this.data[I+2],A[I+3]=255;break;case"bgr":A=new Uint8ClampedArray(this.width*this.height*4);for(let I=0;I<A.length;I+=4)A[I]=this.data[I],A[I+1]=this.data[I+1],A[I+2]=this.data[I+2],A[I+3]=255;break;case"rgba":case"bgra":A=new Uint8ClampedArray(this.data);break;default:throw new Error("The content of 2D Canvas is currently limited to the sRGB color space.")}let D=new ImageData(A,this.width,this.height);return x.getContext("2d").putImageData(D,0,0),x}});let{width:_,height:v}=r,S,m,w,E=r.pixelFormat.toLowerCase();switch(S=u&&u.bCopyData?new Uint8Array(r.data):r.data,E){case"grey":w=Te.IPF_GrayScaled,m=_;break;case"rgb":w=Te.IPF_BGR_888,m=3*_;break;case"bgr":w=Te.IPF_RGB_888,m=3*_;break;case"rgba":w=Te.IPF_ABGR_8888,m=4*_;break;case"bgra":w=Te.IPF_ARGB_8888,m=4*_;break;default:throw new Error("The pixel format is not supported to decode.")}return await this._decodeBuffer_Uint8Array(S,_,v,m,w,u)}async _decode_Base64(r,u){if(k._onLog&&k._onLog("_decode_Base64(base64Str)"),typeof r!="string")return Promise.reject("'_decode_Base64(base64Str, config)': Type of 'base64Str' should be 'string'.");r.substring(0,11)=="data:image/"&&(r=r.substring(r.indexOf(",")+1));{let _=atob(r),v=_.length,S=new Uint8Array(v);for(;v--;)S[v]=_.charCodeAt(v);return await this._decode_Blob(new Blob([S]),u)}}async _decode_Url(r,u){if(k._onLog&&k._onLog("_decode_Url(url)"),typeof r!="string")throw TypeError("'_decode_Url(url, config)': Type of 'url' should be 'string'.");r=r;{let _=await new Promise((v,S)=>{let m=new XMLHttpRequest;m.open("GET",r,!0),m.responseType="blob",m.send(),m.onloadend=async()=>{v(m.response)},m.onerror=()=>{S(new Error("Network Error: "+m.statusText))}});return await this._decode_Blob(_,u)}}async _decode_FilePath(r,u){throw k._onLog&&k._onLog("_decode_FilePath(path)"),Error("'_decode_FilePath(path, config)': The method is only supported in node environment.")}static recalculateResultLocation(r,u,_,v,S,m,w){if(r.length>0)for(let E of r){let x=E.localizationResult;x.resultCoordinateType==2&&(x.x1*=.01*m,x.x2*=.01*m,x.x3*=.01*m,x.x4*=.01*m,x.y1*=.01*w,x.y2*=.01*w,x.y3*=.01*w,x.y4*=.01*w);let A=m/v,D=w/S;x.x1=x.x1/A+u,x.x2=x.x2/A+u,x.x3=x.x3/A+u,x.x4=x.x4/A+u,x.y1=x.y1/D+_,x.y2=x.y2/D+_,x.y3=x.y3/D+_,x.y4=x.y4/D+_,x.resultCoordinateType==2&&(x.x1*=100/v,x.x2*=100/v,x.x3*=100/v,x.x4*=100/v,x.y1*=100/S,x.y2*=100/S,x.y3*=100/S,x.y4*=100/S)}}static BarcodeReaderException(r,u){let _,v=$e.DBR_UNKNOWN;return typeof r=="number"?(v=r,_=new Error(u)):_=new Error(r),_.code=v,_}_handleRetJsonString(r){let u=$e;if(r.textResults){for(let _=0;_<r.textResults.length;_++){let v=r.textResults[_];try{let S=v.barcodeText,m="";for(let w=0;w<S.length;w++)m+=String.fromCharCode(S[w]);try{v.barcodeText=decodeURIComponent(escape(m))}catch(w){v.barcodeText=m}}catch(S){v.barcodeText=""}if(v.exception!=null){k._setWarnnedEx.has(v.exception)||(k._setWarnnedEx.add(v.exception),console.warn(v.exception));let S={};v.exception.split(";").forEach(m=>{let w=m.indexOf(":");S[m.substring(0,w)]=m.substring(w+1)}),v.exception=S}}return r.decodeRecords?this.decodeRecords=r.decodeRecords:this.decodeRecords={},this._lastErrorCode=r.exception,this._lastErrorString=r.description,r.exception&&!k._setWarnnedEx.has(r.description)&&(k._setWarnnedEx.add(r.description),console.warn(r.description)),r.textResults}if(r.exception==u.DBR_SUCCESS)return r.data;throw k.BarcodeReaderException(r.exception,r.description)}async setModeArgument(r,u,_,v){return await new Promise((S,m)=>{let w=k._nextTaskID++;k._taskCallbackMap.set(w,E=>{if(E.success){try{this._handleRetJsonString(E.setReturn)}catch(x){return m(x)}return S()}{let x=new Error(E.message);return x.stack=E.stack+`
`+x.stack,m(x)}}),k._dbrWorker.postMessage({type:"setModeArgument",id:w,instanceID:this._instanceID,body:{modeName:r,index:u,argumentName:_,argumentValue:v}})})}async getModeArgument(r,u,_){return await new Promise((v,S)=>{let m=k._nextTaskID++;k._taskCallbackMap.set(m,w=>{if(w.success){let E;try{E=this._handleRetJsonString(w.getReturn)}catch(x){return S(x)}return v(E)}{let E=new Error(w.message);return E.stack=w.stack+`
`+E.stack,S(E)}}),k._dbrWorker.postMessage({type:"getModeArgument",id:m,instanceID:this._instanceID,body:{modeName:r,index:u,argumentName:_}})})}async getIntermediateResults(){return await new Promise((r,u)=>{let _=k._nextTaskID++;k._taskCallbackMap.set(_,v=>{if(v.success)return r(v.results);{let S=new Error(v.message);return S.stack=v.stack+`
`+S.stack,u(S)}}),k._dbrWorker.postMessage({type:"getIntermediateResults",id:_,instanceID:this._instanceID})})}async getIntermediateCanvas(){let r=await this.getIntermediateResults(),u=[];for(let _ of r)if(_.dataType==ot.IMRDT_IMAGE)for(let v of _.results){let S=v.bytes,m;switch(k._onLog&&k._onLog(" "+S.length+" "+S.byteLength+" "+v.width+" "+v.height+" "+v.stride+" "+v.format),v.format){case Te.IPF_ABGR_8888:m=new Uint8ClampedArray(S);break;case Te.IPF_RGB_888:{let x=S.length/3;m=new Uint8ClampedArray(4*x);for(let A=0;A<x;++A)m[4*A]=S[3*A+2],m[4*A+1]=S[3*A+1],m[4*A+2]=S[3*A],m[4*A+3]=255;break}case Te.IPF_GrayScaled:{let x=S.length;m=new Uint8ClampedArray(4*x);for(let A=0;A<x;A++)m[4*A]=m[4*A+1]=m[4*A+2]=S[A],m[4*A+3]=255;break}case Te.IPF_Binary:case Te.IPF_BinaryInverted:{v.width=8*v.stride,v.height=S.length/v.stride;let x=S.length;m=new Uint8ClampedArray(8*x*4);for(let A=0;A<x;A++){let D=S[A];for(let I=0;I<8;++I)m[4*(8*A+I)]=m[4*(8*A+I)+1]=m[4*(8*A+I)+2]=(128&D)/128*255,m[4*(8*A+I)+3]=255,D<<=1}break}default:console.warn("unknow intermediate image",v)}if(!m)continue;let w=new ImageData(m,v.width,v.height),E=document.createElement("canvas");E.width=v.width,E.height=v.height,E.getContext("2d").putImageData(w,0,0),u.push(E)}return u}async keepAlive(){k._dbrWorker.postMessage({type:"keepAlive"})}async getScanSettings(){return await new Promise((r,u)=>{let _=k._nextTaskID++;k._taskCallbackMap.set(_,v=>{if(v.success){let S=v.results;return S.intervalTime=this.intervalTime,S.whenToPlaySoundforSuccessfulRead=this.whenToPlaySoundforSuccessfulRead,S.soundOnSuccessfullRead=this.soundSource,S.whenToVibrateforSuccessfulRead=this.whenToVibrateforSuccessfulRead,S.vibrateDuration=this.vibrateDuration,S.captureAndDecodeInParallel=this.captureAndDecodeInParallel,r(S)}{let S=new Error(v.message);return S.stack+=`
`+v.stack,u(S)}}),k._dbrWorker.postMessage({type:"getScanSettings",id:_,instanceID:this._instanceID})})}async updateScanSettings(r){if(!r)return;let u=JSON.parse(JSON.stringify(r));return u.hasOwnProperty("intervalTime")&&(this.intervalTime=Math.max(u.intervalTime,0),delete u.intervalTime),u.hasOwnProperty("whenToPlaySoundforSuccessfulRead")&&(this.whenToPlaySoundforSuccessfulRead=u.whenToPlaySoundforSuccessfulRead,delete u.whenToPlaySoundforSuccessfulRead),u.hasOwnProperty("soundOnSuccessfullRead")&&(this.soundSource=u.soundOnSuccessfullRead,delete u.soundOnSuccessfullRead),u.hasOwnProperty("whenToVibrateforSuccessfulRead")&&(this.whenToVibrateforSuccessfulRead=u.whenToVibrateforSuccessfulRead,delete u.whenToVibrateforSuccessfulRead),u.hasOwnProperty("vibrateDuration")&&(this.vibrateDuration=u.vibrateDuration,delete u.vibrateDuration),u.hasOwnProperty("captureAndDecodeInParallel")&&(this.captureAndDecodeInParallel=u.captureAndDecodeInParallel,delete u.captureAndDecodeInParallel),await new Promise((_,v)=>{let S=k._nextTaskID++;k._taskCallbackMap.set(S,m=>{if(m.success)return _();{let w=new Error(m.message);return w.stack+=`
`+m.stack,v(w)}}),k._dbrWorker.postMessage({type:"updateScanSettings",id:S,instanceID:this._instanceID,body:{settings:u}})})}_cloneDecodeResults(r){if(r instanceof Array){let u=[];for(let _ of r)u.push(this._cloneDecodeResults(_));return u}{let u=r;return JSON.parse(JSON.stringify(u,(v,S)=>v=="oriVideoCanvas"||v=="searchRegionCanvas"?void 0:S))}}async _loopReadVideo(){if(this.bDestroyed)return this.dce&&this._dceControler&&this._dceControler.setDisiredAction(this,"stopFetchingLoop"),void this._drawResults(null);if(this.dce&&!this.dce.isOpen())return this._drawResults(null),void await this.clearMapDecodeRecord();if(!this.dce&&!this._imgSource||this._bPauseScan)return k._onLog&&k._onLog("Scan is paused, or imageSource is not set. Ask in 1s."),await this.clearMapDecodeRecord(),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),void(this._loopReadVideoTimeoutId=setTimeout(()=>{this._loopReadVideo()},this._intervalDetectVideoPause));k._onLog&&k._onLog("======= once read ======="),k._onLog&&(this._timeStartDecode=Date.now());let r=null,u=null;if(this.dce)r=this._getVideoFrame();else if(this._imgSource&&(u=await this._imgSource.getImage(),!k.isDSImage(u)))throw new Error("Invalid DSImage.");if(!r&&!u)return k._onLog&&k._onLog("Get invalid frame."),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),void(this._loopReadVideoTimeoutId=setTimeout(()=>{this._loopReadVideo()},0));(async()=>{let _=[];if(r){_=await this._decode_DCEFrame(r,{bScanner:!0,bCopyData:!1});let v=null;if(_&&_.length){let{sx:S,sy:m,width:w,height:E,_sWidth:x,_sHeight:A}=r;v=_.map(D=>({resultState:D.resultState,localizationResult:JSON.parse(JSON.stringify(D.localizationResult))})),k.recalculateResultLocation(v,S,m,x,A,w,E)}this._drawResults(v)}else u&&(_=await this._decode_DSImage(u,{bScanner:!0,bCopyData:!1}));return _})().then(_=>{if(k._onLog&&k._onLog(_),this.dce&&this.captureAndDecodeInParallel){let v=this.array_decodeFrameTimeCost,S=this.array_getFrameTimeCost,m=()=>{let w=0;if(S&&S.length){let E=Math.min(...v),x=Math.max(...S);E&&x&&(w=E-x)}else w=0;return w>0?w:0};(()=>{for(;v.length>=5;)v.shift();v.push(this._lastInnerDecodeDuration)})(),this._intervalGetVideoFrame=m()+this.intervalTime}if((this.dce&&this.dce.isOpen()||this._imgSource)&&!this._bPauseScan){if(this.bPlaySoundOnSuccessfulRead&&_.length){let v=!1;this.bPlaySoundOnSuccessfulRead===!0||this.bPlaySoundOnSuccessfulRead==="frame"?v=!0:this.bPlaySoundOnSuccessfulRead==="unique"&&(v=_.some(S=>S.resultState===0)),v&&(this.beepSound.stop(),this.beepSound.play())}if(navigator.vibrate&&this.bVibrateOnSuccessfulRead&&_.length){let v=!1;if(this.bVibrateOnSuccessfulRead===!0||this.bVibrateOnSuccessfulRead==="frame"?v=!0:this.bVibrateOnSuccessfulRead==="unique"&&(v=_.some(S=>S.resultState===0)),v)try{navigator.vibrate(this.vibrateDuration)}catch(S){console.warn("Vibration not allowed. User interaction required: "+(S.message||S))}}if(this.onImageRead){_=_.filter(S=>S.resultState>=0);let v=this._cloneDecodeResults(_);this.onImageRead(v)}if(this.onUniqueRead){_=_.filter(S=>S.resultState==0);let v=this._cloneDecodeResults(_);for(let S of v)this.onUniqueRead(S.barcodeText,S)}}this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this.intervalTime?this._loopReadVideoTimeoutId=setTimeout(()=>{this._loopReadVideo()},this.intervalTime):this._loopReadVideo()}).catch(_=>{this.dce&&this._dceControler&&this._dceControler.setDisiredAction(this,"stopFetchingLoop"),k._onLog&&k._onLog(_.message||_),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout(()=>{this.dce&&(this.dce.startFetchingLoop(),this._dceControler&&this._dceControler.clearUserDisiredAction({user:this,actionName:"stopFetchingLoop"})),this._loopReadVideo()},Math.max(this.intervalTime,1e3)),_.message=="platform error"||console.warn(_.message)})}_getVideoFrame(){if(!this.dce)return null;let r;if(this.captureAndDecodeInParallel){if(k._onLog&&k._onLog("Get frame in parallel."),this._dceControler&&this._dceControler.setDisiredValue(this,"loopInterval",this._intervalGetVideoFrame),!this.dce.numberOfFramesInBuffer)return this._dceControler&&this._dceControler.setDisiredValue(this,"loopInterval",0),null;r=this.dce.getFrameFromBuffer(),(_=>{if(!_)return;let v=_.timeSpent,S=this.array_getFrameTimeCost;for(;S.length>=5;)S.shift();S.push(v)})(r)}else k._onLog&&k._onLog("Get frame in serial."),this._dceControler&&this._dceControler.setDisiredAction(this,"stopFetchingLoop"),r=this.dce.getFrame();return r}_drawResults(r){if(!this.dce||this._bPauseScan||!this._drawingItemNamespace||!this._drawingItemNamespace.DT_Polygon)return;if(!this._dbrDrawingLayer){if(!this.dce.isOpen())return;this._dbrDrawingLayer=this.dce.getDrawingLayer(3)}let u=this._dbrDrawingLayer;r||(r=[]);let _=this._arrPolygons;for(let v=0;v<r.length;v++){let S,m=r[v].localizationResult;_[v]?(S=_[v],u.hasDrawingItem(S)||u.addDrawingItem(S),S.set("vertices",[{x:m.x1,y:m.y1},{x:m.x2,y:m.y2},{x:m.x3,y:m.y3},{x:m.x4,y:m.y4}])):(S=new this._drawingItemNamespace.DT_Polygon([{x:m.x1,y:m.y1},{x:m.x2,y:m.y2},{x:m.x3,y:m.y3},{x:m.x4,y:m.y4}]),u.addDrawingItem(S),_[v]=S),r[v].resultState===-1?(S.styleId=this._styleIdBeforeVerification,S._mapStyle.set("default",this.dce.getDrawingStyle(this._styleIdBeforeVerification)),S._mapStyle.set("selected",this.dce.getDrawingStyle(this._styleIdBeforeVerification))):(S.styleId=null,S._mapStyle.set("default",this.dce.getDrawingStyle(3)),S._mapStyle.set("selected",this.dce.getDrawingStyle(7))),S.tag=r[v]}for(let v=r.length;v<_.length;v++)u.removeDrawingItem(_[v]);u.renderAll()}async startScanning(r){if(!this.dce&&!this._imgSource)throw new Error("'imageSource' is not set. call 'setImageSource()' before 'startScanning()'.");if(this._tempSolutionStatus!="closed"||(this._tempSolutionStatus="opening",this._tempSolutionStatus!="opening"))return;let u=null;return this.dce&&(this.dce.isOpen()?(r&&this.dce.appendAndShowUI(),u=JSON.parse(JSON.stringify(this.dce.playCallbackInfo))):u=await this.dce.open(r),this._dceControler&&(this._dceControler.clearUserDisiredAction({user:this,actionName:"close"}),this._dceControler.clearUserDisiredValue({property:"ifShowScanRegionLaser"}),this._dceControler.setDisiredValue(this,"ifShowScanRegionLaser",!0),this.dce.ifShowScanRegionLaser&&this.dce.showScanRegionLaser())),this._tempSolutionStatus=="opening"?(this._bPauseScan=!1,this.dce&&this.dce.singleFrameMode||(this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout(()=>{this.dce&&(this.dce.startFetchingLoop(),this._dceControler&&this._dceControler.clearUserDisiredAction({user:this,actionName:"stopFetchingLoop"})),this._loopReadVideo()},0)),this._tempSolutionStatus="opened",this.keepAlive(),u):void 0}stopScanning(r){this.dce&&(this._drawResults(null),this._dceControler&&(this._dceControler.setDisiredValue(this,"ifShowScanRegionLaser",!1),this.dce.ifShowScanRegionLaser||this.dce.hideScanRegionLaser(),this._dceControler.setDisiredAction(this,"close",[r]))),this._bPauseScan=!0,this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0,this._tempSolutionStatus="closed"}pauseScanning(r){if(r&&r.keepResultsHighlighted||this._drawResults(null),this._bPauseScan=!0,this.dce){if(this.dce.singleFrameMode)throw new Error("'pauseScanning()' is unavailable when property 'singleFrameMode' of the 'CameraEnhancer' instance is true.");this._dceControler&&(this._dceControler.setDisiredValue(this,"ifShowScanRegionLaser",!1),this.dce.ifShowScanRegionLaser||this.dce.hideScanRegionLaser(),this._dceControler.setDisiredAction(this,"stopFetchingLoop"))}}resumeScanning(){if(this._bPauseScan=!1,this.dce){if(this.dce.singleFrameMode)throw new Error("'resumeScanning()' is unavailable when property 'singleFrameMode' of the 'CameraEnhancer' instance is true.");this.dce.startFetchingLoop(),this._dceControler&&(this._dceControler.clearUserDisiredAction({user:this,actionName:"stopFetchingLoop"}),this._dceControler.clearUserDisiredValue({property:"ifShowScanRegionLaser"}),this._dceControler.setDisiredValue(this,"ifShowScanRegionLaser",!0),this.dce.ifShowScanRegionLaser&&this.dce.showScanRegionLaser())}}destroyContext(){if(k._onLog&&k._onLog("destroyContext()"),this.bDestroyed)return;this.bDestroyed=!0,(this.dce||this._tempSolutionStatus==="opening")&&this.stopScanning(),this.setImageSource(null);let r=k._nextTaskID++;k._taskCallbackMap.set(r,u=>{if(!u.success){let _=new Error(u.message);throw _.stack=u.stack+`
`+_.stack,_}}),k._dbrWorker.postMessage({type:"destroyContext",id:r,instanceID:this._instanceID})}};k._jsVersion="9.3.1",k._jsEditVersion="20220930",k._version=`loading...(JS ${k._jsVersion}.${k._jsEditVersion})`,k._license=di,k._sessionPassword=fi,k.browserInfo=we,k._workerName=`dbr-${k._jsVersion}.browser.worker.js`,k._engineResourcePath=ui,k._licenseServer=[],k._deviceFriendlyName="",k._isShowRelDecodeTimeInResults=!1,k._bWasmDebug=!1,k._bNeverShowDialog=!1,k.__bUseFullFeature=!0,k._nextTaskID=0,k._taskCallbackMap=new Map,k._pLoad=new class extends Promise{constructor(a){let r,u;super((_,v)=>{r=_,u=v}),this._s="pending",this.resolve=_=>{this.isPending&&(dt(_)?this.task=_:(this._s="fulfilled",r(_)))},this.reject=_=>{this.isPending&&(this._s="rejected",u(_))},this.task=a}get status(){return this._s}get isPending(){return this._s==="pending"}get isFulfilled(){return this._s==="fulfilled"}get isRejected(){return this._s==="rejected"}get task(){return this._task}set task(a){let r;this._task=a,dt(a)?r=a:typeof a=="function"&&(r=new Promise(a)),r&&(async()=>{try{let u=await r;a===this._task&&this.resolve(u)}catch(u){a===this._task&&this.reject(u)}})()}get isEmpty(){return this._task==null}},k._lastErrorCode=0,k._lastErrorString="",k._setWarnnedEx=new Set,k._defaultUIElementURL="@engineResourcePath/dbr.ui.html";var gi={653:(a,r,u)=>{var _,v,S,m,w,E,x,A,D,I,z,se,ee,q,te,ce,K,Q,fe,J,le,g=g||{version:"5.2.1"};if(r.fabric=g,typeof document!="undefined"&&typeof window!="undefined")document instanceof(typeof HTMLDocument!="undefined"?HTMLDocument:Document)?g.document=document:g.document=document.implementation.createHTMLDocument(""),g.window=window;else{var pe=new(u(192)).JSDOM(decodeURIComponent("%3C!DOCTYPE%20html%3E%3Chtml%3E%3Chead%3E%3C%2Fhead%3E%3Cbody%3E%3C%2Fbody%3E%3C%2Fhtml%3E"),{features:{FetchExternalResources:["img"]},resources:"usable"}).window;g.document=pe.document,g.jsdomImplForWrapper=u(898).implForWrapper,g.nodeCanvas=u(245).Canvas,g.window=pe,DOMParser=g.window.DOMParser}function re(n,i){var s=n.canvas,l=i.targetCanvas,e=l.getContext("2d");e.translate(0,l.height),e.scale(1,-1);var t=s.height-l.height;e.drawImage(s,0,t,l.width,l.height,0,0,l.width,l.height)}function ne(n,i){var s=i.targetCanvas.getContext("2d"),l=i.destinationWidth,e=i.destinationHeight,t=l*e*4,o=new Uint8Array(this.imageBuffer,0,t),d=new Uint8ClampedArray(this.imageBuffer,0,t);n.readPixels(0,0,l,e,n.RGBA,n.UNSIGNED_BYTE,o);var h=new ImageData(d,l,e);s.putImageData(h,0,0)}g.isTouchSupported="ontouchstart"in g.window||"ontouchstart"in g.document||g.window&&g.window.navigator&&g.window.navigator.maxTouchPoints>0,g.isLikelyNode=typeof Buffer!="undefined"&&typeof window=="undefined",g.SHARED_ATTRIBUTES=["display","transform","fill","fill-opacity","fill-rule","opacity","stroke","stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"],g.DPI=96,g.reNum="(?:[-+]?(?:\\d+|\\d*\\.\\d+)(?:[eE][-+]?\\d+)?)",g.commaWsp="(?:\\s+,?\\s*|,\\s*)",g.rePathCommand=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:[eE][-+]?\d+)?)/gi,g.reNonWord=/[ \n\.,;!\?\-]/,g.fontPaths={},g.iMatrix=[1,0,0,1,0,0],g.svgNS="http://www.w3.org/2000/svg",g.perfLimitSizeTotal=2097152,g.maxCacheSideLimit=4096,g.minCacheSideLimit=256,g.charWidthsCache={},g.textureSize=2048,g.disableStyleCopyPaste=!1,g.enableGLFiltering=!0,g.devicePixelRatio=g.window.devicePixelRatio||g.window.webkitDevicePixelRatio||g.window.mozDevicePixelRatio||1,g.browserShadowBlurConstant=1,g.arcToSegmentsCache={},g.boundsOfCurveCache={},g.cachesBoundsOfCurve=!0,g.forceGLPutImageData=!1,g.initFilterBackend=function(){return g.enableGLFiltering&&g.isWebglSupported&&g.isWebglSupported(g.textureSize)?(console.log("max texture size: "+g.maxTextureSize),new g.WebglFilterBackend({tileSize:g.textureSize})):g.Canvas2dFilterBackend?new g.Canvas2dFilterBackend:void 0},typeof document!="undefined"&&typeof window!="undefined"&&(window.fabric=g),function(){function n(s,l){if(this.__eventListeners[s]){var e=this.__eventListeners[s];l?e[e.indexOf(l)]=!1:g.util.array.fill(e,!1)}}function i(s,l){var e=function(){l.apply(this,arguments),this.off(s,e)}.bind(this);this.on(s,e)}g.Observable={fire:function(s,l){if(!this.__eventListeners)return this;var e=this.__eventListeners[s];if(!e)return this;for(var t=0,o=e.length;t<o;t++)e[t]&&e[t].call(this,l||{});return this.__eventListeners[s]=e.filter(function(d){return d!==!1}),this},on:function(s,l){if(this.__eventListeners||(this.__eventListeners={}),arguments.length===1)for(var e in s)this.on(e,s[e]);else this.__eventListeners[s]||(this.__eventListeners[s]=[]),this.__eventListeners[s].push(l);return this},once:function(s,l){if(arguments.length===1)for(var e in s)i.call(this,e,s[e]);else i.call(this,s,l);return this},off:function(s,l){if(!this.__eventListeners)return this;if(arguments.length===0)for(s in this.__eventListeners)n.call(this,s);else if(arguments.length===1&&typeof arguments[0]=="object")for(var e in s)n.call(this,e,s[e]);else n.call(this,s,l);return this}}}(),g.Collection={_objects:[],add:function(){if(this._objects.push.apply(this._objects,arguments),this._onObjectAdded)for(var n=0,i=arguments.length;n<i;n++)this._onObjectAdded(arguments[n]);return this.renderOnAddRemove&&this.requestRenderAll(),this},insertAt:function(n,i,s){var l=this._objects;return s?l[i]=n:l.splice(i,0,n),this._onObjectAdded&&this._onObjectAdded(n),this.renderOnAddRemove&&this.requestRenderAll(),this},remove:function(){for(var n,i=this._objects,s=!1,l=0,e=arguments.length;l<e;l++)(n=i.indexOf(arguments[l]))!==-1&&(s=!0,i.splice(n,1),this._onObjectRemoved&&this._onObjectRemoved(arguments[l]));return this.renderOnAddRemove&&s&&this.requestRenderAll(),this},forEachObject:function(n,i){for(var s=this.getObjects(),l=0,e=s.length;l<e;l++)n.call(i,s[l],l,s);return this},getObjects:function(n){return n===void 0?this._objects.concat():this._objects.filter(function(i){return i.type===n})},item:function(n){return this._objects[n]},isEmpty:function(){return this._objects.length===0},size:function(){return this._objects.length},contains:function(n,i){return this._objects.indexOf(n)>-1||!!i&&this._objects.some(function(s){return typeof s.contains=="function"&&s.contains(n,!0)})},complexity:function(){return this._objects.reduce(function(n,i){return n+(i.complexity?i.complexity():0)},0)}},g.CommonMethods={_setOptions:function(n){for(var i in n)this.set(i,n[i])},_initGradient:function(n,i){!n||!n.colorStops||n instanceof g.Gradient||this.set(i,new g.Gradient(n))},_initPattern:function(n,i,s){!n||!n.source||n instanceof g.Pattern?s&&s():this.set(i,new g.Pattern(n,s))},_setObject:function(n){for(var i in n)this._set(i,n[i])},set:function(n,i){return typeof n=="object"?this._setObject(n):this._set(n,i),this},_set:function(n,i){this[n]=i},toggle:function(n){var i=this.get(n);return typeof i=="boolean"&&this.set(n,!i),this},get:function(n){return this[n]}},_=r,v=Math.sqrt,S=Math.atan2,m=Math.pow,w=Math.PI/180,E=Math.PI/2,g.util={cos:function(n){if(n===0)return 1;switch(n<0&&(n=-n),n/E){case 1:case 3:return 0;case 2:return-1}return Math.cos(n)},sin:function(n){if(n===0)return 0;var i=1;switch(n<0&&(i=-1),n/E){case 1:return i;case 2:return 0;case 3:return-i}return Math.sin(n)},removeFromArray:function(n,i){var s=n.indexOf(i);return s!==-1&&n.splice(s,1),n},getRandomInt:function(n,i){return Math.floor(Math.random()*(i-n+1))+n},degreesToRadians:function(n){return n*w},radiansToDegrees:function(n){return n/w},rotatePoint:function(n,i,s){var l=new g.Point(n.x-i.x,n.y-i.y),e=g.util.rotateVector(l,s);return new g.Point(e.x,e.y).addEquals(i)},rotateVector:function(n,i){var s=g.util.sin(i),l=g.util.cos(i);return{x:n.x*l-n.y*s,y:n.x*s+n.y*l}},createVector:function(n,i){return new g.Point(i.x-n.x,i.y-n.y)},calcAngleBetweenVectors:function(n,i){return Math.acos((n.x*i.x+n.y*i.y)/(Math.hypot(n.x,n.y)*Math.hypot(i.x,i.y)))},getHatVector:function(n){return new g.Point(n.x,n.y).multiply(1/Math.hypot(n.x,n.y))},getBisector:function(n,i,s){var l=g.util.createVector(n,i),e=g.util.createVector(n,s),t=g.util.calcAngleBetweenVectors(l,e),o=t*(g.util.calcAngleBetweenVectors(g.util.rotateVector(l,t),e)===0?1:-1)/2;return{vector:g.util.getHatVector(g.util.rotateVector(l,o)),angle:t}},projectStrokeOnPoints:function(n,i,s){var l=[],e=i.strokeWidth/2,t=i.strokeUniform?new g.Point(1/i.scaleX,1/i.scaleY):new g.Point(1,1),o=function(d){var h=e/Math.hypot(d.x,d.y);return new g.Point(d.x*h*t.x,d.y*h*t.y)};return n.length<=1||n.forEach(function(d,h){var c,f,p=new g.Point(d.x,d.y);h===0?(f=n[h+1],c=s?o(g.util.createVector(f,p)).addEquals(p):n[n.length-1]):h===n.length-1?(c=n[h-1],f=s?o(g.util.createVector(c,p)).addEquals(p):n[0]):(c=n[h-1],f=n[h+1]);var y,b,C=g.util.getBisector(p,c,f),T=C.vector,O=C.angle;if(i.strokeLineJoin==="miter"&&(y=-e/Math.sin(O/2),b=new g.Point(T.x*y*t.x,T.y*y*t.y),Math.hypot(b.x,b.y)/e<=i.strokeMiterLimit))return l.push(p.add(b)),void l.push(p.subtract(b));y=-e*Math.SQRT2,b=new g.Point(T.x*y*t.x,T.y*y*t.y),l.push(p.add(b)),l.push(p.subtract(b))}),l},transformPoint:function(n,i,s){return s?new g.Point(i[0]*n.x+i[2]*n.y,i[1]*n.x+i[3]*n.y):new g.Point(i[0]*n.x+i[2]*n.y+i[4],i[1]*n.x+i[3]*n.y+i[5])},makeBoundingBoxFromPoints:function(n,i){if(i)for(var s=0;s<n.length;s++)n[s]=g.util.transformPoint(n[s],i);var l=[n[0].x,n[1].x,n[2].x,n[3].x],e=g.util.array.min(l),t=g.util.array.max(l)-e,o=[n[0].y,n[1].y,n[2].y,n[3].y],d=g.util.array.min(o);return{left:e,top:d,width:t,height:g.util.array.max(o)-d}},invertTransform:function(n){var i=1/(n[0]*n[3]-n[1]*n[2]),s=[i*n[3],-i*n[1],-i*n[2],i*n[0]],l=g.util.transformPoint({x:n[4],y:n[5]},s,!0);return s[4]=-l.x,s[5]=-l.y,s},toFixed:function(n,i){return parseFloat(Number(n).toFixed(i))},parseUnit:function(n,i){var s=/\D{0,2}$/.exec(n),l=parseFloat(n);switch(i||(i=g.Text.DEFAULT_SVG_FONT_SIZE),s[0]){case"mm":return l*g.DPI/25.4;case"cm":return l*g.DPI/2.54;case"in":return l*g.DPI;case"pt":return l*g.DPI/72;case"pc":return l*g.DPI/72*12;case"em":return l*i;default:return l}},falseFunction:function(){return!1},getKlass:function(n,i){return n=g.util.string.camelize(n.charAt(0).toUpperCase()+n.slice(1)),g.util.resolveNamespace(i)[n]},getSvgAttributes:function(n){var i=["instantiated_by_use","style","id","class"];switch(n){case"linearGradient":i=i.concat(["x1","y1","x2","y2","gradientUnits","gradientTransform"]);break;case"radialGradient":i=i.concat(["gradientUnits","gradientTransform","cx","cy","r","fx","fy","fr"]);break;case"stop":i=i.concat(["offset","stop-color","stop-opacity"])}return i},resolveNamespace:function(n){if(!n)return g;var i,s=n.split("."),l=s.length,e=_||g.window;for(i=0;i<l;++i)e=e[s[i]];return e},loadImage:function(n,i,s,l){if(n){var e=g.util.createImage(),t=function(){i&&i.call(s,e,!1),e=e.onload=e.onerror=null};e.onload=t,e.onerror=function(){g.log("Error loading "+e.src),i&&i.call(s,null,!0),e=e.onload=e.onerror=null},n.indexOf("data")!==0&&l!=null&&(e.crossOrigin=l),n.substring(0,14)==="data:image/svg"&&(e.onload=null,g.util.loadImageInDom(e,t)),e.src=n}else i&&i.call(s,n)},loadImageInDom:function(n,i){var s=g.document.createElement("div");s.style.width=s.style.height="1px",s.style.left=s.style.top="-100%",s.style.position="absolute",s.appendChild(n),g.document.querySelector("body").appendChild(s),n.onload=function(){i(),s.parentNode.removeChild(s),s=null}},enlivenObjects:function(n,i,s,l){var e=[],t=0,o=(n=n||[]).length;function d(){++t===o&&i&&i(e.filter(function(h){return h}))}o?n.forEach(function(h,c){h&&h.type?g.util.getKlass(h.type,s).fromObject(h,function(f,p){p||(e[c]=f),l&&l(h,f,p),d()}):d()}):i&&i(e)},enlivenObjectEnlivables:function(n,i,s){var l=g.Object.ENLIVEN_PROPS.filter(function(e){return!!n[e]});g.util.enlivenObjects(l.map(function(e){return n[e]}),function(e){var t={};l.forEach(function(o,d){t[o]=e[d],i&&(i[o]=e[d])}),s&&s(t)})},enlivenPatterns:function(n,i){function s(){++e===t&&i&&i(l)}var l=[],e=0,t=(n=n||[]).length;t?n.forEach(function(o,d){o&&o.source?new g.Pattern(o,function(h){l[d]=h,s()}):(l[d]=o,s())}):i&&i(l)},groupSVGElements:function(n,i,s){var l;return n&&n.length===1?n[0]:(i&&(i.width&&i.height?i.centerPoint={x:i.width/2,y:i.height/2}:(delete i.width,delete i.height)),l=new g.Group(n,i),s!==void 0&&(l.sourcePath=s),l)},populateWithProperties:function(n,i,s){if(s&&Array.isArray(s))for(var l=0,e=s.length;l<e;l++)s[l]in n&&(i[s[l]]=n[s[l]])},createCanvasElement:function(){return g.document.createElement("canvas")},copyCanvasElement:function(n){var i=g.util.createCanvasElement();return i.width=n.width,i.height=n.height,i.getContext("2d").drawImage(n,0,0),i},toDataURL:function(n,i,s){return n.toDataURL("image/"+i,s)},createImage:function(){return g.document.createElement("img")},multiplyTransformMatrices:function(n,i,s){return[n[0]*i[0]+n[2]*i[1],n[1]*i[0]+n[3]*i[1],n[0]*i[2]+n[2]*i[3],n[1]*i[2]+n[3]*i[3],s?0:n[0]*i[4]+n[2]*i[5]+n[4],s?0:n[1]*i[4]+n[3]*i[5]+n[5]]},qrDecompose:function(n){var i=S(n[1],n[0]),s=m(n[0],2)+m(n[1],2),l=v(s),e=(n[0]*n[3]-n[2]*n[1])/l,t=S(n[0]*n[2]+n[1]*n[3],s);return{angle:i/w,scaleX:l,scaleY:e,skewX:t/w,skewY:0,translateX:n[4],translateY:n[5]}},calcRotateMatrix:function(n){if(!n.angle)return g.iMatrix.concat();var i=g.util.degreesToRadians(n.angle),s=g.util.cos(i),l=g.util.sin(i);return[s,l,-l,s,0,0]},calcDimensionsMatrix:function(n){var i=n.scaleX===void 0?1:n.scaleX,s=n.scaleY===void 0?1:n.scaleY,l=[n.flipX?-i:i,0,0,n.flipY?-s:s,0,0],e=g.util.multiplyTransformMatrices,t=g.util.degreesToRadians;return n.skewX&&(l=e(l,[1,0,Math.tan(t(n.skewX)),1],!0)),n.skewY&&(l=e(l,[1,Math.tan(t(n.skewY)),0,1],!0)),l},composeMatrix:function(n){var i=[1,0,0,1,n.translateX||0,n.translateY||0],s=g.util.multiplyTransformMatrices;return n.angle&&(i=s(i,g.util.calcRotateMatrix(n))),(n.scaleX!==1||n.scaleY!==1||n.skewX||n.skewY||n.flipX||n.flipY)&&(i=s(i,g.util.calcDimensionsMatrix(n))),i},resetObjectTransform:function(n){n.scaleX=1,n.scaleY=1,n.skewX=0,n.skewY=0,n.flipX=!1,n.flipY=!1,n.rotate(0)},saveObjectTransform:function(n){return{scaleX:n.scaleX,scaleY:n.scaleY,skewX:n.skewX,skewY:n.skewY,angle:n.angle,left:n.left,flipX:n.flipX,flipY:n.flipY,top:n.top}},isTransparent:function(n,i,s,l){l>0&&(i>l?i-=l:i=0,s>l?s-=l:s=0);var e,t=!0,o=n.getImageData(i,s,2*l||1,2*l||1),d=o.data.length;for(e=3;e<d&&(t=o.data[e]<=0)!=0;e+=4);return o=null,t},parsePreserveAspectRatioAttribute:function(n){var i,s="meet",l=n.split(" ");return l&&l.length&&((s=l.pop())!=="meet"&&s!=="slice"?(i=s,s="meet"):l.length&&(i=l.pop())),{meetOrSlice:s,alignX:i!=="none"?i.slice(1,4):"none",alignY:i!=="none"?i.slice(5,8):"none"}},clearFabricFontCache:function(n){(n=(n||"").toLowerCase())?g.charWidthsCache[n]&&delete g.charWidthsCache[n]:g.charWidthsCache={}},limitDimsByArea:function(n,i){var s=Math.sqrt(i*n),l=Math.floor(i/s);return{x:Math.floor(s),y:l}},capValue:function(n,i,s){return Math.max(n,Math.min(i,s))},findScaleToFit:function(n,i){return Math.min(i.width/n.width,i.height/n.height)},findScaleToCover:function(n,i){return Math.max(i.width/n.width,i.height/n.height)},matrixToSVG:function(n){return"matrix("+n.map(function(i){return g.util.toFixed(i,g.Object.NUM_FRACTION_DIGITS)}).join(" ")+")"},removeTransformFromObject:function(n,i){var s=g.util.invertTransform(i),l=g.util.multiplyTransformMatrices(s,n.calcOwnMatrix());g.util.applyTransformToObject(n,l)},addTransformToObject:function(n,i){g.util.applyTransformToObject(n,g.util.multiplyTransformMatrices(i,n.calcOwnMatrix()))},applyTransformToObject:function(n,i){var s=g.util.qrDecompose(i),l=new g.Point(s.translateX,s.translateY);n.flipX=!1,n.flipY=!1,n.set("scaleX",s.scaleX),n.set("scaleY",s.scaleY),n.skewX=s.skewX,n.skewY=s.skewY,n.angle=s.angle,n.setPositionByOrigin(l,"center","center")},sizeAfterTransform:function(n,i,s){var l=n/2,e=i/2,t=[{x:-l,y:-e},{x:l,y:-e},{x:-l,y:e},{x:l,y:e}],o=g.util.calcDimensionsMatrix(s),d=g.util.makeBoundingBoxFromPoints(t,o);return{x:d.width,y:d.height}},mergeClipPaths:function(n,i){var s=n,l=i;s.inverted&&!l.inverted&&(s=i,l=n),g.util.applyTransformToObject(l,g.util.multiplyTransformMatrices(g.util.invertTransform(s.calcTransformMatrix()),l.calcTransformMatrix()));var e=s.inverted&&l.inverted;return e&&(s.inverted=l.inverted=!1),new g.Group([s],{clipPath:l,inverted:e})}},function(){var n=Array.prototype.join,i={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},s={m:"l",M:"L"};function l(b,C,T,O,F,B,H,U,V,L,R){var N=g.util.cos(b),W=g.util.sin(b),Y=g.util.cos(C),P=g.util.sin(C),M=T*F*Y-O*B*P+H,j=O*F*Y+T*B*P+U;return["C",L+V*(-T*F*W-O*B*N),R+V*(-O*F*W+T*B*N),M+V*(T*F*P+O*B*Y),j+V*(O*F*P-T*B*Y),M,j]}function e(b,C,T,O){var F=Math.atan2(C,b),B=Math.atan2(O,T);return B>=F?B-F:2*Math.PI-(F-B)}function t(b,C,T){for(var O=T[1],F=T[2],B=T[3],H=T[4],U=T[5],V=function(N,W,Y,P,M,j,X){var G=Math.PI,Z=X*G/180,de=g.util.sin(Z),oe=g.util.cos(Z),ie=0,ue=0,he=-oe*N*.5-de*W*.5,ge=-oe*W*.5+de*N*.5,me=(Y=Math.abs(Y))*Y,_e=(P=Math.abs(P))*P,ve=ge*ge,Se=he*he,Ie=me*_e-me*ve-_e*Se,Re=0;if(Ie<0){var ke=Math.sqrt(1-Ie/(me*_e));Y*=ke,P*=ke}else Re=(M===j?-1:1)*Math.sqrt(Ie/(me*ve+_e*Se));var Ce=Re*Y*ge/P,Oe=-Re*P*he/Y,Ge=oe*Ce-de*Oe+.5*N,Be=de*Ce+oe*Oe+.5*W,Le=e(1,0,(he-Ce)/Y,(ge-Oe)/P),Ne=e((he-Ce)/Y,(ge-Oe)/P,(-he-Ce)/Y,(-ge-Oe)/P);j===0&&Ne>0?Ne-=2*G:j===1&&Ne<0&&(Ne+=2*G);for(var at=Math.ceil(Math.abs(Ne/G*2)),ze=[],We=Ne/at,Kt=8/3*Math.sin(We/4)*Math.sin(We/4)/Math.sin(We/2),nt=Le+We,He=0;He<at;He++)ze[He]=l(Le,nt,oe,de,Y,P,Ge,Be,Kt,ie,ue),ie=ze[He][5],ue=ze[He][6],Le=nt,nt+=We;return ze}(T[6]-b,T[7]-C,O,F,H,U,B),L=0,R=V.length;L<R;L++)V[L][1]+=b,V[L][2]+=C,V[L][3]+=b,V[L][4]+=C,V[L][5]+=b,V[L][6]+=C;return V}function o(b,C,T,O){return Math.sqrt((T-b)*(T-b)+(O-C)*(O-C))}function d(b,C,T,O,F,B,H,U){return function(V){var L,R=(L=V)*L*L,N=function(P){return 3*P*P*(1-P)}(V),W=function(P){return 3*P*(1-P)*(1-P)}(V),Y=function(P){return(1-P)*(1-P)*(1-P)}(V);return{x:H*R+F*N+T*W+b*Y,y:U*R+B*N+O*W+C*Y}}}function h(b,C,T,O,F,B,H,U){return function(V){var L=1-V,R=3*L*L*(T-b)+6*L*V*(F-T)+3*V*V*(H-F),N=3*L*L*(O-C)+6*L*V*(B-O)+3*V*V*(U-B);return Math.atan2(N,R)}}function c(b,C,T,O,F,B){return function(H){var U,V=(U=H)*U,L=function(N){return 2*N*(1-N)}(H),R=function(N){return(1-N)*(1-N)}(H);return{x:F*V+T*L+b*R,y:B*V+O*L+C*R}}}function f(b,C,T,O,F,B){return function(H){var U=1-H,V=2*U*(T-b)+2*H*(F-T),L=2*U*(O-C)+2*H*(B-O);return Math.atan2(L,V)}}function p(b,C,T){var O,F,B={x:C,y:T},H=0;for(F=1;F<=100;F+=1)O=b(F/100),H+=o(B.x,B.y,O.x,O.y),B=O;return H}function y(b){for(var C,T,O,F,B=0,H=b.length,U=0,V=0,L=0,R=0,N=[],W=0;W<H;W++){switch(O={x:U,y:V,command:(C=b[W])[0]},C[0]){case"M":O.length=0,L=U=C[1],R=V=C[2];break;case"L":O.length=o(U,V,C[1],C[2]),U=C[1],V=C[2];break;case"C":T=d(U,V,C[1],C[2],C[3],C[4],C[5],C[6]),F=h(U,V,C[1],C[2],C[3],C[4],C[5],C[6]),O.iterator=T,O.angleFinder=F,O.length=p(T,U,V),U=C[5],V=C[6];break;case"Q":T=c(U,V,C[1],C[2],C[3],C[4]),F=f(U,V,C[1],C[2],C[3],C[4]),O.iterator=T,O.angleFinder=F,O.length=p(T,U,V),U=C[3],V=C[4];break;case"Z":case"z":O.destX=L,O.destY=R,O.length=o(U,V,L,R),U=L,V=R}B+=O.length,N.push(O)}return N.push({length:B,x:U,y:V}),N}g.util.joinPath=function(b){return b.map(function(C){return C.join(" ")}).join(" ")},g.util.parsePath=function(b){var C,T,O,F,B,H=[],U=[],V=g.rePathCommand,L="[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?\\s*",R="("+L+")"+g.commaWsp,N="([01])"+g.commaWsp+"?",W=new RegExp(R+"?"+R+"?"+R+N+N+R+"?("+L+")","g");if(!b||!b.match)return H;for(var Y,P=0,M=(B=b.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi)).length;P<M;P++){F=(C=B[P]).slice(1).trim(),U.length=0;var j=C.charAt(0);if(Y=[j],j.toLowerCase()==="a")for(var X;X=W.exec(F);)for(var G=1;G<X.length;G++)U.push(X[G]);else for(;O=V.exec(F);)U.push(O[0]);G=0;for(var Z=U.length;G<Z;G++)T=parseFloat(U[G]),isNaN(T)||Y.push(T);var de=i[j.toLowerCase()],oe=s[j]||j;if(Y.length-1>de)for(var ie=1,ue=Y.length;ie<ue;ie+=de)H.push([j].concat(Y.slice(ie,ie+de))),j=oe;else H.push(Y)}return H},g.util.makePathSimpler=function(b){var C,T,O,F,B,H,U=0,V=0,L=b.length,R=0,N=0,W=[];for(T=0;T<L;++T){switch(O=!1,(C=b[T].slice(0))[0]){case"l":C[0]="L",C[1]+=U,C[2]+=V;case"L":U=C[1],V=C[2];break;case"h":C[1]+=U;case"H":C[0]="L",C[2]=V,U=C[1];break;case"v":C[1]+=V;case"V":C[0]="L",V=C[1],C[1]=U,C[2]=V;break;case"m":C[0]="M",C[1]+=U,C[2]+=V;case"M":U=C[1],V=C[2],R=C[1],N=C[2];break;case"c":C[0]="C",C[1]+=U,C[2]+=V,C[3]+=U,C[4]+=V,C[5]+=U,C[6]+=V;case"C":B=C[3],H=C[4],U=C[5],V=C[6];break;case"s":C[0]="S",C[1]+=U,C[2]+=V,C[3]+=U,C[4]+=V;case"S":F==="C"?(B=2*U-B,H=2*V-H):(B=U,H=V),U=C[3],V=C[4],C[0]="C",C[5]=C[3],C[6]=C[4],C[3]=C[1],C[4]=C[2],C[1]=B,C[2]=H,B=C[3],H=C[4];break;case"q":C[0]="Q",C[1]+=U,C[2]+=V,C[3]+=U,C[4]+=V;case"Q":B=C[1],H=C[2],U=C[3],V=C[4];break;case"t":C[0]="T",C[1]+=U,C[2]+=V;case"T":F==="Q"?(B=2*U-B,H=2*V-H):(B=U,H=V),C[0]="Q",U=C[1],V=C[2],C[1]=B,C[2]=H,C[3]=U,C[4]=V;break;case"a":C[0]="A",C[6]+=U,C[7]+=V;case"A":O=!0,W=W.concat(t(U,V,C)),U=C[6],V=C[7];break;case"z":case"Z":U=R,V=N}O||W.push(C),F=C[0]}return W},g.util.getSmoothPathFromPoints=function(b,C){var T,O=[],F=new g.Point(b[0].x,b[0].y),B=new g.Point(b[1].x,b[1].y),H=b.length,U=1,V=0,L=H>2;for(C=C||0,L&&(U=b[2].x<B.x?-1:b[2].x===B.x?0:1,V=b[2].y<B.y?-1:b[2].y===B.y?0:1),O.push(["M",F.x-U*C,F.y-V*C]),T=1;T<H;T++){if(!F.eq(B)){var R=F.midPointFrom(B);O.push(["Q",F.x,F.y,R.x,R.y])}F=b[T],T+1<b.length&&(B=b[T+1])}return L&&(U=F.x>b[T-2].x?1:F.x===b[T-2].x?0:-1,V=F.y>b[T-2].y?1:F.y===b[T-2].y?0:-1),O.push(["L",F.x+U*C,F.y+V*C]),O},g.util.getPathSegmentsInfo=y,g.util.getBoundsOfCurve=function(b,C,T,O,F,B,H,U){var V;if(g.cachesBoundsOfCurve&&(V=n.call(arguments),g.boundsOfCurveCache[V]))return g.boundsOfCurveCache[V];var L,R,N,W,Y,P,M,j,X=Math.sqrt,G=Math.min,Z=Math.max,de=Math.abs,oe=[],ie=[[],[]];R=6*b-12*T+6*F,L=-3*b+9*T-9*F+3*H,N=3*T-3*b;for(var ue=0;ue<2;++ue)if(ue>0&&(R=6*C-12*O+6*B,L=-3*C+9*O-9*B+3*U,N=3*O-3*C),de(L)<1e-12){if(de(R)<1e-12)continue;0<(W=-N/R)&&W<1&&oe.push(W)}else(M=R*R-4*N*L)<0||(0<(Y=(-R+(j=X(M)))/(2*L))&&Y<1&&oe.push(Y),0<(P=(-R-j)/(2*L))&&P<1&&oe.push(P));for(var he,ge,me,_e=oe.length,ve=_e;_e--;)he=(me=1-(W=oe[_e]))*me*me*b+3*me*me*W*T+3*me*W*W*F+W*W*W*H,ie[0][_e]=he,ge=me*me*me*C+3*me*me*W*O+3*me*W*W*B+W*W*W*U,ie[1][_e]=ge;ie[0][ve]=b,ie[1][ve]=C,ie[0][ve+1]=H,ie[1][ve+1]=U;var Se=[{x:G.apply(null,ie[0]),y:G.apply(null,ie[1])},{x:Z.apply(null,ie[0]),y:Z.apply(null,ie[1])}];return g.cachesBoundsOfCurve&&(g.boundsOfCurveCache[V]=Se),Se},g.util.getPointOnPath=function(b,C,T){T||(T=y(b));for(var O=0;C-T[O].length>0&&O<T.length-2;)C-=T[O].length,O++;var F,B=T[O],H=C/B.length,U=B.command,V=b[O];switch(U){case"M":return{x:B.x,y:B.y,angle:0};case"Z":case"z":return(F=new g.Point(B.x,B.y).lerp(new g.Point(B.destX,B.destY),H)).angle=Math.atan2(B.destY-B.y,B.destX-B.x),F;case"L":return(F=new g.Point(B.x,B.y).lerp(new g.Point(V[1],V[2]),H)).angle=Math.atan2(V[2]-B.y,V[1]-B.x),F;case"C":case"Q":return function(L,R){for(var N,W,Y,P=0,M=0,j=L.iterator,X={x:L.x,y:L.y},G=.01,Z=L.angleFinder;M<R&&G>1e-4;)N=j(P),Y=P,(W=o(X.x,X.y,N.x,N.y))+M>R?(P-=G,G/=2):(X=N,P+=G,M+=W);return N.angle=Z(Y),N}(B,C)}},g.util.transformPath=function(b,C,T){return T&&(C=g.util.multiplyTransformMatrices(C,[1,0,0,1,-T.x,-T.y])),b.map(function(O){for(var F=O.slice(0),B={},H=1;H<O.length-1;H+=2)B.x=O[H],B.y=O[H+1],B=g.util.transformPoint(B,C),F[H]=B.x,F[H+1]=B.y;return F})}}(),function(){var n=Array.prototype.slice;function i(s,l,e){if(s&&s.length!==0){var t=s.length-1,o=l?s[t][l]:s[t];if(l)for(;t--;)e(s[t][l],o)&&(o=s[t][l]);else for(;t--;)e(s[t],o)&&(o=s[t]);return o}}g.util.array={fill:function(s,l){for(var e=s.length;e--;)s[e]=l;return s},invoke:function(s,l){for(var e=n.call(arguments,2),t=[],o=0,d=s.length;o<d;o++)t[o]=e.length?s[o][l].apply(s[o],e):s[o][l].call(s[o]);return t},min:function(s,l){return i(s,l,function(e,t){return e<t})},max:function(s,l){return i(s,l,function(e,t){return e>=t})}}}(),function(){function n(i,s,l){if(l)if(!g.isLikelyNode&&s instanceof Element)i=s;else if(s instanceof Array){i=[];for(var e=0,t=s.length;e<t;e++)i[e]=n({},s[e],l)}else if(s&&typeof s=="object")for(var o in s)o==="canvas"||o==="group"?i[o]=null:s.hasOwnProperty(o)&&(i[o]=n({},s[o],l));else i=s;else for(var o in s)i[o]=s[o];return i}g.util.object={extend:n,clone:function(i,s){return n({},i,s)}},g.util.object.extend(g.util,g.Observable)}(),function(){function n(i,s){var l=i.charCodeAt(s);if(isNaN(l))return"";if(l<55296||l>57343)return i.charAt(s);if(55296<=l&&l<=56319){if(i.length<=s+1)throw"High surrogate without following low surrogate";var e=i.charCodeAt(s+1);if(56320>e||e>57343)throw"High surrogate without following low surrogate";return i.charAt(s)+i.charAt(s+1)}if(s===0)throw"Low surrogate without preceding high surrogate";var t=i.charCodeAt(s-1);if(55296>t||t>56319)throw"Low surrogate without preceding high surrogate";return!1}g.util.string={camelize:function(i){return i.replace(/-+(.)?/g,function(s,l){return l?l.toUpperCase():""})},capitalize:function(i,s){return i.charAt(0).toUpperCase()+(s?i.slice(1):i.slice(1).toLowerCase())},escapeXml:function(i){return i.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},graphemeSplit:function(i){var s,l=0,e=[];for(l=0;l<i.length;l++)(s=n(i,l))!==!1&&e.push(s);return e}}}(),function(){var n=Array.prototype.slice,i=function(){},s=function(){for(var o in{toString:1})if(o==="toString")return!1;return!0}(),l=function(o,d,h){for(var c in d)c in o.prototype&&typeof o.prototype[c]=="function"&&(d[c]+"").indexOf("callSuper")>-1?o.prototype[c]=function(f){return function(){var p=this.constructor.superclass;this.constructor.superclass=h;var y=d[f].apply(this,arguments);if(this.constructor.superclass=p,f!=="initialize")return y}}(c):o.prototype[c]=d[c],s&&(d.toString!==Object.prototype.toString&&(o.prototype.toString=d.toString),d.valueOf!==Object.prototype.valueOf&&(o.prototype.valueOf=d.valueOf))};function e(){}function t(o){for(var d=null,h=this;h.constructor.superclass;){var c=h.constructor.superclass.prototype[o];if(h[o]!==c){d=c;break}h=h.constructor.superclass.prototype}return d?arguments.length>1?d.apply(this,n.call(arguments,1)):d.call(this):console.log("tried to callSuper "+o+", method not found in prototype chain",this)}g.util.createClass=function(){var o=null,d=n.call(arguments,0);function h(){this.initialize.apply(this,arguments)}typeof d[0]=="function"&&(o=d.shift()),h.superclass=o,h.subclasses=[],o&&(e.prototype=o.prototype,h.prototype=new e,o.subclasses.push(h));for(var c=0,f=d.length;c<f;c++)l(h,d[c],o);return h.prototype.initialize||(h.prototype.initialize=i),h.prototype.constructor=h,h.prototype.callSuper=t,h}}(),x=!!g.document.createElement("div").attachEvent,A=["touchstart","touchmove","touchend"],g.util.addListener=function(n,i,s,l){n&&n.addEventListener(i,s,!x&&l)},g.util.removeListener=function(n,i,s,l){n&&n.removeEventListener(i,s,!x&&l)},g.util.getPointer=function(n){var i=n.target,s=g.util.getScrollLeftTop(i),l=function(e){var t=e.changedTouches;return t&&t[0]?t[0]:e}(n);return{x:l.clientX+s.left,y:l.clientY+s.top}},g.util.isTouchEvent=function(n){return A.indexOf(n.type)>-1||n.pointerType==="touch"},I=typeof(D=g.document.createElement("div")).style.opacity=="string",z=typeof D.style.filter=="string",se=/alpha\s*\(\s*opacity\s*=\s*([^\)]+)\)/,ee=function(n){return n},I?ee=function(n,i){return n.style.opacity=i,n}:z&&(ee=function(n,i){var s=n.style;return n.currentStyle&&!n.currentStyle.hasLayout&&(s.zoom=1),se.test(s.filter)?(i=i>=.9999?"":"alpha(opacity="+100*i+")",s.filter=s.filter.replace(se,i)):s.filter+=" alpha(opacity="+100*i+")",n}),g.util.setStyle=function(n,i){var s=n.style;if(!s)return n;if(typeof i=="string")return n.style.cssText+=";"+i,i.indexOf("opacity")>-1?ee(n,i.match(/opacity:\s*(\d?\.?\d*)/)[1]):n;for(var l in i)l==="opacity"?ee(n,i[l]):s[l==="float"||l==="cssFloat"?s.styleFloat===void 0?"cssFloat":"styleFloat":l]=i[l];return n},function(){var n,i,s,l,e=Array.prototype.slice,t=function(h){return e.call(h,0)};try{n=t(g.document.childNodes)instanceof Array}catch(h){}function o(h,c){var f=g.document.createElement(h);for(var p in c)p==="class"?f.className=c[p]:p==="for"?f.htmlFor=c[p]:f.setAttribute(p,c[p]);return f}function d(h){for(var c=0,f=0,p=g.document.documentElement,y=g.document.body||{scrollLeft:0,scrollTop:0};h&&(h.parentNode||h.host)&&((h=h.parentNode||h.host)===g.document?(c=y.scrollLeft||p.scrollLeft||0,f=y.scrollTop||p.scrollTop||0):(c+=h.scrollLeft||0,f+=h.scrollTop||0),h.nodeType!==1||h.style.position!=="fixed"););return{left:c,top:f}}n||(t=function(h){for(var c=new Array(h.length),f=h.length;f--;)c[f]=h[f];return c}),i=g.document.defaultView&&g.document.defaultView.getComputedStyle?function(h,c){var f=g.document.defaultView.getComputedStyle(h,null);return f?f[c]:void 0}:function(h,c){var f=h.style[c];return!f&&h.currentStyle&&(f=h.currentStyle[c]),f},s=g.document.documentElement.style,l="userSelect"in s?"userSelect":"MozUserSelect"in s?"MozUserSelect":"WebkitUserSelect"in s?"WebkitUserSelect":"KhtmlUserSelect"in s?"KhtmlUserSelect":"",g.util.makeElementUnselectable=function(h){return h.onselectstart!==void 0&&(h.onselectstart=g.util.falseFunction),l?h.style[l]="none":typeof h.unselectable=="string"&&(h.unselectable="on"),h},g.util.makeElementSelectable=function(h){return h.onselectstart!==void 0&&(h.onselectstart=null),l?h.style[l]="":typeof h.unselectable=="string"&&(h.unselectable=""),h},g.util.setImageSmoothing=function(h,c){h.imageSmoothingEnabled=h.imageSmoothingEnabled||h.webkitImageSmoothingEnabled||h.mozImageSmoothingEnabled||h.msImageSmoothingEnabled||h.oImageSmoothingEnabled,h.imageSmoothingEnabled=c},g.util.getById=function(h){return typeof h=="string"?g.document.getElementById(h):h},g.util.toArray=t,g.util.addClass=function(h,c){h&&(" "+h.className+" ").indexOf(" "+c+" ")===-1&&(h.className+=(h.className?" ":"")+c)},g.util.makeElement=o,g.util.wrapElement=function(h,c,f){return typeof c=="string"&&(c=o(c,f)),h.parentNode&&h.parentNode.replaceChild(c,h),c.appendChild(h),c},g.util.getScrollLeftTop=d,g.util.getElementOffset=function(h){var c,f,p=h&&h.ownerDocument,y={left:0,top:0},b={left:0,top:0},C={borderLeftWidth:"left",borderTopWidth:"top",paddingLeft:"left",paddingTop:"top"};if(!p)return b;for(var T in C)b[C[T]]+=parseInt(i(h,T),10)||0;return c=p.documentElement,h.getBoundingClientRect!==void 0&&(y=h.getBoundingClientRect()),f=d(h),{left:y.left+f.left-(c.clientLeft||0)+b.left,top:y.top+f.top-(c.clientTop||0)+b.top}},g.util.getNodeCanvas=function(h){var c=g.jsdomImplForWrapper(h);return c._canvas||c._image},g.util.cleanUpJsdomNode=function(h){if(g.isLikelyNode){var c=g.jsdomImplForWrapper(h);c&&(c._image=null,c._canvas=null,c._currentSrc=null,c._attributes=null,c._classList=null)}}}(),function(){function n(){}g.util.request=function(i,s){s||(s={});var l=s.method?s.method.toUpperCase():"GET",e=s.onComplete||function(){},t=new g.window.XMLHttpRequest,o=s.body||s.parameters;return t.onreadystatechange=function(){t.readyState===4&&(e(t),t.onreadystatechange=n)},l==="GET"&&(o=null,typeof s.parameters=="string"&&(i=function(d,h){return d+(/\?/.test(d)?"&":"?")+h}(i,s.parameters))),t.open(l,i,!0),l!=="POST"&&l!=="PUT"||t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(o),t}}(),g.log=console.log,g.warn=console.warn,function(){var n=g.util.object.extend,i=g.util.object.clone,s=[];function l(){return!1}function e(h,c,f,p){return-f*Math.cos(h/p*(Math.PI/2))+f+c}g.util.object.extend(s,{cancelAll:function(){var h=this.splice(0);return h.forEach(function(c){c.cancel()}),h},cancelByCanvas:function(h){if(!h)return[];var c=this.filter(function(f){return typeof f.target=="object"&&f.target.canvas===h});return c.forEach(function(f){f.cancel()}),c},cancelByTarget:function(h){var c=this.findAnimationsByTarget(h);return c.forEach(function(f){f.cancel()}),c},findAnimationIndex:function(h){return this.indexOf(this.findAnimation(h))},findAnimation:function(h){return this.find(function(c){return c.cancel===h})},findAnimationsByTarget:function(h){return h?this.filter(function(c){return c.target===h}):[]}});var t=g.window.requestAnimationFrame||g.window.webkitRequestAnimationFrame||g.window.mozRequestAnimationFrame||g.window.oRequestAnimationFrame||g.window.msRequestAnimationFrame||function(h){return g.window.setTimeout(h,1e3/60)},o=g.window.cancelAnimationFrame||g.window.clearTimeout;function d(){return t.apply(g.window,arguments)}g.util.animate=function(h){h||(h={});var c,f=!1,p=function(){var y=g.runningAnimations.indexOf(c);return y>-1&&g.runningAnimations.splice(y,1)[0]};return c=n(i(h),{cancel:function(){return f=!0,p()},currentValue:"startValue"in h?h.startValue:0,completionRate:0,durationRate:0}),g.runningAnimations.push(c),d(function(y){var b,C=y||+new Date,T=h.duration||500,O=C+T,F=h.onChange||l,B=h.abort||l,H=h.onComplete||l,U=h.easing||e,V="startValue"in h&&h.startValue.length>0,L="startValue"in h?h.startValue:0,R="endValue"in h?h.endValue:100,N=h.byValue||(V?L.map(function(W,Y){return R[Y]-L[Y]}):R-L);h.onStart&&h.onStart(),function W(Y){var P=(b=Y||+new Date)>O?T:b-C,M=P/T,j=V?L.map(function(G,Z){return U(P,L[Z],N[Z],T)}):U(P,L,N,T),X=Math.abs(V?(j[0]-L[0])/N[0]:(j-L)/N);if(c.currentValue=V?j.slice():j,c.completionRate=X,c.durationRate=M,!f){if(!B(j,X,M))return b>O?(c.currentValue=V?R.slice():R,c.completionRate=1,c.durationRate=1,F(V?R.slice():R,1,1),H(R,1,1),void p()):(F(j,X,M),void d(W));p()}}(C)}),c.cancel},g.util.requestAnimFrame=d,g.util.cancelAnimFrame=function(){return o.apply(g.window,arguments)},g.runningAnimations=s}(),function(){function n(i,s,l){var e="rgba("+parseInt(i[0]+l*(s[0]-i[0]),10)+","+parseInt(i[1]+l*(s[1]-i[1]),10)+","+parseInt(i[2]+l*(s[2]-i[2]),10);return(e+=","+(i&&s?parseFloat(i[3]+l*(s[3]-i[3])):1))+")"}g.util.animateColor=function(i,s,l,e){var t=new g.Color(i).getSource(),o=new g.Color(s).getSource(),d=e.onComplete,h=e.onChange;return e=e||{},g.util.animate(g.util.object.extend(e,{duration:l||500,startValue:t,endValue:o,byValue:o,easing:function(c,f,p,y){return n(f,p,e.colorEasing?e.colorEasing(c,y):1-Math.cos(c/y*(Math.PI/2)))},onComplete:function(c,f,p){if(d)return d(n(o,o,0),f,p)},onChange:function(c,f,p){if(h){if(Array.isArray(c))return h(n(c,c,0),f,p);h(c,f,p)}}}))}}(),function(){function n(e,t,o,d){return e<Math.abs(t)?(e=t,d=o/4):d=t===0&&e===0?o/(2*Math.PI)*Math.asin(1):o/(2*Math.PI)*Math.asin(t/e),{a:e,c:t,p:o,s:d}}function i(e,t,o){return e.a*Math.pow(2,10*(t-=1))*Math.sin((t*o-e.s)*(2*Math.PI)/e.p)}function s(e,t,o,d){return o-l(d-e,0,o,d)+t}function l(e,t,o,d){return(e/=d)<1/2.75?o*(7.5625*e*e)+t:e<2/2.75?o*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?o*(7.5625*(e-=2.25/2.75)*e+.9375)+t:o*(7.5625*(e-=2.625/2.75)*e+.984375)+t}g.util.ease={easeInQuad:function(e,t,o,d){return o*(e/=d)*e+t},easeOutQuad:function(e,t,o,d){return-o*(e/=d)*(e-2)+t},easeInOutQuad:function(e,t,o,d){return(e/=d/2)<1?o/2*e*e+t:-o/2*(--e*(e-2)-1)+t},easeInCubic:function(e,t,o,d){return o*(e/=d)*e*e+t},easeOutCubic:function(e,t,o,d){return o*((e=e/d-1)*e*e+1)+t},easeInOutCubic:function(e,t,o,d){return(e/=d/2)<1?o/2*e*e*e+t:o/2*((e-=2)*e*e+2)+t},easeInQuart:function(e,t,o,d){return o*(e/=d)*e*e*e+t},easeOutQuart:function(e,t,o,d){return-o*((e=e/d-1)*e*e*e-1)+t},easeInOutQuart:function(e,t,o,d){return(e/=d/2)<1?o/2*e*e*e*e+t:-o/2*((e-=2)*e*e*e-2)+t},easeInQuint:function(e,t,o,d){return o*(e/=d)*e*e*e*e+t},easeOutQuint:function(e,t,o,d){return o*((e=e/d-1)*e*e*e*e+1)+t},easeInOutQuint:function(e,t,o,d){return(e/=d/2)<1?o/2*e*e*e*e*e+t:o/2*((e-=2)*e*e*e*e+2)+t},easeInSine:function(e,t,o,d){return-o*Math.cos(e/d*(Math.PI/2))+o+t},easeOutSine:function(e,t,o,d){return o*Math.sin(e/d*(Math.PI/2))+t},easeInOutSine:function(e,t,o,d){return-o/2*(Math.cos(Math.PI*e/d)-1)+t},easeInExpo:function(e,t,o,d){return e===0?t:o*Math.pow(2,10*(e/d-1))+t},easeOutExpo:function(e,t,o,d){return e===d?t+o:o*(1-Math.pow(2,-10*e/d))+t},easeInOutExpo:function(e,t,o,d){return e===0?t:e===d?t+o:(e/=d/2)<1?o/2*Math.pow(2,10*(e-1))+t:o/2*(2-Math.pow(2,-10*--e))+t},easeInCirc:function(e,t,o,d){return-o*(Math.sqrt(1-(e/=d)*e)-1)+t},easeOutCirc:function(e,t,o,d){return o*Math.sqrt(1-(e=e/d-1)*e)+t},easeInOutCirc:function(e,t,o,d){return(e/=d/2)<1?-o/2*(Math.sqrt(1-e*e)-1)+t:o/2*(Math.sqrt(1-(e-=2)*e)+1)+t},easeInElastic:function(e,t,o,d){var h=0;return e===0?t:(e/=d)==1?t+o:(h||(h=.3*d),-i(n(o,o,h,1.70158),e,d)+t)},easeOutElastic:function(e,t,o,d){var h=0;if(e===0)return t;if((e/=d)==1)return t+o;h||(h=.3*d);var c=n(o,o,h,1.70158);return c.a*Math.pow(2,-10*e)*Math.sin((e*d-c.s)*(2*Math.PI)/c.p)+c.c+t},easeInOutElastic:function(e,t,o,d){var h=0;if(e===0)return t;if((e/=d/2)==2)return t+o;h||(h=d*(.3*1.5));var c=n(o,o,h,1.70158);return e<1?-.5*i(c,e,d)+t:c.a*Math.pow(2,-10*(e-=1))*Math.sin((e*d-c.s)*(2*Math.PI)/c.p)*.5+c.c+t},easeInBack:function(e,t,o,d,h){return h===void 0&&(h=1.70158),o*(e/=d)*e*((h+1)*e-h)+t},easeOutBack:function(e,t,o,d,h){return h===void 0&&(h=1.70158),o*((e=e/d-1)*e*((h+1)*e+h)+1)+t},easeInOutBack:function(e,t,o,d,h){return h===void 0&&(h=1.70158),(e/=d/2)<1?o/2*(e*e*((1+(h*=1.525))*e-h))+t:o/2*((e-=2)*e*((1+(h*=1.525))*e+h)+2)+t},easeInBounce:s,easeOutBounce:l,easeInOutBounce:function(e,t,o,d){return e<d/2?.5*s(2*e,0,o,d)+t:.5*l(2*e-d,0,o,d)+.5*o+t}}}(),function(n){var i=n.fabric||(n.fabric={}),s=i.util.object.extend,l=i.util.object.clone,e=i.util.toFixed,t=i.util.parseUnit,o=i.util.multiplyTransformMatrices,d={cx:"left",x:"left",r:"radius",cy:"top",y:"top",display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing"},h={stroke:"strokeOpacity",fill:"fillOpacity"},c="font-size",f="clip-path";function p(L){return L in d?d[L]:L}function y(L,R,N,W){var Y,P=Array.isArray(R);if(L!=="fill"&&L!=="stroke"||R!=="none"){if(L==="strokeUniform")return R==="non-scaling-stroke";if(L==="strokeDashArray")R=R==="none"?null:R.replace(/,/g," ").split(/\s+/).map(parseFloat);else if(L==="transformMatrix")R=N&&N.transformMatrix?o(N.transformMatrix,i.parseTransformAttribute(R)):i.parseTransformAttribute(R);else if(L==="visible")R=R!=="none"&&R!=="hidden",N&&N.visible===!1&&(R=!1);else if(L==="opacity")R=parseFloat(R),N&&N.opacity!==void 0&&(R*=N.opacity);else if(L==="textAnchor")R=R==="start"?"left":R==="end"?"right":"center";else if(L==="charSpacing")Y=t(R,W)/W*1e3;else if(L==="paintFirst"){var M=R.indexOf("fill"),j=R.indexOf("stroke");R="fill",(M>-1&&j>-1&&j<M||M===-1&&j>-1)&&(R="stroke")}else{if(L==="href"||L==="xlink:href"||L==="font")return R;if(L==="imageSmoothing")return R==="optimizeQuality";Y=P?R.map(t):t(R,W)}}else R="";return!P&&isNaN(Y)?R:Y}function b(L){return new RegExp("^("+L.join("|")+")\\b","i")}function C(L,R){var N,W,Y,P,M=[];for(Y=0,P=R.length;Y<P;Y++)N=R[Y],W=L.getElementsByTagName(N),M=M.concat(Array.prototype.slice.call(W));return M}function T(L,R){var N,W=!0;return(N=O(L,R.pop()))&&R.length&&(W=function(Y,P){for(var M,j=!0;Y.parentNode&&Y.parentNode.nodeType===1&&P.length;)j&&(M=P.pop()),j=O(Y=Y.parentNode,M);return P.length===0}(L,R)),N&&W&&R.length===0}function O(L,R){var N,W,Y=L.nodeName,P=L.getAttribute("class"),M=L.getAttribute("id");if(N=new RegExp("^"+Y,"i"),R=R.replace(N,""),M&&R.length&&(N=new RegExp("#"+M+"(?![a-zA-Z\\-]+)","i"),R=R.replace(N,"")),P&&R.length)for(W=(P=P.split(" ")).length;W--;)N=new RegExp("\\."+P[W]+"(?![a-zA-Z\\-]+)","i"),R=R.replace(N,"");return R.length===0}function F(L,R){var N;if(L.getElementById&&(N=L.getElementById(R)),N)return N;var W,Y,P,M=L.getElementsByTagName("*");for(Y=0,P=M.length;Y<P;Y++)if(R===(W=M[Y]).getAttribute("id"))return W}i.svgValidTagNamesRegEx=b(["path","circle","polygon","polyline","ellipse","rect","line","image","text"]),i.svgViewBoxElementsRegEx=b(["symbol","image","marker","pattern","view","svg"]),i.svgInvalidAncestorsRegEx=b(["pattern","defs","symbol","metadata","clipPath","mask","desc"]),i.svgValidParentsRegEx=b(["symbol","g","a","svg","clipPath","defs"]),i.cssRules={},i.gradientDefs={},i.clipPaths={},i.parseTransformAttribute=function(){function L(j,X,G){j[G]=Math.tan(i.util.degreesToRadians(X[0]))}var R=i.iMatrix,N=i.reNum,W=i.commaWsp,Y="(?:(?:(matrix)\\s*\\(\\s*("+N+")"+W+"("+N+")"+W+"("+N+")"+W+"("+N+")"+W+"("+N+")"+W+"("+N+")\\s*\\))|(?:(translate)\\s*\\(\\s*("+N+")(?:"+W+"("+N+"))?\\s*\\))|(?:(scale)\\s*\\(\\s*("+N+")(?:"+W+"("+N+"))?\\s*\\))|(?:(rotate)\\s*\\(\\s*("+N+")(?:"+W+"("+N+")"+W+"("+N+"))?\\s*\\))|(?:(skewX)\\s*\\(\\s*("+N+")\\s*\\))|(?:(skewY)\\s*\\(\\s*("+N+")\\s*\\)))",P=new RegExp("^\\s*(?:(?:"+Y+"(?:"+W+"*"+Y+")*)?)\\s*$"),M=new RegExp(Y,"g");return function(j){var X=R.concat(),G=[];if(!j||j&&!P.test(j))return X;j.replace(M,function(de){var oe=new RegExp(Y).exec(de).filter(function(he){return!!he}),ie=oe[1],ue=oe.slice(2).map(parseFloat);switch(ie){case"translate":(function(he,ge){he[4]=ge[0],ge.length===2&&(he[5]=ge[1])})(X,ue);break;case"rotate":ue[0]=i.util.degreesToRadians(ue[0]),function(he,ge){var me=i.util.cos(ge[0]),_e=i.util.sin(ge[0]),ve=0,Se=0;ge.length===3&&(ve=ge[1],Se=ge[2]),he[0]=me,he[1]=_e,he[2]=-_e,he[3]=me,he[4]=ve-(me*ve-_e*Se),he[5]=Se-(_e*ve+me*Se)}(X,ue);break;case"scale":(function(he,ge){var me=ge[0],_e=ge.length===2?ge[1]:ge[0];he[0]=me,he[3]=_e})(X,ue);break;case"skewX":L(X,ue,2);break;case"skewY":L(X,ue,1);break;case"matrix":X=ue}G.push(X.concat()),X=R.concat()});for(var Z=G[0];G.length>1;)G.shift(),Z=i.util.multiplyTransformMatrices(Z,G[0]);return Z}}();var B=new RegExp("^\\s*("+i.reNum+"+)\\s*,?\\s*("+i.reNum+"+)\\s*,?\\s*("+i.reNum+"+)\\s*,?\\s*("+i.reNum+"+)\\s*$");function H(L){if(!i.svgViewBoxElementsRegEx.test(L.nodeName))return{};var R,N,W,Y,P,M,j=L.getAttribute("viewBox"),X=1,G=1,Z=L.getAttribute("width"),de=L.getAttribute("height"),oe=L.getAttribute("x")||0,ie=L.getAttribute("y")||0,ue=L.getAttribute("preserveAspectRatio")||"",he=!j||!(j=j.match(B)),ge=!Z||!de||Z==="100%"||de==="100%",me=he&&ge,_e={},ve="",Se=0,Ie=0;if(_e.width=0,_e.height=0,_e.toBeParsed=me,he&&(oe||ie)&&L.parentNode&&L.parentNode.nodeName!=="#document"&&(ve=" translate("+t(oe)+" "+t(ie)+") ",P=(L.getAttribute("transform")||"")+ve,L.setAttribute("transform",P),L.removeAttribute("x"),L.removeAttribute("y")),me)return _e;if(he)return _e.width=t(Z),_e.height=t(de),_e;if(R=-parseFloat(j[1]),N=-parseFloat(j[2]),W=parseFloat(j[3]),Y=parseFloat(j[4]),_e.minX=R,_e.minY=N,_e.viewBoxWidth=W,_e.viewBoxHeight=Y,ge?(_e.width=W,_e.height=Y):(_e.width=t(Z),_e.height=t(de),X=_e.width/W,G=_e.height/Y),(ue=i.util.parsePreserveAspectRatioAttribute(ue)).alignX!=="none"&&(ue.meetOrSlice==="meet"&&(G=X=X>G?G:X),ue.meetOrSlice==="slice"&&(G=X=X>G?X:G),Se=_e.width-W*X,Ie=_e.height-Y*X,ue.alignX==="Mid"&&(Se/=2),ue.alignY==="Mid"&&(Ie/=2),ue.alignX==="Min"&&(Se=0),ue.alignY==="Min"&&(Ie=0)),X===1&&G===1&&R===0&&N===0&&oe===0&&ie===0)return _e;if((oe||ie)&&L.parentNode.nodeName!=="#document"&&(ve=" translate("+t(oe)+" "+t(ie)+") "),P=ve+" matrix("+X+" 0 0 "+G+" "+(R*X+Se)+" "+(N*G+Ie)+") ",L.nodeName==="svg"){for(M=L.ownerDocument.createElementNS(i.svgNS,"g");L.firstChild;)M.appendChild(L.firstChild);L.appendChild(M)}else(M=L).removeAttribute("x"),M.removeAttribute("y"),P=M.getAttribute("transform")+P;return M.setAttribute("transform",P),_e}function U(L,R){var N="xlink:href",W=F(L,R.getAttribute(N).slice(1));if(W&&W.getAttribute(N)&&U(L,W),["gradientTransform","x1","x2","y1","y2","gradientUnits","cx","cy","r","fx","fy"].forEach(function(P){W&&!R.hasAttribute(P)&&W.hasAttribute(P)&&R.setAttribute(P,W.getAttribute(P))}),!R.children.length)for(var Y=W.cloneNode(!0);Y.firstChild;)R.appendChild(Y.firstChild);R.removeAttribute(N)}i.parseSVGDocument=function(L,R,N,W){if(L){(function(oe){for(var ie=C(oe,["use","svg:use"]),ue=0;ie.length&&ue<ie.length;){var he=ie[ue],ge=he.getAttribute("xlink:href")||he.getAttribute("href");if(ge===null)return;var me,_e,ve,Se,Ie=ge.slice(1),Re=he.getAttribute("x")||0,ke=he.getAttribute("y")||0,Ce=F(oe,Ie).cloneNode(!0),Oe=(Ce.getAttribute("transform")||"")+" translate("+Re+", "+ke+")",Ge=ie.length,Be=i.svgNS;if(H(Ce),/^svg$/i.test(Ce.nodeName)){var Le=Ce.ownerDocument.createElementNS(Be,"g");for(_e=0,Se=(ve=Ce.attributes).length;_e<Se;_e++)me=ve.item(_e),Le.setAttributeNS(Be,me.nodeName,me.nodeValue);for(;Ce.firstChild;)Le.appendChild(Ce.firstChild);Ce=Le}for(_e=0,Se=(ve=he.attributes).length;_e<Se;_e++)(me=ve.item(_e)).nodeName!=="x"&&me.nodeName!=="y"&&me.nodeName!=="xlink:href"&&me.nodeName!=="href"&&(me.nodeName==="transform"?Oe=me.nodeValue+" "+Oe:Ce.setAttribute(me.nodeName,me.nodeValue));Ce.setAttribute("transform",Oe),Ce.setAttribute("instantiated_by_use","1"),Ce.removeAttribute("id"),he.parentNode.replaceChild(Ce,he),ie.length===Ge&&ue++}})(L);var Y,P,M=i.Object.__uid++,j=H(L),X=i.util.toArray(L.getElementsByTagName("*"));if(j.crossOrigin=W&&W.crossOrigin,j.svgUid=M,X.length===0&&i.isLikelyNode){var G=[];for(Y=0,P=(X=L.selectNodes('//*[name(.)!="svg"]')).length;Y<P;Y++)G[Y]=X[Y];X=G}var Z=X.filter(function(oe){return H(oe),i.svgValidTagNamesRegEx.test(oe.nodeName.replace("svg:",""))&&!function(ie,ue){for(;ie&&(ie=ie.parentNode);)if(ie.nodeName&&ue.test(ie.nodeName.replace("svg:",""))&&!ie.getAttribute("instantiated_by_use"))return!0;return!1}(oe,i.svgInvalidAncestorsRegEx)});if(!Z||Z&&!Z.length)R&&R([],{});else{var de={};X.filter(function(oe){return oe.nodeName.replace("svg:","")==="clipPath"}).forEach(function(oe){var ie=oe.getAttribute("id");de[ie]=i.util.toArray(oe.getElementsByTagName("*")).filter(function(ue){return i.svgValidTagNamesRegEx.test(ue.nodeName.replace("svg:",""))})}),i.gradientDefs[M]=i.getGradientDefs(L),i.cssRules[M]=i.getCSSRules(L),i.clipPaths[M]=de,i.parseElements(Z,function(oe,ie){R&&(R(oe,j,ie,X),delete i.gradientDefs[M],delete i.cssRules[M],delete i.clipPaths[M])},l(j),N,W)}}};var V=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+i.reNum+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+i.reNum+"))?\\s+(.*)");s(i,{parseFontDeclaration:function(L,R){var N=L.match(V);if(N){var W=N[1],Y=N[3],P=N[4],M=N[5],j=N[6];W&&(R.fontStyle=W),Y&&(R.fontWeight=isNaN(parseFloat(Y))?Y:parseFloat(Y)),P&&(R.fontSize=t(P)),j&&(R.fontFamily=j),M&&(R.lineHeight=M==="normal"?1:M)}},getGradientDefs:function(L){var R,N=C(L,["linearGradient","radialGradient","svg:linearGradient","svg:radialGradient"]),W=0,Y={};for(W=N.length;W--;)(R=N[W]).getAttribute("xlink:href")&&U(L,R),Y[R.getAttribute("id")]=R;return Y},parseAttributes:function(L,R,N){if(L){var W,Y,P,M={};N===void 0&&(N=L.getAttribute("svgUid")),L.parentNode&&i.svgValidParentsRegEx.test(L.parentNode.nodeName)&&(M=i.parseAttributes(L.parentNode,R,N));var j=R.reduce(function(ue,he){return(W=L.getAttribute(he))&&(ue[he]=W),ue},{}),X=s(function(ue,he){var ge={};for(var me in i.cssRules[he])if(T(ue,me.split(" ")))for(var _e in i.cssRules[he][me])ge[_e]=i.cssRules[he][me][_e];return ge}(L,N),i.parseStyleAttribute(L));j=s(j,X),X[f]&&L.setAttribute(f,X[f]),Y=P=M.fontSize||i.Text.DEFAULT_SVG_FONT_SIZE,j[c]&&(j[c]=Y=t(j[c],P));var G,Z,de={};for(var oe in j)Z=y(G=p(oe),j[oe],M,Y),de[G]=Z;de&&de.font&&i.parseFontDeclaration(de.font,de);var ie=s(M,de);return i.svgValidParentsRegEx.test(L.nodeName)?ie:function(ue){for(var he in h)if(ue[h[he]]!==void 0&&ue[he]!==""){if(ue[he]===void 0){if(!i.Object.prototype[he])continue;ue[he]=i.Object.prototype[he]}if(ue[he].indexOf("url(")!==0){var ge=new i.Color(ue[he]);ue[he]=ge.setAlpha(e(ge.getAlpha()*ue[h[he]],2)).toRgba()}}return ue}(ie)}},parseElements:function(L,R,N,W,Y){new i.ElementsParser(L,R,N,W,Y).parse()},parseStyleAttribute:function(L){var R={},N=L.getAttribute("style");return N&&(typeof N=="string"?function(W,Y){var P,M;W.replace(/;\s*$/,"").split(";").forEach(function(j){var X=j.split(":");P=X[0].trim().toLowerCase(),M=X[1].trim(),Y[P]=M})}(N,R):function(W,Y){var P,M;for(var j in W)W[j]!==void 0&&(P=j.toLowerCase(),M=W[j],Y[P]=M)}(N,R)),R},parsePointsAttribute:function(L){if(!L)return null;var R,N,W=[];for(R=0,N=(L=(L=L.replace(/,/g," ").trim()).split(/\s+/)).length;R<N;R+=2)W.push({x:parseFloat(L[R]),y:parseFloat(L[R+1])});return W},getCSSRules:function(L){var R,N,W=L.getElementsByTagName("style"),Y={};for(R=0,N=W.length;R<N;R++){var P=W[R].textContent;(P=P.replace(/\/\*[\s\S]*?\*\//g,"")).trim()!==""&&P.split("}").filter(function(M){return M.trim()}).forEach(function(M){var j=M.split("{"),X={},G=j[1].trim().split(";").filter(function(ie){return ie.trim()});for(R=0,N=G.length;R<N;R++){var Z=G[R].split(":"),de=Z[0].trim(),oe=Z[1].trim();X[de]=oe}(M=j[0].trim()).split(",").forEach(function(ie){(ie=ie.replace(/^svg/i,"").trim())!==""&&(Y[ie]?i.util.object.extend(Y[ie],X):Y[ie]=i.util.object.clone(X))})})}return Y},loadSVGFromURL:function(L,R,N,W){L=L.replace(/^\n\s*/,"").trim(),new i.util.request(L,{method:"get",onComplete:function(Y){var P=Y.responseXML;if(!P||!P.documentElement)return R&&R(null),!1;i.parseSVGDocument(P.documentElement,function(M,j,X,G){R&&R(M,j,X,G)},N,W)}})},loadSVGFromString:function(L,R,N,W){var Y=new i.window.DOMParser().parseFromString(L.trim(),"text/xml");i.parseSVGDocument(Y.documentElement,function(P,M,j,X){R(P,M,j,X)},N,W)}})}(r),g.ElementsParser=function(n,i,s,l,e,t){this.elements=n,this.callback=i,this.options=s,this.reviver=l,this.svgUid=s&&s.svgUid||0,this.parsingOptions=e,this.regexUrl=/^url\(['"]?#([^'"]+)['"]?\)/g,this.doc=t},(q=g.ElementsParser.prototype).parse=function(){this.instances=new Array(this.elements.length),this.numElements=this.elements.length,this.createObjects()},q.createObjects=function(){var n=this;this.elements.forEach(function(i,s){i.setAttribute("svgUid",n.svgUid),n.createObject(i,s)})},q.findTag=function(n){return g[g.util.string.capitalize(n.tagName.replace("svg:",""))]},q.createObject=function(n,i){var s=this.findTag(n);if(s&&s.fromElement)try{s.fromElement(n,this.createCallback(i,n),this.options)}catch(l){g.log(l)}else this.checkIfDone()},q.createCallback=function(n,i){var s=this;return function(l){var e;s.resolveGradient(l,i,"fill"),s.resolveGradient(l,i,"stroke"),l instanceof g.Image&&l._originalElement&&(e=l.parsePreserveAspectRatioAttribute(i)),l._removeTransformMatrix(e),s.resolveClipPath(l,i),s.reviver&&s.reviver(i,l),s.instances[n]=l,s.checkIfDone()}},q.extractPropertyDefinition=function(n,i,s){var l=n[i],e=this.regexUrl;if(e.test(l)){e.lastIndex=0;var t=e.exec(l)[1];return e.lastIndex=0,g[s][this.svgUid][t]}},q.resolveGradient=function(n,i,s){var l=this.extractPropertyDefinition(n,s,"gradientDefs");if(l){var e=i.getAttribute(s+"-opacity"),t=g.Gradient.fromElement(l,n,e,this.options);n.set(s,t)}},q.createClipPathCallback=function(n,i){return function(s){s._removeTransformMatrix(),s.fillRule=s.clipRule,i.push(s)}},q.resolveClipPath=function(n,i){var s,l,e,t,o=this.extractPropertyDefinition(n,"clipPath","clipPaths");if(o){e=[],l=g.util.invertTransform(n.calcTransformMatrix());for(var d=o[0].parentNode,h=i;h.parentNode&&h.getAttribute("clip-path")!==n.clipPath;)h=h.parentNode;h.parentNode.appendChild(d);for(var c=0;c<o.length;c++)s=o[c],this.findTag(s).fromElement(s,this.createClipPathCallback(n,e),this.options);o=e.length===1?e[0]:new g.Group(e),t=g.util.multiplyTransformMatrices(l,o.calcTransformMatrix()),o.clipPath&&this.resolveClipPath(o,h);var f=g.util.qrDecompose(t);o.flipX=!1,o.flipY=!1,o.set("scaleX",f.scaleX),o.set("scaleY",f.scaleY),o.angle=f.angle,o.skewX=f.skewX,o.skewY=0,o.setPositionByOrigin({x:f.translateX,y:f.translateY},"center","center"),n.clipPath=o}else delete n.clipPath},q.checkIfDone=function(){--this.numElements==0&&(this.instances=this.instances.filter(function(n){return n!=null}),this.callback(this.instances,this.elements))},function(n){var i=n.fabric||(n.fabric={});function s(l,e){this.x=l,this.y=e}i.Point?i.warn("fabric.Point is already defined"):(i.Point=s,s.prototype={type:"point",constructor:s,add:function(l){return new s(this.x+l.x,this.y+l.y)},addEquals:function(l){return this.x+=l.x,this.y+=l.y,this},scalarAdd:function(l){return new s(this.x+l,this.y+l)},scalarAddEquals:function(l){return this.x+=l,this.y+=l,this},subtract:function(l){return new s(this.x-l.x,this.y-l.y)},subtractEquals:function(l){return this.x-=l.x,this.y-=l.y,this},scalarSubtract:function(l){return new s(this.x-l,this.y-l)},scalarSubtractEquals:function(l){return this.x-=l,this.y-=l,this},multiply:function(l){return new s(this.x*l,this.y*l)},multiplyEquals:function(l){return this.x*=l,this.y*=l,this},divide:function(l){return new s(this.x/l,this.y/l)},divideEquals:function(l){return this.x/=l,this.y/=l,this},eq:function(l){return this.x===l.x&&this.y===l.y},lt:function(l){return this.x<l.x&&this.y<l.y},lte:function(l){return this.x<=l.x&&this.y<=l.y},gt:function(l){return this.x>l.x&&this.y>l.y},gte:function(l){return this.x>=l.x&&this.y>=l.y},lerp:function(l,e){return e===void 0&&(e=.5),e=Math.max(Math.min(1,e),0),new s(this.x+(l.x-this.x)*e,this.y+(l.y-this.y)*e)},distanceFrom:function(l){var e=this.x-l.x,t=this.y-l.y;return Math.sqrt(e*e+t*t)},midPointFrom:function(l){return this.lerp(l)},min:function(l){return new s(Math.min(this.x,l.x),Math.min(this.y,l.y))},max:function(l){return new s(Math.max(this.x,l.x),Math.max(this.y,l.y))},toString:function(){return this.x+","+this.y},setXY:function(l,e){return this.x=l,this.y=e,this},setX:function(l){return this.x=l,this},setY:function(l){return this.y=l,this},setFromPoint:function(l){return this.x=l.x,this.y=l.y,this},swap:function(l){var e=this.x,t=this.y;this.x=l.x,this.y=l.y,l.x=e,l.y=t},clone:function(){return new s(this.x,this.y)}})}(r),function(n){var i=n.fabric||(n.fabric={});function s(l){this.status=l,this.points=[]}i.Intersection?i.warn("fabric.Intersection is already defined"):(i.Intersection=s,i.Intersection.prototype={constructor:s,appendPoint:function(l){return this.points.push(l),this},appendPoints:function(l){return this.points=this.points.concat(l),this}},i.Intersection.intersectLineLine=function(l,e,t,o){var d,h=(o.x-t.x)*(l.y-t.y)-(o.y-t.y)*(l.x-t.x),c=(e.x-l.x)*(l.y-t.y)-(e.y-l.y)*(l.x-t.x),f=(o.y-t.y)*(e.x-l.x)-(o.x-t.x)*(e.y-l.y);if(f!==0){var p=h/f,y=c/f;0<=p&&p<=1&&0<=y&&y<=1?(d=new s("Intersection")).appendPoint(new i.Point(l.x+p*(e.x-l.x),l.y+p*(e.y-l.y))):d=new s}else d=new s(h===0||c===0?"Coincident":"Parallel");return d},i.Intersection.intersectLinePolygon=function(l,e,t){var o,d,h,c,f=new s,p=t.length;for(c=0;c<p;c++)o=t[c],d=t[(c+1)%p],h=s.intersectLineLine(l,e,o,d),f.appendPoints(h.points);return f.points.length>0&&(f.status="Intersection"),f},i.Intersection.intersectPolygonPolygon=function(l,e){var t,o=new s,d=l.length;for(t=0;t<d;t++){var h=l[t],c=l[(t+1)%d],f=s.intersectLinePolygon(h,c,e);o.appendPoints(f.points)}return o.points.length>0&&(o.status="Intersection"),o},i.Intersection.intersectPolygonRectangle=function(l,e,t){var o=e.min(t),d=e.max(t),h=new i.Point(d.x,o.y),c=new i.Point(o.x,d.y),f=s.intersectLinePolygon(o,h,l),p=s.intersectLinePolygon(h,d,l),y=s.intersectLinePolygon(d,c,l),b=s.intersectLinePolygon(c,o,l),C=new s;return C.appendPoints(f.points),C.appendPoints(p.points),C.appendPoints(y.points),C.appendPoints(b.points),C.points.length>0&&(C.status="Intersection"),C})}(r),function(n){var i=n.fabric||(n.fabric={});function s(e){e?this._tryParsingColor(e):this.setSource([0,0,0,1])}function l(e,t,o){return o<0&&(o+=1),o>1&&(o-=1),o<1/6?e+6*(t-e)*o:o<.5?t:o<2/3?e+(t-e)*(2/3-o)*6:e}i.Color?i.warn("fabric.Color is already defined."):(i.Color=s,i.Color.prototype={_tryParsingColor:function(e){var t;e in s.colorNameMap&&(e=s.colorNameMap[e]),e==="transparent"&&(t=[255,255,255,0]),t||(t=s.sourceFromHex(e)),t||(t=s.sourceFromRgb(e)),t||(t=s.sourceFromHsl(e)),t||(t=[0,0,0,1]),t&&this.setSource(t)},_rgbToHsl:function(e,t,o){e/=255,t/=255,o/=255;var d,h,c,f=i.util.array.max([e,t,o]),p=i.util.array.min([e,t,o]);if(c=(f+p)/2,f===p)d=h=0;else{var y=f-p;switch(h=c>.5?y/(2-f-p):y/(f+p),f){case e:d=(t-o)/y+(t<o?6:0);break;case t:d=(o-e)/y+2;break;case o:d=(e-t)/y+4}d/=6}return[Math.round(360*d),Math.round(100*h),Math.round(100*c)]},getSource:function(){return this._source},setSource:function(e){this._source=e},toRgb:function(){var e=this.getSource();return"rgb("+e[0]+","+e[1]+","+e[2]+")"},toRgba:function(){var e=this.getSource();return"rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")"},toHsl:function(){var e=this.getSource(),t=this._rgbToHsl(e[0],e[1],e[2]);return"hsl("+t[0]+","+t[1]+"%,"+t[2]+"%)"},toHsla:function(){var e=this.getSource(),t=this._rgbToHsl(e[0],e[1],e[2]);return"hsla("+t[0]+","+t[1]+"%,"+t[2]+"%,"+e[3]+")"},toHex:function(){var e,t,o,d=this.getSource();return e=(e=d[0].toString(16)).length===1?"0"+e:e,t=(t=d[1].toString(16)).length===1?"0"+t:t,o=(o=d[2].toString(16)).length===1?"0"+o:o,e.toUpperCase()+t.toUpperCase()+o.toUpperCase()},toHexa:function(){var e,t=this.getSource();return e=(e=(e=Math.round(255*t[3])).toString(16)).length===1?"0"+e:e,this.toHex()+e.toUpperCase()},getAlpha:function(){return this.getSource()[3]},setAlpha:function(e){var t=this.getSource();return t[3]=e,this.setSource(t),this},toGrayscale:function(){var e=this.getSource(),t=parseInt((.3*e[0]+.59*e[1]+.11*e[2]).toFixed(0),10),o=e[3];return this.setSource([t,t,t,o]),this},toBlackWhite:function(e){var t=this.getSource(),o=(.3*t[0]+.59*t[1]+.11*t[2]).toFixed(0),d=t[3];return e=e||127,o=Number(o)<Number(e)?0:255,this.setSource([o,o,o,d]),this},overlayWith:function(e){e instanceof s||(e=new s(e));var t,o=[],d=this.getAlpha(),h=this.getSource(),c=e.getSource();for(t=0;t<3;t++)o.push(Math.round(.5*h[t]+.5*c[t]));return o[3]=d,this.setSource(o),this}},i.Color.reRGBa=/^rgba?\(\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*(?:\s*,\s*((?:\d*\.?\d+)?)\s*)?\)$/i,i.Color.reHSLa=/^hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)$/i,i.Color.reHex=/^#?([0-9a-f]{8}|[0-9a-f]{6}|[0-9a-f]{4}|[0-9a-f]{3})$/i,i.Color.colorNameMap={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"},i.Color.fromRgb=function(e){return s.fromSource(s.sourceFromRgb(e))},i.Color.sourceFromRgb=function(e){var t=e.match(s.reRGBa);if(t){var o=parseInt(t[1],10)/(/%$/.test(t[1])?100:1)*(/%$/.test(t[1])?255:1),d=parseInt(t[2],10)/(/%$/.test(t[2])?100:1)*(/%$/.test(t[2])?255:1),h=parseInt(t[3],10)/(/%$/.test(t[3])?100:1)*(/%$/.test(t[3])?255:1);return[parseInt(o,10),parseInt(d,10),parseInt(h,10),t[4]?parseFloat(t[4]):1]}},i.Color.fromRgba=s.fromRgb,i.Color.fromHsl=function(e){return s.fromSource(s.sourceFromHsl(e))},i.Color.sourceFromHsl=function(e){var t=e.match(s.reHSLa);if(t){var o,d,h,c=(parseFloat(t[1])%360+360)%360/360,f=parseFloat(t[2])/(/%$/.test(t[2])?100:1),p=parseFloat(t[3])/(/%$/.test(t[3])?100:1);if(f===0)o=d=h=p;else{var y=p<=.5?p*(f+1):p+f-p*f,b=2*p-y;o=l(b,y,c+1/3),d=l(b,y,c),h=l(b,y,c-1/3)}return[Math.round(255*o),Math.round(255*d),Math.round(255*h),t[4]?parseFloat(t[4]):1]}},i.Color.fromHsla=s.fromHsl,i.Color.fromHex=function(e){return s.fromSource(s.sourceFromHex(e))},i.Color.sourceFromHex=function(e){if(e.match(s.reHex)){var t=e.slice(e.indexOf("#")+1),o=t.length===3||t.length===4,d=t.length===8||t.length===4,h=o?t.charAt(0)+t.charAt(0):t.substring(0,2),c=o?t.charAt(1)+t.charAt(1):t.substring(2,4),f=o?t.charAt(2)+t.charAt(2):t.substring(4,6),p=d?o?t.charAt(3)+t.charAt(3):t.substring(6,8):"FF";return[parseInt(h,16),parseInt(c,16),parseInt(f,16),parseFloat((parseInt(p,16)/255).toFixed(2))]}},i.Color.fromSource=function(e){var t=new s;return t.setSource(e),t})}(r),function(n){var i=n.fabric||(n.fabric={}),s=["e","se","s","sw","w","nw","n","ne","e"],l=["ns","nesw","ew","nwse"],e={},t="left",o="top",d="right",h="bottom",c="center",f={top:h,bottom:o,left:d,right:t,center:c},p=i.util.radiansToDegrees,y=Math.sign||function(P){return(P>0)-(P<0)||+P};function b(P,M){var j=P.angle+p(Math.atan2(M.y,M.x))+360;return Math.round(j%360/45)}function C(P,M){var j=M.transform.target,X=j.canvas,G=i.util.object.clone(M);G.target=j,X&&X.fire("object:"+P,G),j.fire(P,M)}function T(P,M){var j=M.canvas,X=P[j.uniScaleKey];return j.uniformScaling&&!X||!j.uniformScaling&&X}function O(P){return P.originX===c&&P.originY===c}function F(P,M,j){var X=P.lockScalingX,G=P.lockScalingY;return!((!X||!G)&&(M||!X&&!G||!j)&&(!X||M!=="x")&&(!G||M!=="y"))}function B(P,M,j,X){return{e:P,transform:M,pointer:{x:j,y:X}}}function H(P){return function(M,j,X,G){var Z=j.target,de=Z.getCenterPoint(),oe=Z.translateToOriginPoint(de,j.originX,j.originY),ie=P(M,j,X,G);return Z.setPositionByOrigin(oe,j.originX,j.originY),ie}}function U(P,M){return function(j,X,G,Z){var de=M(j,X,G,Z);return de&&C(P,B(j,X,G,Z)),de}}function V(P,M,j,X,G){var Z=P.target,de=Z.controls[P.corner],oe=Z.canvas.getZoom(),ie=Z.padding/oe,ue=Z.toLocalPoint(new i.Point(X,G),M,j);return ue.x>=ie&&(ue.x-=ie),ue.x<=-ie&&(ue.x+=ie),ue.y>=ie&&(ue.y-=ie),ue.y<=ie&&(ue.y+=ie),ue.x-=de.offsetX,ue.y-=de.offsetY,ue}function L(P){return P.flipX!==P.flipY}function R(P,M,j,X,G){if(P[M]!==0){var Z=G/P._getTransformedDimensions()[X]*P[j];P.set(j,Z)}}function N(P,M,j,X){var G,Z=M.target,de=Z._getTransformedDimensions(0,Z.skewY),oe=V(M,M.originX,M.originY,j,X),ie=Math.abs(2*oe.x)-de.x,ue=Z.skewX;ie<2?G=0:(G=p(Math.atan2(ie/Z.scaleX,de.y/Z.scaleY)),M.originX===t&&M.originY===h&&(G=-G),M.originX===d&&M.originY===o&&(G=-G),L(Z)&&(G=-G));var he=ue!==G;if(he){var ge=Z._getTransformedDimensions().y;Z.set("skewX",G),R(Z,"skewY","scaleY","y",ge)}return he}function W(P,M,j,X){var G,Z=M.target,de=Z._getTransformedDimensions(Z.skewX,0),oe=V(M,M.originX,M.originY,j,X),ie=Math.abs(2*oe.y)-de.y,ue=Z.skewY;ie<2?G=0:(G=p(Math.atan2(ie/Z.scaleY,de.x/Z.scaleX)),M.originX===t&&M.originY===h&&(G=-G),M.originX===d&&M.originY===o&&(G=-G),L(Z)&&(G=-G));var he=ue!==G;if(he){var ge=Z._getTransformedDimensions().x;Z.set("skewY",G),R(Z,"skewX","scaleX","x",ge)}return he}function Y(P,M,j,X,G){G=G||{};var Z,de,oe,ie,ue,he,ge=M.target,me=ge.lockScalingX,_e=ge.lockScalingY,ve=G.by,Se=T(P,ge),Ie=F(ge,ve,Se),Re=M.gestureScale;if(Ie)return!1;if(Re)de=M.scaleX*Re,oe=M.scaleY*Re;else{if(Z=V(M,M.originX,M.originY,j,X),ue=ve!=="y"?y(Z.x):1,he=ve!=="x"?y(Z.y):1,M.signX||(M.signX=ue),M.signY||(M.signY=he),ge.lockScalingFlip&&(M.signX!==ue||M.signY!==he))return!1;if(ie=ge._getTransformedDimensions(),Se&&!ve){var ke=Math.abs(Z.x)+Math.abs(Z.y),Ce=M.original,Oe=ke/(Math.abs(ie.x*Ce.scaleX/ge.scaleX)+Math.abs(ie.y*Ce.scaleY/ge.scaleY));de=Ce.scaleX*Oe,oe=Ce.scaleY*Oe}else de=Math.abs(Z.x*ge.scaleX/ie.x),oe=Math.abs(Z.y*ge.scaleY/ie.y);O(M)&&(de*=2,oe*=2),M.signX!==ue&&ve!=="y"&&(M.originX=f[M.originX],de*=-1,M.signX=ue),M.signY!==he&&ve!=="x"&&(M.originY=f[M.originY],oe*=-1,M.signY=he)}var Ge=ge.scaleX,Be=ge.scaleY;return ve?(ve==="x"&&ge.set("scaleX",de),ve==="y"&&ge.set("scaleY",oe)):(!me&&ge.set("scaleX",de),!_e&&ge.set("scaleY",oe)),Ge!==ge.scaleX||Be!==ge.scaleY}e.scaleCursorStyleHandler=function(P,M,j){var X=T(P,j),G="";if(M.x!==0&&M.y===0?G="x":M.x===0&&M.y!==0&&(G="y"),F(j,G,X))return"not-allowed";var Z=b(j,M);return s[Z]+"-resize"},e.skewCursorStyleHandler=function(P,M,j){var X="not-allowed";if(M.x!==0&&j.lockSkewingY||M.y!==0&&j.lockSkewingX)return X;var G=b(j,M)%4;return l[G]+"-resize"},e.scaleSkewCursorStyleHandler=function(P,M,j){return P[j.canvas.altActionKey]?e.skewCursorStyleHandler(P,M,j):e.scaleCursorStyleHandler(P,M,j)},e.rotationWithSnapping=U("rotating",H(function(P,M,j,X){var G=M,Z=G.target,de=Z.translateToOriginPoint(Z.getCenterPoint(),G.originX,G.originY);if(Z.lockRotation)return!1;var oe,ie=Math.atan2(G.ey-de.y,G.ex-de.x),ue=Math.atan2(X-de.y,j-de.x),he=p(ue-ie+G.theta);if(Z.snapAngle>0){var ge=Z.snapAngle,me=Z.snapThreshold||ge,_e=Math.ceil(he/ge)*ge,ve=Math.floor(he/ge)*ge;Math.abs(he-ve)<me?he=ve:Math.abs(he-_e)<me&&(he=_e)}return he<0&&(he=360+he),he%=360,oe=Z.angle!==he,Z.angle=he,oe})),e.scalingEqually=U("scaling",H(function(P,M,j,X){return Y(P,M,j,X)})),e.scalingX=U("scaling",H(function(P,M,j,X){return Y(P,M,j,X,{by:"x"})})),e.scalingY=U("scaling",H(function(P,M,j,X){return Y(P,M,j,X,{by:"y"})})),e.scalingYOrSkewingX=function(P,M,j,X){return P[M.target.canvas.altActionKey]?e.skewHandlerX(P,M,j,X):e.scalingY(P,M,j,X)},e.scalingXOrSkewingY=function(P,M,j,X){return P[M.target.canvas.altActionKey]?e.skewHandlerY(P,M,j,X):e.scalingX(P,M,j,X)},e.changeWidth=U("resizing",H(function(P,M,j,X){var G=M.target,Z=V(M,M.originX,M.originY,j,X),de=G.strokeWidth/(G.strokeUniform?G.scaleX:1),oe=O(M)?2:1,ie=G.width,ue=Math.abs(Z.x*oe/G.scaleX)-de;return G.set("width",Math.max(ue,0)),ie!==ue})),e.skewHandlerX=function(P,M,j,X){var G,Z=M.target,de=Z.skewX,oe=M.originY;return!Z.lockSkewingX&&(de===0?G=V(M,c,c,j,X).x>0?t:d:(de>0&&(G=oe===o?t:d),de<0&&(G=oe===o?d:t),L(Z)&&(G=G===t?d:t)),M.originX=G,U("skewing",H(N))(P,M,j,X))},e.skewHandlerY=function(P,M,j,X){var G,Z=M.target,de=Z.skewY,oe=M.originX;return!Z.lockSkewingY&&(de===0?G=V(M,c,c,j,X).y>0?o:h:(de>0&&(G=oe===t?o:h),de<0&&(G=oe===t?h:o),L(Z)&&(G=G===o?h:o)),M.originY=G,U("skewing",H(W))(P,M,j,X))},e.dragHandler=function(P,M,j,X){var G=M.target,Z=j-M.offsetX,de=X-M.offsetY,oe=!G.get("lockMovementX")&&G.left!==Z,ie=!G.get("lockMovementY")&&G.top!==de;return oe&&G.set("left",Z),ie&&G.set("top",de),(oe||ie)&&C("moving",B(P,M,j,X)),oe||ie},e.scaleOrSkewActionName=function(P,M,j){var X=P[j.canvas.altActionKey];return M.x===0?X?"skewX":"scaleY":M.y===0?X?"skewY":"scaleX":void 0},e.rotationStyleHandler=function(P,M,j){return j.lockRotation?"not-allowed":M.cursorStyle},e.fireEvent=C,e.wrapWithFixedAnchor=H,e.wrapWithFireEvent=U,e.getLocalPoint=V,i.controlsUtils=e}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.util.degreesToRadians,l=i.controlsUtils;l.renderCircleControl=function(e,t,o,d,h){d=d||{};var c,f=this.sizeX||d.cornerSize||h.cornerSize,p=this.sizeY||d.cornerSize||h.cornerSize,y=d.transparentCorners!==void 0?d.transparentCorners:h.transparentCorners,b=y?"stroke":"fill",C=!y&&(d.cornerStrokeColor||h.cornerStrokeColor),T=t,O=o;e.save(),e.fillStyle=d.cornerColor||h.cornerColor,e.strokeStyle=d.cornerStrokeColor||h.cornerStrokeColor,f>p?(c=f,e.scale(1,p/f),O=o*f/p):p>f?(c=p,e.scale(f/p,1),T=t*p/f):c=f,e.lineWidth=1,e.beginPath(),e.arc(T,O,c/2,0,2*Math.PI,!1),e[b](),C&&e.stroke(),e.restore()},l.renderSquareControl=function(e,t,o,d,h){d=d||{};var c=this.sizeX||d.cornerSize||h.cornerSize,f=this.sizeY||d.cornerSize||h.cornerSize,p=d.transparentCorners!==void 0?d.transparentCorners:h.transparentCorners,y=p?"stroke":"fill",b=!p&&(d.cornerStrokeColor||h.cornerStrokeColor),C=c/2,T=f/2;e.save(),e.fillStyle=d.cornerColor||h.cornerColor,e.strokeStyle=d.cornerStrokeColor||h.cornerStrokeColor,e.lineWidth=1,e.translate(t,o),e.rotate(s(h.angle)),e[y+"Rect"](-C,-T,c,f),b&&e.strokeRect(-C,-T,c,f),e.restore()}}(r),function(n){var i=n.fabric||(n.fabric={});i.Control=function(s){for(var l in s)this[l]=s[l]},i.Control.prototype={visible:!0,actionName:"scale",angle:0,x:0,y:0,offsetX:0,offsetY:0,sizeX:null,sizeY:null,touchSizeX:null,touchSizeY:null,cursorStyle:"crosshair",withConnection:!1,actionHandler:function(){},mouseDownHandler:function(){},mouseUpHandler:function(){},getActionHandler:function(){return this.actionHandler},getMouseDownHandler:function(){return this.mouseDownHandler},getMouseUpHandler:function(){return this.mouseUpHandler},cursorStyleHandler:function(s,l){return l.cursorStyle},getActionName:function(s,l){return l.actionName},getVisibility:function(s,l){var e=s._controlsVisibility;return e&&e[l]!==void 0?e[l]:this.visible},setVisibility:function(s){this.visible=s},positionHandler:function(s,l){return i.util.transformPoint({x:this.x*s.x+this.offsetX,y:this.y*s.y+this.offsetY},l)},calcCornerCoords:function(s,l,e,t,o){var d,h,c,f,p=o?this.touchSizeX:this.sizeX,y=o?this.touchSizeY:this.sizeY;if(p&&y&&p!==y){var b=Math.atan2(y,p),C=Math.sqrt(p*p+y*y)/2,T=b-i.util.degreesToRadians(s),O=Math.PI/2-b-i.util.degreesToRadians(s);d=C*i.util.cos(T),h=C*i.util.sin(T),c=C*i.util.cos(O),f=C*i.util.sin(O)}else C=.7071067812*(p&&y?p:l),T=i.util.degreesToRadians(45-s),d=c=C*i.util.cos(T),h=f=C*i.util.sin(T);return{tl:{x:e-f,y:t-c},tr:{x:e+d,y:t-h},bl:{x:e-d,y:t+h},br:{x:e+f,y:t+c}}},render:function(s,l,e,t,o){((t=t||{}).cornerStyle||o.cornerStyle)==="circle"?i.controlsUtils.renderCircleControl.call(this,s,l,e,t,o):i.controlsUtils.renderSquareControl.call(this,s,l,e,t,o)}}}(r),function(){function n(s,l){var e,t,o,d,h=s.getAttribute("style"),c=s.getAttribute("offset")||0;if(c=(c=parseFloat(c)/(/%$/.test(c)?100:1))<0?0:c>1?1:c,h){var f=h.split(/\s*;\s*/);for(f[f.length-1]===""&&f.pop(),d=f.length;d--;){var p=f[d].split(/\s*:\s*/),y=p[0].trim(),b=p[1].trim();y==="stop-color"?e=b:y==="stop-opacity"&&(o=b)}}return e||(e=s.getAttribute("stop-color")||"rgb(0,0,0)"),o||(o=s.getAttribute("stop-opacity")),t=(e=new g.Color(e)).getAlpha(),o=isNaN(parseFloat(o))?1:parseFloat(o),o*=t*l,{offset:c,color:e.toRgb(),opacity:o}}var i=g.util.object.clone;g.Gradient=g.util.createClass({offsetX:0,offsetY:0,gradientTransform:null,gradientUnits:"pixels",type:"linear",initialize:function(s){s||(s={}),s.coords||(s.coords={});var l,e=this;Object.keys(s).forEach(function(t){e[t]=s[t]}),this.id?this.id+="_"+g.Object.__uid++:this.id=g.Object.__uid++,l={x1:s.coords.x1||0,y1:s.coords.y1||0,x2:s.coords.x2||0,y2:s.coords.y2||0},this.type==="radial"&&(l.r1=s.coords.r1||0,l.r2=s.coords.r2||0),this.coords=l,this.colorStops=s.colorStops.slice()},addColorStop:function(s){for(var l in s){var e=new g.Color(s[l]);this.colorStops.push({offset:parseFloat(l),color:e.toRgb(),opacity:e.getAlpha()})}return this},toObject:function(s){var l={type:this.type,coords:this.coords,colorStops:this.colorStops,offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform?this.gradientTransform.concat():this.gradientTransform};return g.util.populateWithProperties(this,l,s),l},toSVG:function(s,l){var e,t,o,d,h=i(this.coords,!0),c=(l=l||{},i(this.colorStops,!0)),f=h.r1>h.r2,p=this.gradientTransform?this.gradientTransform.concat():g.iMatrix.concat(),y=-this.offsetX,b=-this.offsetY,C=!!l.additionalTransform,T=this.gradientUnits==="pixels"?"userSpaceOnUse":"objectBoundingBox";if(c.sort(function(H,U){return H.offset-U.offset}),T==="objectBoundingBox"?(y/=s.width,b/=s.height):(y+=s.width/2,b+=s.height/2),s.type==="path"&&this.gradientUnits!=="percentage"&&(y-=s.pathOffset.x,b-=s.pathOffset.y),p[4]-=y,p[5]-=b,d='id="SVGID_'+this.id+'" gradientUnits="'+T+'"',d+=' gradientTransform="'+(C?l.additionalTransform+" ":"")+g.util.matrixToSVG(p)+'" ',this.type==="linear"?o=["<linearGradient ",d,' x1="',h.x1,'" y1="',h.y1,'" x2="',h.x2,'" y2="',h.y2,`">
`]:this.type==="radial"&&(o=["<radialGradient ",d,' cx="',f?h.x1:h.x2,'" cy="',f?h.y1:h.y2,'" r="',f?h.r1:h.r2,'" fx="',f?h.x2:h.x1,'" fy="',f?h.y2:h.y1,`">
`]),this.type==="radial"){if(f)for((c=c.concat()).reverse(),e=0,t=c.length;e<t;e++)c[e].offset=1-c[e].offset;var O=Math.min(h.r1,h.r2);if(O>0){var F=O/Math.max(h.r1,h.r2);for(e=0,t=c.length;e<t;e++)c[e].offset+=F*(1-c[e].offset)}}for(e=0,t=c.length;e<t;e++){var B=c[e];o.push("<stop ",'offset="',100*B.offset+"%",'" style="stop-color:',B.color,B.opacity!==void 0?";stop-opacity: "+B.opacity:";",`"/>
`)}return o.push(this.type==="linear"?`</linearGradient>
`:`</radialGradient>
`),o.join("")},toLive:function(s){var l,e,t,o=g.util.object.clone(this.coords);if(this.type){for(this.type==="linear"?l=s.createLinearGradient(o.x1,o.y1,o.x2,o.y2):this.type==="radial"&&(l=s.createRadialGradient(o.x1,o.y1,o.r1,o.x2,o.y2,o.r2)),e=0,t=this.colorStops.length;e<t;e++){var d=this.colorStops[e].color,h=this.colorStops[e].opacity,c=this.colorStops[e].offset;h!==void 0&&(d=new g.Color(d).setAlpha(h).toRgba()),l.addColorStop(c,d)}return l}}}),g.util.object.extend(g.Gradient,{fromElement:function(s,l,e,t){var o=parseFloat(e)/(/%$/.test(e)?100:1);o=o<0?0:o>1?1:o,isNaN(o)&&(o=1);var d,h,c,f,p=s.getElementsByTagName("stop"),y=s.getAttribute("gradientUnits")==="userSpaceOnUse"?"pixels":"percentage",b=s.getAttribute("gradientTransform")||"",C=[],T=0,O=0;for(s.nodeName==="linearGradient"||s.nodeName==="LINEARGRADIENT"?(d="linear",h=function(F){return{x1:F.getAttribute("x1")||0,y1:F.getAttribute("y1")||0,x2:F.getAttribute("x2")||"100%",y2:F.getAttribute("y2")||0}}(s)):(d="radial",h=function(F){return{x1:F.getAttribute("fx")||F.getAttribute("cx")||"50%",y1:F.getAttribute("fy")||F.getAttribute("cy")||"50%",r1:0,x2:F.getAttribute("cx")||"50%",y2:F.getAttribute("cy")||"50%",r2:F.getAttribute("r")||"50%"}}(s)),c=p.length;c--;)C.push(n(p[c],o));return f=g.parseTransformAttribute(b),function(F,B,H,U){var V,L;Object.keys(B).forEach(function(R){(V=B[R])==="Infinity"?L=1:V==="-Infinity"?L=0:(L=parseFloat(B[R],10),typeof V=="string"&&/^(\d+\.\d+)%|(\d+)%$/.test(V)&&(L*=.01,U==="pixels"&&(R!=="x1"&&R!=="x2"&&R!=="r2"||(L*=H.viewBoxWidth||H.width),R!=="y1"&&R!=="y2"||(L*=H.viewBoxHeight||H.height)))),B[R]=L})}(0,h,t,y),y==="pixels"&&(T=-l.left,O=-l.top),new g.Gradient({id:s.getAttribute("id"),type:d,coords:h,colorStops:C,gradientUnits:y,gradientTransform:f,offsetX:T,offsetY:O})}})}(),te=g.util.toFixed,g.Pattern=g.util.createClass({repeat:"repeat",offsetX:0,offsetY:0,crossOrigin:"",patternTransform:null,initialize:function(n,i){if(n||(n={}),this.id=g.Object.__uid++,this.setOptions(n),!n.source||n.source&&typeof n.source!="string")i&&i(this);else{var s=this;this.source=g.util.createImage(),g.util.loadImage(n.source,function(l,e){s.source=l,i&&i(s,e)},null,this.crossOrigin)}},toObject:function(n){var i,s,l=g.Object.NUM_FRACTION_DIGITS;return typeof this.source.src=="string"?i=this.source.src:typeof this.source=="object"&&this.source.toDataURL&&(i=this.source.toDataURL()),s={type:"pattern",source:i,repeat:this.repeat,crossOrigin:this.crossOrigin,offsetX:te(this.offsetX,l),offsetY:te(this.offsetY,l),patternTransform:this.patternTransform?this.patternTransform.concat():null},g.util.populateWithProperties(this,s,n),s},toSVG:function(n){var i=typeof this.source=="function"?this.source():this.source,s=i.width/n.width,l=i.height/n.height,e=this.offsetX/n.width,t=this.offsetY/n.height,o="";return this.repeat!=="repeat-x"&&this.repeat!=="no-repeat"||(l=1,t&&(l+=Math.abs(t))),this.repeat!=="repeat-y"&&this.repeat!=="no-repeat"||(s=1,e&&(s+=Math.abs(e))),i.src?o=i.src:i.toDataURL&&(o=i.toDataURL()),'<pattern id="SVGID_'+this.id+'" x="'+e+'" y="'+t+'" width="'+s+'" height="'+l+`">
<image x="0" y="0" width="`+i.width+'" height="'+i.height+'" xlink:href="'+o+`"></image>
</pattern>
`},setOptions:function(n){for(var i in n)this[i]=n[i]},toLive:function(n){var i=this.source;return!i||i.src!==void 0&&(!i.complete||i.naturalWidth===0||i.naturalHeight===0)?"":n.createPattern(i,this.repeat)}}),function(n){var i=n.fabric||(n.fabric={}),s=i.util.toFixed;i.Shadow?i.warn("fabric.Shadow is already defined."):(i.Shadow=i.util.createClass({color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1,initialize:function(l){for(var e in typeof l=="string"&&(l=this._parseShadow(l)),l)this[e]=l[e];this.id=i.Object.__uid++},_parseShadow:function(l){var e=l.trim(),t=i.Shadow.reOffsetsAndBlur.exec(e)||[];return{color:(e.replace(i.Shadow.reOffsetsAndBlur,"")||"rgb(0,0,0)").trim(),offsetX:parseFloat(t[1],10)||0,offsetY:parseFloat(t[2],10)||0,blur:parseFloat(t[3],10)||0}},toString:function(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")},toSVG:function(l){var e=40,t=40,o=i.Object.NUM_FRACTION_DIGITS,d=i.util.rotateVector({x:this.offsetX,y:this.offsetY},i.util.degreesToRadians(-l.angle)),h=new i.Color(this.color);return l.width&&l.height&&(e=100*s((Math.abs(d.x)+this.blur)/l.width,o)+20,t=100*s((Math.abs(d.y)+this.blur)/l.height,o)+20),l.flipX&&(d.x*=-1),l.flipY&&(d.y*=-1),'<filter id="SVGID_'+this.id+'" y="-'+t+'%" height="'+(100+2*t)+'%" x="-'+e+'%" width="'+(100+2*e)+`%" >
	<feGaussianBlur in="SourceAlpha" stdDeviation="`+s(this.blur?this.blur/2:0,o)+`"></feGaussianBlur>
	<feOffset dx="`+s(d.x,o)+'" dy="'+s(d.y,o)+`" result="oBlur" ></feOffset>
	<feFlood flood-color="`+h.toRgb()+'" flood-opacity="'+h.getAlpha()+`"/>
	<feComposite in2="oBlur" operator="in" />
	<feMerge>
		<feMergeNode></feMergeNode>
		<feMergeNode in="SourceGraphic"></feMergeNode>
	</feMerge>
</filter>
`},toObject:function(){if(this.includeDefaultValues)return{color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling};var l={},e=i.Shadow.prototype;return["color","blur","offsetX","offsetY","affectStroke","nonScaling"].forEach(function(t){this[t]!==e[t]&&(l[t]=this[t])},this),l}}),i.Shadow.reOffsetsAndBlur=/(?:\s|^)(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(\d+(?:\.\d*)?(?:px)?)?(?:\s?|$)(?:$|\s)/)}(r),function(){if(g.StaticCanvas)g.warn("fabric.StaticCanvas is already defined.");else{var n=g.util.object.extend,i=g.util.getElementOffset,s=g.util.removeFromArray,l=g.util.toFixed,e=g.util.transformPoint,t=g.util.invertTransform,o=g.util.getNodeCanvas,d=g.util.createCanvasElement,h=new Error("Could not initialize `canvas` element");g.StaticCanvas=g.util.createClass(g.CommonMethods,{initialize:function(c,f){f||(f={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(c,f)},backgroundColor:"",backgroundImage:null,overlayColor:"",overlayImage:null,includeDefaultValues:!0,stateful:!1,renderOnAddRemove:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,imageSmoothingEnabled:!0,viewportTransform:g.iMatrix.concat(),backgroundVpt:!0,overlayVpt:!0,enableRetinaScaling:!0,vptCoords:{},skipOffscreen:!0,clipPath:void 0,_initStatic:function(c,f){var p=this.requestRenderAllBound;this._objects=[],this._createLowerCanvas(c),this._initOptions(f),this.interactive||this._initRetinaScaling(),f.overlayImage&&this.setOverlayImage(f.overlayImage,p),f.backgroundImage&&this.setBackgroundImage(f.backgroundImage,p),f.backgroundColor&&this.setBackgroundColor(f.backgroundColor,p),f.overlayColor&&this.setOverlayColor(f.overlayColor,p),this.calcOffset()},_isRetinaScaling:function(){return g.devicePixelRatio>1&&this.enableRetinaScaling},getRetinaScaling:function(){return this._isRetinaScaling()?Math.max(1,g.devicePixelRatio):1},_initRetinaScaling:function(){if(this._isRetinaScaling()){var c=g.devicePixelRatio;this.__initRetinaScaling(c,this.lowerCanvasEl,this.contextContainer),this.upperCanvasEl&&this.__initRetinaScaling(c,this.upperCanvasEl,this.contextTop)}},__initRetinaScaling:function(c,f,p){f.setAttribute("width",this.width*c),f.setAttribute("height",this.height*c),p.scale(c,c)},calcOffset:function(){return this._offset=i(this.lowerCanvasEl),this},setOverlayImage:function(c,f,p){return this.__setBgOverlayImage("overlayImage",c,f,p)},setBackgroundImage:function(c,f,p){return this.__setBgOverlayImage("backgroundImage",c,f,p)},setOverlayColor:function(c,f){return this.__setBgOverlayColor("overlayColor",c,f)},setBackgroundColor:function(c,f){return this.__setBgOverlayColor("backgroundColor",c,f)},__setBgOverlayImage:function(c,f,p,y){return typeof f=="string"?g.util.loadImage(f,function(b,C){if(b){var T=new g.Image(b,y);this[c]=T,T.canvas=this}p&&p(b,C)},this,y&&y.crossOrigin):(y&&f.setOptions(y),this[c]=f,f&&(f.canvas=this),p&&p(f,!1)),this},__setBgOverlayColor:function(c,f,p){return this[c]=f,this._initGradient(f,c),this._initPattern(f,c,p),this},_createCanvasElement:function(){var c=d();if(!c||(c.style||(c.style={}),c.getContext===void 0))throw h;return c},_initOptions:function(c){var f=this.lowerCanvasEl;this._setOptions(c),this.width=this.width||parseInt(f.width,10)||0,this.height=this.height||parseInt(f.height,10)||0,this.lowerCanvasEl.style&&(f.width=this.width,f.height=this.height,f.style.width=this.width+"px",f.style.height=this.height+"px",this.viewportTransform=this.viewportTransform.slice())},_createLowerCanvas:function(c){c&&c.getContext?this.lowerCanvasEl=c:this.lowerCanvasEl=g.util.getById(c)||this._createCanvasElement(),g.util.addClass(this.lowerCanvasEl,"lower-canvas"),this._originalCanvasStyle=this.lowerCanvasEl.style,this.interactive&&this._applyCanvasStyle(this.lowerCanvasEl),this.contextContainer=this.lowerCanvasEl.getContext("2d")},getWidth:function(){return this.width},getHeight:function(){return this.height},setWidth:function(c,f){return this.setDimensions({width:c},f)},setHeight:function(c,f){return this.setDimensions({height:c},f)},setDimensions:function(c,f){var p;for(var y in f=f||{},c)p=c[y],f.cssOnly||(this._setBackstoreDimension(y,c[y]),p+="px",this.hasLostContext=!0),f.backstoreOnly||this._setCssDimension(y,p);return this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(this.contextTop),this._initRetinaScaling(),this.calcOffset(),f.cssOnly||this.requestRenderAll(),this},_setBackstoreDimension:function(c,f){return this.lowerCanvasEl[c]=f,this.upperCanvasEl&&(this.upperCanvasEl[c]=f),this.cacheCanvasEl&&(this.cacheCanvasEl[c]=f),this[c]=f,this},_setCssDimension:function(c,f){return this.lowerCanvasEl.style[c]=f,this.upperCanvasEl&&(this.upperCanvasEl.style[c]=f),this.wrapperEl&&(this.wrapperEl.style[c]=f),this},getZoom:function(){return this.viewportTransform[0]},setViewportTransform:function(c){var f,p,y,b=this._activeObject,C=this.backgroundImage,T=this.overlayImage;for(this.viewportTransform=c,p=0,y=this._objects.length;p<y;p++)(f=this._objects[p]).group||f.setCoords(!0);return b&&b.setCoords(),C&&C.setCoords(!0),T&&T.setCoords(!0),this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll(),this},zoomToPoint:function(c,f){var p=c,y=this.viewportTransform.slice(0);c=e(c,t(this.viewportTransform)),y[0]=f,y[3]=f;var b=e(c,y);return y[4]+=p.x-b.x,y[5]+=p.y-b.y,this.setViewportTransform(y)},setZoom:function(c){return this.zoomToPoint(new g.Point(0,0),c),this},absolutePan:function(c){var f=this.viewportTransform.slice(0);return f[4]=-c.x,f[5]=-c.y,this.setViewportTransform(f)},relativePan:function(c){return this.absolutePan(new g.Point(-c.x-this.viewportTransform[4],-c.y-this.viewportTransform[5]))},getElement:function(){return this.lowerCanvasEl},_onObjectAdded:function(c){this.stateful&&c.setupState(),c._set("canvas",this),c.setCoords(),this.fire("object:added",{target:c}),c.fire("added")},_onObjectRemoved:function(c){this.fire("object:removed",{target:c}),c.fire("removed"),delete c.canvas},clearContext:function(c){return c.clearRect(0,0,this.width,this.height),this},getContext:function(){return this.contextContainer},clear:function(){return this.remove.apply(this,this.getObjects()),this.backgroundImage=null,this.overlayImage=null,this.backgroundColor="",this.overlayColor="",this._hasITextHandlers&&(this.off("mouse:up",this._mouseUpITextHandler),this._iTextInstances=null,this._hasITextHandlers=!1),this.clearContext(this.contextContainer),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll(),this},renderAll:function(){var c=this.contextContainer;return this.renderCanvas(c,this._objects),this},renderAndReset:function(){this.isRendering=0,this.renderAll()},requestRenderAll:function(){return this.isRendering||(this.isRendering=g.util.requestAnimFrame(this.renderAndResetBound)),this},calcViewportBoundaries:function(){var c={},f=this.width,p=this.height,y=t(this.viewportTransform);return c.tl=e({x:0,y:0},y),c.br=e({x:f,y:p},y),c.tr=new g.Point(c.br.x,c.tl.y),c.bl=new g.Point(c.tl.x,c.br.y),this.vptCoords=c,c},cancelRequestedRender:function(){this.isRendering&&(g.util.cancelAnimFrame(this.isRendering),this.isRendering=0)},renderCanvas:function(c,f){var p=this.viewportTransform,y=this.clipPath;this.cancelRequestedRender(),this.calcViewportBoundaries(),this.clearContext(c),g.util.setImageSmoothing(c,this.imageSmoothingEnabled),this.fire("before:render",{ctx:c}),this._renderBackground(c),c.save(),c.transform(p[0],p[1],p[2],p[3],p[4],p[5]),this._renderObjects(c,f),c.restore(),!this.controlsAboveOverlay&&this.interactive&&this.drawControls(c),y&&(y.canvas=this,y.shouldCache(),y._transformDone=!0,y.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(c)),this._renderOverlay(c),this.controlsAboveOverlay&&this.interactive&&this.drawControls(c),this.fire("after:render",{ctx:c})},drawClipPathOnCanvas:function(c){var f=this.viewportTransform,p=this.clipPath;c.save(),c.transform(f[0],f[1],f[2],f[3],f[4],f[5]),c.globalCompositeOperation="destination-in",p.transform(c),c.scale(1/p.zoomX,1/p.zoomY),c.drawImage(p._cacheCanvas,-p.cacheTranslationX,-p.cacheTranslationY),c.restore()},_renderObjects:function(c,f){var p,y;for(p=0,y=f.length;p<y;++p)f[p]&&f[p].render(c)},_renderBackgroundOrOverlay:function(c,f){var p=this[f+"Color"],y=this[f+"Image"],b=this.viewportTransform,C=this[f+"Vpt"];if(p||y){if(p){c.save(),c.beginPath(),c.moveTo(0,0),c.lineTo(this.width,0),c.lineTo(this.width,this.height),c.lineTo(0,this.height),c.closePath(),c.fillStyle=p.toLive?p.toLive(c,this):p,C&&c.transform(b[0],b[1],b[2],b[3],b[4],b[5]),c.transform(1,0,0,1,p.offsetX||0,p.offsetY||0);var T=p.gradientTransform||p.patternTransform;T&&c.transform(T[0],T[1],T[2],T[3],T[4],T[5]),c.fill(),c.restore()}y&&(c.save(),C&&c.transform(b[0],b[1],b[2],b[3],b[4],b[5]),y.render(c),c.restore())}},_renderBackground:function(c){this._renderBackgroundOrOverlay(c,"background")},_renderOverlay:function(c){this._renderBackgroundOrOverlay(c,"overlay")},getCenter:function(){return{top:this.height/2,left:this.width/2}},getCenterPoint:function(){return new g.Point(this.width/2,this.height/2)},centerObjectH:function(c){return this._centerObject(c,new g.Point(this.getCenterPoint().x,c.getCenterPoint().y))},centerObjectV:function(c){return this._centerObject(c,new g.Point(c.getCenterPoint().x,this.getCenterPoint().y))},centerObject:function(c){var f=this.getCenterPoint();return this._centerObject(c,f)},viewportCenterObject:function(c){var f=this.getVpCenter();return this._centerObject(c,f)},viewportCenterObjectH:function(c){var f=this.getVpCenter();return this._centerObject(c,new g.Point(f.x,c.getCenterPoint().y)),this},viewportCenterObjectV:function(c){var f=this.getVpCenter();return this._centerObject(c,new g.Point(c.getCenterPoint().x,f.y))},getVpCenter:function(){var c=this.getCenterPoint(),f=t(this.viewportTransform);return e(c,f)},_centerObject:function(c,f){return c.setPositionByOrigin(f,"center","center"),c.setCoords(),this.renderOnAddRemove&&this.requestRenderAll(),this},toDatalessJSON:function(c){return this.toDatalessObject(c)},toObject:function(c){return this._toObjectMethod("toObject",c)},toDatalessObject:function(c){return this._toObjectMethod("toDatalessObject",c)},_toObjectMethod:function(c,f){var p=this.clipPath,y={version:g.version,objects:this._toObjects(c,f)};return p&&!p.excludeFromExport&&(y.clipPath=this._toObject(this.clipPath,c,f)),n(y,this.__serializeBgOverlay(c,f)),g.util.populateWithProperties(this,y,f),y},_toObjects:function(c,f){return this._objects.filter(function(p){return!p.excludeFromExport}).map(function(p){return this._toObject(p,c,f)},this)},_toObject:function(c,f,p){var y;this.includeDefaultValues||(y=c.includeDefaultValues,c.includeDefaultValues=!1);var b=c[f](p);return this.includeDefaultValues||(c.includeDefaultValues=y),b},__serializeBgOverlay:function(c,f){var p={},y=this.backgroundImage,b=this.overlayImage,C=this.backgroundColor,T=this.overlayColor;return C&&C.toObject?C.excludeFromExport||(p.background=C.toObject(f)):C&&(p.background=C),T&&T.toObject?T.excludeFromExport||(p.overlay=T.toObject(f)):T&&(p.overlay=T),y&&!y.excludeFromExport&&(p.backgroundImage=this._toObject(y,c,f)),b&&!b.excludeFromExport&&(p.overlayImage=this._toObject(b,c,f)),p},svgViewportTransformation:!0,toSVG:function(c,f){c||(c={}),c.reviver=f;var p=[];return this._setSVGPreamble(p,c),this._setSVGHeader(p,c),this.clipPath&&p.push('<g clip-path="url(#'+this.clipPath.clipPathId+`)" >
`),this._setSVGBgOverlayColor(p,"background"),this._setSVGBgOverlayImage(p,"backgroundImage",f),this._setSVGObjects(p,f),this.clipPath&&p.push(`</g>
`),this._setSVGBgOverlayColor(p,"overlay"),this._setSVGBgOverlayImage(p,"overlayImage",f),p.push("</svg>"),p.join("")},_setSVGPreamble:function(c,f){f.suppressPreamble||c.push('<?xml version="1.0" encoding="',f.encoding||"UTF-8",`" standalone="no" ?>
`,'<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ',`"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
`)},_setSVGHeader:function(c,f){var p,y=f.width||this.width,b=f.height||this.height,C='viewBox="0 0 '+this.width+" "+this.height+'" ',T=g.Object.NUM_FRACTION_DIGITS;f.viewBox?C='viewBox="'+f.viewBox.x+" "+f.viewBox.y+" "+f.viewBox.width+" "+f.viewBox.height+'" ':this.svgViewportTransformation&&(p=this.viewportTransform,C='viewBox="'+l(-p[4]/p[0],T)+" "+l(-p[5]/p[3],T)+" "+l(this.width/p[0],T)+" "+l(this.height/p[3],T)+'" '),c.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',y,'" ','height="',b,'" ',C,`xml:space="preserve">
`,"<desc>Created with Fabric.js ",g.version,`</desc>
`,`<defs>
`,this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(f),`</defs>
`)},createSVGClipPathMarkup:function(c){var f=this.clipPath;return f?(f.clipPathId="CLIPPATH_"+g.Object.__uid++,'<clipPath id="'+f.clipPathId+`" >
`+this.clipPath.toClipPathSVG(c.reviver)+`</clipPath>
`):""},createSVGRefElementsMarkup:function(){var c=this;return["background","overlay"].map(function(f){var p=c[f+"Color"];if(p&&p.toLive){var y=c[f+"Vpt"],b=c.viewportTransform,C={width:c.width/(y?b[0]:1),height:c.height/(y?b[3]:1)};return p.toSVG(C,{additionalTransform:y?g.util.matrixToSVG(b):""})}}).join("")},createSVGFontFacesMarkup:function(){var c,f,p,y,b,C,T,O,F="",B={},H=g.fontPaths,U=[];for(this._objects.forEach(function L(R){U.push(R),R._objects&&R._objects.forEach(L)}),T=0,O=U.length;T<O;T++)if(f=(c=U[T]).fontFamily,c.type.indexOf("text")!==-1&&!B[f]&&H[f]&&(B[f]=!0,c.styles))for(b in p=c.styles)for(C in y=p[b])!B[f=y[C].fontFamily]&&H[f]&&(B[f]=!0);for(var V in B)F+=[`		@font-face {
`,"			font-family: '",V,`';
`,"			src: url('",H[V],`');
`,`		}
`].join("");return F&&(F=['	<style type="text/css">',`<![CDATA[
`,F,"]]>",`</style>
`].join("")),F},_setSVGObjects:function(c,f){var p,y,b,C=this._objects;for(y=0,b=C.length;y<b;y++)(p=C[y]).excludeFromExport||this._setSVGObject(c,p,f)},_setSVGObject:function(c,f,p){c.push(f.toSVG(p))},_setSVGBgOverlayImage:function(c,f,p){this[f]&&!this[f].excludeFromExport&&this[f].toSVG&&c.push(this[f].toSVG(p))},_setSVGBgOverlayColor:function(c,f){var p=this[f+"Color"],y=this.viewportTransform,b=this.width,C=this.height;if(p)if(p.toLive){var T=p.repeat,O=g.util.invertTransform(y),F=this[f+"Vpt"]?g.util.matrixToSVG(O):"";c.push('<rect transform="'+F+" translate(",b/2,",",C/2,')"',' x="',p.offsetX-b/2,'" y="',p.offsetY-C/2,'" ','width="',T==="repeat-y"||T==="no-repeat"?p.source.width:b,'" height="',T==="repeat-x"||T==="no-repeat"?p.source.height:C,'" fill="url(#SVGID_'+p.id+')"',`></rect>
`)}else c.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',p,'"',`></rect>
`)},sendToBack:function(c){if(!c)return this;var f,p,y,b=this._activeObject;if(c===b&&c.type==="activeSelection")for(f=(y=b._objects).length;f--;)p=y[f],s(this._objects,p),this._objects.unshift(p);else s(this._objects,c),this._objects.unshift(c);return this.renderOnAddRemove&&this.requestRenderAll(),this},bringToFront:function(c){if(!c)return this;var f,p,y,b=this._activeObject;if(c===b&&c.type==="activeSelection")for(y=b._objects,f=0;f<y.length;f++)p=y[f],s(this._objects,p),this._objects.push(p);else s(this._objects,c),this._objects.push(c);return this.renderOnAddRemove&&this.requestRenderAll(),this},sendBackwards:function(c,f){if(!c)return this;var p,y,b,C,T,O=this._activeObject,F=0;if(c===O&&c.type==="activeSelection")for(T=O._objects,p=0;p<T.length;p++)y=T[p],(b=this._objects.indexOf(y))>0+F&&(C=b-1,s(this._objects,y),this._objects.splice(C,0,y)),F++;else(b=this._objects.indexOf(c))!==0&&(C=this._findNewLowerIndex(c,b,f),s(this._objects,c),this._objects.splice(C,0,c));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewLowerIndex:function(c,f,p){var y,b;if(p){for(y=f,b=f-1;b>=0;--b)if(c.intersectsWithObject(this._objects[b])||c.isContainedWithinObject(this._objects[b])||this._objects[b].isContainedWithinObject(c)){y=b;break}}else y=f-1;return y},bringForward:function(c,f){if(!c)return this;var p,y,b,C,T,O=this._activeObject,F=0;if(c===O&&c.type==="activeSelection")for(p=(T=O._objects).length;p--;)y=T[p],(b=this._objects.indexOf(y))<this._objects.length-1-F&&(C=b+1,s(this._objects,y),this._objects.splice(C,0,y)),F++;else(b=this._objects.indexOf(c))!==this._objects.length-1&&(C=this._findNewUpperIndex(c,b,f),s(this._objects,c),this._objects.splice(C,0,c));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewUpperIndex:function(c,f,p){var y,b,C;if(p){for(y=f,b=f+1,C=this._objects.length;b<C;++b)if(c.intersectsWithObject(this._objects[b])||c.isContainedWithinObject(this._objects[b])||this._objects[b].isContainedWithinObject(c)){y=b;break}}else y=f+1;return y},moveTo:function(c,f){return s(this._objects,c),this._objects.splice(f,0,c),this.renderOnAddRemove&&this.requestRenderAll()},dispose:function(){return this.isRendering&&(g.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(c){c.dispose&&c.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),g.util.setStyle(this.lowerCanvasEl,this._originalCanvasStyle),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),g.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},toString:function(){return"#<fabric.Canvas ("+this.complexity()+"): { objects: "+this._objects.length+" }>"}}),n(g.StaticCanvas.prototype,g.Observable),n(g.StaticCanvas.prototype,g.Collection),n(g.StaticCanvas.prototype,g.DataURLExporter),n(g.StaticCanvas,{EMPTY_JSON:'{"objects": [], "background": "white"}',supports:function(c){var f=d();if(!f||!f.getContext)return null;var p=f.getContext("2d");return p&&c==="setLineDash"?p.setLineDash!==void 0:null}}),g.StaticCanvas.prototype.toJSON=g.StaticCanvas.prototype.toObject,g.isLikelyNode&&(g.StaticCanvas.prototype.createPNGStream=function(){var c=o(this.lowerCanvasEl);return c&&c.createPNGStream()},g.StaticCanvas.prototype.createJPEGStream=function(c){var f=o(this.lowerCanvasEl);return f&&f.createJPEGStream(c)})}}(),g.BaseBrush=g.util.createClass({color:"rgb(0, 0, 0)",width:1,shadow:null,strokeLineCap:"round",strokeLineJoin:"round",strokeMiterLimit:10,strokeDashArray:null,limitedToCanvasSize:!1,_setBrushStyles:function(n){n.strokeStyle=this.color,n.lineWidth=this.width,n.lineCap=this.strokeLineCap,n.miterLimit=this.strokeMiterLimit,n.lineJoin=this.strokeLineJoin,n.setLineDash(this.strokeDashArray||[])},_saveAndTransform:function(n){var i=this.canvas.viewportTransform;n.save(),n.transform(i[0],i[1],i[2],i[3],i[4],i[5])},_setShadow:function(){if(this.shadow){var n=this.canvas,i=this.shadow,s=n.contextTop,l=n.getZoom();n&&n._isRetinaScaling()&&(l*=g.devicePixelRatio),s.shadowColor=i.color,s.shadowBlur=i.blur*l,s.shadowOffsetX=i.offsetX*l,s.shadowOffsetY=i.offsetY*l}},needsFullRender:function(){return new g.Color(this.color).getAlpha()<1||!!this.shadow},_resetShadow:function(){var n=this.canvas.contextTop;n.shadowColor="",n.shadowBlur=n.shadowOffsetX=n.shadowOffsetY=0},_isOutSideCanvas:function(n){return n.x<0||n.x>this.canvas.getWidth()||n.y<0||n.y>this.canvas.getHeight()}}),g.PencilBrush=g.util.createClass(g.BaseBrush,{decimate:.4,drawStraightLine:!1,straightLineKey:"shiftKey",initialize:function(n){this.canvas=n,this._points=[]},needsFullRender:function(){return this.callSuper("needsFullRender")||this._hasStraightLine},_drawSegment:function(n,i,s){var l=i.midPointFrom(s);return n.quadraticCurveTo(i.x,i.y,l.x,l.y),l},onMouseDown:function(n,i){this.canvas._isMainEvent(i.e)&&(this.drawStraightLine=i.e[this.straightLineKey],this._prepareForDrawing(n),this._captureDrawingPath(n),this._render())},onMouseMove:function(n,i){if(this.canvas._isMainEvent(i.e)&&(this.drawStraightLine=i.e[this.straightLineKey],(this.limitedToCanvasSize!==!0||!this._isOutSideCanvas(n))&&this._captureDrawingPath(n)&&this._points.length>1))if(this.needsFullRender())this.canvas.clearContext(this.canvas.contextTop),this._render();else{var s=this._points,l=s.length,e=this.canvas.contextTop;this._saveAndTransform(e),this.oldEnd&&(e.beginPath(),e.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=this._drawSegment(e,s[l-2],s[l-1],!0),e.stroke(),e.restore()}},onMouseUp:function(n){return!this.canvas._isMainEvent(n.e)||(this.drawStraightLine=!1,this.oldEnd=void 0,this._finalizeAndAddPath(),!1)},_prepareForDrawing:function(n){var i=new g.Point(n.x,n.y);this._reset(),this._addPoint(i),this.canvas.contextTop.moveTo(i.x,i.y)},_addPoint:function(n){return!(this._points.length>1&&n.eq(this._points[this._points.length-1])||(this.drawStraightLine&&this._points.length>1&&(this._hasStraightLine=!0,this._points.pop()),this._points.push(n),0))},_reset:function(){this._points=[],this._setBrushStyles(this.canvas.contextTop),this._setShadow(),this._hasStraightLine=!1},_captureDrawingPath:function(n){var i=new g.Point(n.x,n.y);return this._addPoint(i)},_render:function(n){var i,s,l=this._points[0],e=this._points[1];if(n=n||this.canvas.contextTop,this._saveAndTransform(n),n.beginPath(),this._points.length===2&&l.x===e.x&&l.y===e.y){var t=this.width/1e3;l=new g.Point(l.x,l.y),e=new g.Point(e.x,e.y),l.x-=t,e.x+=t}for(n.moveTo(l.x,l.y),i=1,s=this._points.length;i<s;i++)this._drawSegment(n,l,e),l=this._points[i],e=this._points[i+1];n.lineTo(l.x,l.y),n.stroke(),n.restore()},convertPointsToSVGPath:function(n){var i=this.width/1e3;return g.util.getSmoothPathFromPoints(n,i)},_isEmptySVGPath:function(n){return g.util.joinPath(n)==="M 0 0 Q 0 0 0 0 L 0 0"},createPath:function(n){var i=new g.Path(n,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeMiterLimit:this.strokeMiterLimit,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray});return this.shadow&&(this.shadow.affectStroke=!0,i.shadow=new g.Shadow(this.shadow)),i},decimatePoints:function(n,i){if(n.length<=2)return n;var s,l=this.canvas.getZoom(),e=Math.pow(i/l,2),t=n.length-1,o=n[0],d=[o];for(s=1;s<t-1;s++)Math.pow(o.x-n[s].x,2)+Math.pow(o.y-n[s].y,2)>=e&&(o=n[s],d.push(o));return d.push(n[t]),d},_finalizeAndAddPath:function(){this.canvas.contextTop.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate));var n=this.convertPointsToSVGPath(this._points);if(this._isEmptySVGPath(n))this.canvas.requestRenderAll();else{var i=this.createPath(n);this.canvas.clearContext(this.canvas.contextTop),this.canvas.fire("before:path:created",{path:i}),this.canvas.add(i),this.canvas.requestRenderAll(),i.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:i})}}}),g.CircleBrush=g.util.createClass(g.BaseBrush,{width:10,initialize:function(n){this.canvas=n,this.points=[]},drawDot:function(n){var i=this.addPoint(n),s=this.canvas.contextTop;this._saveAndTransform(s),this.dot(s,i),s.restore()},dot:function(n,i){n.fillStyle=i.fill,n.beginPath(),n.arc(i.x,i.y,i.radius,0,2*Math.PI,!1),n.closePath(),n.fill()},onMouseDown:function(n){this.points.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.drawDot(n)},_render:function(){var n,i,s=this.canvas.contextTop,l=this.points;for(this._saveAndTransform(s),n=0,i=l.length;n<i;n++)this.dot(s,l[n]);s.restore()},onMouseMove:function(n){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(n)||(this.needsFullRender()?(this.canvas.clearContext(this.canvas.contextTop),this.addPoint(n),this._render()):this.drawDot(n))},onMouseUp:function(){var n,i,s=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;var l=[];for(n=0,i=this.points.length;n<i;n++){var e=this.points[n],t=new g.Circle({radius:e.radius,left:e.x,top:e.y,originX:"center",originY:"center",fill:e.fill});this.shadow&&(t.shadow=new g.Shadow(this.shadow)),l.push(t)}var o=new g.Group(l);o.canvas=this.canvas,this.canvas.fire("before:path:created",{path:o}),this.canvas.add(o),this.canvas.fire("path:created",{path:o}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=s,this.canvas.requestRenderAll()},addPoint:function(n){var i=new g.Point(n.x,n.y),s=g.util.getRandomInt(Math.max(0,this.width-20),this.width+20)/2,l=new g.Color(this.color).setAlpha(g.util.getRandomInt(0,100)/100).toRgba();return i.radius=s,i.fill=l,this.points.push(i),i}}),g.SprayBrush=g.util.createClass(g.BaseBrush,{width:10,density:20,dotWidth:1,dotWidthVariance:1,randomOpacity:!1,optimizeOverlapping:!0,initialize:function(n){this.canvas=n,this.sprayChunks=[]},onMouseDown:function(n){this.sprayChunks.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.addSprayChunk(n),this.render(this.sprayChunkPoints)},onMouseMove:function(n){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(n)||(this.addSprayChunk(n),this.render(this.sprayChunkPoints))},onMouseUp:function(){var n=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;for(var i=[],s=0,l=this.sprayChunks.length;s<l;s++)for(var e=this.sprayChunks[s],t=0,o=e.length;t<o;t++){var d=new g.Rect({width:e[t].width,height:e[t].width,left:e[t].x+1,top:e[t].y+1,originX:"center",originY:"center",fill:this.color});i.push(d)}this.optimizeOverlapping&&(i=this._getOptimizedRects(i));var h=new g.Group(i);this.shadow&&h.set("shadow",new g.Shadow(this.shadow)),this.canvas.fire("before:path:created",{path:h}),this.canvas.add(h),this.canvas.fire("path:created",{path:h}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=n,this.canvas.requestRenderAll()},_getOptimizedRects:function(n){var i,s,l,e={};for(s=0,l=n.length;s<l;s++)e[i=n[s].left+""+n[s].top]||(e[i]=n[s]);var t=[];for(i in e)t.push(e[i]);return t},render:function(n){var i,s,l=this.canvas.contextTop;for(l.fillStyle=this.color,this._saveAndTransform(l),i=0,s=n.length;i<s;i++){var e=n[i];e.opacity!==void 0&&(l.globalAlpha=e.opacity),l.fillRect(e.x,e.y,e.width,e.width)}l.restore()},_render:function(){var n,i,s=this.canvas.contextTop;for(s.fillStyle=this.color,this._saveAndTransform(s),n=0,i=this.sprayChunks.length;n<i;n++)this.render(this.sprayChunks[n]);s.restore()},addSprayChunk:function(n){this.sprayChunkPoints=[];var i,s,l,e,t=this.width/2;for(e=0;e<this.density;e++){i=g.util.getRandomInt(n.x-t,n.x+t),s=g.util.getRandomInt(n.y-t,n.y+t),l=this.dotWidthVariance?g.util.getRandomInt(Math.max(1,this.dotWidth-this.dotWidthVariance),this.dotWidth+this.dotWidthVariance):this.dotWidth;var o=new g.Point(i,s);o.width=l,this.randomOpacity&&(o.opacity=g.util.getRandomInt(0,100)/100),this.sprayChunkPoints.push(o)}this.sprayChunks.push(this.sprayChunkPoints)}}),g.PatternBrush=g.util.createClass(g.PencilBrush,{getPatternSrc:function(){var n=g.util.createCanvasElement(),i=n.getContext("2d");return n.width=n.height=25,i.fillStyle=this.color,i.beginPath(),i.arc(10,10,10,0,2*Math.PI,!1),i.closePath(),i.fill(),n},getPatternSrcFunction:function(){return String(this.getPatternSrc).replace("this.color",'"'+this.color+'"')},getPattern:function(n){return n.createPattern(this.source||this.getPatternSrc(),"repeat")},_setBrushStyles:function(n){this.callSuper("_setBrushStyles",n),n.strokeStyle=this.getPattern(n)},createPath:function(n){var i=this.callSuper("createPath",n),s=i._getLeftTopCoords().scalarAdd(i.strokeWidth/2);return i.stroke=new g.Pattern({source:this.source||this.getPatternSrcFunction(),offsetX:-s.x,offsetY:-s.y}),i}}),function(){var n=g.util.getPointer,i=g.util.degreesToRadians,s=g.util.isTouchEvent;for(var l in g.Canvas=g.util.createClass(g.StaticCanvas,{initialize:function(e,t){t||(t={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(e,t),this._initInteractive(),this._createCacheCanvas()},uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",interactive:!0,selection:!0,selectionKey:"shiftKey",altSelectionKey:null,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",notAllowedCursor:"not-allowed",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,isDrawingMode:!1,preserveObjectStacking:!1,snapAngle:0,snapThreshold:null,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,targets:[],enablePointerEvents:!1,_hoveredTarget:null,_hoveredTargets:[],_initInteractive:function(){this._currentTransform=null,this._groupSelector=null,this._initWrapperElement(),this._createUpperCanvas(),this._initEventListeners(),this._initRetinaScaling(),this.freeDrawingBrush=g.PencilBrush&&new g.PencilBrush(this),this.calcOffset()},_chooseObjectsToRender:function(){var e,t,o,d=this.getActiveObjects();if(d.length>0&&!this.preserveObjectStacking){t=[],o=[];for(var h=0,c=this._objects.length;h<c;h++)e=this._objects[h],d.indexOf(e)===-1?t.push(e):o.push(e);d.length>1&&(this._activeObject._objects=o),t.push.apply(t,o)}else t=this._objects;return t},renderAll:function(){!this.contextTopDirty||this._groupSelector||this.isDrawingMode||(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&(this.renderTopLayer(this.contextTop),this.hasLostContext=!1);var e=this.contextContainer;return this.renderCanvas(e,this._chooseObjectsToRender()),this},renderTopLayer:function(e){e.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(e),this.contextTopDirty=!0),e.restore()},renderTop:function(){var e=this.contextTop;return this.clearContext(e),this.renderTopLayer(e),this.fire("after:render"),this},_normalizePointer:function(e,t){var o=e.calcTransformMatrix(),d=g.util.invertTransform(o),h=this.restorePointerVpt(t);return g.util.transformPoint(h,d)},isTargetTransparent:function(e,t,o){if(e.shouldCache()&&e._cacheCanvas&&e!==this._activeObject){var d=this._normalizePointer(e,{x:t,y:o}),h=Math.max(e.cacheTranslationX+d.x*e.zoomX,0),c=Math.max(e.cacheTranslationY+d.y*e.zoomY,0);return g.util.isTransparent(e._cacheContext,Math.round(h),Math.round(c),this.targetFindTolerance)}var f=this.contextCache,p=e.selectionBackgroundColor,y=this.viewportTransform;return e.selectionBackgroundColor="",this.clearContext(f),f.save(),f.transform(y[0],y[1],y[2],y[3],y[4],y[5]),e.render(f),f.restore(),e.selectionBackgroundColor=p,g.util.isTransparent(f,t,o,this.targetFindTolerance)},_isSelectionKeyPressed:function(e){return Array.isArray(this.selectionKey)?!!this.selectionKey.find(function(t){return e[t]===!0}):e[this.selectionKey]},_shouldClearSelection:function(e,t){var o=this.getActiveObjects(),d=this._activeObject;return!t||t&&d&&o.length>1&&o.indexOf(t)===-1&&d!==t&&!this._isSelectionKeyPressed(e)||t&&!t.evented||t&&!t.selectable&&d&&d!==t},_shouldCenterTransform:function(e,t,o){var d;if(e)return t==="scale"||t==="scaleX"||t==="scaleY"||t==="resizing"?d=this.centeredScaling||e.centeredScaling:t==="rotate"&&(d=this.centeredRotation||e.centeredRotation),d?!o:o},_getOriginFromCorner:function(e,t){var o={x:e.originX,y:e.originY};return t==="ml"||t==="tl"||t==="bl"?o.x="right":t!=="mr"&&t!=="tr"&&t!=="br"||(o.x="left"),t==="tl"||t==="mt"||t==="tr"?o.y="bottom":t!=="bl"&&t!=="mb"&&t!=="br"||(o.y="top"),o},_getActionFromCorner:function(e,t,o,d){if(!t||!e)return"drag";var h=d.controls[t];return h.getActionName(o,h,d)},_setupCurrentTransform:function(e,t,o){if(t){var d=this.getPointer(e),h=t.__corner,c=t.controls[h],f=o&&h?c.getActionHandler(e,t,c):g.controlsUtils.dragHandler,p=this._getActionFromCorner(o,h,e,t),y=this._getOriginFromCorner(t,h),b=e[this.centeredKey],C={target:t,action:p,actionHandler:f,corner:h,scaleX:t.scaleX,scaleY:t.scaleY,skewX:t.skewX,skewY:t.skewY,offsetX:d.x-t.left,offsetY:d.y-t.top,originX:y.x,originY:y.y,ex:d.x,ey:d.y,lastX:d.x,lastY:d.y,theta:i(t.angle),width:t.width*t.scaleX,shiftKey:e.shiftKey,altKey:b,original:g.util.saveObjectTransform(t)};this._shouldCenterTransform(t,p,b)&&(C.originX="center",C.originY="center"),C.original.originX=y.x,C.original.originY=y.y,this._currentTransform=C,this._beforeTransform(e)}},setCursor:function(e){this.upperCanvasEl.style.cursor=e},_drawSelection:function(e){var t=this._groupSelector,o=new g.Point(t.ex,t.ey),d=g.util.transformPoint(o,this.viewportTransform),h=new g.Point(t.ex+t.left,t.ey+t.top),c=g.util.transformPoint(h,this.viewportTransform),f=Math.min(d.x,c.x),p=Math.min(d.y,c.y),y=Math.max(d.x,c.x),b=Math.max(d.y,c.y),C=this.selectionLineWidth/2;this.selectionColor&&(e.fillStyle=this.selectionColor,e.fillRect(f,p,y-f,b-p)),this.selectionLineWidth&&this.selectionBorderColor&&(e.lineWidth=this.selectionLineWidth,e.strokeStyle=this.selectionBorderColor,f+=C,p+=C,y-=C,b-=C,g.Object.prototype._setLineDash.call(this,e,this.selectionDashArray),e.strokeRect(f,p,y-f,b-p))},findTarget:function(e,t){if(!this.skipTargetFind){var o,d,h=this.getPointer(e,!0),c=this._activeObject,f=this.getActiveObjects(),p=s(e),y=f.length>1&&!t||f.length===1;if(this.targets=[],y&&c._findTargetCorner(h,p)||f.length>1&&!t&&c===this._searchPossibleTargets([c],h))return c;if(f.length===1&&c===this._searchPossibleTargets([c],h)){if(!this.preserveObjectStacking)return c;o=c,d=this.targets,this.targets=[]}var b=this._searchPossibleTargets(this._objects,h);return e[this.altSelectionKey]&&b&&o&&b!==o&&(b=o,this.targets=d),b}},_checkTarget:function(e,t,o){if(t&&t.visible&&t.evented&&t.containsPoint(e)&&(!this.perPixelTargetFind&&!t.perPixelTargetFind||t.isEditing||!this.isTargetTransparent(t,o.x,o.y)))return!0},_searchPossibleTargets:function(e,t){for(var o,d,h=e.length;h--;){var c=e[h],f=c.group?this._normalizePointer(c.group,t):t;if(this._checkTarget(f,c,t)){(o=e[h]).subTargetCheck&&o instanceof g.Group&&(d=this._searchPossibleTargets(o._objects,t))&&this.targets.push(d);break}}return o},restorePointerVpt:function(e){return g.util.transformPoint(e,g.util.invertTransform(this.viewportTransform))},getPointer:function(e,t){if(this._absolutePointer&&!t)return this._absolutePointer;if(this._pointer&&t)return this._pointer;var o,d=n(e),h=this.upperCanvasEl,c=h.getBoundingClientRect(),f=c.width||0,p=c.height||0;f&&p||("top"in c&&"bottom"in c&&(p=Math.abs(c.top-c.bottom)),"right"in c&&"left"in c&&(f=Math.abs(c.right-c.left))),this.calcOffset(),d.x=d.x-this._offset.left,d.y=d.y-this._offset.top,t||(d=this.restorePointerVpt(d));var y=this.getRetinaScaling();return y!==1&&(d.x/=y,d.y/=y),o=f===0||p===0?{width:1,height:1}:{width:h.width/f,height:h.height/p},{x:d.x*o.width,y:d.y*o.height}},_createUpperCanvas:function(){var e=this.lowerCanvasEl.className.replace(/\s*lower-canvas\s*/,""),t=this.lowerCanvasEl,o=this.upperCanvasEl;o?o.className="":(o=this._createCanvasElement(),this.upperCanvasEl=o),g.util.addClass(o,"upper-canvas "+e),this.wrapperEl.appendChild(o),this._copyCanvasStyle(t,o),this._applyCanvasStyle(o),this.contextTop=o.getContext("2d")},getTopContext:function(){return this.contextTop},_createCacheCanvas:function(){this.cacheCanvasEl=this._createCanvasElement(),this.cacheCanvasEl.setAttribute("width",this.width),this.cacheCanvasEl.setAttribute("height",this.height),this.contextCache=this.cacheCanvasEl.getContext("2d")},_initWrapperElement:function(){this.wrapperEl=g.util.wrapElement(this.lowerCanvasEl,"div",{class:this.containerClass}),g.util.setStyle(this.wrapperEl,{width:this.width+"px",height:this.height+"px",position:"relative"}),g.util.makeElementUnselectable(this.wrapperEl)},_applyCanvasStyle:function(e){var t=this.width||e.width,o=this.height||e.height;g.util.setStyle(e,{position:"absolute",width:t+"px",height:o+"px",left:0,top:0,"touch-action":this.allowTouchScrolling?"manipulation":"none","-ms-touch-action":this.allowTouchScrolling?"manipulation":"none"}),e.width=t,e.height=o,g.util.makeElementUnselectable(e)},_copyCanvasStyle:function(e,t){t.style.cssText=e.style.cssText},getSelectionContext:function(){return this.contextTop},getSelectionElement:function(){return this.upperCanvasEl},getActiveObject:function(){return this._activeObject},getActiveObjects:function(){var e=this._activeObject;return e?e.type==="activeSelection"&&e._objects?e._objects.slice(0):[e]:[]},_onObjectRemoved:function(e){e===this._activeObject&&(this.fire("before:selection:cleared",{target:e}),this._discardActiveObject(),this.fire("selection:cleared",{target:e}),e.fire("deselected")),e===this._hoveredTarget&&(this._hoveredTarget=null,this._hoveredTargets=[]),this.callSuper("_onObjectRemoved",e)},_fireSelectionEvents:function(e,t){var o=!1,d=this.getActiveObjects(),h=[],c=[];e.forEach(function(f){d.indexOf(f)===-1&&(o=!0,f.fire("deselected",{e:t,target:f}),c.push(f))}),d.forEach(function(f){e.indexOf(f)===-1&&(o=!0,f.fire("selected",{e:t,target:f}),h.push(f))}),e.length>0&&d.length>0?o&&this.fire("selection:updated",{e:t,selected:h,deselected:c}):d.length>0?this.fire("selection:created",{e:t,selected:h}):e.length>0&&this.fire("selection:cleared",{e:t,deselected:c})},setActiveObject:function(e,t){var o=this.getActiveObjects();return this._setActiveObject(e,t),this._fireSelectionEvents(o,t),this},_setActiveObject:function(e,t){return this._activeObject!==e&&!!this._discardActiveObject(t,e)&&!e.onSelect({e:t})&&(this._activeObject=e,!0)},_discardActiveObject:function(e,t){var o=this._activeObject;if(o){if(o.onDeselect({e,object:t}))return!1;this._activeObject=null}return!0},discardActiveObject:function(e){var t=this.getActiveObjects(),o=this.getActiveObject();return t.length&&this.fire("before:selection:cleared",{target:o,e}),this._discardActiveObject(e),this._fireSelectionEvents(t,e),this},dispose:function(){var e=this.wrapperEl;return this.removeListeners(),e.removeChild(this.upperCanvasEl),e.removeChild(this.lowerCanvasEl),this.contextCache=null,this.contextTop=null,["upperCanvasEl","cacheCanvasEl"].forEach(function(t){g.util.cleanUpJsdomNode(this[t]),this[t]=void 0}.bind(this)),e.parentNode&&e.parentNode.replaceChild(this.lowerCanvasEl,this.wrapperEl),delete this.wrapperEl,g.StaticCanvas.prototype.dispose.call(this),this},clear:function(){return this.discardActiveObject(),this.clearContext(this.contextTop),this.callSuper("clear")},drawControls:function(e){var t=this._activeObject;t&&t._renderControls(e)},_toObject:function(e,t,o){var d=this._realizeGroupTransformOnObject(e),h=this.callSuper("_toObject",e,t,o);return this._unwindGroupTransformOnObject(e,d),h},_realizeGroupTransformOnObject:function(e){if(e.group&&e.group.type==="activeSelection"&&this._activeObject===e.group){var t={};return["angle","flipX","flipY","left","scaleX","scaleY","skewX","skewY","top"].forEach(function(o){t[o]=e[o]}),g.util.addTransformToObject(e,this._activeObject.calcOwnMatrix()),t}return null},_unwindGroupTransformOnObject:function(e,t){t&&e.set(t)},_setSVGObject:function(e,t,o){var d=this._realizeGroupTransformOnObject(t);this.callSuper("_setSVGObject",e,t,o),this._unwindGroupTransformOnObject(t,d)},setViewportTransform:function(e){this.renderOnAddRemove&&this._activeObject&&this._activeObject.isEditing&&this._activeObject.clearContextTop(),g.StaticCanvas.prototype.setViewportTransform.call(this,e)}}),g.StaticCanvas)l!=="prototype"&&(g.Canvas[l]=g.StaticCanvas[l])}(),function(){var n=g.util.addListener,i=g.util.removeListener,s={passive:!1};function l(e,t){return e.button&&e.button===t-1}g.util.object.extend(g.Canvas.prototype,{mainTouchId:null,_initEventListeners:function(){this.removeListeners(),this._bindEvents(),this.addOrRemove(n,"add")},_getEventPrefix:function(){return this.enablePointerEvents?"pointer":"mouse"},addOrRemove:function(e,t){var o=this.upperCanvasEl,d=this._getEventPrefix();e(g.window,"resize",this._onResize),e(o,d+"down",this._onMouseDown),e(o,d+"move",this._onMouseMove,s),e(o,d+"out",this._onMouseOut),e(o,d+"enter",this._onMouseEnter),e(o,"wheel",this._onMouseWheel),e(o,"contextmenu",this._onContextMenu),e(o,"dblclick",this._onDoubleClick),e(o,"dragover",this._onDragOver),e(o,"dragenter",this._onDragEnter),e(o,"dragleave",this._onDragLeave),e(o,"drop",this._onDrop),this.enablePointerEvents||e(o,"touchstart",this._onTouchStart,s),typeof eventjs!="undefined"&&t in eventjs&&(eventjs[t](o,"gesture",this._onGesture),eventjs[t](o,"drag",this._onDrag),eventjs[t](o,"orientation",this._onOrientationChange),eventjs[t](o,"shake",this._onShake),eventjs[t](o,"longpress",this._onLongPress))},removeListeners:function(){this.addOrRemove(i,"remove");var e=this._getEventPrefix();i(g.document,e+"up",this._onMouseUp),i(g.document,"touchend",this._onTouchEnd,s),i(g.document,e+"move",this._onMouseMove,s),i(g.document,"touchmove",this._onMouseMove,s)},_bindEvents:function(){this.eventsBound||(this._onMouseDown=this._onMouseDown.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onResize=this._onResize.bind(this),this._onGesture=this._onGesture.bind(this),this._onDrag=this._onDrag.bind(this),this._onShake=this._onShake.bind(this),this._onLongPress=this._onLongPress.bind(this),this._onOrientationChange=this._onOrientationChange.bind(this),this._onMouseWheel=this._onMouseWheel.bind(this),this._onMouseOut=this._onMouseOut.bind(this),this._onMouseEnter=this._onMouseEnter.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onDoubleClick=this._onDoubleClick.bind(this),this._onDragOver=this._onDragOver.bind(this),this._onDragEnter=this._simpleEventHandler.bind(this,"dragenter"),this._onDragLeave=this._simpleEventHandler.bind(this,"dragleave"),this._onDrop=this._onDrop.bind(this),this.eventsBound=!0)},_onGesture:function(e,t){this.__onTransformGesture&&this.__onTransformGesture(e,t)},_onDrag:function(e,t){this.__onDrag&&this.__onDrag(e,t)},_onMouseWheel:function(e){this.__onMouseWheel(e)},_onMouseOut:function(e){var t=this._hoveredTarget;this.fire("mouse:out",{target:t,e}),this._hoveredTarget=null,t&&t.fire("mouseout",{e});var o=this;this._hoveredTargets.forEach(function(d){o.fire("mouse:out",{target:t,e}),d&&t.fire("mouseout",{e})}),this._hoveredTargets=[],this._iTextInstances&&this._iTextInstances.forEach(function(d){d.isEditing&&d.hiddenTextarea.focus()})},_onMouseEnter:function(e){this._currentTransform||this.findTarget(e)||(this.fire("mouse:over",{target:null,e}),this._hoveredTarget=null,this._hoveredTargets=[])},_onOrientationChange:function(e,t){this.__onOrientationChange&&this.__onOrientationChange(e,t)},_onShake:function(e,t){this.__onShake&&this.__onShake(e,t)},_onLongPress:function(e,t){this.__onLongPress&&this.__onLongPress(e,t)},_onDragOver:function(e){e.preventDefault();var t=this._simpleEventHandler("dragover",e);this._fireEnterLeaveEvents(t,e)},_onDrop:function(e){return this._simpleEventHandler("drop:before",e),this._simpleEventHandler("drop",e)},_onContextMenu:function(e){return this.stopContextMenu&&(e.stopPropagation(),e.preventDefault()),!1},_onDoubleClick:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"dblclick"),this._resetTransformEventData(e)},getPointerId:function(e){var t=e.changedTouches;return t?t[0]&&t[0].identifier:this.enablePointerEvents?e.pointerId:-1},_isMainEvent:function(e){return e.isPrimary===!0||e.isPrimary!==!1&&(e.type==="touchend"&&e.touches.length===0||!e.changedTouches||e.changedTouches[0].identifier===this.mainTouchId)},_onTouchStart:function(e){e.preventDefault(),this.mainTouchId===null&&(this.mainTouchId=this.getPointerId(e)),this.__onMouseDown(e),this._resetTransformEventData();var t=this.upperCanvasEl,o=this._getEventPrefix();n(g.document,"touchend",this._onTouchEnd,s),n(g.document,"touchmove",this._onMouseMove,s),i(t,o+"down",this._onMouseDown)},_onMouseDown:function(e){this.__onMouseDown(e),this._resetTransformEventData();var t=this.upperCanvasEl,o=this._getEventPrefix();i(t,o+"move",this._onMouseMove,s),n(g.document,o+"up",this._onMouseUp),n(g.document,o+"move",this._onMouseMove,s)},_onTouchEnd:function(e){if(!(e.touches.length>0)){this.__onMouseUp(e),this._resetTransformEventData(),this.mainTouchId=null;var t=this._getEventPrefix();i(g.document,"touchend",this._onTouchEnd,s),i(g.document,"touchmove",this._onMouseMove,s);var o=this;this._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout(function(){n(o.upperCanvasEl,t+"down",o._onMouseDown),o._willAddMouseDown=0},400)}},_onMouseUp:function(e){this.__onMouseUp(e),this._resetTransformEventData();var t=this.upperCanvasEl,o=this._getEventPrefix();this._isMainEvent(e)&&(i(g.document,o+"up",this._onMouseUp),i(g.document,o+"move",this._onMouseMove,s),n(t,o+"move",this._onMouseMove,s))},_onMouseMove:function(e){!this.allowTouchScrolling&&e.preventDefault&&e.preventDefault(),this.__onMouseMove(e)},_onResize:function(){this.calcOffset()},_shouldRender:function(e){var t=this._activeObject;return!!(!!t!=!!e||t&&e&&t!==e)||(t&&t.isEditing,!1)},__onMouseUp:function(e){var t,o=this._currentTransform,d=this._groupSelector,h=!1,c=!d||d.left===0&&d.top===0;if(this._cacheTransformEventData(e),t=this._target,this._handleEvent(e,"up:before"),l(e,3))this.fireRightClick&&this._handleEvent(e,"up",3,c);else{if(l(e,2))return this.fireMiddleClick&&this._handleEvent(e,"up",2,c),void this._resetTransformEventData();if(this.isDrawingMode&&this._isCurrentlyDrawing)this._onMouseUpInDrawingMode(e);else if(this._isMainEvent(e)){if(o&&(this._finalizeCurrentTransform(e),h=o.actionPerformed),!c){var f=t===this._activeObject;this._maybeGroupObjects(e),h||(h=this._shouldRender(t)||!f&&t===this._activeObject)}var p,y;if(t){if(p=t._findTargetCorner(this.getPointer(e,!0),g.util.isTouchEvent(e)),t.selectable&&t!==this._activeObject&&t.activeOn==="up")this.setActiveObject(t,e),h=!0;else{var b=t.controls[p],C=b&&b.getMouseUpHandler(e,t,b);C&&C(e,o,(y=this.getPointer(e)).x,y.y)}t.isMoving=!1}if(o&&(o.target!==t||o.corner!==p)){var T=o.target&&o.target.controls[o.corner],O=T&&T.getMouseUpHandler(e,t,b);y=y||this.getPointer(e),O&&O(e,o,y.x,y.y)}this._setCursorFromEvent(e,t),this._handleEvent(e,"up",1,c),this._groupSelector=null,this._currentTransform=null,t&&(t.__corner=0),h?this.requestRenderAll():c||this.renderTop()}}},_simpleEventHandler:function(e,t){var o=this.findTarget(t),d=this.targets,h={e:t,target:o,subTargets:d};if(this.fire(e,h),o&&o.fire(e,h),!d)return o;for(var c=0;c<d.length;c++)d[c].fire(e,h);return o},_handleEvent:function(e,t,o,d){var h=this._target,c=this.targets||[],f={e,target:h,subTargets:c,button:o||1,isClick:d||!1,pointer:this._pointer,absolutePointer:this._absolutePointer,transform:this._currentTransform};t==="up"&&(f.currentTarget=this.findTarget(e),f.currentSubTargets=this.targets),this.fire("mouse:"+t,f),h&&h.fire("mouse"+t,f);for(var p=0;p<c.length;p++)c[p].fire("mouse"+t,f)},_finalizeCurrentTransform:function(e){var t=this._currentTransform,o=t.target,d={e,target:o,transform:t,action:t.action};o._scaling&&(o._scaling=!1),o.setCoords(),(t.actionPerformed||this.stateful&&o.hasStateChanged())&&this._fire("modified",d)},_onMouseDownInDrawingMode:function(e){this._isCurrentlyDrawing=!0,this.getActiveObject()&&this.discardActiveObject(e).requestRenderAll();var t=this.getPointer(e);this.freeDrawingBrush.onMouseDown(t,{e,pointer:t}),this._handleEvent(e,"down")},_onMouseMoveInDrawingMode:function(e){if(this._isCurrentlyDrawing){var t=this.getPointer(e);this.freeDrawingBrush.onMouseMove(t,{e,pointer:t})}this.setCursor(this.freeDrawingCursor),this._handleEvent(e,"move")},_onMouseUpInDrawingMode:function(e){var t=this.getPointer(e);this._isCurrentlyDrawing=this.freeDrawingBrush.onMouseUp({e,pointer:t}),this._handleEvent(e,"up")},__onMouseDown:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"down:before");var t=this._target;if(l(e,3))this.fireRightClick&&this._handleEvent(e,"down",3);else if(l(e,2))this.fireMiddleClick&&this._handleEvent(e,"down",2);else if(this.isDrawingMode)this._onMouseDownInDrawingMode(e);else if(this._isMainEvent(e)&&!this._currentTransform){var o=this._pointer;this._previousPointer=o;var d=this._shouldRender(t),h=this._shouldGroup(e,t);if(this._shouldClearSelection(e,t)?this.discardActiveObject(e):h&&(this._handleGrouping(e,t),t=this._activeObject),!this.selection||t&&(t.selectable||t.isEditing||t===this._activeObject)||(this._groupSelector={ex:this._absolutePointer.x,ey:this._absolutePointer.y,top:0,left:0}),t){var c=t===this._activeObject;t.selectable&&t.activeOn==="down"&&this.setActiveObject(t,e);var f=t._findTargetCorner(this.getPointer(e,!0),g.util.isTouchEvent(e));if(t.__corner=f,t===this._activeObject&&(f||!h)){this._setupCurrentTransform(e,t,c);var p=t.controls[f],y=(o=this.getPointer(e),p&&p.getMouseDownHandler(e,t,p));y&&y(e,this._currentTransform,o.x,o.y)}}this._handleEvent(e,"down"),(d||h)&&this.requestRenderAll()}},_resetTransformEventData:function(){this._target=null,this._pointer=null,this._absolutePointer=null},_cacheTransformEventData:function(e){this._resetTransformEventData(),this._pointer=this.getPointer(e,!0),this._absolutePointer=this.restorePointerVpt(this._pointer),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(e)||null},_beforeTransform:function(e){var t=this._currentTransform;this.stateful&&t.target.saveState(),this.fire("before:transform",{e,transform:t})},__onMouseMove:function(e){var t,o;if(this._handleEvent(e,"move:before"),this._cacheTransformEventData(e),this.isDrawingMode)this._onMouseMoveInDrawingMode(e);else if(this._isMainEvent(e)){var d=this._groupSelector;d?(o=this._absolutePointer,d.left=o.x-d.ex,d.top=o.y-d.ey,this.renderTop()):this._currentTransform?this._transformObject(e):(t=this.findTarget(e)||null,this._setCursorFromEvent(e,t),this._fireOverOutEvents(t,e)),this._handleEvent(e,"move"),this._resetTransformEventData()}},_fireOverOutEvents:function(e,t){var o=this._hoveredTarget,d=this._hoveredTargets,h=this.targets,c=Math.max(d.length,h.length);this.fireSyntheticInOutEvents(e,t,{oldTarget:o,evtOut:"mouseout",canvasEvtOut:"mouse:out",evtIn:"mouseover",canvasEvtIn:"mouse:over"});for(var f=0;f<c;f++)this.fireSyntheticInOutEvents(h[f],t,{oldTarget:d[f],evtOut:"mouseout",evtIn:"mouseover"});this._hoveredTarget=e,this._hoveredTargets=this.targets.concat()},_fireEnterLeaveEvents:function(e,t){var o=this._draggedoverTarget,d=this._hoveredTargets,h=this.targets,c=Math.max(d.length,h.length);this.fireSyntheticInOutEvents(e,t,{oldTarget:o,evtOut:"dragleave",evtIn:"dragenter"});for(var f=0;f<c;f++)this.fireSyntheticInOutEvents(h[f],t,{oldTarget:d[f],evtOut:"dragleave",evtIn:"dragenter"});this._draggedoverTarget=e},fireSyntheticInOutEvents:function(e,t,o){var d,h,c,f=o.oldTarget,p=f!==e,y=o.canvasEvtIn,b=o.canvasEvtOut;p&&(d={e:t,target:e,previousTarget:f},h={e:t,target:f,nextTarget:e}),c=e&&p,f&&p&&(b&&this.fire(b,h),f.fire(o.evtOut,h)),c&&(y&&this.fire(y,d),e.fire(o.evtIn,d))},__onMouseWheel:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"wheel"),this._resetTransformEventData()},_transformObject:function(e){var t=this.getPointer(e),o=this._currentTransform;o.reset=!1,o.shiftKey=e.shiftKey,o.altKey=e[this.centeredKey],this._performTransformAction(e,o,t),o.actionPerformed&&this.requestRenderAll()},_performTransformAction:function(e,t,o){var d=o.x,h=o.y,c=t.action,f=!1,p=t.actionHandler;p&&(f=p(e,t,d,h)),c==="drag"&&f&&(t.target.isMoving=!0,this.setCursor(t.target.moveCursor||this.moveCursor)),t.actionPerformed=t.actionPerformed||f},_fire:g.controlsUtils.fireEvent,_setCursorFromEvent:function(e,t){if(!t)return this.setCursor(this.defaultCursor),!1;var o=t.hoverCursor||this.hoverCursor,d=this._activeObject&&this._activeObject.type==="activeSelection"?this._activeObject:null,h=(!d||!d.contains(t))&&t._findTargetCorner(this.getPointer(e,!0));h?this.setCursor(this.getCornerCursor(h,t,e)):(t.subTargetCheck&&this.targets.concat().reverse().map(function(c){o=c.hoverCursor||o}),this.setCursor(o))},getCornerCursor:function(e,t,o){var d=t.controls[e];return d.cursorStyleHandler(o,d,t)}})}(),ce=Math.min,K=Math.max,g.util.object.extend(g.Canvas.prototype,{_shouldGroup:function(n,i){var s=this._activeObject;return s&&this._isSelectionKeyPressed(n)&&i&&i.selectable&&this.selection&&(s!==i||s.type==="activeSelection")&&!i.onSelect({e:n})},_handleGrouping:function(n,i){var s=this._activeObject;s.__corner||(i!==s||(i=this.findTarget(n,!0))&&i.selectable)&&(s&&s.type==="activeSelection"?this._updateActiveSelection(i,n):this._createActiveSelection(i,n))},_updateActiveSelection:function(n,i){var s=this._activeObject,l=s._objects.slice(0);s.contains(n)?(s.removeWithUpdate(n),this._hoveredTarget=n,this._hoveredTargets=this.targets.concat(),s.size()===1&&this._setActiveObject(s.item(0),i)):(s.addWithUpdate(n),this._hoveredTarget=s,this._hoveredTargets=this.targets.concat()),this._fireSelectionEvents(l,i)},_createActiveSelection:function(n,i){var s=this.getActiveObjects(),l=this._createGroup(n);this._hoveredTarget=l,this._setActiveObject(l,i),this._fireSelectionEvents(s,i)},_createGroup:function(n){var i=this._objects,s=i.indexOf(this._activeObject)<i.indexOf(n)?[this._activeObject,n]:[n,this._activeObject];return this._activeObject.isEditing&&this._activeObject.exitEditing(),new g.ActiveSelection(s,{canvas:this})},_groupSelectedObjects:function(n){var i,s=this._collectObjects(n);s.length===1?this.setActiveObject(s[0],n):s.length>1&&(i=new g.ActiveSelection(s.reverse(),{canvas:this}),this.setActiveObject(i,n))},_collectObjects:function(n){for(var i,s=[],l=this._groupSelector.ex,e=this._groupSelector.ey,t=l+this._groupSelector.left,o=e+this._groupSelector.top,d=new g.Point(ce(l,t),ce(e,o)),h=new g.Point(K(l,t),K(e,o)),c=!this.selectionFullyContained,f=l===t&&e===o,p=this._objects.length;p--&&!((i=this._objects[p])&&i.selectable&&i.visible&&(c&&i.intersectsWithRect(d,h,!0)||i.isContainedWithinRect(d,h,!0)||c&&i.containsPoint(d,null,!0)||c&&i.containsPoint(h,null,!0))&&(s.push(i),f)););return s.length>1&&(s=s.filter(function(y){return!y.onSelect({e:n})})),s},_maybeGroupObjects:function(n){this.selection&&this._groupSelector&&this._groupSelectedObjects(n),this.setCursor(this.defaultCursor),this._groupSelector=null}}),g.util.object.extend(g.StaticCanvas.prototype,{toDataURL:function(n){n||(n={});var i=n.format||"png",s=n.quality||1,l=(n.multiplier||1)*(n.enableRetinaScaling?this.getRetinaScaling():1),e=this.toCanvasElement(l,n);return g.util.toDataURL(e,i,s)},toCanvasElement:function(n,i){n=n||1;var s=((i=i||{}).width||this.width)*n,l=(i.height||this.height)*n,e=this.getZoom(),t=this.width,o=this.height,d=e*n,h=this.viewportTransform,c=(h[4]-(i.left||0))*n,f=(h[5]-(i.top||0))*n,p=this.interactive,y=[d,0,0,d,c,f],b=this.enableRetinaScaling,C=g.util.createCanvasElement(),T=this.contextTop;return C.width=s,C.height=l,this.contextTop=null,this.enableRetinaScaling=!1,this.interactive=!1,this.viewportTransform=y,this.width=s,this.height=l,this.calcViewportBoundaries(),this.renderCanvas(C.getContext("2d"),this._objects),this.viewportTransform=h,this.width=t,this.height=o,this.calcViewportBoundaries(),this.interactive=p,this.enableRetinaScaling=b,this.contextTop=T,C}}),g.util.object.extend(g.StaticCanvas.prototype,{loadFromJSON:function(n,i,s){if(n){var l=typeof n=="string"?JSON.parse(n):g.util.object.clone(n),e=this,t=l.clipPath,o=this.renderOnAddRemove;return this.renderOnAddRemove=!1,delete l.clipPath,this._enlivenObjects(l.objects,function(d){e.clear(),e._setBgOverlay(l,function(){t?e._enlivenObjects([t],function(h){e.clipPath=h[0],e.__setupCanvas.call(e,l,d,o,i)}):e.__setupCanvas.call(e,l,d,o,i)})},s),this}},__setupCanvas:function(n,i,s,l){var e=this;i.forEach(function(t,o){e.insertAt(t,o)}),this.renderOnAddRemove=s,delete n.objects,delete n.backgroundImage,delete n.overlayImage,delete n.background,delete n.overlay,this._setOptions(n),this.renderAll(),l&&l()},_setBgOverlay:function(n,i){var s={backgroundColor:!1,overlayColor:!1,backgroundImage:!1,overlayImage:!1};if(n.backgroundImage||n.overlayImage||n.background||n.overlay){var l=function(){s.backgroundImage&&s.overlayImage&&s.backgroundColor&&s.overlayColor&&i&&i()};this.__setBgOverlay("backgroundImage",n.backgroundImage,s,l),this.__setBgOverlay("overlayImage",n.overlayImage,s,l),this.__setBgOverlay("backgroundColor",n.background,s,l),this.__setBgOverlay("overlayColor",n.overlay,s,l)}else i&&i()},__setBgOverlay:function(n,i,s,l){var e=this;if(!i)return s[n]=!0,void(l&&l());n==="backgroundImage"||n==="overlayImage"?g.util.enlivenObjects([i],function(t){e[n]=t[0],s[n]=!0,l&&l()}):this["set"+g.util.string.capitalize(n,!0)](i,function(){s[n]=!0,l&&l()})},_enlivenObjects:function(n,i,s){n&&n.length!==0?g.util.enlivenObjects(n,function(l){i&&i(l)},null,s):i&&i([])},_toDataURL:function(n,i){this.clone(function(s){i(s.toDataURL(n))})},_toDataURLWithMultiplier:function(n,i,s){this.clone(function(l){s(l.toDataURLWithMultiplier(n,i))})},clone:function(n,i){var s=JSON.stringify(this.toJSON(i));this.cloneWithoutData(function(l){l.loadFromJSON(s,function(){n&&n(l)})})},cloneWithoutData:function(n){var i=g.util.createCanvasElement();i.width=this.width,i.height=this.height;var s=new g.Canvas(i);this.backgroundImage?(s.setBackgroundImage(this.backgroundImage.src,function(){s.renderAll(),n&&n(s)}),s.backgroundImageOpacity=this.backgroundImageOpacity,s.backgroundImageStretch=this.backgroundImageStretch):n&&n(s)}}),function(n){var i=n.fabric||(n.fabric={}),s=i.util.object.extend,l=i.util.object.clone,e=i.util.toFixed,t=i.util.string.capitalize,o=i.util.degreesToRadians,d=!i.isLikelyNode;i.Object||(i.Object=i.util.createClass(i.CommonMethods,{type:"object",originX:"left",originY:"top",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,skewX:0,skewY:0,cornerSize:13,touchCornerSize:24,transparentCorners:!0,hoverCursor:null,moveCursor:null,padding:0,borderColor:"rgb(178,204,255)",borderDashArray:null,cornerColor:"rgb(178,204,255)",cornerStrokeColor:null,cornerStyle:"rect",cornerDashArray:null,centeredScaling:!1,centeredRotation:!0,fill:"rgb(0,0,0)",fillRule:"nonzero",globalCompositeOperation:"source-over",backgroundColor:"",selectionBackgroundColor:"",stroke:null,strokeWidth:1,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,shadow:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,minScaleLimit:0,selectable:!0,evented:!0,visible:!0,hasControls:!0,hasBorders:!0,perPixelTargetFind:!1,includeDefaultValues:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,excludeFromExport:!1,objectCaching:d,statefullCache:!1,noScaleCache:!0,strokeUniform:!1,dirty:!0,__corner:0,paintFirst:"fill",activeOn:"down",stateProperties:"top left width height scaleX scaleY flipX flipY originX originY transformMatrix stroke strokeWidth strokeDashArray strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit angle opacity fill globalCompositeOperation shadow visible backgroundColor skewX skewY fillRule paintFirst clipPath strokeUniform".split(" "),cacheProperties:"fill stroke strokeWidth strokeDashArray width height paintFirst strokeUniform strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit backgroundColor clipPath".split(" "),colorProperties:"fill stroke backgroundColor".split(" "),clipPath:void 0,inverted:!1,absolutePositioned:!1,initialize:function(h){h&&this.setOptions(h)},_createCacheCanvas:function(){this._cacheProperties={},this._cacheCanvas=i.util.createCanvasElement(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0},_limitCacheSize:function(h){var c=i.perfLimitSizeTotal,f=h.width,p=h.height,y=i.maxCacheSideLimit,b=i.minCacheSideLimit;if(f<=y&&p<=y&&f*p<=c)return f<b&&(h.width=b),p<b&&(h.height=b),h;var C=f/p,T=i.util.limitDimsByArea(C,c),O=i.util.capValue,F=O(b,T.x,y),B=O(b,T.y,y);return f>F&&(h.zoomX/=f/F,h.width=F,h.capped=!0),p>B&&(h.zoomY/=p/B,h.height=B,h.capped=!0),h},_getCacheCanvasDimensions:function(){var h=this.getTotalObjectScaling(),c=this._getTransformedDimensions(0,0),f=c.x*h.scaleX/this.scaleX,p=c.y*h.scaleY/this.scaleY;return{width:f+2,height:p+2,zoomX:h.scaleX,zoomY:h.scaleY,x:f,y:p}},_updateCacheCanvas:function(){var h=this.canvas;if(this.noScaleCache&&h&&h._currentTransform){var c=h._currentTransform.target,f=h._currentTransform.action;if(this===c&&f.slice&&f.slice(0,5)==="scale")return!1}var p,y,b=this._cacheCanvas,C=this._limitCacheSize(this._getCacheCanvasDimensions()),T=i.minCacheSideLimit,O=C.width,F=C.height,B=C.zoomX,H=C.zoomY,U=O!==this.cacheWidth||F!==this.cacheHeight,V=this.zoomX!==B||this.zoomY!==H,L=U||V,R=0,N=0,W=!1;if(U){var Y=this._cacheCanvas.width,P=this._cacheCanvas.height,M=O>Y||F>P;W=M||(O<.9*Y||F<.9*P)&&Y>T&&P>T,M&&!C.capped&&(O>T||F>T)&&(R=.1*O,N=.1*F)}return this instanceof i.Text&&this.path&&(L=!0,W=!0,R+=this.getHeightOfLine(0)*this.zoomX,N+=this.getHeightOfLine(0)*this.zoomY),!!L&&(W?(b.width=Math.ceil(O+R),b.height=Math.ceil(F+N)):(this._cacheContext.setTransform(1,0,0,1,0,0),this._cacheContext.clearRect(0,0,b.width,b.height)),p=C.x/2,y=C.y/2,this.cacheTranslationX=Math.round(b.width/2-p)+p,this.cacheTranslationY=Math.round(b.height/2-y)+y,this.cacheWidth=O,this.cacheHeight=F,this._cacheContext.translate(this.cacheTranslationX,this.cacheTranslationY),this._cacheContext.scale(B,H),this.zoomX=B,this.zoomY=H,!0)},setOptions:function(h){this._setOptions(h),this._initGradient(h.fill,"fill"),this._initGradient(h.stroke,"stroke"),this._initPattern(h.fill,"fill"),this._initPattern(h.stroke,"stroke")},transform:function(h){var c=this.group&&!this.group._transformDone||this.group&&this.canvas&&h===this.canvas.contextTop,f=this.calcTransformMatrix(!c);h.transform(f[0],f[1],f[2],f[3],f[4],f[5])},toObject:function(h){var c=i.Object.NUM_FRACTION_DIGITS,f={type:this.type,version:i.version,originX:this.originX,originY:this.originY,left:e(this.left,c),top:e(this.top,c),width:e(this.width,c),height:e(this.height,c),fill:this.fill&&this.fill.toObject?this.fill.toObject():this.fill,stroke:this.stroke&&this.stroke.toObject?this.stroke.toObject():this.stroke,strokeWidth:e(this.strokeWidth,c),strokeDashArray:this.strokeDashArray?this.strokeDashArray.concat():this.strokeDashArray,strokeLineCap:this.strokeLineCap,strokeDashOffset:this.strokeDashOffset,strokeLineJoin:this.strokeLineJoin,strokeUniform:this.strokeUniform,strokeMiterLimit:e(this.strokeMiterLimit,c),scaleX:e(this.scaleX,c),scaleY:e(this.scaleY,c),angle:e(this.angle,c),flipX:this.flipX,flipY:this.flipY,opacity:e(this.opacity,c),shadow:this.shadow&&this.shadow.toObject?this.shadow.toObject():this.shadow,visible:this.visible,backgroundColor:this.backgroundColor,fillRule:this.fillRule,paintFirst:this.paintFirst,globalCompositeOperation:this.globalCompositeOperation,skewX:e(this.skewX,c),skewY:e(this.skewY,c)};return this.clipPath&&!this.clipPath.excludeFromExport&&(f.clipPath=this.clipPath.toObject(h),f.clipPath.inverted=this.clipPath.inverted,f.clipPath.absolutePositioned=this.clipPath.absolutePositioned),i.util.populateWithProperties(this,f,h),this.includeDefaultValues||(f=this._removeDefaultValues(f)),f},toDatalessObject:function(h){return this.toObject(h)},_removeDefaultValues:function(h){var c=i.util.getKlass(h.type).prototype;return c.stateProperties.forEach(function(f){f!=="left"&&f!=="top"&&(h[f]===c[f]&&delete h[f],Array.isArray(h[f])&&Array.isArray(c[f])&&h[f].length===0&&c[f].length===0&&delete h[f])}),h},toString:function(){return"#<fabric."+t(this.type)+">"},getObjectScaling:function(){if(!this.group)return{scaleX:this.scaleX,scaleY:this.scaleY};var h=i.util.qrDecompose(this.calcTransformMatrix());return{scaleX:Math.abs(h.scaleX),scaleY:Math.abs(h.scaleY)}},getTotalObjectScaling:function(){var h=this.getObjectScaling(),c=h.scaleX,f=h.scaleY;if(this.canvas){var p=this.canvas.getZoom(),y=this.canvas.getRetinaScaling();c*=p*y,f*=p*y}return{scaleX:c,scaleY:f}},getObjectOpacity:function(){var h=this.opacity;return this.group&&(h*=this.group.getObjectOpacity()),h},_set:function(h,c){var f=h==="scaleX"||h==="scaleY",p=this[h]!==c,y=!1;return f&&(c=this._constrainScale(c)),h==="scaleX"&&c<0?(this.flipX=!this.flipX,c*=-1):h==="scaleY"&&c<0?(this.flipY=!this.flipY,c*=-1):h!=="shadow"||!c||c instanceof i.Shadow?h==="dirty"&&this.group&&this.group.set("dirty",c):c=new i.Shadow(c),this[h]=c,p&&(y=this.group&&this.group.isOnACache(),this.cacheProperties.indexOf(h)>-1?(this.dirty=!0,y&&this.group.set("dirty",!0)):y&&this.stateProperties.indexOf(h)>-1&&this.group.set("dirty",!0)),this},setOnGroup:function(){},getViewportTransform:function(){return this.canvas&&this.canvas.viewportTransform?this.canvas.viewportTransform:i.iMatrix.concat()},isNotVisible:function(){return this.opacity===0||!this.width&&!this.height&&this.strokeWidth===0||!this.visible},render:function(h){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(h.save(),this._setupCompositeOperation(h),this.drawSelectionBackground(h),this.transform(h),this._setOpacity(h),this._setShadow(h,this),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(h)):(this._removeCacheCanvas(),this.dirty=!1,this.drawObject(h),this.objectCaching&&this.statefullCache&&this.saveState({propertySet:"cacheProperties"})),h.restore())},renderCache:function(h){h=h||{},this._cacheCanvas&&this._cacheContext||this._createCacheCanvas(),this.isCacheDirty()&&(this.statefullCache&&this.saveState({propertySet:"cacheProperties"}),this.drawObject(this._cacheContext,h.forClipping),this.dirty=!1)},_removeCacheCanvas:function(){this._cacheCanvas=null,this._cacheContext=null,this.cacheWidth=0,this.cacheHeight=0},hasStroke:function(){return this.stroke&&this.stroke!=="transparent"&&this.strokeWidth!==0},hasFill:function(){return this.fill&&this.fill!=="transparent"},needsItsOwnCache:function(){return!(this.paintFirst!=="stroke"||!this.hasFill()||!this.hasStroke()||typeof this.shadow!="object")||!!this.clipPath},shouldCache:function(){return this.ownCaching=this.needsItsOwnCache()||this.objectCaching&&(!this.group||!this.group.isOnACache()),this.ownCaching},willDrawShadow:function(){return!!this.shadow&&(this.shadow.offsetX!==0||this.shadow.offsetY!==0)},drawClipPathOnCache:function(h,c){if(h.save(),c.inverted?h.globalCompositeOperation="destination-out":h.globalCompositeOperation="destination-in",c.absolutePositioned){var f=i.util.invertTransform(this.calcTransformMatrix());h.transform(f[0],f[1],f[2],f[3],f[4],f[5])}c.transform(h),h.scale(1/c.zoomX,1/c.zoomY),h.drawImage(c._cacheCanvas,-c.cacheTranslationX,-c.cacheTranslationY),h.restore()},drawObject:function(h,c){var f=this.fill,p=this.stroke;c?(this.fill="black",this.stroke="",this._setClippingProperties(h)):this._renderBackground(h),this._render(h),this._drawClipPath(h,this.clipPath),this.fill=f,this.stroke=p},_drawClipPath:function(h,c){c&&(c.canvas=this.canvas,c.shouldCache(),c._transformDone=!0,c.renderCache({forClipping:!0}),this.drawClipPathOnCache(h,c))},drawCacheOnCanvas:function(h){h.scale(1/this.zoomX,1/this.zoomY),h.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)},isCacheDirty:function(h){if(this.isNotVisible())return!1;if(this._cacheCanvas&&this._cacheContext&&!h&&this._updateCacheCanvas())return!0;if(this.dirty||this.clipPath&&this.clipPath.absolutePositioned||this.statefullCache&&this.hasStateChanged("cacheProperties")){if(this._cacheCanvas&&this._cacheContext&&!h){var c=this.cacheWidth/this.zoomX,f=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-c/2,-f/2,c,f)}return!0}return!1},_renderBackground:function(h){if(this.backgroundColor){var c=this._getNonTransformedDimensions();h.fillStyle=this.backgroundColor,h.fillRect(-c.x/2,-c.y/2,c.x,c.y),this._removeShadow(h)}},_setOpacity:function(h){this.group&&!this.group._transformDone?h.globalAlpha=this.getObjectOpacity():h.globalAlpha*=this.opacity},_setStrokeStyles:function(h,c){var f=c.stroke;f&&(h.lineWidth=c.strokeWidth,h.lineCap=c.strokeLineCap,h.lineDashOffset=c.strokeDashOffset,h.lineJoin=c.strokeLineJoin,h.miterLimit=c.strokeMiterLimit,f.toLive?f.gradientUnits==="percentage"||f.gradientTransform||f.patternTransform?this._applyPatternForTransformedGradient(h,f):(h.strokeStyle=f.toLive(h,this),this._applyPatternGradientTransform(h,f)):h.strokeStyle=c.stroke)},_setFillStyles:function(h,c){var f=c.fill;f&&(f.toLive?(h.fillStyle=f.toLive(h,this),this._applyPatternGradientTransform(h,c.fill)):h.fillStyle=f)},_setClippingProperties:function(h){h.globalAlpha=1,h.strokeStyle="transparent",h.fillStyle="#000000"},_setLineDash:function(h,c){c&&c.length!==0&&(1&c.length&&c.push.apply(c,c),h.setLineDash(c))},_renderControls:function(h,c){var f,p,y,b=this.getViewportTransform(),C=this.calcTransformMatrix();p=(c=c||{}).hasBorders!==void 0?c.hasBorders:this.hasBorders,y=c.hasControls!==void 0?c.hasControls:this.hasControls,C=i.util.multiplyTransformMatrices(b,C),f=i.util.qrDecompose(C),h.save(),h.translate(f.translateX,f.translateY),h.lineWidth=1*this.borderScaleFactor,this.group||(h.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),this.flipX&&(f.angle-=180),h.rotate(o(this.group?f.angle:this.angle)),c.forActiveSelection||this.group?p&&this.drawBordersInGroup(h,f,c):p&&this.drawBorders(h,c),y&&this.drawControls(h,c),h.restore()},_setShadow:function(h){if(this.shadow){var c,f=this.shadow,p=this.canvas,y=p&&p.viewportTransform[0]||1,b=p&&p.viewportTransform[3]||1;c=f.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),p&&p._isRetinaScaling()&&(y*=i.devicePixelRatio,b*=i.devicePixelRatio),h.shadowColor=f.color,h.shadowBlur=f.blur*i.browserShadowBlurConstant*(y+b)*(c.scaleX+c.scaleY)/4,h.shadowOffsetX=f.offsetX*y*c.scaleX,h.shadowOffsetY=f.offsetY*b*c.scaleY}},_removeShadow:function(h){this.shadow&&(h.shadowColor="",h.shadowBlur=h.shadowOffsetX=h.shadowOffsetY=0)},_applyPatternGradientTransform:function(h,c){if(!c||!c.toLive)return{offsetX:0,offsetY:0};var f=c.gradientTransform||c.patternTransform,p=-this.width/2+c.offsetX||0,y=-this.height/2+c.offsetY||0;return c.gradientUnits==="percentage"?h.transform(this.width,0,0,this.height,p,y):h.transform(1,0,0,1,p,y),f&&h.transform(f[0],f[1],f[2],f[3],f[4],f[5]),{offsetX:p,offsetY:y}},_renderPaintInOrder:function(h){this.paintFirst==="stroke"?(this._renderStroke(h),this._renderFill(h)):(this._renderFill(h),this._renderStroke(h))},_render:function(){},_renderFill:function(h){this.fill&&(h.save(),this._setFillStyles(h,this),this.fillRule==="evenodd"?h.fill("evenodd"):h.fill(),h.restore())},_renderStroke:function(h){if(this.stroke&&this.strokeWidth!==0){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(h),h.save(),this.strokeUniform&&this.group){var c=this.getObjectScaling();h.scale(1/c.scaleX,1/c.scaleY)}else this.strokeUniform&&h.scale(1/this.scaleX,1/this.scaleY);this._setLineDash(h,this.strokeDashArray),this._setStrokeStyles(h,this),h.stroke(),h.restore()}},_applyPatternForTransformedGradient:function(h,c){var f,p=this._limitCacheSize(this._getCacheCanvasDimensions()),y=i.util.createCanvasElement(),b=this.canvas.getRetinaScaling(),C=p.x/this.scaleX/b,T=p.y/this.scaleY/b;y.width=C,y.height=T,(f=y.getContext("2d")).beginPath(),f.moveTo(0,0),f.lineTo(C,0),f.lineTo(C,T),f.lineTo(0,T),f.closePath(),f.translate(C/2,T/2),f.scale(p.zoomX/this.scaleX/b,p.zoomY/this.scaleY/b),this._applyPatternGradientTransform(f,c),f.fillStyle=c.toLive(h),f.fill(),h.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),h.scale(b*this.scaleX/p.zoomX,b*this.scaleY/p.zoomY),h.strokeStyle=f.createPattern(y,"no-repeat")},_findCenterFromElement:function(){return{x:this.left+this.width/2,y:this.top+this.height/2}},_assignTransformMatrixProps:function(){if(this.transformMatrix){var h=i.util.qrDecompose(this.transformMatrix);this.flipX=!1,this.flipY=!1,this.set("scaleX",h.scaleX),this.set("scaleY",h.scaleY),this.angle=h.angle,this.skewX=h.skewX,this.skewY=0}},_removeTransformMatrix:function(h){var c=this._findCenterFromElement();this.transformMatrix&&(this._assignTransformMatrixProps(),c=i.util.transformPoint(c,this.transformMatrix)),this.transformMatrix=null,h&&(this.scaleX*=h.scaleX,this.scaleY*=h.scaleY,this.cropX=h.cropX,this.cropY=h.cropY,c.x+=h.offsetLeft,c.y+=h.offsetTop,this.width=h.width,this.height=h.height),this.setPositionByOrigin(c,"center","center")},clone:function(h,c){var f=this.toObject(c);this.constructor.fromObject?this.constructor.fromObject(f,h):i.Object._fromObject("Object",f,h)},cloneAsImage:function(h,c){var f=this.toCanvasElement(c);return h&&h(new i.Image(f)),this},toCanvasElement:function(h){h||(h={});var c=i.util,f=c.saveObjectTransform(this),p=this.group,y=this.shadow,b=Math.abs,C=(h.multiplier||1)*(h.enableRetinaScaling?i.devicePixelRatio:1);delete this.group,h.withoutTransform&&c.resetObjectTransform(this),h.withoutShadow&&(this.shadow=null);var T,O,F,B,H=i.util.createCanvasElement(),U=this.getBoundingRect(!0,!0),V=this.shadow,L={x:0,y:0};V&&(O=V.blur,T=V.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),L.x=2*Math.round(b(V.offsetX)+O)*b(T.scaleX),L.y=2*Math.round(b(V.offsetY)+O)*b(T.scaleY)),F=U.width+L.x,B=U.height+L.y,H.width=Math.ceil(F),H.height=Math.ceil(B);var R=new i.StaticCanvas(H,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1});h.format==="jpeg"&&(R.backgroundColor="#fff"),this.setPositionByOrigin(new i.Point(R.width/2,R.height/2),"center","center");var N=this.canvas;R.add(this);var W=R.toCanvasElement(C||1,h);return this.shadow=y,this.set("canvas",N),p&&(this.group=p),this.set(f).setCoords(),R._objects=[],R.dispose(),R=null,W},toDataURL:function(h){return h||(h={}),i.util.toDataURL(this.toCanvasElement(h),h.format||"png",h.quality||1)},isType:function(h){return arguments.length>1?Array.from(arguments).includes(this.type):this.type===h},complexity:function(){return 1},toJSON:function(h){return this.toObject(h)},rotate:function(h){var c=(this.originX!=="center"||this.originY!=="center")&&this.centeredRotation;return c&&this._setOriginToCenter(),this.set("angle",h),c&&this._resetOrigin(),this},centerH:function(){return this.canvas&&this.canvas.centerObjectH(this),this},viewportCenterH:function(){return this.canvas&&this.canvas.viewportCenterObjectH(this),this},centerV:function(){return this.canvas&&this.canvas.centerObjectV(this),this},viewportCenterV:function(){return this.canvas&&this.canvas.viewportCenterObjectV(this),this},center:function(){return this.canvas&&this.canvas.centerObject(this),this},viewportCenter:function(){return this.canvas&&this.canvas.viewportCenterObject(this),this},getLocalPointer:function(h,c){c=c||this.canvas.getPointer(h);var f=new i.Point(c.x,c.y),p=this._getLeftTopCoords();return this.angle&&(f=i.util.rotatePoint(f,p,o(-this.angle))),{x:f.x-p.x,y:f.y-p.y}},_setupCompositeOperation:function(h){this.globalCompositeOperation&&(h.globalCompositeOperation=this.globalCompositeOperation)},dispose:function(){i.runningAnimations&&i.runningAnimations.cancelByTarget(this)}}),i.util.createAccessors&&i.util.createAccessors(i.Object),s(i.Object.prototype,i.Observable),i.Object.NUM_FRACTION_DIGITS=2,i.Object.ENLIVEN_PROPS=["clipPath"],i.Object._fromObject=function(h,c,f,p){var y=i[h];c=l(c,!0),i.util.enlivenPatterns([c.fill,c.stroke],function(b){b[0]!==void 0&&(c.fill=b[0]),b[1]!==void 0&&(c.stroke=b[1]),i.util.enlivenObjectEnlivables(c,c,function(){var C=p?new y(c[p],c):new y(c);f&&f(C)})})},i.Object.__uid=0)}(r),Q=g.util.degreesToRadians,fe={left:-.5,center:0,right:.5},J={top:-.5,center:0,bottom:.5},g.util.object.extend(g.Object.prototype,{translateToGivenOrigin:function(n,i,s,l,e){var t,o,d,h=n.x,c=n.y;return typeof i=="string"?i=fe[i]:i-=.5,typeof l=="string"?l=fe[l]:l-=.5,typeof s=="string"?s=J[s]:s-=.5,typeof e=="string"?e=J[e]:e-=.5,o=e-s,((t=l-i)||o)&&(d=this._getTransformedDimensions(),h=n.x+t*d.x,c=n.y+o*d.y),new g.Point(h,c)},translateToCenterPoint:function(n,i,s){var l=this.translateToGivenOrigin(n,i,s,"center","center");return this.angle?g.util.rotatePoint(l,n,Q(this.angle)):l},translateToOriginPoint:function(n,i,s){var l=this.translateToGivenOrigin(n,"center","center",i,s);return this.angle?g.util.rotatePoint(l,n,Q(this.angle)):l},getCenterPoint:function(){var n=new g.Point(this.left,this.top);return this.translateToCenterPoint(n,this.originX,this.originY)},getPointByOrigin:function(n,i){var s=this.getCenterPoint();return this.translateToOriginPoint(s,n,i)},toLocalPoint:function(n,i,s){var l,e,t=this.getCenterPoint();return l=i!==void 0&&s!==void 0?this.translateToGivenOrigin(t,"center","center",i,s):new g.Point(this.left,this.top),e=new g.Point(n.x,n.y),this.angle&&(e=g.util.rotatePoint(e,t,-Q(this.angle))),e.subtractEquals(l)},setPositionByOrigin:function(n,i,s){var l=this.translateToCenterPoint(n,i,s),e=this.translateToOriginPoint(l,this.originX,this.originY);this.set("left",e.x),this.set("top",e.y)},adjustPosition:function(n){var i,s,l=Q(this.angle),e=this.getScaledWidth(),t=g.util.cos(l)*e,o=g.util.sin(l)*e;i=typeof this.originX=="string"?fe[this.originX]:this.originX-.5,s=typeof n=="string"?fe[n]:n-.5,this.left+=t*(s-i),this.top+=o*(s-i),this.setCoords(),this.originX=n},_setOriginToCenter:function(){this._originalOriginX=this.originX,this._originalOriginY=this.originY;var n=this.getCenterPoint();this.originX="center",this.originY="center",this.left=n.x,this.top=n.y},_resetOrigin:function(){var n=this.translateToOriginPoint(this.getCenterPoint(),this._originalOriginX,this._originalOriginY);this.originX=this._originalOriginX,this.originY=this._originalOriginY,this.left=n.x,this.top=n.y,this._originalOriginX=null,this._originalOriginY=null},_getLeftTopCoords:function(){return this.translateToOriginPoint(this.getCenterPoint(),"left","top")}}),function(){var n=g.util,i=n.degreesToRadians,s=n.multiplyTransformMatrices,l=n.transformPoint;n.object.extend(g.Object.prototype,{oCoords:null,aCoords:null,lineCoords:null,ownMatrixCache:null,matrixCache:null,controls:{},_getCoords:function(e,t){return t?e?this.calcACoords():this.calcLineCoords():(this.aCoords&&this.lineCoords||this.setCoords(!0),e?this.aCoords:this.lineCoords)},getCoords:function(e,t){return o=this._getCoords(e,t),[new g.Point(o.tl.x,o.tl.y),new g.Point(o.tr.x,o.tr.y),new g.Point(o.br.x,o.br.y),new g.Point(o.bl.x,o.bl.y)];var o},intersectsWithRect:function(e,t,o,d){var h=this.getCoords(o,d);return g.Intersection.intersectPolygonRectangle(h,e,t).status==="Intersection"},intersectsWithObject:function(e,t,o){return g.Intersection.intersectPolygonPolygon(this.getCoords(t,o),e.getCoords(t,o)).status==="Intersection"||e.isContainedWithinObject(this,t,o)||this.isContainedWithinObject(e,t,o)},isContainedWithinObject:function(e,t,o){for(var d=this.getCoords(t,o),h=t?e.aCoords:e.lineCoords,c=0,f=e._getImageLines(h);c<4;c++)if(!e.containsPoint(d[c],f))return!1;return!0},isContainedWithinRect:function(e,t,o,d){var h=this.getBoundingRect(o,d);return h.left>=e.x&&h.left+h.width<=t.x&&h.top>=e.y&&h.top+h.height<=t.y},containsPoint:function(e,t,o,d){var h=this._getCoords(o,d),c=(t=t||this._getImageLines(h),this._findCrossPoints(e,t));return c!==0&&c%2==1},isOnScreen:function(e){if(!this.canvas)return!1;var t=this.canvas.vptCoords.tl,o=this.canvas.vptCoords.br;return!!this.getCoords(!0,e).some(function(d){return d.x<=o.x&&d.x>=t.x&&d.y<=o.y&&d.y>=t.y})||!!this.intersectsWithRect(t,o,!0,e)||this._containsCenterOfCanvas(t,o,e)},_containsCenterOfCanvas:function(e,t,o){var d={x:(e.x+t.x)/2,y:(e.y+t.y)/2};return!!this.containsPoint(d,null,!0,o)},isPartiallyOnScreen:function(e){if(!this.canvas)return!1;var t=this.canvas.vptCoords.tl,o=this.canvas.vptCoords.br;return!!this.intersectsWithRect(t,o,!0,e)||this.getCoords(!0,e).every(function(d){return(d.x>=o.x||d.x<=t.x)&&(d.y>=o.y||d.y<=t.y)})&&this._containsCenterOfCanvas(t,o,e)},_getImageLines:function(e){return{topline:{o:e.tl,d:e.tr},rightline:{o:e.tr,d:e.br},bottomline:{o:e.br,d:e.bl},leftline:{o:e.bl,d:e.tl}}},_findCrossPoints:function(e,t){var o,d,h,c=0;for(var f in t)if(!((h=t[f]).o.y<e.y&&h.d.y<e.y||h.o.y>=e.y&&h.d.y>=e.y||(h.o.x===h.d.x&&h.o.x>=e.x?d=h.o.x:(o=(h.d.y-h.o.y)/(h.d.x-h.o.x),d=-(e.y-0*e.x-(h.o.y-o*h.o.x))/(0-o)),d>=e.x&&(c+=1),c!==2)))break;return c},getBoundingRect:function(e,t){var o=this.getCoords(e,t);return n.makeBoundingBoxFromPoints(o)},getScaledWidth:function(){return this._getTransformedDimensions().x},getScaledHeight:function(){return this._getTransformedDimensions().y},_constrainScale:function(e){return Math.abs(e)<this.minScaleLimit?e<0?-this.minScaleLimit:this.minScaleLimit:e===0?1e-4:e},scale:function(e){return this._set("scaleX",e),this._set("scaleY",e),this.setCoords()},scaleToWidth:function(e,t){var o=this.getBoundingRect(t).width/this.getScaledWidth();return this.scale(e/this.width/o)},scaleToHeight:function(e,t){var o=this.getBoundingRect(t).height/this.getScaledHeight();return this.scale(e/this.height/o)},calcLineCoords:function(){var e=this.getViewportTransform(),t=this.padding,o=i(this.angle),d=n.cos(o)*t,h=n.sin(o)*t,c=d+h,f=d-h,p=this.calcACoords(),y={tl:l(p.tl,e),tr:l(p.tr,e),bl:l(p.bl,e),br:l(p.br,e)};return t&&(y.tl.x-=f,y.tl.y-=c,y.tr.x+=c,y.tr.y-=f,y.bl.x-=c,y.bl.y+=f,y.br.x+=f,y.br.y+=c),y},calcOCoords:function(){var e=this._calcRotateMatrix(),t=this._calcTranslateMatrix(),o=this.getViewportTransform(),d=s(o,t),h=s(d,e),c=(h=s(h,[1/o[0],0,0,1/o[3],0,0]),this._calculateCurrentDimensions()),f={};return this.forEachControl(function(p,y,b){f[y]=p.positionHandler(c,h,b)}),f},calcACoords:function(){var e=this._calcRotateMatrix(),t=this._calcTranslateMatrix(),o=s(t,e),d=this._getTransformedDimensions(),h=d.x/2,c=d.y/2;return{tl:l({x:-h,y:-c},o),tr:l({x:h,y:-c},o),bl:l({x:-h,y:c},o),br:l({x:h,y:c},o)}},setCoords:function(e){return this.aCoords=this.calcACoords(),this.lineCoords=this.group?this.aCoords:this.calcLineCoords(),e||(this.oCoords=this.calcOCoords(),this._setCornerCoords&&this._setCornerCoords()),this},_calcRotateMatrix:function(){return n.calcRotateMatrix(this)},_calcTranslateMatrix:function(){var e=this.getCenterPoint();return[1,0,0,1,e.x,e.y]},transformMatrixKey:function(e){var t="_",o="";return!e&&this.group&&(o=this.group.transformMatrixKey(e)+t),o+this.top+t+this.left+t+this.scaleX+t+this.scaleY+t+this.skewX+t+this.skewY+t+this.angle+t+this.originX+t+this.originY+t+this.width+t+this.height+t+this.strokeWidth+this.flipX+this.flipY},calcTransformMatrix:function(e){var t=this.calcOwnMatrix();if(e||!this.group)return t;var o=this.transformMatrixKey(e),d=this.matrixCache||(this.matrixCache={});return d.key===o?d.value:(this.group&&(t=s(this.group.calcTransformMatrix(!1),t)),d.key=o,d.value=t,t)},calcOwnMatrix:function(){var e=this.transformMatrixKey(!0),t=this.ownMatrixCache||(this.ownMatrixCache={});if(t.key===e)return t.value;var o=this._calcTranslateMatrix(),d={angle:this.angle,translateX:o[4],translateY:o[5],scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY};return t.key=e,t.value=n.composeMatrix(d),t.value},_getNonTransformedDimensions:function(){var e=this.strokeWidth;return{x:this.width+e,y:this.height+e}},_getTransformedDimensions:function(e,t){e===void 0&&(e=this.skewX),t===void 0&&(t=this.skewY);var o,d,h,c=e===0&&t===0;if(this.strokeUniform?(d=this.width,h=this.height):(d=(o=this._getNonTransformedDimensions()).x,h=o.y),c)return this._finalizeDimensions(d*this.scaleX,h*this.scaleY);var f=n.sizeAfterTransform(d,h,{scaleX:this.scaleX,scaleY:this.scaleY,skewX:e,skewY:t});return this._finalizeDimensions(f.x,f.y)},_finalizeDimensions:function(e,t){return this.strokeUniform?{x:e+this.strokeWidth,y:t+this.strokeWidth}:{x:e,y:t}},_calculateCurrentDimensions:function(){var e=this.getViewportTransform(),t=this._getTransformedDimensions();return l(t,e,!0).scalarAdd(2*this.padding)}})}(),g.util.object.extend(g.Object.prototype,{sendToBack:function(){return this.group?g.StaticCanvas.prototype.sendToBack.call(this.group,this):this.canvas&&this.canvas.sendToBack(this),this},bringToFront:function(){return this.group?g.StaticCanvas.prototype.bringToFront.call(this.group,this):this.canvas&&this.canvas.bringToFront(this),this},sendBackwards:function(n){return this.group?g.StaticCanvas.prototype.sendBackwards.call(this.group,this,n):this.canvas&&this.canvas.sendBackwards(this,n),this},bringForward:function(n){return this.group?g.StaticCanvas.prototype.bringForward.call(this.group,this,n):this.canvas&&this.canvas.bringForward(this,n),this},moveTo:function(n){return this.group&&this.group.type!=="activeSelection"?g.StaticCanvas.prototype.moveTo.call(this.group,this,n):this.canvas&&this.canvas.moveTo(this,n),this}}),function(){function n(s,l){if(l){if(l.toLive)return s+": url(#SVGID_"+l.id+"); ";var e=new g.Color(l),t=s+": "+e.toRgb()+"; ",o=e.getAlpha();return o!==1&&(t+=s+"-opacity: "+o.toString()+"; "),t}return s+": none; "}var i=g.util.toFixed;g.util.object.extend(g.Object.prototype,{getSvgStyles:function(s){var l=this.fillRule?this.fillRule:"nonzero",e=this.strokeWidth?this.strokeWidth:"0",t=this.strokeDashArray?this.strokeDashArray.join(" "):"none",o=this.strokeDashOffset?this.strokeDashOffset:"0",d=this.strokeLineCap?this.strokeLineCap:"butt",h=this.strokeLineJoin?this.strokeLineJoin:"miter",c=this.strokeMiterLimit?this.strokeMiterLimit:"4",f=this.opacity!==void 0?this.opacity:"1",p=this.visible?"":" visibility: hidden;",y=s?"":this.getSvgFilter(),b=n("fill",this.fill);return[n("stroke",this.stroke),"stroke-width: ",e,"; ","stroke-dasharray: ",t,"; ","stroke-linecap: ",d,"; ","stroke-dashoffset: ",o,"; ","stroke-linejoin: ",h,"; ","stroke-miterlimit: ",c,"; ",b,"fill-rule: ",l,"; ","opacity: ",f,";",y,p].join("")},getSvgSpanStyles:function(s,l){var e="; ",t=s.fontFamily?"font-family: "+(s.fontFamily.indexOf("'")===-1&&s.fontFamily.indexOf('"')===-1?"'"+s.fontFamily+"'":s.fontFamily)+e:"",o=s.strokeWidth?"stroke-width: "+s.strokeWidth+e:"",d=s.fontSize?"font-size: "+s.fontSize+"px"+e:"",h=s.fontStyle?"font-style: "+s.fontStyle+e:"",c=s.fontWeight?"font-weight: "+s.fontWeight+e:"",f=s.fill?n("fill",s.fill):"",p=s.stroke?n("stroke",s.stroke):"",y=this.getSvgTextDecoration(s);return y&&(y="text-decoration: "+y+e),[p,o,t,d,h,c,y,f,s.deltaY?"baseline-shift: "+-s.deltaY+"; ":"",l?"white-space: pre; ":""].join("")},getSvgTextDecoration:function(s){return["overline","underline","line-through"].filter(function(l){return s[l.replace("-","")]}).join(" ")},getSvgFilter:function(){return this.shadow?"filter: url(#SVGID_"+this.shadow.id+");":""},getSvgCommons:function(){return[this.id?'id="'+this.id+'" ':"",this.clipPath?'clip-path="url(#'+this.clipPath.clipPathId+')" ':""].join("")},getSvgTransform:function(s,l){var e=s?this.calcTransformMatrix():this.calcOwnMatrix();return'transform="'+g.util.matrixToSVG(e)+(l||"")+'" '},_setSVGBg:function(s){if(this.backgroundColor){var l=g.Object.NUM_FRACTION_DIGITS;s.push("		<rect ",this._getFillAttributes(this.backgroundColor),' x="',i(-this.width/2,l),'" y="',i(-this.height/2,l),'" width="',i(this.width,l),'" height="',i(this.height,l),`"></rect>
`)}},toSVG:function(s){return this._createBaseSVGMarkup(this._toSVG(s),{reviver:s})},toClipPathSVG:function(s){return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(s),{reviver:s})},_createBaseClipPathSVGMarkup:function(s,l){var e=(l=l||{}).reviver,t=l.additionalTransform||"",o=[this.getSvgTransform(!0,t),this.getSvgCommons()].join(""),d=s.indexOf("COMMON_PARTS");return s[d]=o,e?e(s.join("")):s.join("")},_createBaseSVGMarkup:function(s,l){var e,t,o=(l=l||{}).noStyle,d=l.reviver,h=o?"":'style="'+this.getSvgStyles()+'" ',c=l.withShadow?'style="'+this.getSvgFilter()+'" ':"",f=this.clipPath,p=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",y=f&&f.absolutePositioned,b=this.stroke,C=this.fill,T=this.shadow,O=[],F=s.indexOf("COMMON_PARTS"),B=l.additionalTransform;return f&&(f.clipPathId="CLIPPATH_"+g.Object.__uid++,t='<clipPath id="'+f.clipPathId+`" >
`+f.toClipPathSVG(d)+`</clipPath>
`),y&&O.push("<g ",c,this.getSvgCommons(),` >
`),O.push("<g ",this.getSvgTransform(!1),y?"":c+this.getSvgCommons(),` >
`),e=[h,p,o?"":this.addPaintOrder()," ",B?'transform="'+B+'" ':""].join(""),s[F]=e,C&&C.toLive&&O.push(C.toSVG(this)),b&&b.toLive&&O.push(b.toSVG(this)),T&&O.push(T.toSVG(this)),f&&O.push(t),O.push(s.join("")),O.push(`</g>
`),y&&O.push(`</g>
`),d?d(O.join("")):O.join("")},addPaintOrder:function(){return this.paintFirst!=="fill"?' paint-order="'+this.paintFirst+'" ':""}})}(),function(){var n=g.util.object.extend,i="stateProperties";function s(e,t,o){var d={};o.forEach(function(h){d[h]=e[h]}),n(e[t],d,!0)}function l(e,t,o){if(e===t)return!0;if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(var d=0,h=e.length;d<h;d++)if(!l(e[d],t[d]))return!1;return!0}if(e&&typeof e=="object"){var c,f=Object.keys(e);if(!t||typeof t!="object"||!o&&f.length!==Object.keys(t).length)return!1;for(d=0,h=f.length;d<h;d++)if((c=f[d])!=="canvas"&&c!=="group"&&!l(e[c],t[c]))return!1;return!0}}g.util.object.extend(g.Object.prototype,{hasStateChanged:function(e){var t="_"+(e=e||i);return Object.keys(this[t]).length<this[e].length||!l(this[t],this,!0)},saveState:function(e){var t=e&&e.propertySet||i,o="_"+t;return this[o]?(s(this,o,this[t]),e&&e.stateProperties&&s(this,o,e.stateProperties),this):this.setupState(e)},setupState:function(e){var t=(e=e||{}).propertySet||i;return e.propertySet=t,this["_"+t]={},this.saveState(e),this}})}(),function(){var n=g.util.degreesToRadians;g.util.object.extend(g.Object.prototype,{_findTargetCorner:function(i,s){if(!this.hasControls||this.group||!this.canvas||this.canvas._activeObject!==this)return!1;var l,e,t,o=i.x,d=i.y,h=Object.keys(this.oCoords),c=h.length-1;for(this.__corner=0;c>=0;c--)if(t=h[c],this.isControlVisible(t)&&(e=this._getImageLines(s?this.oCoords[t].touchCorner:this.oCoords[t].corner),(l=this._findCrossPoints({x:o,y:d},e))!==0&&l%2==1))return this.__corner=t,t;return!1},forEachControl:function(i){for(var s in this.controls)i(this.controls[s],s,this)},_setCornerCoords:function(){var i=this.oCoords;for(var s in i){var l=this.controls[s];i[s].corner=l.calcCornerCoords(this.angle,this.cornerSize,i[s].x,i[s].y,!1),i[s].touchCorner=l.calcCornerCoords(this.angle,this.touchCornerSize,i[s].x,i[s].y,!0)}},drawSelectionBackground:function(i){if(!this.selectionBackgroundColor||this.canvas&&!this.canvas.interactive||this.canvas&&this.canvas._activeObject!==this)return this;i.save();var s=this.getCenterPoint(),l=this._calculateCurrentDimensions(),e=this.canvas.viewportTransform;return i.translate(s.x,s.y),i.scale(1/e[0],1/e[3]),i.rotate(n(this.angle)),i.fillStyle=this.selectionBackgroundColor,i.fillRect(-l.x/2,-l.y/2,l.x,l.y),i.restore(),this},drawBorders:function(i,s){s=s||{};var l=this._calculateCurrentDimensions(),e=this.borderScaleFactor,t=l.x+e,o=l.y+e,d=s.hasControls!==void 0?s.hasControls:this.hasControls,h=!1;return i.save(),i.strokeStyle=s.borderColor||this.borderColor,this._setLineDash(i,s.borderDashArray||this.borderDashArray),i.strokeRect(-t/2,-o/2,t,o),d&&(i.beginPath(),this.forEachControl(function(c,f,p){c.withConnection&&c.getVisibility(p,f)&&(h=!0,i.moveTo(c.x*t,c.y*o),i.lineTo(c.x*t+c.offsetX,c.y*o+c.offsetY))}),h&&i.stroke()),i.restore(),this},drawBordersInGroup:function(i,s,l){l=l||{};var e=g.util.sizeAfterTransform(this.width,this.height,s),t=this.strokeWidth,o=this.strokeUniform,d=this.borderScaleFactor,h=e.x+t*(o?this.canvas.getZoom():s.scaleX)+d,c=e.y+t*(o?this.canvas.getZoom():s.scaleY)+d;return i.save(),this._setLineDash(i,l.borderDashArray||this.borderDashArray),i.strokeStyle=l.borderColor||this.borderColor,i.strokeRect(-h/2,-c/2,h,c),i.restore(),this},drawControls:function(i,s){s=s||{},i.save();var l,e,t=this.canvas.getRetinaScaling();return i.setTransform(t,0,0,t,0,0),i.strokeStyle=i.fillStyle=s.cornerColor||this.cornerColor,this.transparentCorners||(i.strokeStyle=s.cornerStrokeColor||this.cornerStrokeColor),this._setLineDash(i,s.cornerDashArray||this.cornerDashArray),this.setCoords(),this.group&&(l=this.group.calcTransformMatrix()),this.forEachControl(function(o,d,h){e=h.oCoords[d],o.getVisibility(h,d)&&(l&&(e=g.util.transformPoint(e,l)),o.render(i,e.x,e.y,s,h))}),i.restore(),this},isControlVisible:function(i){return this.controls[i]&&this.controls[i].getVisibility(this,i)},setControlVisible:function(i,s){return this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[i]=s,this},setControlsVisibility:function(i){for(var s in i||(i={}),i)this.setControlVisible(s,i[s]);return this},onDeselect:function(){},onSelect:function(){}})}(),g.util.object.extend(g.StaticCanvas.prototype,{FX_DURATION:500,fxCenterObjectH:function(n,i){var s=function(){},l=(i=i||{}).onComplete||s,e=i.onChange||s,t=this;return g.util.animate({target:this,startValue:n.left,endValue:this.getCenterPoint().x,duration:this.FX_DURATION,onChange:function(o){n.set("left",o),t.requestRenderAll(),e()},onComplete:function(){n.setCoords(),l()}})},fxCenterObjectV:function(n,i){var s=function(){},l=(i=i||{}).onComplete||s,e=i.onChange||s,t=this;return g.util.animate({target:this,startValue:n.top,endValue:this.getCenterPoint().y,duration:this.FX_DURATION,onChange:function(o){n.set("top",o),t.requestRenderAll(),e()},onComplete:function(){n.setCoords(),l()}})},fxRemove:function(n,i){var s=function(){},l=(i=i||{}).onComplete||s,e=i.onChange||s,t=this;return g.util.animate({target:this,startValue:n.opacity,endValue:0,duration:this.FX_DURATION,onChange:function(o){n.set("opacity",o),t.requestRenderAll(),e()},onComplete:function(){t.remove(n),l()}})}}),g.util.object.extend(g.Object.prototype,{animate:function(){if(arguments[0]&&typeof arguments[0]=="object"){var n,i,s=[],l=[];for(n in arguments[0])s.push(n);for(var e=0,t=s.length;e<t;e++)n=s[e],i=e!==t-1,l.push(this._animate(n,arguments[0][n],arguments[1],i));return l}return this._animate.apply(this,arguments)},_animate:function(n,i,s,l){var e,t=this;i=i.toString(),s=s?g.util.object.clone(s):{},~n.indexOf(".")&&(e=n.split("."));var o=t.colorProperties.indexOf(n)>-1||e&&t.colorProperties.indexOf(e[1])>-1,d=e?this.get(e[0])[e[1]]:this.get(n);"from"in s||(s.from=d),o||(i=~i.indexOf("=")?d+parseFloat(i.replace("=","")):parseFloat(i));var h={target:this,startValue:s.from,endValue:i,byValue:s.by,easing:s.easing,duration:s.duration,abort:s.abort&&function(c,f,p){return s.abort.call(t,c,f,p)},onChange:function(c,f,p){e?t[e[0]][e[1]]=c:t.set(n,c),l||s.onChange&&s.onChange(c,f,p)},onComplete:function(c,f,p){l||(t.setCoords(),s.onComplete&&s.onComplete(c,f,p))}};return o?g.util.animateColor(h.startValue,h.endValue,h.duration,h):g.util.animate(h)}}),function(n){var i=n.fabric||(n.fabric={}),s=i.util.object.extend,l=i.util.object.clone,e={x1:1,x2:1,y1:1,y2:1};function t(o,d){var h=o.origin,c=o.axis1,f=o.axis2,p=o.dimension,y=d.nearest,b=d.center,C=d.farthest;return function(){switch(this.get(h)){case y:return Math.min(this.get(c),this.get(f));case b:return Math.min(this.get(c),this.get(f))+.5*this.get(p);case C:return Math.max(this.get(c),this.get(f))}}}i.Line?i.warn("fabric.Line is already defined"):(i.Line=i.util.createClass(i.Object,{type:"line",x1:0,y1:0,x2:0,y2:0,cacheProperties:i.Object.prototype.cacheProperties.concat("x1","x2","y1","y2"),initialize:function(o,d){o||(o=[0,0,0,0]),this.callSuper("initialize",d),this.set("x1",o[0]),this.set("y1",o[1]),this.set("x2",o[2]),this.set("y2",o[3]),this._setWidthHeight(d)},_setWidthHeight:function(o){o||(o={}),this.width=Math.abs(this.x2-this.x1),this.height=Math.abs(this.y2-this.y1),this.left="left"in o?o.left:this._getLeftToOriginX(),this.top="top"in o?o.top:this._getTopToOriginY()},_set:function(o,d){return this.callSuper("_set",o,d),e[o]!==void 0&&this._setWidthHeight(),this},_getLeftToOriginX:t({origin:"originX",axis1:"x1",axis2:"x2",dimension:"width"},{nearest:"left",center:"center",farthest:"right"}),_getTopToOriginY:t({origin:"originY",axis1:"y1",axis2:"y2",dimension:"height"},{nearest:"top",center:"center",farthest:"bottom"}),_render:function(o){o.beginPath();var d=this.calcLinePoints();o.moveTo(d.x1,d.y1),o.lineTo(d.x2,d.y2),o.lineWidth=this.strokeWidth;var h=o.strokeStyle;o.strokeStyle=this.stroke||o.fillStyle,this.stroke&&this._renderStroke(o),o.strokeStyle=h},_findCenterFromElement:function(){return{x:(this.x1+this.x2)/2,y:(this.y1+this.y2)/2}},toObject:function(o){return s(this.callSuper("toObject",o),this.calcLinePoints())},_getNonTransformedDimensions:function(){var o=this.callSuper("_getNonTransformedDimensions");return this.strokeLineCap==="butt"&&(this.width===0&&(o.y-=this.strokeWidth),this.height===0&&(o.x-=this.strokeWidth)),o},calcLinePoints:function(){var o=this.x1<=this.x2?-1:1,d=this.y1<=this.y2?-1:1,h=o*this.width*.5,c=d*this.height*.5;return{x1:h,x2:o*this.width*-.5,y1:c,y2:d*this.height*-.5}},_toSVG:function(){var o=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="',o.x1,'" y1="',o.y1,'" x2="',o.x2,'" y2="',o.y2,`" />
`]}}),i.Line.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("x1 y1 x2 y2".split(" ")),i.Line.fromElement=function(o,d,h){h=h||{};var c=i.parseAttributes(o,i.Line.ATTRIBUTE_NAMES),f=[c.x1||0,c.y1||0,c.x2||0,c.y2||0];d(new i.Line(f,s(c,h)))},i.Line.fromObject=function(o,d){var h=l(o,!0);h.points=[o.x1,o.y1,o.x2,o.y2],i.Object._fromObject("Line",h,function(c){delete c.points,d&&d(c)},"points")})}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.util.degreesToRadians;i.Circle?i.warn("fabric.Circle is already defined."):(i.Circle=i.util.createClass(i.Object,{type:"circle",radius:0,startAngle:0,endAngle:360,cacheProperties:i.Object.prototype.cacheProperties.concat("radius","startAngle","endAngle"),_set:function(l,e){return this.callSuper("_set",l,e),l==="radius"&&this.setRadius(e),this},toObject:function(l){return this.callSuper("toObject",["radius","startAngle","endAngle"].concat(l))},_toSVG:function(){var l,e=(this.endAngle-this.startAngle)%360;if(e===0)l=["<circle ","COMMON_PARTS",'cx="0" cy="0" ','r="',this.radius,`" />
`];else{var t=s(this.startAngle),o=s(this.endAngle),d=this.radius;l=['<path d="M '+i.util.cos(t)*d+" "+i.util.sin(t)*d," A "+d+" "+d," 0 ",+(e>180?"1":"0")+" 1"," "+i.util.cos(o)*d+" "+i.util.sin(o)*d,'" ',"COMMON_PARTS",` />
`]}return l},_render:function(l){l.beginPath(),l.arc(0,0,this.radius,s(this.startAngle),s(this.endAngle),!1),this._renderPaintInOrder(l)},getRadiusX:function(){return this.get("radius")*this.get("scaleX")},getRadiusY:function(){return this.get("radius")*this.get("scaleY")},setRadius:function(l){return this.radius=l,this.set("width",2*l).set("height",2*l)}}),i.Circle.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("cx cy r".split(" ")),i.Circle.fromElement=function(l,e){var t,o=i.parseAttributes(l,i.Circle.ATTRIBUTE_NAMES);if(!("radius"in(t=o)&&t.radius>=0))throw new Error("value of `r` attribute is required and can not be negative");o.left=(o.left||0)-o.radius,o.top=(o.top||0)-o.radius,e(new i.Circle(o))},i.Circle.fromObject=function(l,e){i.Object._fromObject("Circle",l,e)})}(r),function(n){var i=n.fabric||(n.fabric={});i.Triangle?i.warn("fabric.Triangle is already defined"):(i.Triangle=i.util.createClass(i.Object,{type:"triangle",width:100,height:100,_render:function(s){var l=this.width/2,e=this.height/2;s.beginPath(),s.moveTo(-l,e),s.lineTo(0,-e),s.lineTo(l,e),s.closePath(),this._renderPaintInOrder(s)},_toSVG:function(){var s=this.width/2,l=this.height/2;return["<polygon ","COMMON_PARTS",'points="',[-s+" "+l,"0 "+-l,s+" "+l].join(","),'" />']}}),i.Triangle.fromObject=function(s,l){return i.Object._fromObject("Triangle",s,l)})}(r),function(n){var i=n.fabric||(n.fabric={}),s=2*Math.PI;i.Ellipse?i.warn("fabric.Ellipse is already defined."):(i.Ellipse=i.util.createClass(i.Object,{type:"ellipse",rx:0,ry:0,cacheProperties:i.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(l){this.callSuper("initialize",l),this.set("rx",l&&l.rx||0),this.set("ry",l&&l.ry||0)},_set:function(l,e){switch(this.callSuper("_set",l,e),l){case"rx":this.rx=e,this.set("width",2*e);break;case"ry":this.ry=e,this.set("height",2*e)}return this},getRx:function(){return this.get("rx")*this.get("scaleX")},getRy:function(){return this.get("ry")*this.get("scaleY")},toObject:function(l){return this.callSuper("toObject",["rx","ry"].concat(l))},_toSVG:function(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" ','rx="',this.rx,'" ry="',this.ry,`" />
`]},_render:function(l){l.beginPath(),l.save(),l.transform(1,0,0,this.ry/this.rx,0,0),l.arc(0,0,this.rx,0,s,!1),l.restore(),this._renderPaintInOrder(l)}}),i.Ellipse.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("cx cy rx ry".split(" ")),i.Ellipse.fromElement=function(l,e){var t=i.parseAttributes(l,i.Ellipse.ATTRIBUTE_NAMES);t.left=(t.left||0)-t.rx,t.top=(t.top||0)-t.ry,e(new i.Ellipse(t))},i.Ellipse.fromObject=function(l,e){i.Object._fromObject("Ellipse",l,e)})}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.util.object.extend;i.Rect?i.warn("fabric.Rect is already defined"):(i.Rect=i.util.createClass(i.Object,{stateProperties:i.Object.prototype.stateProperties.concat("rx","ry"),type:"rect",rx:0,ry:0,cacheProperties:i.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(l){this.callSuper("initialize",l),this._initRxRy()},_initRxRy:function(){this.rx&&!this.ry?this.ry=this.rx:this.ry&&!this.rx&&(this.rx=this.ry)},_render:function(l){var e=this.rx?Math.min(this.rx,this.width/2):0,t=this.ry?Math.min(this.ry,this.height/2):0,o=this.width,d=this.height,h=-this.width/2,c=-this.height/2,f=e!==0||t!==0,p=.4477152502;l.beginPath(),l.moveTo(h+e,c),l.lineTo(h+o-e,c),f&&l.bezierCurveTo(h+o-p*e,c,h+o,c+p*t,h+o,c+t),l.lineTo(h+o,c+d-t),f&&l.bezierCurveTo(h+o,c+d-p*t,h+o-p*e,c+d,h+o-e,c+d),l.lineTo(h+e,c+d),f&&l.bezierCurveTo(h+p*e,c+d,h,c+d-p*t,h,c+d-t),l.lineTo(h,c+t),f&&l.bezierCurveTo(h,c+p*t,h+p*e,c,h+e,c),l.closePath(),this._renderPaintInOrder(l)},toObject:function(l){return this.callSuper("toObject",["rx","ry"].concat(l))},_toSVG:function(){return["<rect ","COMMON_PARTS",'x="',-this.width/2,'" y="',-this.height/2,'" rx="',this.rx,'" ry="',this.ry,'" width="',this.width,'" height="',this.height,`" />
`]}}),i.Rect.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("x y rx ry width height".split(" ")),i.Rect.fromElement=function(l,e,t){if(!l)return e(null);t=t||{};var o=i.parseAttributes(l,i.Rect.ATTRIBUTE_NAMES);o.left=o.left||0,o.top=o.top||0,o.height=o.height||0,o.width=o.width||0;var d=new i.Rect(s(t?i.util.object.clone(t):{},o));d.visible=d.visible&&d.width>0&&d.height>0,e(d)},i.Rect.fromObject=function(l,e){return i.Object._fromObject("Rect",l,e)})}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.util.object.extend,l=i.util.array.min,e=i.util.array.max,t=i.util.toFixed,o=i.util.projectStrokeOnPoints;i.Polyline?i.warn("fabric.Polyline is already defined"):(i.Polyline=i.util.createClass(i.Object,{type:"polyline",points:null,exactBoundingBox:!1,cacheProperties:i.Object.prototype.cacheProperties.concat("points"),initialize:function(d,h){h=h||{},this.points=d||[],this.callSuper("initialize",h),this._setPositionDimensions(h)},_projectStrokeOnPoints:function(){return o(this.points,this,!0)},_setPositionDimensions:function(d){var h,c=this._calcDimensions(d),f=this.exactBoundingBox?this.strokeWidth:0;this.width=c.width-f,this.height=c.height-f,d.fromSVG||(h=this.translateToGivenOrigin({x:c.left-this.strokeWidth/2+f/2,y:c.top-this.strokeWidth/2+f/2},"left","top",this.originX,this.originY)),d.left===void 0&&(this.left=d.fromSVG?c.left:h.x),d.top===void 0&&(this.top=d.fromSVG?c.top:h.y),this.pathOffset={x:c.left+this.width/2+f/2,y:c.top+this.height/2+f/2}},_calcDimensions:function(){var d=this.exactBoundingBox?this._projectStrokeOnPoints():this.points,h=l(d,"x")||0,c=l(d,"y")||0;return{left:h,top:c,width:(e(d,"x")||0)-h,height:(e(d,"y")||0)-c}},toObject:function(d){return s(this.callSuper("toObject",d),{points:this.points.concat()})},_toSVG:function(){for(var d=[],h=this.pathOffset.x,c=this.pathOffset.y,f=i.Object.NUM_FRACTION_DIGITS,p=0,y=this.points.length;p<y;p++)d.push(t(this.points[p].x-h,f),",",t(this.points[p].y-c,f)," ");return["<"+this.type+" ","COMMON_PARTS",'points="',d.join(""),`" />
`]},commonRender:function(d){var h,c=this.points.length,f=this.pathOffset.x,p=this.pathOffset.y;if(!c||isNaN(this.points[c-1].y))return!1;d.beginPath(),d.moveTo(this.points[0].x-f,this.points[0].y-p);for(var y=0;y<c;y++)h=this.points[y],d.lineTo(h.x-f,h.y-p);return!0},_render:function(d){this.commonRender(d)&&this._renderPaintInOrder(d)},complexity:function(){return this.get("points").length}}),i.Polyline.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat(),i.Polyline.fromElementGenerator=function(d){return function(h,c,f){if(!h)return c(null);f||(f={});var p=i.parsePointsAttribute(h.getAttribute("points")),y=i.parseAttributes(h,i[d].ATTRIBUTE_NAMES);y.fromSVG=!0,c(new i[d](p,s(y,f)))}},i.Polyline.fromElement=i.Polyline.fromElementGenerator("Polyline"),i.Polyline.fromObject=function(d,h){return i.Object._fromObject("Polyline",d,h,"points")})}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.util.projectStrokeOnPoints;i.Polygon?i.warn("fabric.Polygon is already defined"):(i.Polygon=i.util.createClass(i.Polyline,{type:"polygon",_projectStrokeOnPoints:function(){return s(this.points,this)},_render:function(l){this.commonRender(l)&&(l.closePath(),this._renderPaintInOrder(l))}}),i.Polygon.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat(),i.Polygon.fromElement=i.Polyline.fromElementGenerator("Polygon"),i.Polygon.fromObject=function(l,e){i.Object._fromObject("Polygon",l,e,"points")})}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.util.array.min,l=i.util.array.max,e=i.util.object.extend,t=i.util.object.clone,o=i.util.toFixed;i.Path?i.warn("fabric.Path is already defined"):(i.Path=i.util.createClass(i.Object,{type:"path",path:null,cacheProperties:i.Object.prototype.cacheProperties.concat("path","fillRule"),stateProperties:i.Object.prototype.stateProperties.concat("path"),initialize:function(d,h){delete(h=t(h||{})).path,this.callSuper("initialize",h),this._setPath(d||[],h)},_setPath:function(d,h){this.path=i.util.makePathSimpler(Array.isArray(d)?d:i.util.parsePath(d)),i.Polyline.prototype._setPositionDimensions.call(this,h||{})},_renderPathCommands:function(d){var h,c=0,f=0,p=0,y=0,b=0,C=0,T=-this.pathOffset.x,O=-this.pathOffset.y;d.beginPath();for(var F=0,B=this.path.length;F<B;++F)switch((h=this.path[F])[0]){case"L":p=h[1],y=h[2],d.lineTo(p+T,y+O);break;case"M":c=p=h[1],f=y=h[2],d.moveTo(p+T,y+O);break;case"C":p=h[5],y=h[6],b=h[3],C=h[4],d.bezierCurveTo(h[1]+T,h[2]+O,b+T,C+O,p+T,y+O);break;case"Q":d.quadraticCurveTo(h[1]+T,h[2]+O,h[3]+T,h[4]+O),p=h[3],y=h[4],b=h[1],C=h[2];break;case"z":case"Z":p=c,y=f,d.closePath()}},_render:function(d){this._renderPathCommands(d),this._renderPaintInOrder(d)},toString:function(){return"#<fabric.Path ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:function(d){return e(this.callSuper("toObject",d),{path:this.path.map(function(h){return h.slice()})})},toDatalessObject:function(d){var h=this.toObject(["sourcePath"].concat(d));return h.sourcePath&&delete h.path,h},_toSVG:function(){return["<path ","COMMON_PARTS",'d="',i.util.joinPath(this.path),'" stroke-linecap="round" ',`/>
`]},_getOffsetTransform:function(){var d=i.Object.NUM_FRACTION_DIGITS;return" translate("+o(-this.pathOffset.x,d)+", "+o(-this.pathOffset.y,d)+")"},toClipPathSVG:function(d){var h=this._getOffsetTransform();return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:d,additionalTransform:h})},toSVG:function(d){var h=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:d,additionalTransform:h})},complexity:function(){return this.path.length},_calcDimensions:function(){for(var d,h,c=[],f=[],p=0,y=0,b=0,C=0,T=0,O=this.path.length;T<O;++T){switch((d=this.path[T])[0]){case"L":b=d[1],C=d[2],h=[];break;case"M":p=b=d[1],y=C=d[2],h=[];break;case"C":h=i.util.getBoundsOfCurve(b,C,d[1],d[2],d[3],d[4],d[5],d[6]),b=d[5],C=d[6];break;case"Q":h=i.util.getBoundsOfCurve(b,C,d[1],d[2],d[1],d[2],d[3],d[4]),b=d[3],C=d[4];break;case"z":case"Z":b=p,C=y}h.forEach(function(H){c.push(H.x),f.push(H.y)}),c.push(b),f.push(C)}var F=s(c)||0,B=s(f)||0;return{left:F,top:B,width:(l(c)||0)-F,height:(l(f)||0)-B}}}),i.Path.fromObject=function(d,h){if(typeof d.sourcePath=="string"){var c=d.sourcePath;i.loadSVGFromURL(c,function(f){var p=f[0];p.setOptions(d),h&&h(p)})}else i.Object._fromObject("Path",d,h,"path")},i.Path.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat(["d"]),i.Path.fromElement=function(d,h,c){var f=i.parseAttributes(d,i.Path.ATTRIBUTE_NAMES);f.fromSVG=!0,h(new i.Path(f.d,e(f,c)))})}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.util.array.min,l=i.util.array.max;i.Group||(i.Group=i.util.createClass(i.Object,i.Collection,{type:"group",strokeWidth:0,subTargetCheck:!1,cacheProperties:[],useSetOnGroup:!1,initialize:function(e,t,o){t=t||{},this._objects=[],o&&this.callSuper("initialize",t),this._objects=e||[];for(var d=this._objects.length;d--;)this._objects[d].group=this;if(o)this._updateObjectsACoords();else{var h=t&&t.centerPoint;t.originX!==void 0&&(this.originX=t.originX),t.originY!==void 0&&(this.originY=t.originY),h||this._calcBounds(),this._updateObjectsCoords(h),delete t.centerPoint,this.callSuper("initialize",t)}this.setCoords()},_updateObjectsACoords:function(){for(var e=this._objects.length;e--;)this._objects[e].setCoords(!0)},_updateObjectsCoords:function(e){e=e||this.getCenterPoint();for(var t=this._objects.length;t--;)this._updateObjectCoords(this._objects[t],e)},_updateObjectCoords:function(e,t){var o=e.left,d=e.top;e.set({left:o-t.x,top:d-t.y}),e.group=this,e.setCoords(!0)},toString:function(){return"#<fabric.Group: ("+this.complexity()+")>"},addWithUpdate:function(e){var t=!!this.group;return this._restoreObjectsState(),i.util.resetObjectTransform(this),e&&(t&&i.util.removeTransformFromObject(e,this.group.calcTransformMatrix()),this._objects.push(e),e.group=this,e._set("canvas",this.canvas)),this._calcBounds(),this._updateObjectsCoords(),this.dirty=!0,t?this.group.addWithUpdate():this.setCoords(),this},removeWithUpdate:function(e){return this._restoreObjectsState(),i.util.resetObjectTransform(this),this.remove(e),this._calcBounds(),this._updateObjectsCoords(),this.setCoords(),this.dirty=!0,this},_onObjectAdded:function(e){this.dirty=!0,e.group=this,e._set("canvas",this.canvas)},_onObjectRemoved:function(e){this.dirty=!0,delete e.group},_set:function(e,t){var o=this._objects.length;if(this.useSetOnGroup)for(;o--;)this._objects[o].setOnGroup(e,t);if(e==="canvas")for(;o--;)this._objects[o]._set(e,t);i.Object.prototype._set.call(this,e,t)},toObject:function(e){var t=this.includeDefaultValues,o=this._objects.filter(function(h){return!h.excludeFromExport}).map(function(h){var c=h.includeDefaultValues;h.includeDefaultValues=t;var f=h.toObject(e);return h.includeDefaultValues=c,f}),d=i.Object.prototype.toObject.call(this,e);return d.objects=o,d},toDatalessObject:function(e){var t,o=this.sourcePath;if(o)t=o;else{var d=this.includeDefaultValues;t=this._objects.map(function(c){var f=c.includeDefaultValues;c.includeDefaultValues=d;var p=c.toDatalessObject(e);return c.includeDefaultValues=f,p})}var h=i.Object.prototype.toDatalessObject.call(this,e);return h.objects=t,h},render:function(e){this._transformDone=!0,this.callSuper("render",e),this._transformDone=!1},shouldCache:function(){var e=i.Object.prototype.shouldCache.call(this);if(e){for(var t=0,o=this._objects.length;t<o;t++)if(this._objects[t].willDrawShadow())return this.ownCaching=!1,!1}return e},willDrawShadow:function(){if(i.Object.prototype.willDrawShadow.call(this))return!0;for(var e=0,t=this._objects.length;e<t;e++)if(this._objects[e].willDrawShadow())return!0;return!1},isOnACache:function(){return this.ownCaching||this.group&&this.group.isOnACache()},drawObject:function(e){for(var t=0,o=this._objects.length;t<o;t++)this._objects[t].render(e);this._drawClipPath(e,this.clipPath)},isCacheDirty:function(e){if(this.callSuper("isCacheDirty",e))return!0;if(!this.statefullCache)return!1;for(var t=0,o=this._objects.length;t<o;t++)if(this._objects[t].isCacheDirty(!0)){if(this._cacheCanvas){var d=this.cacheWidth/this.zoomX,h=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-d/2,-h/2,d,h)}return!0}return!1},_restoreObjectsState:function(){var e=this.calcOwnMatrix();return this._objects.forEach(function(t){i.util.addTransformToObject(t,e),delete t.group,t.setCoords()}),this},destroy:function(){return this._objects.forEach(function(e){e.set("dirty",!0)}),this._restoreObjectsState()},dispose:function(){this.callSuper("dispose"),this.forEachObject(function(e){e.dispose&&e.dispose()}),this._objects=[]},toActiveSelection:function(){if(this.canvas){var e=this._objects,t=this.canvas;this._objects=[];var o=this.toObject();delete o.objects;var d=new i.ActiveSelection([]);return d.set(o),d.type="activeSelection",t.remove(this),e.forEach(function(h){h.group=d,h.dirty=!0,t.add(h)}),d.canvas=t,d._objects=e,t._activeObject=d,d.setCoords(),d}},ungroupOnCanvas:function(){return this._restoreObjectsState()},setObjectsCoords:function(){return this.forEachObject(function(e){e.setCoords(!0)}),this},_calcBounds:function(e){for(var t,o,d,h,c=[],f=[],p=["tr","br","bl","tl"],y=0,b=this._objects.length,C=p.length;y<b;++y){for(d=(t=this._objects[y]).calcACoords(),h=0;h<C;h++)o=p[h],c.push(d[o].x),f.push(d[o].y);t.aCoords=d}this._getBounds(c,f,e)},_getBounds:function(e,t,o){var d=new i.Point(s(e),s(t)),h=new i.Point(l(e),l(t)),c=d.y||0,f=d.x||0,p=h.x-d.x||0,y=h.y-d.y||0;this.width=p,this.height=y,o||this.setPositionByOrigin({x:f,y:c},"left","top")},_toSVG:function(e){for(var t=["<g ","COMMON_PARTS",` >
`],o=0,d=this._objects.length;o<d;o++)t.push("		",this._objects[o].toSVG(e));return t.push(`</g>
`),t},getSvgStyles:function(){var e=this.opacity!==void 0&&this.opacity!==1?"opacity: "+this.opacity+";":"",t=this.visible?"":" visibility: hidden;";return[e,this.getSvgFilter(),t].join("")},toClipPathSVG:function(e){for(var t=[],o=0,d=this._objects.length;o<d;o++)t.push("	",this._objects[o].toClipPathSVG(e));return this._createBaseClipPathSVGMarkup(t,{reviver:e})}}),i.Group.fromObject=function(e,t){var o=e.objects,d=i.util.object.clone(e,!0);delete d.objects,typeof o!="string"?i.util.enlivenObjects(o,function(h){var c=i.util.object.clone(e,!0);delete c.objects,i.util.enlivenObjectEnlivables(e,c,function(){t&&t(new i.Group(h,c,!0))})}):i.loadSVGFromURL(o,function(h){var c=i.util.groupSVGElements(h,e,o);c.set(d),t&&t(c)})})}(r),function(n){var i=n.fabric||(n.fabric={});i.ActiveSelection||(i.ActiveSelection=i.util.createClass(i.Group,{type:"activeSelection",initialize:function(s,l){l=l||{},this._objects=s||[];for(var e=this._objects.length;e--;)this._objects[e].group=this;l.originX&&(this.originX=l.originX),l.originY&&(this.originY=l.originY),this._calcBounds(),this._updateObjectsCoords(),i.Object.prototype.initialize.call(this,l),this.setCoords()},toGroup:function(){var s=this._objects.concat();this._objects=[];var l=i.Object.prototype.toObject.call(this),e=new i.Group([]);if(delete l.type,e.set(l),s.forEach(function(o){o.canvas.remove(o),o.group=e}),e._objects=s,!this.canvas)return e;var t=this.canvas;return t.add(e),t._activeObject=e,e.setCoords(),e},onDeselect:function(){return this.destroy(),!1},toString:function(){return"#<fabric.ActiveSelection: ("+this.complexity()+")>"},shouldCache:function(){return!1},isOnACache:function(){return!1},_renderControls:function(s,l,e){s.save(),s.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1,this.callSuper("_renderControls",s,l),(e=e||{}).hasControls===void 0&&(e.hasControls=!1),e.forActiveSelection=!0;for(var t=0,o=this._objects.length;t<o;t++)this._objects[t]._renderControls(s,e);s.restore()}}),i.ActiveSelection.fromObject=function(s,l){i.util.enlivenObjects(s.objects,function(e){delete s.objects,l&&l(new i.ActiveSelection(e,s,!0))})})}(r),function(n){var i=g.util.object.extend;n.fabric||(n.fabric={}),n.fabric.Image?g.warn("fabric.Image is already defined."):(g.Image=g.util.createClass(g.Object,{type:"image",strokeWidth:0,srcFromAttribute:!1,_lastScaleX:1,_lastScaleY:1,_filterScalingX:1,_filterScalingY:1,minimumScaleTrigger:.5,stateProperties:g.Object.prototype.stateProperties.concat("cropX","cropY"),cacheProperties:g.Object.prototype.cacheProperties.concat("cropX","cropY"),cacheKey:"",cropX:0,cropY:0,imageSmoothing:!0,initialize:function(s,l){l||(l={}),this.filters=[],this.cacheKey="texture"+g.Object.__uid++,this.callSuper("initialize",l),this._initElement(s,l)},getElement:function(){return this._element||{}},setElement:function(s,l){return this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._element=s,this._originalElement=s,this._initConfig(l),this.filters.length!==0&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters(),this},removeTexture:function(s){var l=g.filterBackend;l&&l.evictCachesForKey&&l.evictCachesForKey(s)},dispose:function(){this.callSuper("dispose"),this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._cacheContext=void 0,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach(function(s){g.util.cleanUpJsdomNode(this[s]),this[s]=void 0}.bind(this))},getCrossOrigin:function(){return this._originalElement&&(this._originalElement.crossOrigin||null)},getOriginalSize:function(){var s=this.getElement();return{width:s.naturalWidth||s.width,height:s.naturalHeight||s.height}},_stroke:function(s){if(this.stroke&&this.strokeWidth!==0){var l=this.width/2,e=this.height/2;s.beginPath(),s.moveTo(-l,-e),s.lineTo(l,-e),s.lineTo(l,e),s.lineTo(-l,e),s.lineTo(-l,-e),s.closePath()}},toObject:function(s){var l=[];this.filters.forEach(function(t){t&&l.push(t.toObject())});var e=i(this.callSuper("toObject",["cropX","cropY"].concat(s)),{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:l});return this.resizeFilter&&(e.resizeFilter=this.resizeFilter.toObject()),e},hasCrop:function(){return this.cropX||this.cropY||this.width<this._element.width||this.height<this._element.height},_toSVG:function(){var s,l=[],e=[],t=this._element,o=-this.width/2,d=-this.height/2,h="",c="";if(!t)return[];if(this.hasCrop()){var f=g.Object.__uid++;l.push('<clipPath id="imageCrop_'+f+`">
`,'	<rect x="'+o+'" y="'+d+'" width="'+this.width+'" height="'+this.height+`" />
`,`</clipPath>
`),h=' clip-path="url(#imageCrop_'+f+')" '}if(this.imageSmoothing||(c='" image-rendering="optimizeSpeed'),e.push("	<image ","COMMON_PARTS",'xlink:href="',this.getSvgSrc(!0),'" x="',o-this.cropX,'" y="',d-this.cropY,'" width="',t.width||t.naturalWidth,'" height="',t.height||t.height,c,'"',h,`></image>
`),this.stroke||this.strokeDashArray){var p=this.fill;this.fill=null,s=["	<rect ",'x="',o,'" y="',d,'" width="',this.width,'" height="',this.height,'" style="',this.getSvgStyles(),`"/>
`],this.fill=p}return this.paintFirst!=="fill"?l.concat(s,e):l.concat(e,s)},getSrc:function(s){var l=s?this._element:this._originalElement;return l?l.toDataURL?l.toDataURL():this.srcFromAttribute?l.getAttribute("src"):l.src:this.src||""},setSrc:function(s,l,e){return g.util.loadImage(s,function(t,o){this.setElement(t,e),this._setWidthHeight(),l&&l(this,o)},this,e&&e.crossOrigin),this},toString:function(){return'#<fabric.Image: { src: "'+this.getSrc()+'" }>'},applyResizeFilters:function(){var s=this.resizeFilter,l=this.minimumScaleTrigger,e=this.getTotalObjectScaling(),t=e.scaleX,o=e.scaleY,d=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!s||t>l&&o>l)return this._element=d,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=t,void(this._lastScaleY=o);g.filterBackend||(g.filterBackend=g.initFilterBackend());var h=g.util.createCanvasElement(),c=this._filteredEl?this.cacheKey+"_filtered":this.cacheKey,f=d.width,p=d.height;h.width=f,h.height=p,this._element=h,this._lastScaleX=s.scaleX=t,this._lastScaleY=s.scaleY=o,g.filterBackend.applyFilters([s],d,f,p,this._element,c),this._filterScalingX=h.width/this._originalElement.width,this._filterScalingY=h.height/this._originalElement.height},applyFilters:function(s){if(s=(s=s||this.filters||[]).filter(function(d){return d&&!d.isNeutralState()}),this.set("dirty",!0),this.removeTexture(this.cacheKey+"_filtered"),s.length===0)return this._element=this._originalElement,this._filteredEl=null,this._filterScalingX=1,this._filterScalingY=1,this;var l=this._originalElement,e=l.naturalWidth||l.width,t=l.naturalHeight||l.height;if(this._element===this._originalElement){var o=g.util.createCanvasElement();o.width=e,o.height=t,this._element=o,this._filteredEl=o}else this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,e,t),this._lastScaleX=1,this._lastScaleY=1;return g.filterBackend||(g.filterBackend=g.initFilterBackend()),g.filterBackend.applyFilters(s,this._originalElement,e,t,this._element,this.cacheKey),this._originalElement.width===this._element.width&&this._originalElement.height===this._element.height||(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height),this},_render:function(s){g.util.setImageSmoothing(s,this.imageSmoothing),this.isMoving!==!0&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(s),this._renderPaintInOrder(s)},drawCacheOnCanvas:function(s){g.util.setImageSmoothing(s,this.imageSmoothing),g.Object.prototype.drawCacheOnCanvas.call(this,s)},shouldCache:function(){return this.needsItsOwnCache()},_renderFill:function(s){var l=this._element;if(l){var e=this._filterScalingX,t=this._filterScalingY,o=this.width,d=this.height,h=Math.min,c=Math.max,f=c(this.cropX,0),p=c(this.cropY,0),y=l.naturalWidth||l.width,b=l.naturalHeight||l.height,C=f*e,T=p*t,O=h(o*e,y-C),F=h(d*t,b-T),B=-o/2,H=-d/2,U=h(o,y/e-f),V=h(d,b/t-p);l&&s.drawImage(l,C,T,O,F,B,H,U,V)}},_needsResize:function(){var s=this.getTotalObjectScaling();return s.scaleX!==this._lastScaleX||s.scaleY!==this._lastScaleY},_resetWidthHeight:function(){this.set(this.getOriginalSize())},_initElement:function(s,l){this.setElement(g.util.getById(s),l),g.util.addClass(this.getElement(),g.Image.CSS_CANVAS)},_initConfig:function(s){s||(s={}),this.setOptions(s),this._setWidthHeight(s)},_initFilters:function(s,l){s&&s.length?g.util.enlivenObjects(s,function(e){l&&l(e)},"fabric.Image.filters"):l&&l()},_setWidthHeight:function(s){s||(s={});var l=this.getElement();this.width=s.width||l.naturalWidth||l.width||0,this.height=s.height||l.naturalHeight||l.height||0},parsePreserveAspectRatioAttribute:function(){var s,l=g.util.parsePreserveAspectRatioAttribute(this.preserveAspectRatio||""),e=this._element.width,t=this._element.height,o=1,d=1,h=0,c=0,f=0,p=0,y=this.width,b=this.height,C={width:y,height:b};return!l||l.alignX==="none"&&l.alignY==="none"?(o=y/e,d=b/t):(l.meetOrSlice==="meet"&&(s=(y-e*(o=d=g.util.findScaleToFit(this._element,C)))/2,l.alignX==="Min"&&(h=-s),l.alignX==="Max"&&(h=s),s=(b-t*d)/2,l.alignY==="Min"&&(c=-s),l.alignY==="Max"&&(c=s)),l.meetOrSlice==="slice"&&(s=e-y/(o=d=g.util.findScaleToCover(this._element,C)),l.alignX==="Mid"&&(f=s/2),l.alignX==="Max"&&(f=s),s=t-b/d,l.alignY==="Mid"&&(p=s/2),l.alignY==="Max"&&(p=s),e=y/o,t=b/d)),{width:e,height:t,scaleX:o,scaleY:d,offsetLeft:h,offsetTop:c,cropX:f,cropY:p}}}),g.Image.CSS_CANVAS="canvas-img",g.Image.prototype.getSvgSrc=g.Image.prototype.getSrc,g.Image.fromObject=function(s,l){var e=g.util.object.clone(s);g.util.loadImage(e.src,function(t,o){o?l&&l(null,!0):g.Image.prototype._initFilters.call(e,e.filters,function(d){e.filters=d||[],g.Image.prototype._initFilters.call(e,[e.resizeFilter],function(h){e.resizeFilter=h[0],g.util.enlivenObjectEnlivables(e,e,function(){var c=new g.Image(t,e);l(c,!1)})})})},null,e.crossOrigin)},g.Image.fromURL=function(s,l,e){g.util.loadImage(s,function(t,o){l&&l(new g.Image(t,e),o)},null,e&&e.crossOrigin)},g.Image.ATTRIBUTE_NAMES=g.SHARED_ATTRIBUTES.concat("x y width height preserveAspectRatio xlink:href crossOrigin image-rendering".split(" ")),g.Image.fromElement=function(s,l,e){var t=g.parseAttributes(s,g.Image.ATTRIBUTE_NAMES);g.Image.fromURL(t["xlink:href"],l,i(e?g.util.object.clone(e):{},t))})}(r),g.util.object.extend(g.Object.prototype,{_getAngleValueForStraighten:function(){var n=this.angle%360;return n>0?90*Math.round((n-1)/90):90*Math.round(n/90)},straighten:function(){return this.rotate(this._getAngleValueForStraighten())},fxStraighten:function(n){var i=function(){},s=(n=n||{}).onComplete||i,l=n.onChange||i,e=this;return g.util.animate({target:this,startValue:this.get("angle"),endValue:this._getAngleValueForStraighten(),duration:this.FX_DURATION,onChange:function(t){e.rotate(t),l()},onComplete:function(){e.setCoords(),s()}})}}),g.util.object.extend(g.StaticCanvas.prototype,{straightenObject:function(n){return n.straighten(),this.requestRenderAll(),this},fxStraightenObject:function(n){return n.fxStraighten({onChange:this.requestRenderAllBound})}}),function(){function n(s,l){var e="precision "+l+` float;
void main(){}`,t=s.createShader(s.FRAGMENT_SHADER);return s.shaderSource(t,e),s.compileShader(t),!!s.getShaderParameter(t,s.COMPILE_STATUS)}function i(s){s&&s.tileSize&&(this.tileSize=s.tileSize),this.setupGLContext(this.tileSize,this.tileSize),this.captureGPUInfo()}g.isWebglSupported=function(s){if(g.isLikelyNode)return!1;s=s||g.WebglFilterBackend.prototype.tileSize;var l=document.createElement("canvas"),e=l.getContext("webgl")||l.getContext("experimental-webgl"),t=!1;if(e){g.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),t=g.maxTextureSize>=s;for(var o=["highp","mediump","lowp"],d=0;d<3;d++)if(n(e,o[d])){g.webGlPrecision=o[d];break}}return this.isSupported=t,t},g.WebglFilterBackend=i,i.prototype={tileSize:2048,resources:{},setupGLContext:function(s,l){this.dispose(),this.createWebGLCanvas(s,l),this.aPosition=new Float32Array([0,0,0,1,1,0,1,1]),this.chooseFastestCopyGLTo2DMethod(s,l)},chooseFastestCopyGLTo2DMethod:function(s,l){var e,t=window.performance!==void 0;try{new ImageData(1,1),e=!0}catch(b){e=!1}var o=typeof ArrayBuffer!="undefined",d=typeof Uint8ClampedArray!="undefined";if(t&&e&&o&&d){var h=g.util.createCanvasElement(),c=new ArrayBuffer(s*l*4);if(g.forceGLPutImageData)return this.imageBuffer=c,void(this.copyGLTo2D=ne);var f,p,y={imageBuffer:c,destinationWidth:s,destinationHeight:l,targetCanvas:h};h.width=s,h.height=l,f=window.performance.now(),re.call(y,this.gl,y),p=window.performance.now()-f,f=window.performance.now(),ne.call(y,this.gl,y),p>window.performance.now()-f?(this.imageBuffer=c,this.copyGLTo2D=ne):this.copyGLTo2D=re}},createWebGLCanvas:function(s,l){var e=g.util.createCanvasElement();e.width=s,e.height=l;var t={alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1},o=e.getContext("webgl",t);o||(o=e.getContext("experimental-webgl",t)),o&&(o.clearColor(0,0,0,0),this.canvas=e,this.gl=o)},applyFilters:function(s,l,e,t,o,d){var h,c=this.gl;d&&(h=this.getCachedTexture(d,l));var f={originalWidth:l.width||l.originalWidth,originalHeight:l.height||l.originalHeight,sourceWidth:e,sourceHeight:t,destinationWidth:e,destinationHeight:t,context:c,sourceTexture:this.createTexture(c,e,t,!h&&l),targetTexture:this.createTexture(c,e,t),originalTexture:h||this.createTexture(c,e,t,!h&&l),passes:s.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:o},p=c.createFramebuffer();return c.bindFramebuffer(c.FRAMEBUFFER,p),s.forEach(function(y){y&&y.applyTo(f)}),function(y){var b=y.targetCanvas,C=b.width,T=b.height,O=y.destinationWidth,F=y.destinationHeight;C===O&&T===F||(b.width=O,b.height=F)}(f),this.copyGLTo2D(c,f),c.bindTexture(c.TEXTURE_2D,null),c.deleteTexture(f.sourceTexture),c.deleteTexture(f.targetTexture),c.deleteFramebuffer(p),o.getContext("2d").setTransform(1,0,0,1,0,0),f},dispose:function(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()},clearWebGLCaches:function(){this.programCache={},this.textureCache={}},createTexture:function(s,l,e,t){var o=s.createTexture();return s.bindTexture(s.TEXTURE_2D,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),t?s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,t):s.texImage2D(s.TEXTURE_2D,0,s.RGBA,l,e,0,s.RGBA,s.UNSIGNED_BYTE,null),o},getCachedTexture:function(s,l){if(this.textureCache[s])return this.textureCache[s];var e=this.createTexture(this.gl,l.width,l.height,l);return this.textureCache[s]=e,e},evictCachesForKey:function(s){this.textureCache[s]&&(this.gl.deleteTexture(this.textureCache[s]),delete this.textureCache[s])},copyGLTo2D:re,captureGPUInfo:function(){if(this.gpuInfo)return this.gpuInfo;var s=this.gl,l={renderer:"",vendor:""};if(!s)return l;var e=s.getExtension("WEBGL_debug_renderer_info");if(e){var t=s.getParameter(e.UNMASKED_RENDERER_WEBGL),o=s.getParameter(e.UNMASKED_VENDOR_WEBGL);t&&(l.renderer=t.toLowerCase()),o&&(l.vendor=o.toLowerCase())}return this.gpuInfo=l,l}}}(),function(){var n=function(){};function i(){}g.Canvas2dFilterBackend=i,i.prototype={evictCachesForKey:n,dispose:n,clearWebGLCaches:n,resources:{},applyFilters:function(s,l,e,t,o){var d=o.getContext("2d");d.drawImage(l,0,0,e,t);var h={sourceWidth:e,sourceHeight:t,imageData:d.getImageData(0,0,e,t),originalEl:l,originalImageData:d.getImageData(0,0,e,t),canvasEl:o,ctx:d,filterBackend:this};return s.forEach(function(c){c.applyTo(h)}),h.imageData.width===e&&h.imageData.height===t||(o.width=h.imageData.width,o.height=h.imageData.height),d.putImageData(h.imageData,0,0),h}}}(),g.Image=g.Image||{},g.Image.filters=g.Image.filters||{},g.Image.filters.BaseFilter=g.util.createClass({type:"BaseFilter",vertexSource:`attribute vec2 aPosition;
varying vec2 vTexCoord;
void main() {
vTexCoord = aPosition;
gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
}`,fragmentSource:`precision highp float;
varying vec2 vTexCoord;
uniform sampler2D uTexture;
void main() {
gl_FragColor = texture2D(uTexture, vTexCoord);
}`,initialize:function(n){n&&this.setOptions(n)},setOptions:function(n){for(var i in n)this[i]=n[i]},createProgram:function(n,i,s){i=i||this.fragmentSource,s=s||this.vertexSource,g.webGlPrecision!=="highp"&&(i=i.replace(/precision highp float/g,"precision "+g.webGlPrecision+" float"));var l=n.createShader(n.VERTEX_SHADER);if(n.shaderSource(l,s),n.compileShader(l),!n.getShaderParameter(l,n.COMPILE_STATUS))throw new Error("Vertex shader compile error for "+this.type+": "+n.getShaderInfoLog(l));var e=n.createShader(n.FRAGMENT_SHADER);if(n.shaderSource(e,i),n.compileShader(e),!n.getShaderParameter(e,n.COMPILE_STATUS))throw new Error("Fragment shader compile error for "+this.type+": "+n.getShaderInfoLog(e));var t=n.createProgram();if(n.attachShader(t,l),n.attachShader(t,e),n.linkProgram(t),!n.getProgramParameter(t,n.LINK_STATUS))throw new Error('Shader link error for "${this.type}" '+n.getProgramInfoLog(t));var o=this.getAttributeLocations(n,t),d=this.getUniformLocations(n,t)||{};return d.uStepW=n.getUniformLocation(t,"uStepW"),d.uStepH=n.getUniformLocation(t,"uStepH"),{program:t,attributeLocations:o,uniformLocations:d}},getAttributeLocations:function(n,i){return{aPosition:n.getAttribLocation(i,"aPosition")}},getUniformLocations:function(){return{}},sendAttributeData:function(n,i,s){var l=i.aPosition,e=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,e),n.enableVertexAttribArray(l),n.vertexAttribPointer(l,2,n.FLOAT,!1,0,0),n.bufferData(n.ARRAY_BUFFER,s,n.STATIC_DRAW)},_setupFrameBuffer:function(n){var i,s,l=n.context;n.passes>1?(i=n.destinationWidth,s=n.destinationHeight,n.sourceWidth===i&&n.sourceHeight===s||(l.deleteTexture(n.targetTexture),n.targetTexture=n.filterBackend.createTexture(l,i,s)),l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,n.targetTexture,0)):(l.bindFramebuffer(l.FRAMEBUFFER,null),l.finish())},_swapTextures:function(n){n.passes--,n.pass++;var i=n.targetTexture;n.targetTexture=n.sourceTexture,n.sourceTexture=i},isNeutralState:function(){var n=this.mainParameter,i=g.Image.filters[this.type].prototype;if(n){if(Array.isArray(i[n])){for(var s=i[n].length;s--;)if(this[n][s]!==i[n][s])return!1;return!0}return i[n]===this[n]}return!1},applyTo:function(n){n.webgl?(this._setupFrameBuffer(n),this.applyToWebGL(n),this._swapTextures(n)):this.applyTo2d(n)},retrieveShader:function(n){return n.programCache.hasOwnProperty(this.type)||(n.programCache[this.type]=this.createProgram(n.context)),n.programCache[this.type]},applyToWebGL:function(n){var i=n.context,s=this.retrieveShader(n);n.pass===0&&n.originalTexture?i.bindTexture(i.TEXTURE_2D,n.originalTexture):i.bindTexture(i.TEXTURE_2D,n.sourceTexture),i.useProgram(s.program),this.sendAttributeData(i,s.attributeLocations,n.aPosition),i.uniform1f(s.uniformLocations.uStepW,1/n.sourceWidth),i.uniform1f(s.uniformLocations.uStepH,1/n.sourceHeight),this.sendUniformData(i,s.uniformLocations),i.viewport(0,0,n.destinationWidth,n.destinationHeight),i.drawArrays(i.TRIANGLE_STRIP,0,4)},bindAdditionalTexture:function(n,i,s){n.activeTexture(s),n.bindTexture(n.TEXTURE_2D,i),n.activeTexture(n.TEXTURE0)},unbindAdditionalTexture:function(n,i){n.activeTexture(i),n.bindTexture(n.TEXTURE_2D,null),n.activeTexture(n.TEXTURE0)},getMainParameter:function(){return this[this.mainParameter]},setMainParameter:function(n){this[this.mainParameter]=n},sendUniformData:function(){},createHelpLayer:function(n){if(!n.helpLayer){var i=document.createElement("canvas");i.width=n.sourceWidth,i.height=n.sourceHeight,n.helpLayer=i}},toObject:function(){var n={type:this.type},i=this.mainParameter;return i&&(n[i]=this[i]),n},toJSON:function(){return this.toObject()}}),g.Image.filters.BaseFilter.fromObject=function(n,i){var s=new g.Image.filters[n.type](n);return i&&i(s),s},function(n){var i=n.fabric||(n.fabric={}),s=i.Image.filters,l=i.util.createClass;s.ColorMatrix=l(s.BaseFilter,{type:"ColorMatrix",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
varying vec2 vTexCoord;
uniform mat4 uColorMatrix;
uniform vec4 uConstants;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color *= uColorMatrix;
color += uConstants;
gl_FragColor = color;
}`,matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],mainParameter:"matrix",colorsOnly:!0,initialize:function(e){this.callSuper("initialize",e),this.matrix=this.matrix.slice(0)},applyTo2d:function(e){var t,o,d,h,c,f=e.imageData.data,p=f.length,y=this.matrix,b=this.colorsOnly;for(c=0;c<p;c+=4)t=f[c],o=f[c+1],d=f[c+2],b?(f[c]=t*y[0]+o*y[1]+d*y[2]+255*y[4],f[c+1]=t*y[5]+o*y[6]+d*y[7]+255*y[9],f[c+2]=t*y[10]+o*y[11]+d*y[12]+255*y[14]):(h=f[c+3],f[c]=t*y[0]+o*y[1]+d*y[2]+h*y[3]+255*y[4],f[c+1]=t*y[5]+o*y[6]+d*y[7]+h*y[8]+255*y[9],f[c+2]=t*y[10]+o*y[11]+d*y[12]+h*y[13]+255*y[14],f[c+3]=t*y[15]+o*y[16]+d*y[17]+h*y[18]+255*y[19])},getUniformLocations:function(e,t){return{uColorMatrix:e.getUniformLocation(t,"uColorMatrix"),uConstants:e.getUniformLocation(t,"uConstants")}},sendUniformData:function(e,t){var o=this.matrix,d=[o[0],o[1],o[2],o[3],o[5],o[6],o[7],o[8],o[10],o[11],o[12],o[13],o[15],o[16],o[17],o[18]],h=[o[4],o[9],o[14],o[19]];e.uniformMatrix4fv(t.uColorMatrix,!1,d),e.uniform4fv(t.uConstants,h)}}),i.Image.filters.ColorMatrix.fromObject=i.Image.filters.BaseFilter.fromObject}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.Image.filters,l=i.util.createClass;s.Brightness=l(s.BaseFilter,{type:"Brightness",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uBrightness;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color.rgb += uBrightness;
gl_FragColor = color;
}`,brightness:0,mainParameter:"brightness",applyTo2d:function(e){if(this.brightness!==0){var t,o=e.imageData.data,d=o.length,h=Math.round(255*this.brightness);for(t=0;t<d;t+=4)o[t]=o[t]+h,o[t+1]=o[t+1]+h,o[t+2]=o[t+2]+h}},getUniformLocations:function(e,t){return{uBrightness:e.getUniformLocation(t,"uBrightness")}},sendUniformData:function(e,t){e.uniform1f(t.uBrightness,this.brightness)}}),i.Image.filters.Brightness.fromObject=i.Image.filters.BaseFilter.fromObject}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.util.object.extend,l=i.Image.filters,e=i.util.createClass;l.Convolute=e(l.BaseFilter,{type:"Convolute",opaque:!1,matrix:[0,0,0,0,1,0,0,0,0],fragmentSource:{Convolute_3_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[9];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 3.0; h+=1.0) {
for (float w = 0.0; w < 3.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_3_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[9];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 3.0; h+=1.0) {
for (float w = 0.0; w < 3.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_5_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[25];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 5.0; h+=1.0) {
for (float w = 0.0; w < 5.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_5_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[25];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 5.0; h+=1.0) {
for (float w = 0.0; w < 5.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_7_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[49];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 7.0; h+=1.0) {
for (float w = 0.0; w < 7.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_7_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[49];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 7.0; h+=1.0) {
for (float w = 0.0; w < 7.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_9_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[81];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 9.0; h+=1.0) {
for (float w = 0.0; w < 9.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_9_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[81];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 9.0; h+=1.0) {
for (float w = 0.0; w < 9.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`},retrieveShader:function(t){var o=Math.sqrt(this.matrix.length),d=this.type+"_"+o+"_"+(this.opaque?1:0),h=this.fragmentSource[d];return t.programCache.hasOwnProperty(d)||(t.programCache[d]=this.createProgram(t.context,h)),t.programCache[d]},applyTo2d:function(t){var o,d,h,c,f,p,y,b,C,T,O,F,B,H=t.imageData,U=H.data,V=this.matrix,L=Math.round(Math.sqrt(V.length)),R=Math.floor(L/2),N=H.width,W=H.height,Y=t.ctx.createImageData(N,W),P=Y.data,M=this.opaque?1:0;for(O=0;O<W;O++)for(T=0;T<N;T++){for(f=4*(O*N+T),o=0,d=0,h=0,c=0,B=0;B<L;B++)for(F=0;F<L;F++)p=T+F-R,(y=O+B-R)<0||y>=W||p<0||p>=N||(b=4*(y*N+p),C=V[B*L+F],o+=U[b]*C,d+=U[b+1]*C,h+=U[b+2]*C,M||(c+=U[b+3]*C));P[f]=o,P[f+1]=d,P[f+2]=h,P[f+3]=M?U[f+3]:c}t.imageData=Y},getUniformLocations:function(t,o){return{uMatrix:t.getUniformLocation(o,"uMatrix"),uOpaque:t.getUniformLocation(o,"uOpaque"),uHalfSize:t.getUniformLocation(o,"uHalfSize"),uSize:t.getUniformLocation(o,"uSize")}},sendUniformData:function(t,o){t.uniform1fv(o.uMatrix,this.matrix)},toObject:function(){return s(this.callSuper("toObject"),{opaque:this.opaque,matrix:this.matrix})}}),i.Image.filters.Convolute.fromObject=i.Image.filters.BaseFilter.fromObject}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.Image.filters,l=i.util.createClass;s.Grayscale=l(s.BaseFilter,{type:"Grayscale",fragmentSource:{average:`precision highp float;
uniform sampler2D uTexture;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float average = (color.r + color.b + color.g) / 3.0;
gl_FragColor = vec4(average, average, average, color.a);
}`,lightness:`precision highp float;
uniform sampler2D uTexture;
uniform int uMode;
varying vec2 vTexCoord;
void main() {
vec4 col = texture2D(uTexture, vTexCoord);
float average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;
gl_FragColor = vec4(average, average, average, col.a);
}`,luminosity:`precision highp float;
uniform sampler2D uTexture;
uniform int uMode;
varying vec2 vTexCoord;
void main() {
vec4 col = texture2D(uTexture, vTexCoord);
float average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;
gl_FragColor = vec4(average, average, average, col.a);
}`},mode:"average",mainParameter:"mode",applyTo2d:function(e){var t,o,d=e.imageData.data,h=d.length,c=this.mode;for(t=0;t<h;t+=4)c==="average"?o=(d[t]+d[t+1]+d[t+2])/3:c==="lightness"?o=(Math.min(d[t],d[t+1],d[t+2])+Math.max(d[t],d[t+1],d[t+2]))/2:c==="luminosity"&&(o=.21*d[t]+.72*d[t+1]+.07*d[t+2]),d[t]=o,d[t+1]=o,d[t+2]=o},retrieveShader:function(e){var t=this.type+"_"+this.mode;if(!e.programCache.hasOwnProperty(t)){var o=this.fragmentSource[this.mode];e.programCache[t]=this.createProgram(e.context,o)}return e.programCache[t]},getUniformLocations:function(e,t){return{uMode:e.getUniformLocation(t,"uMode")}},sendUniformData:function(e,t){e.uniform1i(t.uMode,1)},isNeutralState:function(){return!1}}),i.Image.filters.Grayscale.fromObject=i.Image.filters.BaseFilter.fromObject}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.Image.filters,l=i.util.createClass;s.Invert=l(s.BaseFilter,{type:"Invert",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform int uInvert;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
if (uInvert == 1) {
gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);
} else {
gl_FragColor = color;
}
}`,invert:!0,mainParameter:"invert",applyTo2d:function(e){var t,o=e.imageData.data,d=o.length;for(t=0;t<d;t+=4)o[t]=255-o[t],o[t+1]=255-o[t+1],o[t+2]=255-o[t+2]},isNeutralState:function(){return!this.invert},getUniformLocations:function(e,t){return{uInvert:e.getUniformLocation(t,"uInvert")}},sendUniformData:function(e,t){e.uniform1i(t.uInvert,this.invert)}}),i.Image.filters.Invert.fromObject=i.Image.filters.BaseFilter.fromObject}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.util.object.extend,l=i.Image.filters,e=i.util.createClass;l.Noise=e(l.BaseFilter,{type:"Noise",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uStepH;
uniform float uNoise;
uniform float uSeed;
varying vec2 vTexCoord;
float rand(vec2 co, float seed, float vScale) {
return fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);
}
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;
gl_FragColor = color;
}`,mainParameter:"noise",noise:0,applyTo2d:function(t){if(this.noise!==0){var o,d,h=t.imageData.data,c=h.length,f=this.noise;for(o=0,c=h.length;o<c;o+=4)d=(.5-Math.random())*f,h[o]+=d,h[o+1]+=d,h[o+2]+=d}},getUniformLocations:function(t,o){return{uNoise:t.getUniformLocation(o,"uNoise"),uSeed:t.getUniformLocation(o,"uSeed")}},sendUniformData:function(t,o){t.uniform1f(o.uNoise,this.noise/255),t.uniform1f(o.uSeed,Math.random())},toObject:function(){return s(this.callSuper("toObject"),{noise:this.noise})}}),i.Image.filters.Noise.fromObject=i.Image.filters.BaseFilter.fromObject}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.Image.filters,l=i.util.createClass;s.Pixelate=l(s.BaseFilter,{type:"Pixelate",blocksize:4,mainParameter:"blocksize",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uBlocksize;
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
float blockW = uBlocksize * uStepW;
float blockH = uBlocksize * uStepW;
int posX = int(vTexCoord.x / blockW);
int posY = int(vTexCoord.y / blockH);
float fposX = float(posX);
float fposY = float(posY);
vec2 squareCoords = vec2(fposX * blockW, fposY * blockH);
vec4 color = texture2D(uTexture, squareCoords);
gl_FragColor = color;
}`,applyTo2d:function(e){var t,o,d,h,c,f,p,y,b,C,T,O=e.imageData,F=O.data,B=O.height,H=O.width;for(o=0;o<B;o+=this.blocksize)for(d=0;d<H;d+=this.blocksize)for(h=F[t=4*o*H+4*d],c=F[t+1],f=F[t+2],p=F[t+3],C=Math.min(o+this.blocksize,B),T=Math.min(d+this.blocksize,H),y=o;y<C;y++)for(b=d;b<T;b++)F[t=4*y*H+4*b]=h,F[t+1]=c,F[t+2]=f,F[t+3]=p},isNeutralState:function(){return this.blocksize===1},getUniformLocations:function(e,t){return{uBlocksize:e.getUniformLocation(t,"uBlocksize"),uStepW:e.getUniformLocation(t,"uStepW"),uStepH:e.getUniformLocation(t,"uStepH")}},sendUniformData:function(e,t){e.uniform1f(t.uBlocksize,this.blocksize)}}),i.Image.filters.Pixelate.fromObject=i.Image.filters.BaseFilter.fromObject}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.util.object.extend,l=i.Image.filters,e=i.util.createClass;l.RemoveColor=e(l.BaseFilter,{type:"RemoveColor",color:"#FFFFFF",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec4 uLow;
uniform vec4 uHigh;
varying vec2 vTexCoord;
void main() {
gl_FragColor = texture2D(uTexture, vTexCoord);
if(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {
gl_FragColor.a = 0.0;
}
}`,distance:.02,useAlpha:!1,applyTo2d:function(t){var o,d,h,c,f=t.imageData.data,p=255*this.distance,y=new i.Color(this.color).getSource(),b=[y[0]-p,y[1]-p,y[2]-p],C=[y[0]+p,y[1]+p,y[2]+p];for(o=0;o<f.length;o+=4)d=f[o],h=f[o+1],c=f[o+2],d>b[0]&&h>b[1]&&c>b[2]&&d<C[0]&&h<C[1]&&c<C[2]&&(f[o+3]=0)},getUniformLocations:function(t,o){return{uLow:t.getUniformLocation(o,"uLow"),uHigh:t.getUniformLocation(o,"uHigh")}},sendUniformData:function(t,o){var d=new i.Color(this.color).getSource(),h=parseFloat(this.distance),c=[0+d[0]/255-h,0+d[1]/255-h,0+d[2]/255-h,1],f=[d[0]/255+h,d[1]/255+h,d[2]/255+h,1];t.uniform4fv(o.uLow,c),t.uniform4fv(o.uHigh,f)},toObject:function(){return s(this.callSuper("toObject"),{color:this.color,distance:this.distance})}}),i.Image.filters.RemoveColor.fromObject=i.Image.filters.BaseFilter.fromObject}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.Image.filters,l=i.util.createClass,e={Brownie:[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0],Vintage:[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0],Kodachrome:[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0],Technicolor:[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0],Polaroid:[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],Sepia:[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0],BlackWhite:[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]};for(var t in e)s[t]=l(s.ColorMatrix,{type:t,matrix:e[t],mainParameter:!1,colorsOnly:!0}),i.Image.filters[t].fromObject=i.Image.filters.BaseFilter.fromObject}(r),function(n){var i=n.fabric,s=i.Image.filters,l=i.util.createClass;s.BlendColor=l(s.BaseFilter,{type:"BlendColor",color:"#F95C63",mode:"multiply",alpha:1,fragmentSource:{multiply:`gl_FragColor.rgb *= uColor.rgb;
`,screen:`gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);
`,add:`gl_FragColor.rgb += uColor.rgb;
`,diff:`gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);
`,subtract:`gl_FragColor.rgb -= uColor.rgb;
`,lighten:`gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);
`,darken:`gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);
`,exclusion:`gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);
`,overlay:`if (uColor.r < 0.5) {
gl_FragColor.r *= 2.0 * uColor.r;
} else {
gl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);
}
if (uColor.g < 0.5) {
gl_FragColor.g *= 2.0 * uColor.g;
} else {
gl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);
}
if (uColor.b < 0.5) {
gl_FragColor.b *= 2.0 * uColor.b;
} else {
gl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);
}
`,tint:`gl_FragColor.rgb *= (1.0 - uColor.a);
gl_FragColor.rgb += uColor.rgb;
`},buildSource:function(e){return`precision highp float;
uniform sampler2D uTexture;
uniform vec4 uColor;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
gl_FragColor = color;
if (color.a > 0.0) {
`+this.fragmentSource[e]+`}
}`},retrieveShader:function(e){var t,o=this.type+"_"+this.mode;return e.programCache.hasOwnProperty(o)||(t=this.buildSource(this.mode),e.programCache[o]=this.createProgram(e.context,t)),e.programCache[o]},applyTo2d:function(e){var t,o,d,h,c,f,p,y=e.imageData.data,b=y.length,C=1-this.alpha;t=(p=new i.Color(this.color).getSource())[0]*this.alpha,o=p[1]*this.alpha,d=p[2]*this.alpha;for(var T=0;T<b;T+=4)switch(h=y[T],c=y[T+1],f=y[T+2],this.mode){case"multiply":y[T]=h*t/255,y[T+1]=c*o/255,y[T+2]=f*d/255;break;case"screen":y[T]=255-(255-h)*(255-t)/255,y[T+1]=255-(255-c)*(255-o)/255,y[T+2]=255-(255-f)*(255-d)/255;break;case"add":y[T]=h+t,y[T+1]=c+o,y[T+2]=f+d;break;case"diff":case"difference":y[T]=Math.abs(h-t),y[T+1]=Math.abs(c-o),y[T+2]=Math.abs(f-d);break;case"subtract":y[T]=h-t,y[T+1]=c-o,y[T+2]=f-d;break;case"darken":y[T]=Math.min(h,t),y[T+1]=Math.min(c,o),y[T+2]=Math.min(f,d);break;case"lighten":y[T]=Math.max(h,t),y[T+1]=Math.max(c,o),y[T+2]=Math.max(f,d);break;case"overlay":y[T]=t<128?2*h*t/255:255-2*(255-h)*(255-t)/255,y[T+1]=o<128?2*c*o/255:255-2*(255-c)*(255-o)/255,y[T+2]=d<128?2*f*d/255:255-2*(255-f)*(255-d)/255;break;case"exclusion":y[T]=t+h-2*t*h/255,y[T+1]=o+c-2*o*c/255,y[T+2]=d+f-2*d*f/255;break;case"tint":y[T]=t+h*C,y[T+1]=o+c*C,y[T+2]=d+f*C}},getUniformLocations:function(e,t){return{uColor:e.getUniformLocation(t,"uColor")}},sendUniformData:function(e,t){var o=new i.Color(this.color).getSource();o[0]=this.alpha*o[0]/255,o[1]=this.alpha*o[1]/255,o[2]=this.alpha*o[2]/255,o[3]=this.alpha,e.uniform4fv(t.uColor,o)},toObject:function(){return{type:this.type,color:this.color,mode:this.mode,alpha:this.alpha}}}),i.Image.filters.BlendColor.fromObject=i.Image.filters.BaseFilter.fromObject}(r),function(n){var i=n.fabric,s=i.Image.filters,l=i.util.createClass;s.BlendImage=l(s.BaseFilter,{type:"BlendImage",image:null,mode:"multiply",alpha:1,vertexSource:`attribute vec2 aPosition;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
uniform mat3 uTransformMatrix;
void main() {
vTexCoord = aPosition;
vTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;
gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
}`,fragmentSource:{multiply:`precision highp float;
uniform sampler2D uTexture;
uniform sampler2D uImage;
uniform vec4 uColor;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec4 color2 = texture2D(uImage, vTexCoord2);
color.rgba *= color2.rgba;
gl_FragColor = color;
}`,mask:`precision highp float;
uniform sampler2D uTexture;
uniform sampler2D uImage;
uniform vec4 uColor;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec4 color2 = texture2D(uImage, vTexCoord2);
color.a = color2.a;
gl_FragColor = color;
}`},retrieveShader:function(e){var t=this.type+"_"+this.mode,o=this.fragmentSource[this.mode];return e.programCache.hasOwnProperty(t)||(e.programCache[t]=this.createProgram(e.context,o)),e.programCache[t]},applyToWebGL:function(e){var t=e.context,o=this.createTexture(e.filterBackend,this.image);this.bindAdditionalTexture(t,o,t.TEXTURE1),this.callSuper("applyToWebGL",e),this.unbindAdditionalTexture(t,t.TEXTURE1)},createTexture:function(e,t){return e.getCachedTexture(t.cacheKey,t._element)},calculateMatrix:function(){var e=this.image,t=e._element.width,o=e._element.height;return[1/e.scaleX,0,0,0,1/e.scaleY,0,-e.left/t,-e.top/o,1]},applyTo2d:function(e){var t,o,d,h,c,f,p,y,b,C,T,O=e.imageData,F=e.filterBackend.resources,B=O.data,H=B.length,U=O.width,V=O.height,L=this.image;F.blendImage||(F.blendImage=i.util.createCanvasElement()),C=(b=F.blendImage).getContext("2d"),b.width!==U||b.height!==V?(b.width=U,b.height=V):C.clearRect(0,0,U,V),C.setTransform(L.scaleX,0,0,L.scaleY,L.left,L.top),C.drawImage(L._element,0,0,U,V),T=C.getImageData(0,0,U,V).data;for(var R=0;R<H;R+=4)switch(c=B[R],f=B[R+1],p=B[R+2],y=B[R+3],t=T[R],o=T[R+1],d=T[R+2],h=T[R+3],this.mode){case"multiply":B[R]=c*t/255,B[R+1]=f*o/255,B[R+2]=p*d/255,B[R+3]=y*h/255;break;case"mask":B[R+3]=h}},getUniformLocations:function(e,t){return{uTransformMatrix:e.getUniformLocation(t,"uTransformMatrix"),uImage:e.getUniformLocation(t,"uImage")}},sendUniformData:function(e,t){var o=this.calculateMatrix();e.uniform1i(t.uImage,1),e.uniformMatrix3fv(t.uTransformMatrix,!1,o)},toObject:function(){return{type:this.type,image:this.image&&this.image.toObject(),mode:this.mode,alpha:this.alpha}}}),i.Image.filters.BlendImage.fromObject=function(e,t){i.Image.fromObject(e.image,function(o){var d=i.util.object.clone(e);d.image=o,t(new i.Image.filters.BlendImage(d))})}}(r),function(n){var i=n.fabric||(n.fabric={}),s=Math.pow,l=Math.floor,e=Math.sqrt,t=Math.abs,o=Math.round,d=Math.sin,h=Math.ceil,c=i.Image.filters,f=i.util.createClass;c.Resize=f(c.BaseFilter,{type:"Resize",resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3,getUniformLocations:function(p,y){return{uDelta:p.getUniformLocation(y,"uDelta"),uTaps:p.getUniformLocation(y,"uTaps")}},sendUniformData:function(p,y){p.uniform2fv(y.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),p.uniform1fv(y.uTaps,this.taps)},retrieveShader:function(p){var y=this.getFilterWindow(),b=this.type+"_"+y;if(!p.programCache.hasOwnProperty(b)){var C=this.generateShader(y);p.programCache[b]=this.createProgram(p.context,C)}return p.programCache[b]},getFilterWindow:function(){var p=this.tempScale;return Math.ceil(this.lanczosLobes/p)},getTaps:function(){for(var p=this.lanczosCreate(this.lanczosLobes),y=this.tempScale,b=this.getFilterWindow(),C=new Array(b),T=1;T<=b;T++)C[T-1]=p(T*y);return C},generateShader:function(p){for(var y=new Array(p),b=this.fragmentSourceTOP,C=1;C<=p;C++)y[C-1]=C+".0 * uDelta";return b+="uniform float uTaps["+p+`];
`,b+=`void main() {
`,b+=`  vec4 color = texture2D(uTexture, vTexCoord);
`,b+=`  float sum = 1.0;
`,y.forEach(function(T,O){b+="  color += texture2D(uTexture, vTexCoord + "+T+") * uTaps["+O+`];
`,b+="  color += texture2D(uTexture, vTexCoord - "+T+") * uTaps["+O+`];
`,b+="  sum += 2.0 * uTaps["+O+`];
`}),b+=`  gl_FragColor = color / sum;
`,b+="}"},fragmentSourceTOP:`precision highp float;
uniform sampler2D uTexture;
uniform vec2 uDelta;
varying vec2 vTexCoord;
`,applyTo:function(p){p.webgl?(p.passes++,this.width=p.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=p.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),p.destinationWidth=this.dW,this._setupFrameBuffer(p),this.applyToWebGL(p),this._swapTextures(p),p.sourceWidth=p.destinationWidth,this.height=p.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),p.destinationHeight=this.dH,this._setupFrameBuffer(p),this.applyToWebGL(p),this._swapTextures(p),p.sourceHeight=p.destinationHeight):this.applyTo2d(p)},isNeutralState:function(){return this.scaleX===1&&this.scaleY===1},lanczosCreate:function(p){return function(y){if(y>=p||y<=-p)return 0;if(y<11920929e-14&&y>-11920929e-14)return 1;var b=(y*=Math.PI)/p;return d(y)/y*d(b)/b}},applyTo2d:function(p){var y=p.imageData,b=this.scaleX,C=this.scaleY;this.rcpScaleX=1/b,this.rcpScaleY=1/C;var T,O=y.width,F=y.height,B=o(O*b),H=o(F*C);this.resizeType==="sliceHack"?T=this.sliceByTwo(p,O,F,B,H):this.resizeType==="hermite"?T=this.hermiteFastResize(p,O,F,B,H):this.resizeType==="bilinear"?T=this.bilinearFiltering(p,O,F,B,H):this.resizeType==="lanczos"&&(T=this.lanczosResize(p,O,F,B,H)),p.imageData=T},sliceByTwo:function(p,y,b,C,T){var O,F,B=p.imageData,H=.5,U=!1,V=!1,L=y*H,R=b*H,N=i.filterBackend.resources,W=0,Y=0,P=y,M=0;for(N.sliceByTwo||(N.sliceByTwo=document.createElement("canvas")),((O=N.sliceByTwo).width<1.5*y||O.height<b)&&(O.width=1.5*y,O.height=b),(F=O.getContext("2d")).clearRect(0,0,1.5*y,b),F.putImageData(B,0,0),C=l(C),T=l(T);!U||!V;)y=L,b=R,C<l(L*H)?L=l(L*H):(L=C,U=!0),T<l(R*H)?R=l(R*H):(R=T,V=!0),F.drawImage(O,W,Y,y,b,P,M,L,R),W=P,Y=M,M+=R;return F.getImageData(W,Y,C,T)},lanczosResize:function(p,y,b,C,T){var O=p.imageData.data,F=p.ctx.createImageData(C,T),B=F.data,H=this.lanczosCreate(this.lanczosLobes),U=this.rcpScaleX,V=this.rcpScaleY,L=2/this.rcpScaleX,R=2/this.rcpScaleY,N=h(U*this.lanczosLobes/2),W=h(V*this.lanczosLobes/2),Y={},P={},M={};return function j(X){var G,Z,de,oe,ie,ue,he,ge,me,_e,ve;for(P.x=(X+.5)*U,M.x=l(P.x),G=0;G<T;G++){for(P.y=(G+.5)*V,M.y=l(P.y),ie=0,ue=0,he=0,ge=0,me=0,Z=M.x-N;Z<=M.x+N;Z++)if(!(Z<0||Z>=y)){_e=l(1e3*t(Z-P.x)),Y[_e]||(Y[_e]={});for(var Se=M.y-W;Se<=M.y+W;Se++)Se<0||Se>=b||(ve=l(1e3*t(Se-P.y)),Y[_e][ve]||(Y[_e][ve]=H(e(s(_e*L,2)+s(ve*R,2))/1e3)),(de=Y[_e][ve])>0&&(ie+=de,ue+=de*O[oe=4*(Se*y+Z)],he+=de*O[oe+1],ge+=de*O[oe+2],me+=de*O[oe+3]))}B[oe=4*(G*C+X)]=ue/ie,B[oe+1]=he/ie,B[oe+2]=ge/ie,B[oe+3]=me/ie}return++X<C?j(X):F}(0)},bilinearFiltering:function(p,y,b,C,T){var O,F,B,H,U,V,L,R,N,W=0,Y=this.rcpScaleX,P=this.rcpScaleY,M=4*(y-1),j=p.imageData.data,X=p.ctx.createImageData(C,T),G=X.data;for(B=0;B<T;B++)for(H=0;H<C;H++)for(U=Y*H-(O=l(Y*H)),V=P*B-(F=l(P*B)),N=4*(F*y+O),L=0;L<4;L++)R=j[N+L]*(1-U)*(1-V)+j[N+4+L]*U*(1-V)+j[N+M+L]*V*(1-U)+j[N+M+4+L]*U*V,G[W++]=R;return X},hermiteFastResize:function(p,y,b,C,T){for(var O=this.rcpScaleX,F=this.rcpScaleY,B=h(O/2),H=h(F/2),U=p.imageData.data,V=p.ctx.createImageData(C,T),L=V.data,R=0;R<T;R++)for(var N=0;N<C;N++){for(var W=4*(N+R*C),Y=0,P=0,M=0,j=0,X=0,G=0,Z=0,de=(R+.5)*F,oe=l(R*F);oe<(R+1)*F;oe++)for(var ie=t(de-(oe+.5))/H,ue=(N+.5)*O,he=ie*ie,ge=l(N*O);ge<(N+1)*O;ge++){var me=t(ue-(ge+.5))/B,_e=e(he+me*me);_e>1&&_e<-1||(Y=2*_e*_e*_e-3*_e*_e+1)>0&&(Z+=Y*U[3+(me=4*(ge+oe*y))],M+=Y,U[me+3]<255&&(Y=Y*U[me+3]/250),j+=Y*U[me],X+=Y*U[me+1],G+=Y*U[me+2],P+=Y)}L[W]=j/P,L[W+1]=X/P,L[W+2]=G/P,L[W+3]=Z/M}return V},toObject:function(){return{type:this.type,scaleX:this.scaleX,scaleY:this.scaleY,resizeType:this.resizeType,lanczosLobes:this.lanczosLobes}}}),i.Image.filters.Resize.fromObject=i.Image.filters.BaseFilter.fromObject}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.Image.filters,l=i.util.createClass;s.Contrast=l(s.BaseFilter,{type:"Contrast",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uContrast;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));
color.rgb = contrastF * (color.rgb - 0.5) + 0.5;
gl_FragColor = color;
}`,contrast:0,mainParameter:"contrast",applyTo2d:function(e){if(this.contrast!==0){var t,o=e.imageData.data,d=o.length,h=Math.floor(255*this.contrast),c=259*(h+255)/(255*(259-h));for(t=0;t<d;t+=4)o[t]=c*(o[t]-128)+128,o[t+1]=c*(o[t+1]-128)+128,o[t+2]=c*(o[t+2]-128)+128}},getUniformLocations:function(e,t){return{uContrast:e.getUniformLocation(t,"uContrast")}},sendUniformData:function(e,t){e.uniform1f(t.uContrast,this.contrast)}}),i.Image.filters.Contrast.fromObject=i.Image.filters.BaseFilter.fromObject}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.Image.filters,l=i.util.createClass;s.Saturation=l(s.BaseFilter,{type:"Saturation",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uSaturation;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float rgMax = max(color.r, color.g);
float rgbMax = max(rgMax, color.b);
color.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;
color.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;
color.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;
gl_FragColor = color;
}`,saturation:0,mainParameter:"saturation",applyTo2d:function(e){if(this.saturation!==0){var t,o,d=e.imageData.data,h=d.length,c=-this.saturation;for(t=0;t<h;t+=4)o=Math.max(d[t],d[t+1],d[t+2]),d[t]+=o!==d[t]?(o-d[t])*c:0,d[t+1]+=o!==d[t+1]?(o-d[t+1])*c:0,d[t+2]+=o!==d[t+2]?(o-d[t+2])*c:0}},getUniformLocations:function(e,t){return{uSaturation:e.getUniformLocation(t,"uSaturation")}},sendUniformData:function(e,t){e.uniform1f(t.uSaturation,-this.saturation)}}),i.Image.filters.Saturation.fromObject=i.Image.filters.BaseFilter.fromObject}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.Image.filters,l=i.util.createClass;s.Vibrance=l(s.BaseFilter,{type:"Vibrance",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uVibrance;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float max = max(color.r, max(color.g, color.b));
float avg = (color.r + color.g + color.b) / 3.0;
float amt = (abs(max - avg) * 2.0) * uVibrance;
color.r += max != color.r ? (max - color.r) * amt : 0.00;
color.g += max != color.g ? (max - color.g) * amt : 0.00;
color.b += max != color.b ? (max - color.b) * amt : 0.00;
gl_FragColor = color;
}`,vibrance:0,mainParameter:"vibrance",applyTo2d:function(e){if(this.vibrance!==0){var t,o,d,h,c=e.imageData.data,f=c.length,p=-this.vibrance;for(t=0;t<f;t+=4)o=Math.max(c[t],c[t+1],c[t+2]),d=(c[t]+c[t+1]+c[t+2])/3,h=2*Math.abs(o-d)/255*p,c[t]+=o!==c[t]?(o-c[t])*h:0,c[t+1]+=o!==c[t+1]?(o-c[t+1])*h:0,c[t+2]+=o!==c[t+2]?(o-c[t+2])*h:0}},getUniformLocations:function(e,t){return{uVibrance:e.getUniformLocation(t,"uVibrance")}},sendUniformData:function(e,t){e.uniform1f(t.uVibrance,-this.vibrance)}}),i.Image.filters.Vibrance.fromObject=i.Image.filters.BaseFilter.fromObject}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.Image.filters,l=i.util.createClass;s.Blur=l(s.BaseFilter,{type:"Blur",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec2 uDelta;
varying vec2 vTexCoord;
const float nSamples = 15.0;
vec3 v3offset = vec3(12.9898, 78.233, 151.7182);
float random(vec3 scale) {
return fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);
}
void main() {
vec4 color = vec4(0.0);
float total = 0.0;
float offset = random(v3offset);
for (float t = -nSamples; t <= nSamples; t++) {
float percent = (t + offset - 0.5) / nSamples;
float weight = 1.0 - abs(percent);
color += texture2D(uTexture, vTexCoord + uDelta * percent) * weight;
total += weight;
}
gl_FragColor = color / total;
}`,blur:0,mainParameter:"blur",applyTo:function(e){e.webgl?(this.aspectRatio=e.sourceWidth/e.sourceHeight,e.passes++,this._setupFrameBuffer(e),this.horizontal=!0,this.applyToWebGL(e),this._swapTextures(e),this._setupFrameBuffer(e),this.horizontal=!1,this.applyToWebGL(e),this._swapTextures(e)):this.applyTo2d(e)},applyTo2d:function(e){e.imageData=this.simpleBlur(e)},simpleBlur:function(e){var t,o,d=e.filterBackend.resources,h=e.imageData.width,c=e.imageData.height;d.blurLayer1||(d.blurLayer1=i.util.createCanvasElement(),d.blurLayer2=i.util.createCanvasElement()),t=d.blurLayer1,o=d.blurLayer2,t.width===h&&t.height===c||(o.width=t.width=h,o.height=t.height=c);var f,p,y,b,C=t.getContext("2d"),T=o.getContext("2d"),O=.06*this.blur*.5;for(C.putImageData(e.imageData,0,0),T.clearRect(0,0,h,c),b=-15;b<=15;b++)y=O*(p=b/15)*h+(f=(Math.random()-.5)/4),T.globalAlpha=1-Math.abs(p),T.drawImage(t,y,f),C.drawImage(o,0,0),T.globalAlpha=1,T.clearRect(0,0,o.width,o.height);for(b=-15;b<=15;b++)y=O*(p=b/15)*c+(f=(Math.random()-.5)/4),T.globalAlpha=1-Math.abs(p),T.drawImage(t,f,y),C.drawImage(o,0,0),T.globalAlpha=1,T.clearRect(0,0,o.width,o.height);e.ctx.drawImage(t,0,0);var F=e.ctx.getImageData(0,0,t.width,t.height);return C.globalAlpha=1,C.clearRect(0,0,t.width,t.height),F},getUniformLocations:function(e,t){return{delta:e.getUniformLocation(t,"uDelta")}},sendUniformData:function(e,t){var o=this.chooseRightDelta();e.uniform2fv(t.delta,o)},chooseRightDelta:function(){var e,t=1,o=[0,0];return this.horizontal?this.aspectRatio>1&&(t=1/this.aspectRatio):this.aspectRatio<1&&(t=this.aspectRatio),e=t*this.blur*.12,this.horizontal?o[0]=e:o[1]=e,o}}),s.Blur.fromObject=i.Image.filters.BaseFilter.fromObject}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.Image.filters,l=i.util.createClass;s.Gamma=l(s.BaseFilter,{type:"Gamma",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec3 uGamma;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec3 correction = (1.0 / uGamma);
color.r = pow(color.r, correction.r);
color.g = pow(color.g, correction.g);
color.b = pow(color.b, correction.b);
gl_FragColor = color;
gl_FragColor.rgb *= color.a;
}`,gamma:[1,1,1],mainParameter:"gamma",initialize:function(e){this.gamma=[1,1,1],s.BaseFilter.prototype.initialize.call(this,e)},applyTo2d:function(e){var t,o=e.imageData.data,d=this.gamma,h=o.length,c=1/d[0],f=1/d[1],p=1/d[2];for(this.rVals||(this.rVals=new Uint8Array(256),this.gVals=new Uint8Array(256),this.bVals=new Uint8Array(256)),t=0,h=256;t<h;t++)this.rVals[t]=255*Math.pow(t/255,c),this.gVals[t]=255*Math.pow(t/255,f),this.bVals[t]=255*Math.pow(t/255,p);for(t=0,h=o.length;t<h;t+=4)o[t]=this.rVals[o[t]],o[t+1]=this.gVals[o[t+1]],o[t+2]=this.bVals[o[t+2]]},getUniformLocations:function(e,t){return{uGamma:e.getUniformLocation(t,"uGamma")}},sendUniformData:function(e,t){e.uniform3fv(t.uGamma,this.gamma)}}),i.Image.filters.Gamma.fromObject=i.Image.filters.BaseFilter.fromObject}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.Image.filters,l=i.util.createClass;s.Composed=l(s.BaseFilter,{type:"Composed",subFilters:[],initialize:function(e){this.callSuper("initialize",e),this.subFilters=this.subFilters.slice(0)},applyTo:function(e){e.passes+=this.subFilters.length-1,this.subFilters.forEach(function(t){t.applyTo(e)})},toObject:function(){return i.util.object.extend(this.callSuper("toObject"),{subFilters:this.subFilters.map(function(e){return e.toObject()})})},isNeutralState:function(){return!this.subFilters.some(function(e){return!e.isNeutralState()})}}),i.Image.filters.Composed.fromObject=function(e,t){var o=(e.subFilters||[]).map(function(h){return new i.Image.filters[h.type](h)}),d=new i.Image.filters.Composed({subFilters:o});return t&&t(d),d}}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.Image.filters,l=i.util.createClass;s.HueRotation=l(s.ColorMatrix,{type:"HueRotation",rotation:0,mainParameter:"rotation",calculateMatrix:function(){var e=this.rotation*Math.PI,t=i.util.cos(e),o=i.util.sin(e),d=1/3,h=Math.sqrt(d)*o,c=1-t;this.matrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],this.matrix[0]=t+c/3,this.matrix[1]=d*c-h,this.matrix[2]=d*c+h,this.matrix[5]=d*c+h,this.matrix[6]=t+d*c,this.matrix[7]=d*c-h,this.matrix[10]=d*c-h,this.matrix[11]=d*c+h,this.matrix[12]=t+d*c},isNeutralState:function(e){return this.calculateMatrix(),s.BaseFilter.prototype.isNeutralState.call(this,e)},applyTo:function(e){this.calculateMatrix(),s.BaseFilter.prototype.applyTo.call(this,e)}}),i.Image.filters.HueRotation.fromObject=i.Image.filters.BaseFilter.fromObject}(r),function(n){var i=n.fabric||(n.fabric={}),s=i.util.object.clone;if(i.Text)i.warn("fabric.Text is already defined");else{var l="fontFamily fontWeight fontSize text underline overline linethrough textAlign fontStyle lineHeight textBackgroundColor charSpacing styles direction path pathStartOffset pathSide pathAlign".split(" ");i.Text=i.util.createClass(i.Object,{_dimensionAffectingProps:["fontSize","fontWeight","fontFamily","fontStyle","lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide","pathAlign"],_reNewline:/\r?\n/,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,type:"text",fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:"left",fontStyle:"normal",lineHeight:1.16,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},textBackgroundColor:"",stateProperties:i.Object.prototype.stateProperties.concat(l),cacheProperties:i.Object.prototype.cacheProperties.concat(l),stroke:null,shadow:null,path:null,pathStartOffset:0,pathSide:"left",pathAlign:"baseline",_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.315,overline:-.88},_fontSizeMult:1.13,charSpacing:0,styles:null,_measuringContext:null,deltaY:0,direction:"ltr",_styleProperties:["stroke","strokeWidth","fill","fontFamily","fontSize","fontWeight","fontStyle","underline","overline","linethrough","deltaY","textBackgroundColor"],__charBounds:[],CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,initialize:function(e,t){this.styles=t&&t.styles||{},this.text=e,this.__skipDimension=!0,this.callSuper("initialize",t),this.path&&this.setPathInfo(),this.__skipDimension=!1,this.initDimensions(),this.setCoords(),this.setupState({propertySet:"_dimensionAffectingProps"})},setPathInfo:function(){var e=this.path;e&&(e.segmentsInfo=i.util.getPathSegmentsInfo(e.path))},getMeasuringContext:function(){return i._measuringContext||(i._measuringContext=this.canvas&&this.canvas.contextCache||i.util.createCanvasElement().getContext("2d")),i._measuringContext},_splitText:function(){var e=this._splitTextIntoLines(this.text);return this.textLines=e.lines,this._textLines=e.graphemeLines,this._unwrappedTextLines=e._unwrappedLines,this._text=e.graphemeText,e},initDimensions:function(){this.__skipDimension||(this._splitText(),this._clearCache(),this.path?(this.width=this.path.width,this.height=this.path.height):(this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight()),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.saveState({propertySet:"_dimensionAffectingProps"}))},enlargeSpaces:function(){for(var e,t,o,d,h,c,f,p=0,y=this._textLines.length;p<y;p++)if((this.textAlign==="justify"||p!==y-1&&!this.isEndOfWrapping(p))&&(d=0,h=this._textLines[p],(t=this.getLineWidth(p))<this.width&&(f=this.textLines[p].match(this._reSpacesAndTabs)))){o=f.length,e=(this.width-t)/o;for(var b=0,C=h.length;b<=C;b++)c=this.__charBounds[p][b],this._reSpaceAndTab.test(h[b])?(c.width+=e,c.kernedWidth+=e,c.left+=d,d+=e):c.left+=d}},isEndOfWrapping:function(e){return e===this._textLines.length-1},missingNewlineOffset:function(){return 1},toString:function(){return"#<fabric.Text ("+this.complexity()+'): { "text": "'+this.text+'", "fontFamily": "'+this.fontFamily+'" }>'},_getCacheCanvasDimensions:function(){var e=this.callSuper("_getCacheCanvasDimensions"),t=this.fontSize;return e.width+=t*e.zoomX,e.height+=t*e.zoomY,e},_render:function(e){var t=this.path;t&&!t.isNotVisible()&&t._render(e),this._setTextStyles(e),this._renderTextLinesBackground(e),this._renderTextDecoration(e,"underline"),this._renderText(e),this._renderTextDecoration(e,"overline"),this._renderTextDecoration(e,"linethrough")},_renderText:function(e){this.paintFirst==="stroke"?(this._renderTextStroke(e),this._renderTextFill(e)):(this._renderTextFill(e),this._renderTextStroke(e))},_setTextStyles:function(e,t,o){if(e.textBaseline="alphabetical",this.path)switch(this.pathAlign){case"center":e.textBaseline="middle";break;case"ascender":e.textBaseline="top";break;case"descender":e.textBaseline="bottom"}e.font=this._getFontDeclaration(t,o)},calcTextWidth:function(){for(var e=this.getLineWidth(0),t=1,o=this._textLines.length;t<o;t++){var d=this.getLineWidth(t);d>e&&(e=d)}return e},_renderTextLine:function(e,t,o,d,h,c){this._renderChars(e,t,o,d,h,c)},_renderTextLinesBackground:function(e){if(this.textBackgroundColor||this.styleHas("textBackgroundColor")){for(var t,o,d,h,c,f,p,y=e.fillStyle,b=this._getLeftOffset(),C=this._getTopOffset(),T=0,O=0,F=this.path,B=0,H=this._textLines.length;B<H;B++)if(t=this.getHeightOfLine(B),this.textBackgroundColor||this.styleHas("textBackgroundColor",B)){d=this._textLines[B],o=this._getLineLeftOffset(B),O=0,T=0,h=this.getValueOfPropertyAt(B,0,"textBackgroundColor");for(var U=0,V=d.length;U<V;U++)c=this.__charBounds[B][U],f=this.getValueOfPropertyAt(B,U,"textBackgroundColor"),F?(e.save(),e.translate(c.renderLeft,c.renderTop),e.rotate(c.angle),e.fillStyle=f,f&&e.fillRect(-c.width/2,-t/this.lineHeight*(1-this._fontSizeFraction),c.width,t/this.lineHeight),e.restore()):f!==h?(p=b+o+T,this.direction==="rtl"&&(p=this.width-p-O),e.fillStyle=h,h&&e.fillRect(p,C,O,t/this.lineHeight),T=c.left,O=c.width,h=f):O+=c.kernedWidth;f&&!F&&(p=b+o+T,this.direction==="rtl"&&(p=this.width-p-O),e.fillStyle=f,e.fillRect(p,C,O,t/this.lineHeight)),C+=t}else C+=t;e.fillStyle=y,this._removeShadow(e)}},getFontCache:function(e){var t=e.fontFamily.toLowerCase();i.charWidthsCache[t]||(i.charWidthsCache[t]={});var o=i.charWidthsCache[t],d=e.fontStyle.toLowerCase()+"_"+(e.fontWeight+"").toLowerCase();return o[d]||(o[d]={}),o[d]},_measureChar:function(e,t,o,d){var h,c,f,p,y=this.getFontCache(t),b=o+e,C=this._getFontDeclaration(t)===this._getFontDeclaration(d),T=t.fontSize/this.CACHE_FONT_SIZE;if(o&&y[o]!==void 0&&(f=y[o]),y[e]!==void 0&&(p=h=y[e]),C&&y[b]!==void 0&&(p=(c=y[b])-f),h===void 0||f===void 0||c===void 0){var O=this.getMeasuringContext();this._setTextStyles(O,t,!0)}return h===void 0&&(p=h=O.measureText(e).width,y[e]=h),f===void 0&&C&&o&&(f=O.measureText(o).width,y[o]=f),C&&c===void 0&&(c=O.measureText(b).width,y[b]=c,p=c-f),{width:h*T,kernedWidth:p*T}},getHeightOfChar:function(e,t){return this.getValueOfPropertyAt(e,t,"fontSize")},measureLine:function(e){var t=this._measureLine(e);return this.charSpacing!==0&&(t.width-=this._getWidthOfCharSpacing()),t.width<0&&(t.width=0),t},_measureLine:function(e){var t,o,d,h,c,f,p=0,y=this._textLines[e],b=new Array(y.length),C=0,T=this.path,O=this.pathSide==="right";for(this.__charBounds[e]=b,t=0;t<y.length;t++)o=y[t],h=this._getGraphemeBox(o,e,t,d),b[t]=h,p+=h.kernedWidth,d=o;if(b[t]={left:h?h.left+h.width:0,width:0,kernedWidth:0,height:this.fontSize},T){switch(f=T.segmentsInfo[T.segmentsInfo.length-1].length,(c=i.util.getPointOnPath(T.path,0,T.segmentsInfo)).x+=T.pathOffset.x,c.y+=T.pathOffset.y,this.textAlign){case"left":C=O?f-p:0;break;case"center":C=(f-p)/2;break;case"right":C=O?0:f-p}for(C+=this.pathStartOffset*(O?-1:1),t=O?y.length-1:0;O?t>=0:t<y.length;O?t--:t++)h=b[t],C>f?C%=f:C<0&&(C+=f),this._setGraphemeOnPath(C,h,c),C+=h.kernedWidth}return{width:p,numOfSpaces:0}},_setGraphemeOnPath:function(e,t,o){var d=e+t.kernedWidth/2,h=this.path,c=i.util.getPointOnPath(h.path,d,h.segmentsInfo);t.renderLeft=c.x-o.x,t.renderTop=c.y-o.y,t.angle=c.angle+(this.pathSide==="right"?Math.PI:0)},_getGraphemeBox:function(e,t,o,d,h){var c,f=this.getCompleteStyleDeclaration(t,o),p=d?this.getCompleteStyleDeclaration(t,o-1):{},y=this._measureChar(e,f,d,p),b=y.kernedWidth,C=y.width;this.charSpacing!==0&&(C+=c=this._getWidthOfCharSpacing(),b+=c);var T={width:C,left:0,height:f.fontSize,kernedWidth:b,deltaY:f.deltaY};if(o>0&&!h){var O=this.__charBounds[t][o-1];T.left=O.left+O.width+y.kernedWidth-y.width}return T},getHeightOfLine:function(e){if(this.__lineHeights[e])return this.__lineHeights[e];for(var t=this._textLines[e],o=this.getHeightOfChar(e,0),d=1,h=t.length;d<h;d++)o=Math.max(this.getHeightOfChar(e,d),o);return this.__lineHeights[e]=o*this.lineHeight*this._fontSizeMult},calcTextHeight:function(){for(var e,t=0,o=0,d=this._textLines.length;o<d;o++)e=this.getHeightOfLine(o),t+=o===d-1?e/this.lineHeight:e;return t},_getLeftOffset:function(){return this.direction==="ltr"?-this.width/2:this.width/2},_getTopOffset:function(){return-this.height/2},_renderTextCommon:function(e,t){e.save();for(var o=0,d=this._getLeftOffset(),h=this._getTopOffset(),c=0,f=this._textLines.length;c<f;c++){var p=this.getHeightOfLine(c),y=p/this.lineHeight,b=this._getLineLeftOffset(c);this._renderTextLine(t,e,this._textLines[c],d+b,h+o+y,c),o+=p}e.restore()},_renderTextFill:function(e){(this.fill||this.styleHas("fill"))&&this._renderTextCommon(e,"fillText")},_renderTextStroke:function(e){(this.stroke&&this.strokeWidth!==0||!this.isEmptyStyles())&&(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(e),e.save(),this._setLineDash(e,this.strokeDashArray),e.beginPath(),this._renderTextCommon(e,"strokeText"),e.closePath(),e.restore())},_renderChars:function(e,t,o,d,h,c){var f,p,y,b,C,T=this.getHeightOfLine(c),O=this.textAlign.indexOf("justify")!==-1,F="",B=0,H=this.path,U=!O&&this.charSpacing===0&&this.isEmptyStyles(c)&&!H,V=this.direction==="ltr",L=this.direction==="ltr"?1:-1,R=t.canvas.getAttribute("dir");if(t.save(),R!==this.direction&&(t.canvas.setAttribute("dir",V?"ltr":"rtl"),t.direction=V?"ltr":"rtl",t.textAlign=V?"left":"right"),h-=T*this._fontSizeFraction/this.lineHeight,U)return this._renderChar(e,t,c,0,o.join(""),d,h,T),void t.restore();for(var N=0,W=o.length-1;N<=W;N++)b=N===W||this.charSpacing||H,F+=o[N],y=this.__charBounds[c][N],B===0?(d+=L*(y.kernedWidth-y.width),B+=y.width):B+=y.kernedWidth,O&&!b&&this._reSpaceAndTab.test(o[N])&&(b=!0),b||(f=f||this.getCompleteStyleDeclaration(c,N),p=this.getCompleteStyleDeclaration(c,N+1),b=this._hasStyleChanged(f,p)),b&&(H?(t.save(),t.translate(y.renderLeft,y.renderTop),t.rotate(y.angle),this._renderChar(e,t,c,N,F,-B/2,0,T),t.restore()):(C=d,this._renderChar(e,t,c,N,F,C,h,T)),F="",f=p,d+=L*B,B=0);t.restore()},_applyPatternGradientTransformText:function(e){var t,o=i.util.createCanvasElement(),d=this.width+this.strokeWidth,h=this.height+this.strokeWidth;return o.width=d,o.height=h,(t=o.getContext("2d")).beginPath(),t.moveTo(0,0),t.lineTo(d,0),t.lineTo(d,h),t.lineTo(0,h),t.closePath(),t.translate(d/2,h/2),t.fillStyle=e.toLive(t),this._applyPatternGradientTransform(t,e),t.fill(),t.createPattern(o,"no-repeat")},handleFiller:function(e,t,o){var d,h;return o.toLive?o.gradientUnits==="percentage"||o.gradientTransform||o.patternTransform?(d=-this.width/2,h=-this.height/2,e.translate(d,h),e[t]=this._applyPatternGradientTransformText(o),{offsetX:d,offsetY:h}):(e[t]=o.toLive(e,this),this._applyPatternGradientTransform(e,o)):(e[t]=o,{offsetX:0,offsetY:0})},_setStrokeStyles:function(e,t){return e.lineWidth=t.strokeWidth,e.lineCap=this.strokeLineCap,e.lineDashOffset=this.strokeDashOffset,e.lineJoin=this.strokeLineJoin,e.miterLimit=this.strokeMiterLimit,this.handleFiller(e,"strokeStyle",t.stroke)},_setFillStyles:function(e,t){return this.handleFiller(e,"fillStyle",t.fill)},_renderChar:function(e,t,o,d,h,c,f){var p,y,b=this._getStyleDeclaration(o,d),C=this.getCompleteStyleDeclaration(o,d),T=e==="fillText"&&C.fill,O=e==="strokeText"&&C.stroke&&C.strokeWidth;(O||T)&&(t.save(),T&&(p=this._setFillStyles(t,C)),O&&(y=this._setStrokeStyles(t,C)),t.font=this._getFontDeclaration(C),b&&b.textBackgroundColor&&this._removeShadow(t),b&&b.deltaY&&(f+=b.deltaY),T&&t.fillText(h,c-p.offsetX,f-p.offsetY),O&&t.strokeText(h,c-y.offsetX,f-y.offsetY),t.restore())},setSuperscript:function(e,t){return this._setScript(e,t,this.superscript)},setSubscript:function(e,t){return this._setScript(e,t,this.subscript)},_setScript:function(e,t,o){var d=this.get2DCursorLocation(e,!0),h=this.getValueOfPropertyAt(d.lineIndex,d.charIndex,"fontSize"),c=this.getValueOfPropertyAt(d.lineIndex,d.charIndex,"deltaY"),f={fontSize:h*o.size,deltaY:c+h*o.baseline};return this.setSelectionStyles(f,e,t),this},_hasStyleChanged:function(e,t){return e.fill!==t.fill||e.stroke!==t.stroke||e.strokeWidth!==t.strokeWidth||e.fontSize!==t.fontSize||e.fontFamily!==t.fontFamily||e.fontWeight!==t.fontWeight||e.fontStyle!==t.fontStyle||e.deltaY!==t.deltaY},_hasStyleChangedForSvg:function(e,t){return this._hasStyleChanged(e,t)||e.overline!==t.overline||e.underline!==t.underline||e.linethrough!==t.linethrough},_getLineLeftOffset:function(e){var t=this.getLineWidth(e),o=this.width-t,d=this.textAlign,h=this.direction,c=0,f=this.isEndOfWrapping(e);return d==="justify"||d==="justify-center"&&!f||d==="justify-right"&&!f||d==="justify-left"&&!f?0:(d==="center"&&(c=o/2),d==="right"&&(c=o),d==="justify-center"&&(c=o/2),d==="justify-right"&&(c=o),h==="rtl"&&(c-=o),c)},_clearCache:function(){this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]},_shouldClearDimensionCache:function(){var e=this._forceClearCache;return e||(e=this.hasStateChanged("_dimensionAffectingProps")),e&&(this.dirty=!0,this._forceClearCache=!1),e},getLineWidth:function(e){if(this.__lineWidths[e]!==void 0)return this.__lineWidths[e];var t=this.measureLine(e).width;return this.__lineWidths[e]=t,t},_getWidthOfCharSpacing:function(){return this.charSpacing!==0?this.fontSize*this.charSpacing/1e3:0},getValueOfPropertyAt:function(e,t,o){var d=this._getStyleDeclaration(e,t);return d&&d[o]!==void 0?d[o]:this[o]},_renderTextDecoration:function(e,t){if(this[t]||this.styleHas(t)){for(var o,d,h,c,f,p,y,b,C,T,O,F,B,H,U,V,L=this._getLeftOffset(),R=this._getTopOffset(),N=this.path,W=this._getWidthOfCharSpacing(),Y=this.offsets[t],P=0,M=this._textLines.length;P<M;P++)if(o=this.getHeightOfLine(P),this[t]||this.styleHas(t,P)){y=this._textLines[P],H=o/this.lineHeight,c=this._getLineLeftOffset(P),T=0,O=0,b=this.getValueOfPropertyAt(P,0,t),V=this.getValueOfPropertyAt(P,0,"fill"),C=R+H*(1-this._fontSizeFraction),d=this.getHeightOfChar(P,0),f=this.getValueOfPropertyAt(P,0,"deltaY");for(var j=0,X=y.length;j<X;j++)if(F=this.__charBounds[P][j],B=this.getValueOfPropertyAt(P,j,t),U=this.getValueOfPropertyAt(P,j,"fill"),h=this.getHeightOfChar(P,j),p=this.getValueOfPropertyAt(P,j,"deltaY"),N&&B&&U)e.save(),e.fillStyle=V,e.translate(F.renderLeft,F.renderTop),e.rotate(F.angle),e.fillRect(-F.kernedWidth/2,Y*h+p,F.kernedWidth,this.fontSize/15),e.restore();else if((B!==b||U!==V||h!==d||p!==f)&&O>0){var G=L+c+T;this.direction==="rtl"&&(G=this.width-G-O),b&&V&&(e.fillStyle=V,e.fillRect(G,C+Y*d+f,O,this.fontSize/15)),T=F.left,O=F.width,b=B,V=U,d=h,f=p}else O+=F.kernedWidth;G=L+c+T,this.direction==="rtl"&&(G=this.width-G-O),e.fillStyle=U,B&&U&&e.fillRect(G,C+Y*d+f,O-W,this.fontSize/15),R+=o}else R+=o;this._removeShadow(e)}},_getFontDeclaration:function(e,t){var o=e||this,d=this.fontFamily,h=i.Text.genericFonts.indexOf(d.toLowerCase())>-1,c=d===void 0||d.indexOf("'")>-1||d.indexOf(",")>-1||d.indexOf('"')>-1||h?o.fontFamily:'"'+o.fontFamily+'"';return[i.isLikelyNode?o.fontWeight:o.fontStyle,i.isLikelyNode?o.fontStyle:o.fontWeight,t?this.CACHE_FONT_SIZE+"px":o.fontSize+"px",c].join(" ")},render:function(e){this.visible&&(this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._shouldClearDimensionCache()&&this.initDimensions(),this.callSuper("render",e)))},_splitTextIntoLines:function(e){for(var t=e.split(this._reNewline),o=new Array(t.length),d=[`
`],h=[],c=0;c<t.length;c++)o[c]=i.util.string.graphemeSplit(t[c]),h=h.concat(o[c],d);return h.pop(),{_unwrappedLines:o,lines:t,graphemeText:h,graphemeLines:o}},toObject:function(e){var t=l.concat(e),o=this.callSuper("toObject",t);return o.styles=s(this.styles,!0),o.path&&(o.path=this.path.toObject()),o},set:function(e,t){this.callSuper("set",e,t);var o=!1,d=!1;if(typeof e=="object")for(var h in e)h==="path"&&this.setPathInfo(),o=o||this._dimensionAffectingProps.indexOf(h)!==-1,d=d||h==="path";else o=this._dimensionAffectingProps.indexOf(e)!==-1,d=e==="path";return d&&this.setPathInfo(),o&&(this.initDimensions(),this.setCoords()),this},complexity:function(){return 1}}),i.Text.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("x y dx dy font-family font-style font-weight font-size letter-spacing text-decoration text-anchor".split(" ")),i.Text.DEFAULT_SVG_FONT_SIZE=16,i.Text.fromElement=function(e,t,o){if(!e)return t(null);var d=i.parseAttributes(e,i.Text.ATTRIBUTE_NAMES),h=d.textAnchor||"left";if((o=i.util.object.extend(o?s(o):{},d)).top=o.top||0,o.left=o.left||0,d.textDecoration){var c=d.textDecoration;c.indexOf("underline")!==-1&&(o.underline=!0),c.indexOf("overline")!==-1&&(o.overline=!0),c.indexOf("line-through")!==-1&&(o.linethrough=!0),delete o.textDecoration}"dx"in d&&(o.left+=d.dx),"dy"in d&&(o.top+=d.dy),"fontSize"in o||(o.fontSize=i.Text.DEFAULT_SVG_FONT_SIZE);var f="";"textContent"in e?f=e.textContent:"firstChild"in e&&e.firstChild!==null&&"data"in e.firstChild&&e.firstChild.data!==null&&(f=e.firstChild.data),f=f.replace(/^\s+|\s+$|\n+/g,"").replace(/\s+/g," ");var p=o.strokeWidth;o.strokeWidth=0;var y=new i.Text(f,o),b=y.getScaledHeight()/y.height,C=((y.height+y.strokeWidth)*y.lineHeight-y.height)*b,T=y.getScaledHeight()+C,O=0;h==="center"&&(O=y.getScaledWidth()/2),h==="right"&&(O=y.getScaledWidth()),y.set({left:y.left-O,top:y.top-(T-y.fontSize*(.07+y._fontSizeFraction))/y.lineHeight,strokeWidth:p!==void 0?p:1}),t(y)},i.Text.fromObject=function(e,t){var o=s(e),d=e.path;return delete o.path,i.Object._fromObject("Text",o,function(h){d?i.Object._fromObject("Path",d,function(c){h.set("path",c),t(h)},"path"):t(h)},"text")},i.Text.genericFonts=["sans-serif","serif","cursive","fantasy","monospace"],i.util.createAccessors&&i.util.createAccessors(i.Text)}}(r),g.util.object.extend(g.Text.prototype,{isEmptyStyles:function(n){if(!this.styles||n!==void 0&&!this.styles[n])return!0;var i=n===void 0?this.styles:{line:this.styles[n]};for(var s in i)for(var l in i[s])for(var e in i[s][l])return!1;return!0},styleHas:function(n,i){if(!this.styles||!n||n===""||i!==void 0&&!this.styles[i])return!1;var s=i===void 0?this.styles:{0:this.styles[i]};for(var l in s)for(var e in s[l])if(s[l][e][n]!==void 0)return!0;return!1},cleanStyle:function(n){if(!this.styles||!n||n==="")return!1;var i,s,l=this.styles,e=0,t=!0,o=0;for(var d in l){for(var h in i=0,l[d]){var c;e++,(c=l[d][h]).hasOwnProperty(n)?(s?c[n]!==s&&(t=!1):s=c[n],c[n]===this[n]&&delete c[n]):t=!1,Object.keys(c).length!==0?i++:delete l[d][h]}i===0&&delete l[d]}for(var f=0;f<this._textLines.length;f++)o+=this._textLines[f].length;t&&e===o&&(this[n]=s,this.removeStyle(n))},removeStyle:function(n){if(this.styles&&n&&n!==""){var i,s,l,e=this.styles;for(s in e){for(l in i=e[s])delete i[l][n],Object.keys(i[l]).length===0&&delete i[l];Object.keys(i).length===0&&delete e[s]}}},_extendStyles:function(n,i){var s=this.get2DCursorLocation(n);this._getLineStyle(s.lineIndex)||this._setLineStyle(s.lineIndex),this._getStyleDeclaration(s.lineIndex,s.charIndex)||this._setStyleDeclaration(s.lineIndex,s.charIndex,{}),g.util.object.extend(this._getStyleDeclaration(s.lineIndex,s.charIndex),i)},get2DCursorLocation:function(n,i){n===void 0&&(n=this.selectionStart);for(var s=i?this._unwrappedTextLines:this._textLines,l=s.length,e=0;e<l;e++){if(n<=s[e].length)return{lineIndex:e,charIndex:n};n-=s[e].length+this.missingNewlineOffset(e)}return{lineIndex:e-1,charIndex:s[e-1].length<n?s[e-1].length:n}},getSelectionStyles:function(n,i,s){n===void 0&&(n=this.selectionStart||0),i===void 0&&(i=this.selectionEnd||n);for(var l=[],e=n;e<i;e++)l.push(this.getStyleAtPosition(e,s));return l},getStyleAtPosition:function(n,i){var s=this.get2DCursorLocation(n);return(i?this.getCompleteStyleDeclaration(s.lineIndex,s.charIndex):this._getStyleDeclaration(s.lineIndex,s.charIndex))||{}},setSelectionStyles:function(n,i,s){i===void 0&&(i=this.selectionStart||0),s===void 0&&(s=this.selectionEnd||i);for(var l=i;l<s;l++)this._extendStyles(l,n);return this._forceClearCache=!0,this},_getStyleDeclaration:function(n,i){var s=this.styles&&this.styles[n];return s?s[i]:null},getCompleteStyleDeclaration:function(n,i){for(var s,l=this._getStyleDeclaration(n,i)||{},e={},t=0;t<this._styleProperties.length;t++)e[s=this._styleProperties[t]]=l[s]===void 0?this[s]:l[s];return e},_setStyleDeclaration:function(n,i,s){this.styles[n][i]=s},_deleteStyleDeclaration:function(n,i){delete this.styles[n][i]},_getLineStyle:function(n){return!!this.styles[n]},_setLineStyle:function(n){this.styles[n]={}},_deleteLineStyle:function(n){delete this.styles[n]}}),function(){function n(i){i.textDecoration&&(i.textDecoration.indexOf("underline")>-1&&(i.underline=!0),i.textDecoration.indexOf("line-through")>-1&&(i.linethrough=!0),i.textDecoration.indexOf("overline")>-1&&(i.overline=!0),delete i.textDecoration)}g.IText=g.util.createClass(g.Text,g.Observable,{type:"i-text",selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,hiddenTextareaContainer:null,_reSpace:/\s|\n/,_currentCursorOpacity:0,_selectionDirection:null,_abortCursorAnimation:!1,__widthOfSpace:[],inCompositionMode:!1,initialize:function(i,s){this.callSuper("initialize",i,s),this.initBehavior()},setSelectionStart:function(i){i=Math.max(i,0),this._updateAndFire("selectionStart",i)},setSelectionEnd:function(i){i=Math.min(i,this.text.length),this._updateAndFire("selectionEnd",i)},_updateAndFire:function(i,s){this[i]!==s&&(this._fireSelectionChanged(),this[i]=s),this._updateTextarea()},_fireSelectionChanged:function(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})},initDimensions:function(){this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this.callSuper("initDimensions")},render:function(i){this.clearContextTop(),this.callSuper("render",i),this.cursorOffsetCache={},this.renderCursorOrSelection()},_render:function(i){this.callSuper("_render",i)},clearContextTop:function(i){if(this.isEditing&&this.canvas&&this.canvas.contextTop){var s=this.canvas.contextTop,l=this.canvas.viewportTransform;s.save(),s.transform(l[0],l[1],l[2],l[3],l[4],l[5]),this.transform(s),this._clearTextArea(s),i||s.restore()}},renderCursorOrSelection:function(){if(this.isEditing&&this.canvas&&this.canvas.contextTop){var i=this._getCursorBoundaries(),s=this.canvas.contextTop;this.clearContextTop(!0),this.selectionStart===this.selectionEnd?this.renderCursor(i,s):this.renderSelection(i,s),s.restore()}},_clearTextArea:function(i){var s=this.width+4,l=this.height+4;i.clearRect(-s/2,-l/2,s,l)},_getCursorBoundaries:function(i){i===void 0&&(i=this.selectionStart);var s=this._getLeftOffset(),l=this._getTopOffset(),e=this._getCursorBoundariesOffsets(i);return{left:s,top:l,leftOffset:e.left,topOffset:e.top}},_getCursorBoundariesOffsets:function(i){if(this.cursorOffsetCache&&"top"in this.cursorOffsetCache)return this.cursorOffsetCache;var s,l,e,t,o=0,d=0,h=this.get2DCursorLocation(i);e=h.charIndex,l=h.lineIndex;for(var c=0;c<l;c++)o+=this.getHeightOfLine(c);s=this._getLineLeftOffset(l);var f=this.__charBounds[l][e];return f&&(d=f.left),this.charSpacing!==0&&e===this._textLines[l].length&&(d-=this._getWidthOfCharSpacing()),t={top:o,left:s+(d>0?d:0)},this.direction==="rtl"&&(t.left*=-1),this.cursorOffsetCache=t,this.cursorOffsetCache},renderCursor:function(i,s){var l=this.get2DCursorLocation(),e=l.lineIndex,t=l.charIndex>0?l.charIndex-1:0,o=this.getValueOfPropertyAt(e,t,"fontSize"),d=this.scaleX*this.canvas.getZoom(),h=this.cursorWidth/d,c=i.topOffset,f=this.getValueOfPropertyAt(e,t,"deltaY");c+=(1-this._fontSizeFraction)*this.getHeightOfLine(e)/this.lineHeight-o*(1-this._fontSizeFraction),this.inCompositionMode&&this.renderSelection(i,s),s.fillStyle=this.cursorColor||this.getValueOfPropertyAt(e,t,"fill"),s.globalAlpha=this.__isMousedown?1:this._currentCursorOpacity,s.fillRect(i.left+i.leftOffset-h/2,c+i.top+f,h,o)},renderSelection:function(i,s){for(var l=this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,e=this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd,t=this.textAlign.indexOf("justify")!==-1,o=this.get2DCursorLocation(l),d=this.get2DCursorLocation(e),h=o.lineIndex,c=d.lineIndex,f=o.charIndex<0?0:o.charIndex,p=d.charIndex<0?0:d.charIndex,y=h;y<=c;y++){var b,C=this._getLineLeftOffset(y)||0,T=this.getHeightOfLine(y),O=0,F=0;if(y===h&&(O=this.__charBounds[h][f].left),y>=h&&y<c)F=t&&!this.isEndOfWrapping(y)?this.width:this.getLineWidth(y)||5;else if(y===c)if(p===0)F=this.__charBounds[c][p].left;else{var B=this._getWidthOfCharSpacing();F=this.__charBounds[c][p-1].left+this.__charBounds[c][p-1].width-B}b=T,(this.lineHeight<1||y===c&&this.lineHeight>1)&&(T/=this.lineHeight);var H=i.left+C+O,U=F-O,V=T,L=0;this.inCompositionMode?(s.fillStyle=this.compositionColor||"black",V=1,L=T):s.fillStyle=this.selectionColor,this.direction==="rtl"&&(H=this.width-H-U),s.fillRect(H,i.top+i.topOffset+L,U,V),i.topOffset+=b}},getCurrentCharFontSize:function(){var i=this._getCurrentCharIndex();return this.getValueOfPropertyAt(i.l,i.c,"fontSize")},getCurrentCharColor:function(){var i=this._getCurrentCharIndex();return this.getValueOfPropertyAt(i.l,i.c,"fill")},_getCurrentCharIndex:function(){var i=this.get2DCursorLocation(this.selectionStart,!0),s=i.charIndex>0?i.charIndex-1:0;return{l:i.lineIndex,c:s}}}),g.IText.fromObject=function(i,s){if(n(i),i.styles)for(var l in i.styles)for(var e in i.styles[l])n(i.styles[l][e]);g.Object._fromObject("IText",i,s,"text")}}(),le=g.util.object.clone,g.util.object.extend(g.IText.prototype,{initBehavior:function(){this.initAddedHandler(),this.initRemovedHandler(),this.initCursorSelectionHandlers(),this.initDoubleClickSimulation(),this.mouseMoveHandler=this.mouseMoveHandler.bind(this)},onDeselect:function(){this.isEditing&&this.exitEditing(),this.selected=!1},initAddedHandler:function(){var n=this;this.on("added",function(){var i=n.canvas;i&&(i._hasITextHandlers||(i._hasITextHandlers=!0,n._initCanvasHandlers(i)),i._iTextInstances=i._iTextInstances||[],i._iTextInstances.push(n))})},initRemovedHandler:function(){var n=this;this.on("removed",function(){var i=n.canvas;i&&(i._iTextInstances=i._iTextInstances||[],g.util.removeFromArray(i._iTextInstances,n),i._iTextInstances.length===0&&(i._hasITextHandlers=!1,n._removeCanvasHandlers(i)))})},_initCanvasHandlers:function(n){n._mouseUpITextHandler=function(){n._iTextInstances&&n._iTextInstances.forEach(function(i){i.__isMousedown=!1})},n.on("mouse:up",n._mouseUpITextHandler)},_removeCanvasHandlers:function(n){n.off("mouse:up",n._mouseUpITextHandler)},_tick:function(){this._currentTickState=this._animateCursor(this,1,this.cursorDuration,"_onTickComplete")},_animateCursor:function(n,i,s,l){var e;return e={isAborted:!1,abort:function(){this.isAborted=!0}},n.animate("_currentCursorOpacity",i,{duration:s,onComplete:function(){e.isAborted||n[l]()},onChange:function(){n.canvas&&n.selectionStart===n.selectionEnd&&n.renderCursorOrSelection()},abort:function(){return e.isAborted}}),e},_onTickComplete:function(){var n=this;this._cursorTimeout1&&clearTimeout(this._cursorTimeout1),this._cursorTimeout1=setTimeout(function(){n._currentTickCompleteState=n._animateCursor(n,0,this.cursorDuration/2,"_tick")},100)},initDelayedCursor:function(n){var i=this,s=n?0:this.cursorDelay;this.abortCursorAnimation(),this._currentCursorOpacity=1,this._cursorTimeout2=setTimeout(function(){i._tick()},s)},abortCursorAnimation:function(){var n=this._currentTickState||this._currentTickCompleteState,i=this.canvas;this._currentTickState&&this._currentTickState.abort(),this._currentTickCompleteState&&this._currentTickCompleteState.abort(),clearTimeout(this._cursorTimeout1),clearTimeout(this._cursorTimeout2),this._currentCursorOpacity=0,n&&i&&i.clearContext(i.contextTop||i.contextContainer)},selectAll:function(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this},getSelectedText:function(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")},findWordBoundaryLeft:function(n){var i=0,s=n-1;if(this._reSpace.test(this._text[s]))for(;this._reSpace.test(this._text[s]);)i++,s--;for(;/\S/.test(this._text[s])&&s>-1;)i++,s--;return n-i},findWordBoundaryRight:function(n){var i=0,s=n;if(this._reSpace.test(this._text[s]))for(;this._reSpace.test(this._text[s]);)i++,s++;for(;/\S/.test(this._text[s])&&s<this._text.length;)i++,s++;return n+i},findLineBoundaryLeft:function(n){for(var i=0,s=n-1;!/\n/.test(this._text[s])&&s>-1;)i++,s--;return n-i},findLineBoundaryRight:function(n){for(var i=0,s=n;!/\n/.test(this._text[s])&&s<this._text.length;)i++,s++;return n+i},searchWordBoundary:function(n,i){for(var s=this._text,l=this._reSpace.test(s[n])?n-1:n,e=s[l],t=g.reNonWord;!t.test(e)&&l>0&&l<s.length;)e=s[l+=i];return t.test(e)&&(l+=i===1?0:1),l},selectWord:function(n){n=n||this.selectionStart;var i=this.searchWordBoundary(n,-1),s=this.searchWordBoundary(n,1);this.selectionStart=i,this.selectionEnd=s,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()},selectLine:function(n){n=n||this.selectionStart;var i=this.findLineBoundaryLeft(n),s=this.findLineBoundaryRight(n);return this.selectionStart=i,this.selectionEnd=s,this._fireSelectionChanged(),this._updateTextarea(),this},enterEditing:function(n){if(!this.isEditing&&this.editable)return this.canvas&&(this.canvas.calcOffset(),this.exitEditingOnOthers(this.canvas)),this.isEditing=!0,this.initHiddenTextarea(n),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick(),this.fire("editing:entered"),this._fireSelectionChanged(),this.canvas?(this.canvas.fire("text:editing:entered",{target:this}),this.initMouseMoveHandler(),this.canvas.requestRenderAll(),this):this},exitEditingOnOthers:function(n){n._iTextInstances&&n._iTextInstances.forEach(function(i){i.selected=!1,i.isEditing&&i.exitEditing()})},initMouseMoveHandler:function(){this.canvas.on("mouse:move",this.mouseMoveHandler)},mouseMoveHandler:function(n){if(this.__isMousedown&&this.isEditing){var i=this.getSelectionStartFromPointer(n.e),s=this.selectionStart,l=this.selectionEnd;(i===this.__selectionStartOnMouseDown&&s!==l||s!==i&&l!==i)&&(i>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=i):(this.selectionStart=i,this.selectionEnd=this.__selectionStartOnMouseDown),this.selectionStart===s&&this.selectionEnd===l||(this.restartCursorIfNeeded(),this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()))}},_setEditingProps:function(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0},fromStringToGraphemeSelection:function(n,i,s){var l=s.slice(0,n),e=g.util.string.graphemeSplit(l).length;if(n===i)return{selectionStart:e,selectionEnd:e};var t=s.slice(n,i);return{selectionStart:e,selectionEnd:e+g.util.string.graphemeSplit(t).length}},fromGraphemeToStringSelection:function(n,i,s){var l=s.slice(0,n).join("").length;return n===i?{selectionStart:l,selectionEnd:l}:{selectionStart:l,selectionEnd:l+s.slice(n,i).join("").length}},_updateTextarea:function(){if(this.cursorOffsetCache={},this.hiddenTextarea){if(!this.inCompositionMode){var n=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=n.selectionStart,this.hiddenTextarea.selectionEnd=n.selectionEnd}this.updateTextareaPosition()}},updateFromTextArea:function(){if(this.hiddenTextarea){this.cursorOffsetCache={},this.text=this.hiddenTextarea.value,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords());var n=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value);this.selectionEnd=this.selectionStart=n.selectionEnd,this.inCompositionMode||(this.selectionStart=n.selectionStart),this.updateTextareaPosition()}},updateTextareaPosition:function(){if(this.selectionStart===this.selectionEnd){var n=this._calcTextareaPosition();this.hiddenTextarea.style.left=n.left,this.hiddenTextarea.style.top=n.top}},_calcTextareaPosition:function(){if(!this.canvas)return{x:1,y:1};var n=this.inCompositionMode?this.compositionStart:this.selectionStart,i=this._getCursorBoundaries(n),s=this.get2DCursorLocation(n),l=s.lineIndex,e=s.charIndex,t=this.getValueOfPropertyAt(l,e,"fontSize")*this.lineHeight,o=i.leftOffset,d=this.calcTransformMatrix(),h={x:i.left+o,y:i.top+i.topOffset+t},c=this.canvas.getRetinaScaling(),f=this.canvas.upperCanvasEl,p=f.width/c,y=f.height/c,b=p-t,C=y-t,T=f.clientWidth/p,O=f.clientHeight/y;return h=g.util.transformPoint(h,d),(h=g.util.transformPoint(h,this.canvas.viewportTransform)).x*=T,h.y*=O,h.x<0&&(h.x=0),h.x>b&&(h.x=b),h.y<0&&(h.y=0),h.y>C&&(h.y=C),h.x+=this.canvas._offset.left,h.y+=this.canvas._offset.top,{left:h.x+"px",top:h.y+"px",fontSize:t+"px",charHeight:t}},_saveEditingProps:function(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}},_restoreEditingProps:function(){this._savedProps&&(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor))},exitEditing:function(){var n=this._textBeforeEdit!==this.text,i=this.hiddenTextarea;return this.selected=!1,this.isEditing=!1,this.selectionEnd=this.selectionStart,i&&(i.blur&&i.blur(),i.parentNode&&i.parentNode.removeChild(i)),this.hiddenTextarea=null,this.abortCursorAnimation(),this._restoreEditingProps(),this._currentCursorOpacity=0,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this.fire("editing:exited"),n&&this.fire("modified"),this.canvas&&(this.canvas.off("mouse:move",this.mouseMoveHandler),this.canvas.fire("text:editing:exited",{target:this}),n&&this.canvas.fire("object:modified",{target:this})),this},_removeExtraneousStyles:function(){for(var n in this.styles)this._textLines[n]||delete this.styles[n]},removeStyleFromTo:function(n,i){var s,l,e=this.get2DCursorLocation(n,!0),t=this.get2DCursorLocation(i,!0),o=e.lineIndex,d=e.charIndex,h=t.lineIndex,c=t.charIndex;if(o!==h){if(this.styles[o])for(s=d;s<this._unwrappedTextLines[o].length;s++)delete this.styles[o][s];if(this.styles[h])for(s=c;s<this._unwrappedTextLines[h].length;s++)(l=this.styles[h][s])&&(this.styles[o]||(this.styles[o]={}),this.styles[o][d+s-c]=l);for(s=o+1;s<=h;s++)delete this.styles[s];this.shiftLineStyles(h,o-h)}else if(this.styles[o]){l=this.styles[o];var f,p,y=c-d;for(s=d;s<c;s++)delete l[s];for(p in this.styles[o])(f=parseInt(p,10))>=c&&(l[f-y]=l[p],delete l[p])}},shiftLineStyles:function(n,i){var s=le(this.styles);for(var l in this.styles){var e=parseInt(l,10);e>n&&(this.styles[e+i]=s[e],s[e-i]||delete this.styles[e])}},restartCursorIfNeeded:function(){this._currentTickState&&!this._currentTickState.isAborted&&this._currentTickCompleteState&&!this._currentTickCompleteState.isAborted||this.initDelayedCursor()},insertNewlineStyleObject:function(n,i,s,l){var e,t={},o=!1,d=this._unwrappedTextLines[n].length===i;for(var h in s||(s=1),this.shiftLineStyles(n,s),this.styles[n]&&(e=this.styles[n][i===0?i:i-1]),this.styles[n]){var c=parseInt(h,10);c>=i&&(o=!0,t[c-i]=this.styles[n][h],d&&i===0||delete this.styles[n][h])}var f=!1;for(o&&!d&&(this.styles[n+s]=t,f=!0),f&&s--;s>0;)l&&l[s-1]?this.styles[n+s]={0:le(l[s-1])}:e?this.styles[n+s]={0:le(e)}:delete this.styles[n+s],s--;this._forceClearCache=!0},insertCharStyleObject:function(n,i,s,l){this.styles||(this.styles={});var e=this.styles[n],t=e?le(e):{};for(var o in s||(s=1),t){var d=parseInt(o,10);d>=i&&(e[d+s]=t[d],t[d-s]||delete e[d])}if(this._forceClearCache=!0,l)for(;s--;)Object.keys(l[s]).length&&(this.styles[n]||(this.styles[n]={}),this.styles[n][i+s]=le(l[s]));else if(e)for(var h=e[i?i-1:1];h&&s--;)this.styles[n][i+s]=le(h)},insertNewStyleBlock:function(n,i,s){for(var l=this.get2DCursorLocation(i,!0),e=[0],t=0,o=0;o<n.length;o++)n[o]===`
`?e[++t]=0:e[t]++;for(e[0]>0&&(this.insertCharStyleObject(l.lineIndex,l.charIndex,e[0],s),s=s&&s.slice(e[0]+1)),t&&this.insertNewlineStyleObject(l.lineIndex,l.charIndex+e[0],t),o=1;o<t;o++)e[o]>0?this.insertCharStyleObject(l.lineIndex+o,0,e[o],s):s&&this.styles[l.lineIndex+o]&&s[0]&&(this.styles[l.lineIndex+o][0]=s[0]),s=s&&s.slice(e[o]+1);e[o]>0&&this.insertCharStyleObject(l.lineIndex+o,0,e[o],s)},setSelectionStartEndWithShift:function(n,i,s){s<=n?(i===n?this._selectionDirection="left":this._selectionDirection==="right"&&(this._selectionDirection="left",this.selectionEnd=n),this.selectionStart=s):s>n&&s<i?this._selectionDirection==="right"?this.selectionEnd=s:this.selectionStart=s:(i===n?this._selectionDirection="right":this._selectionDirection==="left"&&(this._selectionDirection="right",this.selectionStart=i),this.selectionEnd=s)},setSelectionInBoundaries:function(){var n=this.text.length;this.selectionStart>n?this.selectionStart=n:this.selectionStart<0&&(this.selectionStart=0),this.selectionEnd>n?this.selectionEnd=n:this.selectionEnd<0&&(this.selectionEnd=0)}}),g.util.object.extend(g.IText.prototype,{initDoubleClickSimulation:function(){this.__lastClickTime=+new Date,this.__lastLastClickTime=+new Date,this.__lastPointer={},this.on("mousedown",this.onMouseDown)},onMouseDown:function(n){if(this.canvas){this.__newClickTime=+new Date;var i=n.pointer;this.isTripleClick(i)&&(this.fire("tripleclick",n),this._stopEvent(n.e)),this.__lastLastClickTime=this.__lastClickTime,this.__lastClickTime=this.__newClickTime,this.__lastPointer=i,this.__lastIsEditing=this.isEditing,this.__lastSelected=this.selected}},isTripleClick:function(n){return this.__newClickTime-this.__lastClickTime<500&&this.__lastClickTime-this.__lastLastClickTime<500&&this.__lastPointer.x===n.x&&this.__lastPointer.y===n.y},_stopEvent:function(n){n.preventDefault&&n.preventDefault(),n.stopPropagation&&n.stopPropagation()},initCursorSelectionHandlers:function(){this.initMousedownHandler(),this.initMouseupHandler(),this.initClicks()},doubleClickHandler:function(n){this.isEditing&&this.selectWord(this.getSelectionStartFromPointer(n.e))},tripleClickHandler:function(n){this.isEditing&&this.selectLine(this.getSelectionStartFromPointer(n.e))},initClicks:function(){this.on("mousedblclick",this.doubleClickHandler),this.on("tripleclick",this.tripleClickHandler)},_mouseDownHandler:function(n){!this.canvas||!this.editable||n.e.button&&n.e.button!==1||(this.__isMousedown=!0,this.selected&&(this.inCompositionMode=!1,this.setCursorByClick(n.e)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()))},_mouseDownHandlerBefore:function(n){!this.canvas||!this.editable||n.e.button&&n.e.button!==1||(this.selected=this===this.canvas._activeObject)},initMousedownHandler:function(){this.on("mousedown",this._mouseDownHandler),this.on("mousedown:before",this._mouseDownHandlerBefore)},initMouseupHandler:function(){this.on("mouseup",this.mouseUpHandler)},mouseUpHandler:function(n){if(this.__isMousedown=!1,!(!this.editable||this.group||n.transform&&n.transform.actionPerformed||n.e.button&&n.e.button!==1)){if(this.canvas){var i=this.canvas._activeObject;if(i&&i!==this)return}this.__lastSelected&&!this.__corner?(this.selected=!1,this.__lastSelected=!1,this.enterEditing(n.e),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection()):this.selected=!0}},setCursorByClick:function(n){var i=this.getSelectionStartFromPointer(n),s=this.selectionStart,l=this.selectionEnd;n.shiftKey?this.setSelectionStartEndWithShift(s,l,i):(this.selectionStart=i,this.selectionEnd=i),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())},getSelectionStartFromPointer:function(n){for(var i,s=this.getLocalPointer(n),l=0,e=0,t=0,o=0,d=0,h=0,c=this._textLines.length;h<c&&t<=s.y;h++)t+=this.getHeightOfLine(h)*this.scaleY,d=h,h>0&&(o+=this._textLines[h-1].length+this.missingNewlineOffset(h-1));e=this._getLineLeftOffset(d)*this.scaleX,i=this._textLines[d],this.direction==="rtl"&&(s.x=this.width*this.scaleX-s.x+e);for(var f=0,p=i.length;f<p&&(l=e,(e+=this.__charBounds[d][f].kernedWidth*this.scaleX)<=s.x);f++)o++;return this._getNewSelectionStartFromOffset(s,l,e,o,p)},_getNewSelectionStartFromOffset:function(n,i,s,l,e){var t=n.x-i,o=s-n.x,d=l+(o>t||o<0?0:1);return this.flipX&&(d=e-d),d>this._text.length&&(d=this._text.length),d}}),g.util.object.extend(g.IText.prototype,{initHiddenTextarea:function(){this.hiddenTextarea=g.document.createElement("textarea"),this.hiddenTextarea.setAttribute("autocapitalize","off"),this.hiddenTextarea.setAttribute("autocorrect","off"),this.hiddenTextarea.setAttribute("autocomplete","off"),this.hiddenTextarea.setAttribute("spellcheck","false"),this.hiddenTextarea.setAttribute("data-fabric-hiddentextarea",""),this.hiddenTextarea.setAttribute("wrap","off");var n=this._calcTextareaPosition();this.hiddenTextarea.style.cssText="position: absolute; top: "+n.top+"; left: "+n.left+"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; padding\uFF70top: "+n.fontSize+";",this.hiddenTextareaContainer?this.hiddenTextareaContainer.appendChild(this.hiddenTextarea):g.document.body.appendChild(this.hiddenTextarea),g.util.addListener(this.hiddenTextarea,"keydown",this.onKeyDown.bind(this)),g.util.addListener(this.hiddenTextarea,"keyup",this.onKeyUp.bind(this)),g.util.addListener(this.hiddenTextarea,"input",this.onInput.bind(this)),g.util.addListener(this.hiddenTextarea,"copy",this.copy.bind(this)),g.util.addListener(this.hiddenTextarea,"cut",this.copy.bind(this)),g.util.addListener(this.hiddenTextarea,"paste",this.paste.bind(this)),g.util.addListener(this.hiddenTextarea,"compositionstart",this.onCompositionStart.bind(this)),g.util.addListener(this.hiddenTextarea,"compositionupdate",this.onCompositionUpdate.bind(this)),g.util.addListener(this.hiddenTextarea,"compositionend",this.onCompositionEnd.bind(this)),!this._clickHandlerInitialized&&this.canvas&&(g.util.addListener(this.canvas.upperCanvasEl,"click",this.onClick.bind(this)),this._clickHandlerInitialized=!0)},keysMap:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorRight",36:"moveCursorLeft",37:"moveCursorLeft",38:"moveCursorUp",39:"moveCursorRight",40:"moveCursorDown"},keysMapRtl:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorLeft",36:"moveCursorRight",37:"moveCursorRight",38:"moveCursorUp",39:"moveCursorLeft",40:"moveCursorDown"},ctrlKeysMapUp:{67:"copy",88:"cut"},ctrlKeysMapDown:{65:"selectAll"},onClick:function(){this.hiddenTextarea&&this.hiddenTextarea.focus()},onKeyDown:function(n){if(this.isEditing){var i=this.direction==="rtl"?this.keysMapRtl:this.keysMap;if(n.keyCode in i)this[i[n.keyCode]](n);else{if(!(n.keyCode in this.ctrlKeysMapDown)||!n.ctrlKey&&!n.metaKey)return;this[this.ctrlKeysMapDown[n.keyCode]](n)}n.stopImmediatePropagation(),n.preventDefault(),n.keyCode>=33&&n.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}},onKeyUp:function(n){!this.isEditing||this._copyDone||this.inCompositionMode?this._copyDone=!1:n.keyCode in this.ctrlKeysMapUp&&(n.ctrlKey||n.metaKey)&&(this[this.ctrlKeysMapUp[n.keyCode]](n),n.stopImmediatePropagation(),n.preventDefault(),this.canvas&&this.canvas.requestRenderAll())},onInput:function(n){var i=this.fromPaste;if(this.fromPaste=!1,n&&n.stopPropagation(),this.isEditing){var s,l,e,t,o,d=this._splitTextIntoLines(this.hiddenTextarea.value).graphemeText,h=this._text.length,c=d.length,f=c-h,p=this.selectionStart,y=this.selectionEnd,b=p!==y;if(this.hiddenTextarea.value==="")return this.styles={},this.updateFromTextArea(),this.fire("changed"),void(this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll()));var C=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value),T=p>C.selectionStart;b?(s=this._text.slice(p,y),f+=y-p):c<h&&(s=T?this._text.slice(y+f,y):this._text.slice(p,p-f)),l=d.slice(C.selectionEnd-f,C.selectionEnd),s&&s.length&&(l.length&&(e=this.getSelectionStyles(p,p+1,!1),e=l.map(function(){return e[0]})),b?(t=p,o=y):T?(t=y-s.length,o=y):(t=y,o=y+s.length),this.removeStyleFromTo(t,o)),l.length&&(i&&l.join("")===g.copiedText&&!g.disableStyleCopyPaste&&(e=g.copiedTextStyle),this.insertNewStyleBlock(l,p,e)),this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())}},onCompositionStart:function(){this.inCompositionMode=!0},onCompositionEnd:function(){this.inCompositionMode=!1},onCompositionUpdate:function(n){this.compositionStart=n.target.selectionStart,this.compositionEnd=n.target.selectionEnd,this.updateTextareaPosition()},copy:function(){this.selectionStart!==this.selectionEnd&&(g.copiedText=this.getSelectedText(),g.disableStyleCopyPaste?g.copiedTextStyle=null:g.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0)},paste:function(){this.fromPaste=!0},_getClipboardData:function(n){return n&&n.clipboardData||g.window.clipboardData},_getWidthBeforeCursor:function(n,i){var s,l=this._getLineLeftOffset(n);return i>0&&(l+=(s=this.__charBounds[n][i-1]).left+s.width),l},getDownCursorOffset:function(n,i){var s=this._getSelectionForOffset(n,i),l=this.get2DCursorLocation(s),e=l.lineIndex;if(e===this._textLines.length-1||n.metaKey||n.keyCode===34)return this._text.length-s;var t=l.charIndex,o=this._getWidthBeforeCursor(e,t),d=this._getIndexOnLine(e+1,o);return this._textLines[e].slice(t).length+d+1+this.missingNewlineOffset(e)},_getSelectionForOffset:function(n,i){return n.shiftKey&&this.selectionStart!==this.selectionEnd&&i?this.selectionEnd:this.selectionStart},getUpCursorOffset:function(n,i){var s=this._getSelectionForOffset(n,i),l=this.get2DCursorLocation(s),e=l.lineIndex;if(e===0||n.metaKey||n.keyCode===33)return-s;var t=l.charIndex,o=this._getWidthBeforeCursor(e,t),d=this._getIndexOnLine(e-1,o),h=this._textLines[e].slice(0,t),c=this.missingNewlineOffset(e-1);return-this._textLines[e-1].length+d-h.length+(1-c)},_getIndexOnLine:function(n,i){for(var s,l,e=this._textLines[n],t=this._getLineLeftOffset(n),o=0,d=0,h=e.length;d<h;d++)if((t+=s=this.__charBounds[n][d].width)>i){l=!0;var c=t-s,f=t,p=Math.abs(c-i);o=Math.abs(f-i)<p?d:d-1;break}return l||(o=e.length-1),o},moveCursorDown:function(n){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",n)},moveCursorUp:function(n){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorUpOrDown("Up",n)},_moveCursorUpOrDown:function(n,i){var s=this["get"+n+"CursorOffset"](i,this._selectionDirection==="right");i.shiftKey?this.moveCursorWithShift(s):this.moveCursorWithoutShift(s),s!==0&&(this.setSelectionInBoundaries(),this.abortCursorAnimation(),this._currentCursorOpacity=1,this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorWithShift:function(n){var i=this._selectionDirection==="left"?this.selectionStart+n:this.selectionEnd+n;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,i),n!==0},moveCursorWithoutShift:function(n){return n<0?(this.selectionStart+=n,this.selectionEnd=this.selectionStart):(this.selectionEnd+=n,this.selectionStart=this.selectionEnd),n!==0},moveCursorLeft:function(n){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorLeftOrRight("Left",n)},_move:function(n,i,s){var l;if(n.altKey)l=this["findWordBoundary"+s](this[i]);else{if(!n.metaKey&&n.keyCode!==35&&n.keyCode!==36)return this[i]+=s==="Left"?-1:1,!0;l=this["findLineBoundary"+s](this[i])}if(typeof l!==void 0&&this[i]!==l)return this[i]=l,!0},_moveLeft:function(n,i){return this._move(n,i,"Left")},_moveRight:function(n,i){return this._move(n,i,"Right")},moveCursorLeftWithoutShift:function(n){var i=!0;return this._selectionDirection="left",this.selectionEnd===this.selectionStart&&this.selectionStart!==0&&(i=this._moveLeft(n,"selectionStart")),this.selectionEnd=this.selectionStart,i},moveCursorLeftWithShift:function(n){return this._selectionDirection==="right"&&this.selectionStart!==this.selectionEnd?this._moveLeft(n,"selectionEnd"):this.selectionStart!==0?(this._selectionDirection="left",this._moveLeft(n,"selectionStart")):void 0},moveCursorRight:function(n){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",n)},_moveCursorLeftOrRight:function(n,i){var s="moveCursor"+n+"With";this._currentCursorOpacity=1,i.shiftKey?s+="Shift":s+="outShift",this[s](i)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorRightWithShift:function(n){return this._selectionDirection==="left"&&this.selectionStart!==this.selectionEnd?this._moveRight(n,"selectionStart"):this.selectionEnd!==this._text.length?(this._selectionDirection="right",this._moveRight(n,"selectionEnd")):void 0},moveCursorRightWithoutShift:function(n){var i=!0;return this._selectionDirection="right",this.selectionStart===this.selectionEnd?(i=this._moveRight(n,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,i},removeChars:function(n,i){i===void 0&&(i=n+1),this.removeStyleFromTo(n,i),this._text.splice(n,i-n),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()},insertChars:function(n,i,s,l){l===void 0&&(l=s),l>s&&this.removeStyleFromTo(s,l);var e=g.util.string.graphemeSplit(n);this.insertNewStyleBlock(e,s,i),this._text=[].concat(this._text.slice(0,s),e,this._text.slice(l)),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()}}),function(){var n=g.util.toFixed,i=/  +/g;g.util.object.extend(g.Text.prototype,{_toSVG:function(){var s=this._getSVGLeftTopOffsets(),l=this._getSVGTextAndBg(s.textTop,s.textLeft);return this._wrapSVGTextAndBg(l)},toSVG:function(s){return this._createBaseSVGMarkup(this._toSVG(),{reviver:s,noStyle:!0,withShadow:!0})},_getSVGLeftTopOffsets:function(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}},_wrapSVGTextAndBg:function(s){var l=this.getSvgTextDecoration(this);return[s.textBgRects.join(""),'		<text xml:space="preserve" ',this.fontFamily?'font-family="'+this.fontFamily.replace(/"/g,"'")+'" ':"",this.fontSize?'font-size="'+this.fontSize+'" ':"",this.fontStyle?'font-style="'+this.fontStyle+'" ':"",this.fontWeight?'font-weight="'+this.fontWeight+'" ':"",l?'text-decoration="'+l+'" ':"",'style="',this.getSvgStyles(!0),'"',this.addPaintOrder()," >",s.textSpans.join(""),`</text>
`]},_getSVGTextAndBg:function(s,l){var e,t=[],o=[],d=s;this._setSVGBg(o);for(var h=0,c=this._textLines.length;h<c;h++)e=this._getLineLeftOffset(h),(this.textBackgroundColor||this.styleHas("textBackgroundColor",h))&&this._setSVGTextLineBg(o,h,l+e,d),this._setSVGTextLineText(t,h,l+e,d),d+=this.getHeightOfLine(h);return{textSpans:t,textBgRects:o}},_createTextCharSpan:function(s,l,e,t){var o=s!==s.trim()||s.match(i),d=this.getSvgSpanStyles(l,o),h=d?'style="'+d+'"':"",c=l.deltaY,f="",p=g.Object.NUM_FRACTION_DIGITS;return c&&(f=' dy="'+n(c,p)+'" '),['<tspan x="',n(e,p),'" y="',n(t,p),'" ',f,h,">",g.util.string.escapeXml(s),"</tspan>"].join("")},_setSVGTextLineText:function(s,l,e,t){var o,d,h,c,f,p=this.getHeightOfLine(l),y=this.textAlign.indexOf("justify")!==-1,b="",C=0,T=this._textLines[l];t+=p*(1-this._fontSizeFraction)/this.lineHeight;for(var O=0,F=T.length-1;O<=F;O++)f=O===F||this.charSpacing,b+=T[O],h=this.__charBounds[l][O],C===0?(e+=h.kernedWidth-h.width,C+=h.width):C+=h.kernedWidth,y&&!f&&this._reSpaceAndTab.test(T[O])&&(f=!0),f||(o=o||this.getCompleteStyleDeclaration(l,O),d=this.getCompleteStyleDeclaration(l,O+1),f=this._hasStyleChangedForSvg(o,d)),f&&(c=this._getStyleDeclaration(l,O)||{},s.push(this._createTextCharSpan(b,c,e,t)),b="",o=d,e+=C,C=0)},_pushTextBgRect:function(s,l,e,t,o,d){var h=g.Object.NUM_FRACTION_DIGITS;s.push("		<rect ",this._getFillAttributes(l),' x="',n(e,h),'" y="',n(t,h),'" width="',n(o,h),'" height="',n(d,h),`"></rect>
`)},_setSVGTextLineBg:function(s,l,e,t){for(var o,d,h=this._textLines[l],c=this.getHeightOfLine(l)/this.lineHeight,f=0,p=0,y=this.getValueOfPropertyAt(l,0,"textBackgroundColor"),b=0,C=h.length;b<C;b++)o=this.__charBounds[l][b],(d=this.getValueOfPropertyAt(l,b,"textBackgroundColor"))!==y?(y&&this._pushTextBgRect(s,y,e+p,t,f,c),p=o.left,f=o.width,y=d):f+=o.kernedWidth;d&&this._pushTextBgRect(s,d,e+p,t,f,c)},_getFillAttributes:function(s){var l=s&&typeof s=="string"?new g.Color(s):"";return l&&l.getSource()&&l.getAlpha()!==1?'opacity="'+l.getAlpha()+'" fill="'+l.setAlpha(1).toRgb()+'"':'fill="'+s+'"'},_getSVGLineTopOffset:function(s){for(var l,e=0,t=0;t<s;t++)e+=this.getHeightOfLine(t);return l=this.getHeightOfLine(t),{lineTop:e,offset:(this._fontSizeMult-this._fontSizeFraction)*l/(this.lineHeight*this._fontSizeMult)}},getSvgStyles:function(s){return g.Object.prototype.getSvgStyles.call(this,s)+" white-space: pre;"}})}(),function(n){var i=n.fabric||(n.fabric={});i.Textbox=i.util.createClass(i.IText,i.Observable,{type:"textbox",minWidth:20,dynamicMinWidth:2,__cachedLines:null,lockScalingFlip:!0,noScaleCache:!1,_dimensionAffectingProps:i.Text.prototype._dimensionAffectingProps.concat("width"),_wordJoiners:/[ \t\r]/,splitByGrapheme:!1,initDimensions:function(){this.__skipDimension||(this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}))},_generateStyleMap:function(s){for(var l=0,e=0,t=0,o={},d=0;d<s.graphemeLines.length;d++)s.graphemeText[t]===`
`&&d>0?(e=0,t++,l++):!this.splitByGrapheme&&this._reSpaceAndTab.test(s.graphemeText[t])&&d>0&&(e++,t++),o[d]={line:l,offset:e},t+=s.graphemeLines[d].length,e+=s.graphemeLines[d].length;return o},styleHas:function(s,l){if(this._styleMap&&!this.isWrapping){var e=this._styleMap[l];e&&(l=e.line)}return i.Text.prototype.styleHas.call(this,s,l)},isEmptyStyles:function(s){if(!this.styles)return!0;var l,e,t=0,o=!1,d=this._styleMap[s],h=this._styleMap[s+1];for(var c in d&&(s=d.line,t=d.offset),h&&(o=h.line===s,l=h.offset),e=s===void 0?this.styles:{line:this.styles[s]})for(var f in e[c])if(f>=t&&(!o||f<l))for(var p in e[c][f])return!1;return!0},_getStyleDeclaration:function(s,l){if(this._styleMap&&!this.isWrapping){var e=this._styleMap[s];if(!e)return null;s=e.line,l=e.offset+l}return this.callSuper("_getStyleDeclaration",s,l)},_setStyleDeclaration:function(s,l,e){var t=this._styleMap[s];s=t.line,l=t.offset+l,this.styles[s][l]=e},_deleteStyleDeclaration:function(s,l){var e=this._styleMap[s];s=e.line,l=e.offset+l,delete this.styles[s][l]},_getLineStyle:function(s){var l=this._styleMap[s];return!!this.styles[l.line]},_setLineStyle:function(s){var l=this._styleMap[s];this.styles[l.line]={}},_wrapText:function(s,l){var e,t=[];for(this.isWrapping=!0,e=0;e<s.length;e++)t=t.concat(this._wrapLine(s[e],e,l));return this.isWrapping=!1,t},_measureWord:function(s,l,e){var t,o=0;e=e||0;for(var d=0,h=s.length;d<h;d++)o+=this._getGraphemeBox(s[d],l,d+e,t,!0).kernedWidth,t=s[d];return o},_wrapLine:function(s,l,e,t){var o=0,d=this.splitByGrapheme,h=[],c=[],f=d?i.util.string.graphemeSplit(s):s.split(this._wordJoiners),p="",y=0,b=d?"":" ",C=0,T=0,O=0,F=!0,B=this._getWidthOfCharSpacing();t=t||0,f.length===0&&f.push([]),e-=t;for(var H=0;H<f.length;H++)p=d?f[H]:i.util.string.graphemeSplit(f[H]),C=this._measureWord(p,l,y),y+=p.length,(o+=T+C-B)>e&&!F?(h.push(c),c=[],o=C,F=!0):o+=B,F||d||c.push(b),c=c.concat(p),T=d?0:this._measureWord([b],l,y),y++,F=!1,C>O&&(O=C);return H&&h.push(c),O+t>this.dynamicMinWidth&&(this.dynamicMinWidth=O-B+t),h},isEndOfWrapping:function(s){return!this._styleMap[s+1]||this._styleMap[s+1].line!==this._styleMap[s].line},missingNewlineOffset:function(s){return this.splitByGrapheme?this.isEndOfWrapping(s)?1:0:1},_splitTextIntoLines:function(s){for(var l=i.Text.prototype._splitTextIntoLines.call(this,s),e=this._wrapText(l.lines,this.width),t=new Array(e.length),o=0;o<e.length;o++)t[o]=e[o].join("");return l.lines=t,l.graphemeLines=e,l},getMinWidth:function(){return Math.max(this.minWidth,this.dynamicMinWidth)},_removeExtraneousStyles:function(){var s={};for(var l in this._styleMap)this._textLines[l]&&(s[this._styleMap[l].line]=1);for(var l in this.styles)s[l]||delete this.styles[l]},toObject:function(s){return this.callSuper("toObject",["minWidth","splitByGrapheme"].concat(s))}}),i.Textbox.fromObject=function(s,l){return i.Object._fromObject("Textbox",s,l,"text")}}(r),function(){var n=g.controlsUtils,i=n.scaleSkewCursorStyleHandler,s=n.scaleCursorStyleHandler,l=n.scalingEqually,e=n.scalingYOrSkewingX,t=n.scalingXOrSkewingY,o=n.scaleOrSkewActionName,d=g.Object.prototype.controls;if(d.ml=new g.Control({x:-.5,y:0,cursorStyleHandler:i,actionHandler:t,getActionName:o}),d.mr=new g.Control({x:.5,y:0,cursorStyleHandler:i,actionHandler:t,getActionName:o}),d.mb=new g.Control({x:0,y:.5,cursorStyleHandler:i,actionHandler:e,getActionName:o}),d.mt=new g.Control({x:0,y:-.5,cursorStyleHandler:i,actionHandler:e,getActionName:o}),d.tl=new g.Control({x:-.5,y:-.5,cursorStyleHandler:s,actionHandler:l}),d.tr=new g.Control({x:.5,y:-.5,cursorStyleHandler:s,actionHandler:l}),d.bl=new g.Control({x:-.5,y:.5,cursorStyleHandler:s,actionHandler:l}),d.br=new g.Control({x:.5,y:.5,cursorStyleHandler:s,actionHandler:l}),d.mtr=new g.Control({x:0,y:-.5,actionHandler:n.rotationWithSnapping,cursorStyleHandler:n.rotationStyleHandler,offsetY:-40,withConnection:!0,actionName:"rotate"}),g.Textbox){var h=g.Textbox.prototype.controls={};h.mtr=d.mtr,h.tr=d.tr,h.br=d.br,h.tl=d.tl,h.bl=d.bl,h.mt=d.mt,h.mb=d.mb,h.mr=new g.Control({x:.5,y:0,actionHandler:n.changeWidth,cursorStyleHandler:i,actionName:"resizing"}),h.ml=new g.Control({x:-.5,y:0,actionHandler:n.changeWidth,cursorStyleHandler:i,actionName:"resizing"})}}()},192:()=>{},898:()=>{},245:()=>{}},gt={};function Pe(a){var r=gt[a];if(r!==void 0)return r.exports;var u=gt[a]={exports:{}};return gi[a](u,u.exports,Pe),u.exports}Pe.d=(a,r)=>{for(var u in r)Pe.o(r,u)&&!Pe.o(a,u)&&Object.defineProperty(a,u,{enumerable:!0,get:r[u]})},Pe.o=(a,r)=>Object.prototype.hasOwnProperty.call(a,r);var Wt={};(()=>{let a;Pe.d(Wt,{R:()=>a}),a=typeof document!="undefined"&&typeof window!="undefined"?Pe(653).fabric:{version:"5.2.1"}})();var xe=Wt.R;function ye(a,r,u,_){return new(u||(u=Promise))(function(v,S){function m(x){try{E(_.next(x))}catch(A){S(A)}}function w(x){try{E(_.throw(x))}catch(A){S(A)}}function E(x){var A;x.done?v(x.value):(A=x.value,A instanceof u?A:new u(function(D){D(A)})).then(m,w)}E((_=_.apply(a,r||[])).next())})}var tt=typeof self=="undefined",Ve,Ee,Qe,et,be;if(typeof navigator!="undefined"&&(Ve=navigator,Ee=Ve.userAgent,Qe=Ve.platform,et=Ve.mediaDevices),!tt){let a={init:function(){this.browser=this.searchString(this.dataBrowser)||"unknownBrowser",this.version=this.searchVersion(Ee)||this.searchVersion(Ve.appVersion)||0,this.OS=this.searchString(this.dataOS)||"unknownOS",this.OS=="Linux"&&Ee.indexOf("Windows NT")!=-1&&(this.OS="HarmonyOS")},searchString:function(r){for(let u=0;u<r.length;u++){let _=r[u].string,v=r[u].prop;if(this.versionSearchString=r[u].versionSearch||r[u].identity,_){if(_.indexOf(r[u].subString)!=-1)return r[u].identity}else if(v)return r[u].identity}},searchVersion:function(r){let u=r.indexOf(this.versionSearchString);if(u!=-1)return parseFloat(r.substring(u+this.versionSearchString.length+1))},dataBrowser:[{string:Ee,subString:"Edge",identity:"Edge"},{string:Ee,subString:"OPR",identity:"OPR"},{string:Ee,subString:"Chrome",identity:"Chrome"},{string:Ve.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{string:Ee,subString:"Firefox",identity:"Firefox"},{string:Ee,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"}],dataOS:[{string:Ee,subString:"HarmonyOS",identity:"HarmonyOS"},{string:Ee,subString:"Android",identity:"Android"},{string:Ee,subString:"iPhone",identity:"iPhone"},{string:Qe,subString:"Win",identity:"Windows"},{string:Qe,subString:"Mac",identity:"Mac"},{string:Qe,subString:"Linux",identity:"Linux"}]};a.init(),be={browser:a.browser,version:a.version,OS:a.OS}}tt&&(be={browser:"ssr",version:0,OS:"ssr"});var _i=typeof WebAssembly!="undefined"&&Ee&&!(/Safari/.test(Ee)&&!/Chrome/.test(Ee)&&/\(.+\s11_2_([2-6]).*\)/.test(Ee)),pi=typeof Worker!="undefined",Ht=!(!et||!et.getUserMedia),mi=async()=>{let a=!1;if(Ht)try{(await et.getUserMedia({video:!0})).getTracks().forEach(r=>{r.stop()}),a=!0}catch(r){}return a};be.browser==="Chrome"&&be.version>66||be.browser==="Safari"&&be.version>13||be.browser==="OPR"&&be.version>43||be.browser==="Edge"&&be.version;var vi=(()=>{if(!tt&&document.currentScript){let a=document.currentScript.src,r=a.indexOf("?");if(r!=-1)a=a.substring(0,r);else{let u=a.indexOf("#");u!=-1&&(a=a.substring(0,u))}return a.substring(0,a.lastIndexOf("/")+1)}return"./"})(),De=class{constructor(r,u){this._zIndex=null,this._drawingLayer=null,this._drawingLayerId=null,this._mapStyle=new Map,this.mapEvents=new Map([["select",[]],["deselect",[]]]),this.isDrawingItem=!0,this._setFabricObject(r),this._mediaType=r.type,this.styleSelector="default",this.styleId=u;for(let _ of De.arrStyleSelectors)this._mapStyle.set(_,null)}get mediaType(){return this._mediaType}get drawingLayerId(){return this._drawingLayerId}_setFabricObject(r){this._fabricObject=r;let u=this.mapEvents;this._fabricObject.onSelect=()=>{this.styleSelector="selected";let _=this.mapEvents.get("select");for(let v of _)v&&v.apply(this)},this._fabricObject.onDeselect=()=>{this.styleSelector="default";let _=u.get("deselect");for(let v of _)v&&v.apply(this)},r.getDrawingItem=()=>this}_getFabricObject(){return this._fabricObject}on(r,u,_){let v=this.mapEvents.get(r);v.includes(u)||v.push(u)}off(r,u){let _=this.mapEvents.get(r),v=_.indexOf(u);v!==-1&&_.splice(v,1)}_setEditable(r){let u=this._fabricObject;r?(u.selectable=!0,u.evented=!0,u.hasControls=!0):(u.selectable=!1,u.evented=!1,u.hasControls=!1)}_extendSet(r,u){return!1}_extendGet(r){}set(r,u){this._extendSet(r,u)||(r==="x"?this._fabricObject.set("left",u):r==="y"?this._fabricObject.set("top",u):this._fabricObject.set(r,u)),["vertices","left","top","width","height","scaleX","scaleY","skewX","skewY","padding","angle","strokeWidth"].includes(r)&&this._fabricObject.setCoords()}get(r){let u=this._extendGet(r);return u===void 0&&(u=r==="x"?this._fabricObject.get("left"):r==="y"?this._fabricObject.get("top"):this._fabricObject.get(r)),u}};De.arrMediaTypes=["rect","arc","polygon","image","text","line","path"],De.arrStyleSelectors=["default","selected"],typeof document!="undefined"&&typeof window!="undefined"&&(xe.StaticCanvas.prototype.dispose=function(){return this.isRendering&&(xe.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(a){a.dispose&&a.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),xe.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},xe.Object.prototype.transparentCorners=!1,xe.Object.prototype.cornerSize=20,xe.Object.prototype.touchCornerSize=100,xe.Object.prototype.cornerColor="rgb(254,142,20)",xe.Object.prototype.cornerStyle="circle",xe.Object.prototype.strokeUniform=!0,xe.Object.prototype.hasBorders=!1,xe.ActiveSelection.prototype.onDeselect=function(){return this.getObjects().forEach(a=>{setTimeout(a.onDeselect,0)}),this.destroy(),!1},xe.Canvas.prototype.containerClass="",xe.Canvas.prototype.getPointer=function(a,r){if(this._absolutePointer&&!r)return this._absolutePointer;if(this._pointer&&r)return this._pointer;var u,_=this.upperCanvasEl,v=xe.util.getPointer(a,_),S=_.getBoundingClientRect(),m=S.width||0,w=S.height||0;m&&w||("top"in S&&"bottom"in S&&(w=Math.abs(S.top-S.bottom)),"right"in S&&"left"in S&&(m=Math.abs(S.right-S.left))),this.calcOffset(),v.x=v.x-this._offset.left,v.y=v.y-this._offset.top,r||(v=this.restorePointerVpt(v));var E=this.getRetinaScaling();if(E!==1&&(v.x/=E,v.y/=E),m!==0&&w!==0){var x=window.getComputedStyle(_).objectFit,A=_.width,D=_.height,I=m,z=w;u={width:A/I,height:D/z};var se,ee,q=A/D,te=I/z;return x==="contain"?q>te?(se=I,ee=I/q,{x:v.x*u.width,y:(v.y-(z-ee)/2)*u.width}):(se=z*q,ee=z,{x:(v.x-(I-se)/2)*u.height,y:v.y*u.height}):x==="cover"?q>te?{x:(A-u.height*I)/2+v.x*u.height,y:v.y*u.height}:{x:v.x*u.width,y:(D-u.width*z)/2+v.y*u.width}:{x:v.x*u.width,y:v.y*u.height}}return u={width:1,height:1},{x:v.x*u.width,y:v.y*u.height}});var Yt=class{constructor(r,u,_,v){let S,m;switch(this.mapMediaType_Style=new Map,this.mode="viewer",this.onSelectionChange=null,this._arrDrwaingItem=[],this._arrFabricObject=[],this._visible=!0,r.hasOwnProperty("getFabricCanvas")?this.fabricCanvas=r.getFabricCanvas():(this.fabricCanvas=new xe.Canvas(r,v),this.fabricCanvas.setDimensions({width:"100%",height:"100%"},{cssOnly:!0}),this.fabricCanvas.lowerCanvasEl.className="",this.fabricCanvas.upperCanvasEl.className="",this.fabricCanvas.on("selection:created",function(w){let E=w.selected,x=[];for(let A of E){let D=A.getDrawingItem()._drawingLayer;D&&!x.includes(D)&&x.push(D)}for(let A of x){let D=[];for(let I of E){let z=I.getDrawingItem();z._drawingLayer===A&&D.push(z)}setTimeout(()=>{A.onSelectionChange&&A.onSelectionChange(D,[])},0)}}),this.fabricCanvas.on("before:selection:cleared",function(w){let E=this.getActiveObjects(),x=[];for(let A of E){let D=A.getDrawingItem()._drawingLayer;D&&!x.includes(D)&&x.push(D)}for(let A of x){let D=[];for(let I of E){let z=I.getDrawingItem();z._drawingLayer===A&&D.push(z)}setTimeout(()=>{let I=[];for(let z of D)A.hasDrawingItem(z)&&I.push(z);I.length>0&&A.onSelectionChange&&A.onSelectionChange([],I)},0)}}),this.fabricCanvas.on("selection:updated",function(w){let E=w.selected,x=w.deselected,A=[];for(let D of E){let I=D.getDrawingItem()._drawingLayer;I&&!A.includes(I)&&A.push(I)}for(let D of x){let I=D.getDrawingItem()._drawingLayer;I&&!A.includes(I)&&A.push(I)}for(let D of A){let I=[],z=[];for(let se of E){let ee=se.getDrawingItem();ee._drawingLayer===D&&I.push(ee)}for(let se of x){let ee=se.getDrawingItem();ee._drawingLayer===D&&z.push(ee)}setTimeout(()=>{D.onSelectionChange&&D.onSelectionChange(I,z)},0)}}),this.fabricCanvas.wrapperEl.style.position="absolute",r.getFabricCanvas=()=>this.fabricCanvas),this.id=u,this._mapDrawingStyles=_,u){case 1:S=_.get(1),m=_.get(5);break;case 2:S=_.get(2),m=_.get(6);break;case 3:S=_.get(3),m=_.get(7);break;default:S=_.get(4),m=_.get(8)}for(let w of De.arrMediaTypes)this.mapMediaType_Style.set(w,{default:S,selected:m})}getId(){return this.id}_getDrawingStyle(r,u){if(typeof r!="number")throw new Error("Invalid style id.");let _=this._mapDrawingStyles.get(r);return _?u?JSON.parse(JSON.stringify(_)):_:null}setVisible(r){if(r){for(let u of this._arrFabricObject)u.visible=!0;this._visible=!0}else{for(let u of this._arrFabricObject)u.visible=!1;this._visible=!1}this.fabricCanvas.renderAll()}isVisible(){return this._visible}_getItemCurrentStyleId(r){return r.styleId?r.styleId:this.mapMediaType_Style.get(r._mediaType)[r.styleSelector].styleId}_getItemCurrentStyle(r){return r.styleId?this._getDrawingStyle(r.styleId):r._mapStyle.get(r.styleSelector)||null}_changeMediaTypeCurStyleInStyleSelector(r,u,_,v){let S;switch(r){case"rect":S=this.fabricCanvas.getObjects("rect");break;case"arc":S=this.fabricCanvas.getObjects("circle");break;case"polygon":S=this.fabricCanvas.getObjects("polygon");break;case"image":S=this.fabricCanvas.getObjects("image");break;case"text":S=this.fabricCanvas.getObjects("text");break;case"line":S=this.fabricCanvas.getObjects("line");break;case"path":S=this.fabricCanvas.getObjects("path")}for(let m of S){if(!this._arrFabricObject.includes(m))continue;let w=m.getDrawingItem();w.styleSelector===u&&this._changeItemStyle(w,_,!0)}v||this.fabricCanvas.renderAll()}_changeItemStyle(r,u,_){if(!r||!u)return;let v=r._getFabricObject();typeof r.styleId=="number"&&(u=this._getDrawingStyle(r.styleId)),v.strokeWidth=u.lineWidth,u.paintMode==="fill"?(v.fill=u.fillStyle,v.stroke=u.fillStyle):u.paintMode==="stroke"?(v.fill="transparent",v.stroke=u.strokeStyle):u.paintMode==="strokeAndFill"&&(v.fill=u.fillStyle,v.stroke=u.strokeStyle),v.fontFamily&&(v.fontFamily=u.fontFamily),v.fontSize&&(v.fontSize=u.fontSize),v.group||(v.dirty=!0),_||this.fabricCanvas.renderAll()}_updateGroupItem(r,u,_){if(!r||!u)return;let v=r.getChildItems();if(_==="add"){if(v.includes(u))return;let S=u._getFabricObject();if(this.fabricCanvas.getObjects().includes(S)){if(!this._arrFabricObject.includes(S))throw new Error("Existed in other drawing layers.");u._zIndex=null}else{let m;if(u.styleId)m=this._getDrawingStyle(u.styleId);else{m=this.mapMediaType_Style.get(u._mediaType)[r.styleSelector];let w=()=>{this._changeItemStyle(u,this.mapMediaType_Style.get(u._mediaType).selected,!0)},E=()=>{this._changeItemStyle(u,this.mapMediaType_Style.get(u._mediaType).default,!0)};u.on("select",w),u.on("deselect",E),u._funcChangeStyleToSelected=w,u._funcChangeStyleToDefault=E}u._drawingLayer=this,u._drawingLayerId=this.id,this._changeItemStyle(u,m,!0)}r._fabricObject.addWithUpdate(u._getFabricObject())}else{if(_!=="remove"||!v.includes(u))return;u._zIndex=null,u._drawingLayer=null,u._drawingLayerId=null,u.off("select",u._funcChangeStyleToSelected),u.off("deselect",u._funcChangeStyleToDefault),u._funcChangeStyleToSelected=null,u._funcChangeStyleToDefault=null,r._fabricObject.removeWithUpdate(u._getFabricObject())}this.fabricCanvas.renderAll()}_addDrawingItem(r,u){let _=r._getFabricObject(),v=this.fabricCanvas.getObjects(),S,m;if(v.includes(_)){if(this._arrFabricObject.includes(_))return;throw new Error("Existed in other drawing layers.")}if(r._mediaType==="group"){S=r.getChildItems();for(let x of S)if(x._drawingLayer&&x._drawingLayer!==this)throw new Error("The childItems of DT_Group have existed in other drawing layers.")}if(u&&typeof u=="object"&&!Array.isArray(u))for(let x in u)_.set(x,u[x]);if(S){for(let x of S){if(x.styleId)m=this._getDrawingStyle(x.styleId);else{let A=this.mapMediaType_Style.get(x._mediaType);for(let z of De.arrStyleSelectors)x._mapStyle.set(z,A[z]);m=A.default;let D=()=>{this._changeItemStyle(x,this.mapMediaType_Style.get(x._mediaType).selected,!0)},I=()=>{this._changeItemStyle(x,this.mapMediaType_Style.get(x._mediaType).default,!0)};x.on("select",D),x.on("deselect",I),x._funcChangeStyleToSelected=D,x._funcChangeStyleToDefault=I}x._drawingLayer=this,x._drawingLayerId=this.id,this._changeItemStyle(x,m,!0)}_.dirty=!0,this.fabricCanvas.renderAll()}else{if(r.styleId)m=this._getDrawingStyle(r.styleId);else{let x=this.mapMediaType_Style.get(r._mediaType);for(let I of De.arrStyleSelectors)r._mapStyle.set(I,x[I]);m=x.default;let A=()=>{this._changeItemStyle(r,this.mapMediaType_Style.get(r._mediaType).selected)},D=()=>{this._changeItemStyle(r,this.mapMediaType_Style.get(r._mediaType).default)};r.on("select",A),r.on("deselect",D),r._funcChangeStyleToSelected=A,r._funcChangeStyleToDefault=D}this._changeItemStyle(r,m)}r._zIndex=this.id,r._drawingLayer=this,r._drawingLayerId=this.id;let w=this._arrFabricObject.length,E=v.length;if(w)E=v.indexOf(this._arrFabricObject[w-1])+1;else for(let x=0;x<v.length;x++)if(r._zIndex<v[x].getDrawingItem()._zIndex){E=x;break}this._arrDrwaingItem.push(r),this._arrFabricObject.push(_),this._visible?_.visible=!0:_.visible=!1,this.fabricCanvas.insertAt(_,E,!1)}addDrawingItem(r){if(!r||!r.isDrawingItem)throw TypeError("Illegal drawing item.");if(this.mode==="viewer")r._setEditable(!1);else{if(this.mode!=="editor")throw new Error("Illegal 'mode'.");r._setEditable(!0)}this._addDrawingItem(r)}addDrawingItems(r){for(let u of r)this.addDrawingItem(u)}removeDrawingItem(r){if(!r||!r.isDrawingItem)throw TypeError("Illegal drawing item.");if(!this.hasDrawingItem(r))return;if(r._zIndex=null,r._drawingLayer=null,r._drawingLayerId=null,r._mediaType==="group"){let _=r.getChildItems();for(let v of _)v._zIndex=null,v._drawingLayer=null,v._drawingLayerId=null,v.off("select",v._funcChangeStyleToSelected),v.off("deselect",v._funcChangeStyleToDefault),v._funcChangeStyleToSelected=null,v._funcChangeStyleToDefault=null,v._mapStyle.clear()}else r.off("select",r._funcChangeStyleToSelected),r.off("deselect",r._funcChangeStyleToDefault),r._funcChangeStyleToSelected=null,r._funcChangeStyleToDefault=null,r._mapStyle.clear();r.styleSelector==="selected"&&(this.fabricCanvas._activeObject=null,r.styleSelector="default");let u=r._getFabricObject();this.fabricCanvas.remove(u),this._arrDrwaingItem.splice(this._arrDrwaingItem.indexOf(r),1),this._arrFabricObject.splice(this._arrFabricObject.indexOf(u),1)}removeDrawingItems(r){for(let u of r)this.removeDrawingItem(u)}setDrawingItems(r){this.clearDrawingItems(),this.addDrawingItems(r)}getDrawingItems(){return this._arrDrwaingItem}getSelectedDrawingItems(){let r=this.fabricCanvas.getActiveObjects(),u=[];for(let _ of r)this._arrFabricObject.includes(_)&&u.push(_.getDrawingItem());return u}hasDrawingItem(r){if(!r||!r.isDrawingItem)throw TypeError("Illegal drawing item.");return this._arrDrwaingItem.includes(r)}clearDrawingItems(){this.removeDrawingItems(Array.from(this._arrDrwaingItem))}setDrawingStyle(r,u,_){let v,S;if(u=u?u.toLocaleLowerCase():"all",_=_?_.toLocaleLowerCase():"all",v=typeof r=="number"?this._getDrawingStyle(r):r,u==="all"){let m=this.mapMediaType_Style.keys();for(let w of m)if(S=this.mapMediaType_Style.get(w),_==="all")for(let E of De.arrStyleSelectors){this._changeMediaTypeCurStyleInStyleSelector(w,E,v,!0),S[E]=v;for(let x of this._arrDrwaingItem)typeof x.styleId!="number"&&x._mapStyle.set(E,v)}else{this._changeMediaTypeCurStyleInStyleSelector(w,_,v,!0),S[_]=v;for(let E of this._arrDrwaingItem)typeof E.styleId!="number"&&E._mapStyle.set(_,v)}this.fabricCanvas.renderAll()}else if(S=this.mapMediaType_Style.get(u),_==="all")for(let m of De.arrStyleSelectors){this._changeMediaTypeCurStyleInStyleSelector(u,m,v,!0),S[m]=v;for(let w of this._arrDrwaingItem)typeof w.styleId!="number"&&w._mediaType===u&&w._mapStyle.set(m,v)}else{this._changeMediaTypeCurStyleInStyleSelector(u,_,v,!0),S[_]=v;for(let m of this._arrDrwaingItem)typeof m.styleId!="number"&&m._mediaType===u&&m._mapStyle.set(_,v)}}setMode(r){if((r=r.toLocaleLowerCase())==="viewer"){for(let u of this._arrDrwaingItem)u._setEditable(!1);this.fabricCanvas.discardActiveObject(),this.fabricCanvas.renderAll(),this.mode="viewer"}else{if(r!=="editor")throw new RangeError("Invalid value.");for(let u of this._arrDrwaingItem)u._setEditable(!0);this.mode="editor"}this._manager._switchPointerEvent()}getMode(){return this.mode}_setDimensions(r,u){this.fabricCanvas.setDimensions(r,u)}_setObjectFit(r){if(r=r.toLowerCase(),!["contain","cover"].includes(r))throw new Error(`Unsupported value '${r}'.`);this.fabricCanvas.lowerCanvasEl.style.objectFit=r,this.fabricCanvas.upperCanvasEl.style.objectFit=r}_getObjectFit(){return this.fabricCanvas.lowerCanvasEl.style.objectFit}renderAll(){for(let r of this._arrDrwaingItem){let u=this._getItemCurrentStyle(r);this._changeItemStyle(r,u,!0)}this.fabricCanvas.renderAll()}dispose(){this.clearDrawingItems(),this._manager._arrDrawingLayer.length===1&&(this.fabricCanvas.wrapperEl.style.pointerEvents="none",this.fabricCanvas.dispose(),this._arrDrwaingItem.length=0,this._arrFabricObject.length=0)}},Xt=class{constructor(){this._arrDrawingLayer=[],this._mapDrawingStyles=new Map([[1,{id:1,lineWidth:2,fillStyle:"rgba(73, 173, 245, 0.3)",strokeStyle:"rgba(73, 173, 245, 1)",paintMode:"stroke",fontFamily:"sans-serif",fontSize:10}],[2,{id:2,lineWidth:2,fillStyle:"rgba(73, 245, 73, 0.3)",strokeStyle:"rgba(73, 245, 73, 0.9)",paintMode:"strokeAndFill",fontFamily:"sans-serif",fontSize:10}],[3,{id:3,lineWidth:2,fillStyle:"rgba(254, 180, 32, 0.3)",strokeStyle:"rgba(254, 180, 32, 0.9)",paintMode:"strokeAndFill",fontFamily:"sans-serif",fontSize:10}],[4,{id:4,lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"stroke",fontFamily:"sans-serif",fontSize:10}],[5,{id:5,lineWidth:2,fillStyle:"rgba(73, 173, 245, 0.3)",strokeStyle:"rgba(73, 173, 245, 1)",paintMode:"strokeAndFill",fontFamily:"sans-serif",fontSize:10}],[6,{id:6,lineWidth:2,fillStyle:"rgba(73, 245, 73, 0.3)",strokeStyle:"rgba(73, 245, 73, 0.9)",paintMode:"strokeAndFill",fontFamily:"sans-serif",fontSize:10}],[7,{id:7,lineWidth:2,fillStyle:"rgba(254, 180, 32, 0.3)",strokeStyle:"rgba(254, 180, 32, 1)",paintMode:"strokeAndFill",fontFamily:"sans-serif",fontSize:10}],[8,{id:8,lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"strokeAndFill",fontFamily:"sans-serif",fontSize:10}]]),this._defaultStyleTemplate={lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"stroke",fontFamily:"sans-serif",fontSize:10}}createDrawingStyle(r){let u;if(r.hasOwnProperty("id")){if(this._mapDrawingStyles.has(r.id))throw new Error("Existing drawing style id.");u=r.id}else{let v=100;for(;this._mapDrawingStyles.has(v);)v++;u=v}let _=JSON.parse(JSON.stringify(r));_.id=u;for(let v in this._defaultStyleTemplate)_.hasOwnProperty(v)||(_[v]=this._defaultStyleTemplate[v]);return this._mapDrawingStyles.set(u,_),_.id}_getDrawingStyle(r,u){if(typeof r!="number")throw new Error("Invalid style id.");let _=this._mapDrawingStyles.get(r);return _?u?JSON.parse(JSON.stringify(_)):_:null}getDrawingStyle(r){return this._getDrawingStyle(r,!0)}getDrawingStyles(){return JSON.parse(JSON.stringify(Array.from(this._mapDrawingStyles.values())))}_updateDrawingStyle(r,u){let _=this._mapDrawingStyles.get(r);if(_)for(let v in u)_.hasOwnProperty(v)&&(_[v]=u[v])}updateDrawingStyle(r,u){this._updateDrawingStyle(r,u);for(let _ of this._arrDrawingLayer)_.renderAll()}createDrawingLayer(r,u){let _=S=>{for(let m of this._arrDrawingLayer)if(m.getId()===S)return!0;return!1};if(u===void 0){for(let S=100;;S++)if(!_(S)){u=S;break}}else if(_(u))throw new Error("Existed drawing layer id.");let v=new Yt(r,u,this._mapDrawingStyles,{enableRetinaScaling:!1});return v._manager=this,this._arrDrawingLayer.push(v),this._switchPointerEvent(),v}deleteDrwaingLayer(r){let u=this.getDrawingLayer(r);if(!u)return;let _=this._arrDrawingLayer;u.dispose(),_.splice(_.indexOf(u),1),this._switchPointerEvent()}clearDrawingLayers(){for(let r of this._arrDrawingLayer)r.dispose();this._arrDrawingLayer.length=0}getDrawingLayer(r){for(let u of this._arrDrawingLayer)if(u.getId()===r)return u;return null}getDrawingLayers(){return Array.from(this._arrDrawingLayer)}getSelectedDrawingItems(){if(!this._arrDrawingLayer.length)return;let r=this._arrDrawingLayer[0].fabricCanvas.getActiveObjects(),u=[];for(let _ of r)u.push(_.getDrawingItem());return u}setDimensions(r,u){this._arrDrawingLayer.length&&this._arrDrawingLayer[0]._setDimensions(r,u)}setObjectFit(r){for(let u of this._arrDrawingLayer)u&&u._setObjectFit(r)}getObjectFit(){return this._arrDrawingLayer.length?this._arrDrawingLayer[0]._getObjectFit():null}setVisible(r){this._arrDrawingLayer.length&&(this._arrDrawingLayer[0].fabricCanvas.wrapperEl.style.display=r?"block":"none")}_switchPointerEvent(){if(!this._arrDrawingLayer.length)return;let r=!1;for(let u of this._arrDrawingLayer)u.getMode()==="editor"&&(r=!0);this._arrDrawingLayer[0].fabricCanvas.wrapperEl.style.pointerEvents=r?"":"none"}},zt=class{constructor(r){this._controlTarget=null,this._arrUsers=[],this._mapAction_UserArgs=new Map,this._mapProperty_UserValue=new Map,this._mapAction_Callbacks=new Map,this._controlTarget=r}setControlTarget(r){this._controlTarget=r}getControlTarget(){return this._controlTarget}register(r){this._arrUsers.includes(r)||this._arrUsers.push(r)}logout(r){let u=this._arrUsers.indexOf(r);u!==-1&&(this.clearUserDisiredAction({user:r}),this.clearUserDisiredValue({user:r}),this._arrUsers.splice(u,1))}getRegisteredUsers(){return this._arrUsers}ifUserExisted(r){return this._arrUsers.includes(r)}setDisiredValue(r,u,_,v){if(!this._arrUsers.includes(r))throw new Error("Unregistered user.");v&&(this._controlTarget[u]=_),this._mapProperty_UserValue.get(u)?this._mapProperty_UserValue.get(u).set(r,_):this._mapProperty_UserValue.set(u,new Map([[r,_]]))}clearUserDisiredValue(r){if(r&&(r.user||r.property)){if(r.property&&r.user){let u=this._mapProperty_UserValue.get(r.property);if(!u)return;u.delete(r.user)}else if(r.property)this._mapProperty_UserValue.delete(r.property);else if(r.user)for(let u of this._mapProperty_UserValue.values())u.delete(r.user)}else this._mapProperty_UserValue=new Map}getValue(r){if(!this._controlTarget)throw new Error("Control target is not set.");return this._controlTarget[r]}getPropertyDisiredValue(r){if(this._mapProperty_UserValue.get(r)){let u=[],_=this._mapProperty_UserValue.get(r);for(let v of _.values())u.push(v);return u}return null}setDisiredAction(r,u,_,v){if(!this._arrUsers.includes(r))throw new Error("Unregistered user.");return _||(_=[]),v?this._controlTarget[u](..._):(this._mapAction_UserArgs.get(u)?this._mapAction_UserArgs.get(u).set(r,_):this._mapAction_UserArgs.set(u,new Map([[r,_]])),this._render(u))}clearUserDisiredAction(r){if(r&&(r.user||r.actionName)){if(r.actionName&&r.user){let u=this._mapAction_UserArgs.get(r.actionName);if(!u)return;u.delete(r.user)}else if(r.actionName)this._mapAction_UserArgs.delete(r.actionName);else if(r.user)for(let u of this._mapAction_UserArgs.values())u.delete(r.user);this.render()}else this._mapAction_UserArgs=new Map}addCallback(r,u){let _=this._mapAction_Callbacks.get(r);_?_.push(u):this._mapAction_Callbacks.set(r,[u])}removeCallback(r,u){let _=this._mapAction_Callbacks.get(r);if(!_)return;let v=_.indexOf(u);v!==-1&&_.splice(v,1)}clearCallback(r){r?this._mapAction_Callbacks.delete(r):this._mapAction_Callbacks.clear()}_fireCallback(r){let u=this._mapAction_Callbacks.get(r);if(u)for(let _ of u){if(!_)return;setTimeout(_.bind(this._controlTarget),0)}}_render(r){let u=this._mapAction_UserArgs.get(r);if(!u)throw new Error("Unrecorded action.");if(u.size===this._arrUsers.length){let _=[];for(let v of u.values())v.length>0&&(_=v);if(this._controlTarget[r]){let v=this._controlTarget[r](..._);return this._mapAction_UserArgs.delete(r),this._fireCallback(r),v}}}render(r){if(r)return this._render(r);for(let u of this._mapAction_UserArgs.keys())this._render(u)}},ae=class{constructor(){this._maxCvsSideLength=void 0,this._defaultMaxCvsSideLength=null,this._predefinedResolutions=[{width:160,height:120},{width:320,height:240},{width:480,height:360},{width:640,height:480},{width:800,height:600},{width:960,height:720},{width:1280,height:720},{width:1920,height:1080},{width:2560,height:1440},{width:3840,height:2160}],this._mapCameraResolutions=new Map,this._bWebGLSupported=!0,this.extraBindings=[],this._singleFrameMode=!(navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),this._cvsSingleFrameMode=null,this._cvsOriginalImage=null,this._imgWidth=0,this._imgHeight=0,this._singleFrameModeIpt=null,this._clickIptSingleFrameMode=()=>{if(this.singleFrameMode){if(!this._singleFrameModeIpt){let r=document.createElement("input");this._singleFrameModeIpt=r,r.setAttribute("type","file"),r.setAttribute("accept",".jpg,.jpeg,.icon,.gif,.svg,.webp,.png,.bmp"),r.setAttribute("capture",""),r.addEventListener("change",()=>ye(this,void 0,void 0,function*(){let u=r.files[0];r.value="";let _=yield(x=>ye(this,void 0,void 0,function*(){let A=null,D=null;if(typeof createImageBitmap!="undefined")try{if(A=yield createImageBitmap(x),A)return A}catch(z){}var I;return A||(D=yield(I=x,new Promise((z,se)=>{let ee=URL.createObjectURL(I),q=new Image;q.dbrObjUrl=ee,q.src=ee,q.onload=()=>{z(q)},q.onerror=te=>{se(new Error("Can't convert blob to image : "+(te instanceof Event?te.type:te)))}}))),D}))(u),v=_ instanceof HTMLImageElement?_.naturalWidth:_.width,S=_ instanceof HTMLImageElement?_.naturalHeight:_.height;this._imgWidth=v,this._imgHeight=S;let m=x=>{let A=Date.now();if(v===0||S===0)return null;let D=this._scanRegion,I=this.getFrameSize(v,S,D,this.maxCvsSideLength);if(!I)return null;let z,se;z=v!==I.sWidth||S!==I.sHeight,se=I.sWidth!==I.dWidth||I.sHeight!==I.dHeight;let ee=(()=>!(!this._bWebGLSupported||se))(),q={data:null,region:D?JSON.parse(JSON.stringify(D)):null,sx:I.sx,sy:I.sy,width:I.dWidth,height:I.dHeight,colorMode:null,timeSpent:null,timeStamp:null,isCropped:z,toCanvas:this._toCanvas,_sWidth:I.sWidth,_sHeight:I.sHeight,_bUseWebGL:null},te;try{te=this._getImageData(x,v,S,I,null,{targetColorMode:this.frameColorMode,bUseWebGL:ee})}catch(K){if(K.name!=="WebGLError")throw K;te=this._getImageData(x,v,S,I,null,{targetColorMode:this.frameColorMode,bUseWebGL:!1})}if(!te)return null;let ce=Date.now();return ae._onLog&&ae._onLog("DCE: _getVideoFrame(region?) END: "+ce),q.data=te.data,q.colorMode=te.colorMode,q._bUseWebGL=te._bUseWebGL,q.timeSpent=ce-A,q.timeStamp=ce,q};(x=>{let A=this._cvsSingleFrameMode;if(!A){if(A=document.createElement("canvas"),A.style.pointerEvents="none",!this._video)throw new Error("'video' is null.");this._video.after(A),A.style.position="absolute",A.style.width="100%",A.style.height="100%",A.style.left="0",A.style.top="0",A.style.objectFit="contain",this._cvsSingleFrameMode=A}A.width==v&&A.height==S||(A.width=v,A.height=S);let D=A.getContext("2d");D.clearRect(0,0,A.width,A.height),D.drawImage(x,0,0)})(_),this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let x of this._arrScanRegionOverlays)x&&this._updateScanRegionOverlay(x);let w;this._updateDrawingLayersSize();try{w=m(_)}catch(x){throw x}let E=this.mapCameraEvents.get("singleFrameAcquired");for(let x of E)if(x)try{let A={data:new Uint8Array(w.data),region:JSON.parse(JSON.stringify(w.region)),sx:w.sx,sy:w.sy,width:w.width,height:w.height,colorMode:w.colorMode,timeSpent:w.timeSpent,timeStamp:w.timeStamp,isCropped:w.isCropped,toCanvas:w.toCanvas,_sWidth:w._sWidth,_sHeight:w._sHeight,_bUseWebGL:w._bUseWebGL};yield x.apply(this,[A])}catch(A){console.error(A)}})),r.style.position="fixed",r.style.left="-1px",r.style.top="-1px",r.style.width="1px",r.style.height="1px",r.style.backgroundColor="transparent",r.style.color="transparent",document.body.appendChild(r)}this._singleFrameModeIpt.click()}},this.styleEls=[],this._frameColorMode=void 0,this._defaultFrameColorMode="RGBA",this.currentFSColorMode="rgba",this.ifReuseArrayBufferView=!1,this.maxVideoCvsLength=3,this._reusedCvs=null,this._reusedWebGLCvs=null,this._reusedWebGLCtx=null,this._reusedDataContainer=null,this._webGLTexture=null,this._webGLProgramInfo=null,this._webGLBuffers=null,this._recordedStates={},this._toCanvas=function(){let r=document.createElement("canvas"),u;if(r.width=this.width,r.height=this.height,this.colorMode==="grey"){u=new Uint8ClampedArray(this.width*this.height*4);for(let v=0;v<u.length;v+=4)u[v]=this.data[v/4],u[v+1]=this.data[v/4],u[v+2]=this.data[v/4],u[v+3]=255}else u=new Uint8ClampedArray(this.data);let _=new ImageData(u,this.width,this.height);return r.getContext("2d").putImageData(_,0,0),r},this._onCameraSelChange=()=>ye(this,void 0,void 0,function*(){yield this.selectCamera(this._selCam.value),this._bOpen||this.stop()}),this._onResolutionSelChange=()=>ye(this,void 0,void 0,function*(){let r,u;if(this._selRsl&&this._selRsl.selectedIndex!=-1){let _=this._selRsl.options[this._selRsl.selectedIndex];r=_.getAttribute("data-width"),u=_.getAttribute("data-height")}yield this.setResolution(r,u),this._bOpen||this.stop()}),this._onCloseBtnClick=()=>{this.close(!0)},this._bOpen=!1,this.isCameraEnhancer=!0,this.isDisposed=!1,this.videoSrc=null,this.videoSettings={video:{width:{ideal:1280},height:{ideal:720},facingMode:{ideal:"environment"}}},this.iPlayRound=0,this.promisePlay=null,this._ifSaveLastUsedCamera=!1,this.ifSkipCameraInspection=!1,this._allCameras=[],this._currentCamera=null,this._videoTrack=null,this._lastDeviceId=void 0,this._vc_bPlayingVideoBeforeHide=!1,this._ev_documentHideEvent=()=>{document.visibilityState==="visible"?this._vc_bPlayingVideoBeforeHide&&(be.browser=="Firefox"?this.play():this._video.play(),this._vc_bPlayingVideoBeforeHide=!1):this._video&&!this._video.paused&&(this._vc_bPlayingVideoBeforeHide=!0,this._video.pause())},this._divVideoContainer=null,this._video=null,this.videoFit="contain",this._cvsScanRegion=null,this._divScanArea=null,this._divScanLight=null,this._bgLoading=null,this._selCam=null,this._bgCamera=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._selMinLtr=null,this._optGotMinLtr=null,this.regionMaskFillStyle="rgba(0,0,0,0.5)",this.regionMaskStrokeStyle="rgb(254,142,20)",this.regionMaskLineWidth=2,this._bShowScanRegionMask=!0,this._bShowScanRegionLaser=void 0,this._defaultBShowScanRegionLaser=!1,this._scanRegion=null,this._arrScanRegionOverlays=[],this._layerBaseCvs=null,this._cvsViewDecorator=null,this._decoratorType=[],this._decoratorArea=null,this._viewDecoratorInfo={rectangle:{lineWidth:4,strokeStyle:"rgb(254,142,20)",fillStyle:"transparent",maskFillStyle:"transparent"},focus:{lineWidth:4,strokeStyle:"rgb(254,142,20)",fillStyle:"transparent",maskFillStyle:"transparent"},crossline:{lineWidth:2,strokeStyle:"rgb(254,142,20)"},crosshair:{lineWidth:4,strokeStyle:"rgb(254,142,20)"}},this._croppingRegions=void 0,this._defaultCroppingRegions=[null],this.bIncreaseRegionIndexAuto=!0,this._croppingRegionIndex=0,this._loopInterval=void 0,this._defaultLoopInterval=0,this._maxNumberOfFramesInBuffer=void 0,this._defaultMaxNumberOfFramesInBuffer=1,this._frameQueue=[],this._bFetchingLoopStarted=!1,this._refreshInterval=void 0,this._defaultRefreshInterval=-1,this._updateLayersTimeout=100,this._updateLayers=()=>{this._resizeTimeoutId&&clearTimeout(this._resizeTimeoutId),this._resizeTimeoutId=setTimeout(()=>{if(!this.isDisposed){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let r of this._arrScanRegionOverlays)r&&this._updateScanRegionOverlay(r);this._updateDrawingLayersSize()}},this._updateLayersTimeout)},this.mapCameraEvents=new Map([["cameraOpen",[]],["cameraClose",[]],["cameraChange",[]],["resolutionChange",[]],["played",[]],["singleFrameAcquired",[]],["frameAddedToBuffer",[]]]),this._controler=null}static getVersion(){return this._version}static detectEnvironment(){return ye(this,void 0,void 0,function*(){return yield(async()=>({wasm:_i,worker:pi,getUserMedia:Ht,camera:await mi(),browser:be.browser,version:be.version,OS:be.OS}))()})}static set engineResourcePath(r){if(this._hasEngineResourceLoaded)throw new Error("`engineResourcePath` is not allowed to change after `createInstance` is called.");ae._engineResourcePath=(u=>{if(u==null&&(u="./"),!tt){let _=document.createElement("a");_.href=u,u=_.href}return u.endsWith("/")||(u+="/"),u})(r)}static get engineResourcePath(){return this._engineResourcePath}static isStorageAvailable(r){let u;try{u=window[r];let _="__storage_test__";return u.setItem(_,_),u.removeItem(_),!0}catch(_){return _ instanceof DOMException&&(_.code===22||_.code===1014||_.name==="QuotaExceededError"||_.name==="NS_ERROR_DOM_QUOTA_REACHED")&&u&&u.length!==0}}static isDCEFrame(r){return!(!r||typeof r!="object"||Array.isArray(r))&&"data"in r&&"region"in r&&"sx"in r&&"sy"in r&&"width"in r&&"height"in r&&"colorMode"in r&&"timeSpent"in r&&"timeStamp"in r&&"isCropped"in r&&"toCanvas"in r&&"_sWidth"in r&&"_sHeight"in r&&"_bUseWebGL"in r}set maxCvsSideLength(r){if(r<=0)throw new Error("Invalid value.");this._maxCvsSideLength=r}get maxCvsSideLength(){if(this._maxCvsSideLength!==void 0)return this._maxCvsSideLength;if(this._controler){let r=this._controler.getPropertyDisiredValue("maxCvsSideLength");if(r&&r.length===1)return r[0]}return this._defaultMaxCvsSideLength}static set defaultUIElementURL(r){ae._defaultUIElementURL=r}static get defaultUIElementURL(){var r;return(r=ae._defaultUIElementURL)===null||r===void 0?void 0:r.replace("@engineResourcePath/",ae.engineResourcePath)}getUIElement(){return this.UIElement}setUIElement(r){return ye(this,void 0,void 0,function*(){if(this._bOpen)throw new Error("It is not allowed to change the UIElement when the camera is open.");if(typeof r=="string"||r instanceof String){if(!r.trim().startsWith("<")){let _=yield fetch(r);if(!_.ok)throw Error("setUIElement(elementOrUrl): Network Error: "+_.statusText);r=yield _.text()}if(!r.trim().startsWith("<"))throw Error("setUIElement(elementOrUrl): Can't get valid HTMLElement.");let u=document.createElement("div");u.innerHTML=r;for(let _=0;_<u.childElementCount;++_){let v=u.children[_];v instanceof HTMLStyleElement&&(this.styleEls.push(v),document.head.append(v))}(r=u.childElementCount==1?u.children[0]:u).remove()}this.UIElement=r,this._uiOriginalState={display:r&&r.style.display,inDom:document.body.contains(r)}})}appendAndShowUI(){this.UIElement&&(this.UIElement.parentNode||(this.UIElement.style.position="fixed",this.UIElement.style.left="0",this.UIElement.style.top="0",document.body.append(this.UIElement)),this.UIElement.style.display=="none"&&(this.UIElement.style.display=""))}hideUI(){this.UIElement&&(this.UIElement.style.display="none")}get singleFrameMode(){return this._singleFrameMode}set singleFrameMode(r){if(this._bOpen)throw new Error("It is not allowed to change `singleFrameMode` when the camera is open.");this._singleFrameMode=r}set frameColorMode(r){this._frameColorMode=r}get frameColorMode(){if(this._frameColorMode!==void 0)return this._frameColorMode;if(this._controler){let r=this._controler.getPropertyDisiredValue("frameColorMode");if(r&&r.length===1)return r[0]}return this._defaultFrameColorMode}set bOpen(r){if(this._bOpen=r,r){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let u of this._arrScanRegionOverlays)u&&this._updateScanRegionOverlay(u);this._updateDrawingLayersSize(),this.ifShowScanRegionMask?this.showScanRegionMask():this.hideScanRegionMask(),this.ifShowScanRegionLaser?this.showScanRegionLaser():this.hideScanRegionLaser(),this.showViewDecorator(),this.showScanRegionOverlays(),this._drawingLayersManager.setVisible(!0)}}set ifSaveLastUsedCamera(r){r?ae.isStorageAvailable("localStorage")?this._ifSaveLastUsedCamera=!0:(this._ifSaveLastUsedCamera=!1,console.warn("Local storage is unavailable")):this._ifSaveLastUsedCamera=!1}get ifSaveLastUsedCamera(){return this._ifSaveLastUsedCamera}get video(){return this._video}setVideoFit(r){if(r=r.toLowerCase(),!["contain","cover"].includes(r))throw new Error(`Unsupported value '${r}'.`);if(this.videoFit=r,this._video&&(this._video.style.objectFit=r,!this.singleFrameMode)){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let u of this._arrScanRegionOverlays)u&&this._updateScanRegionOverlay(u);this._drawingLayersManager.setObjectFit(r)}}getVideoFit(){return this.videoFit}set ifShowScanRegionMask(r){this._bShowScanRegionMask=r,r?this.showScanRegionMask():this.hideScanRegionMask()}get ifShowScanRegionMask(){return this._bShowScanRegionMask}showScanRegionMask(){this._cvsScanRegion&&(this._cvsScanRegion.style.display=="none"&&(this._cvsScanRegion.style.display=""),this._recordedStates.maskShow=!0)}hideScanRegionMask(){this._cvsScanRegion&&(this._cvsScanRegion.style.display="none",this._recordedStates.maskShow=!1)}set ifShowScanRegionLaser(r){this._bShowScanRegionLaser=r,r?this.showScanRegionLaser():this.hideScanRegionLaser()}get ifShowScanRegionLaser(){if(this._bShowScanRegionLaser!==void 0)return this._bShowScanRegionLaser;if(this._controler){let r=this._controler.getPropertyDisiredValue("ifShowScanRegionLaser");if(r&&r.length){let u=0;for(let _ of r)_||u++;return u!==this._controler.getRegisteredUsers().length}}return this._defaultBShowScanRegionLaser}showScanRegionLaser(){this._divScanLight&&(this._divScanLight.style.display=="none"&&(this._divScanLight.style.display="block"),this._recordedStates.laserShow=!0)}hideScanRegionLaser(){this._divScanLight&&(this._divScanLight.style.display="none",this._recordedStates.laserShow=!1)}_checkValidRegion(r){return!(r!==null&&(!r||!(r.hasOwnProperty("regionLeft")&&r.hasOwnProperty("regionTop")&&r.hasOwnProperty("regionRight")&&r.hasOwnProperty("regionBottom")&&r.hasOwnProperty("regionMeasuredByPercentage"))||r.regionLeft<0||r.regionTop<0||r.regionRight<0||r.regionBottom<0||r.regionMeasuredByPercentage&&(r.regionLeft>100||r.regionTop>100||r.regionRight>100||r.regionBottom>100)))}set scanRegion(r){if(!this._checkValidRegion(r))throw new Error("Invalid region.");this._scanRegion=JSON.parse(JSON.stringify(r)),this._updateScanRegionCanvas(),this._updateScanAreaDiv();for(let u of this._arrScanRegionOverlays)u&&this._updateScanRegionOverlay(u)}setScanRegion(r){this.scanRegion=r}getScanRegion(){return JSON.parse(JSON.stringify(this._scanRegion))}_calculateCvsSize(){if(!this._bOpen)return null;let r,u,_;if(this.singleFrameMode)r=this._imgWidth,u=this._imgHeight,_="contain";else{if(!this._video)return null;r=this._video.videoWidth,u=this._video.videoHeight,_=this.getVideoFit()}return{width:r,height:u,objectFit:_}}addScanRegionOverlayCanvas(){this._assertOpen();let r=document.createElement("canvas");if(this._updateScanRegionOverlay(r),!this._scanRegionOverlayContainer){let u=document.createElement("div");if(this._scanRegionOverlayContainer=u,u.style.position="absolute",u.style.left="0",u.style.top="0",u.style.width="100%",u.style.height="100%",u.style.overflow="hidden",u.style.pointerEvents="none",this._layerBaseCvs)this._layerBaseCvs.parentElement.after(u);else if(this._cvsScanRegion)this._cvsScanRegion.before(u);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(u);else{if(!this._video)throw new Error("'video' is null.");this._video.after(u)}this._recordedStates.overlayShow=!0}return this._scanRegionOverlayContainer.append(r),this._arrScanRegionOverlays.push(r),r}removeScanRegionOverlayCanvas(r){let u=this._arrScanRegionOverlays.indexOf(r);u!==-1&&(r.remove(),this._arrScanRegionOverlays.splice(u,1))}_updateScanRegionOverlay(r){if(!r)return;let u=this._calculateCvsSize();if(!u)return;let{width:_,height:v,objectFit:S}=u;if(_<=0||v<=0)return r.width=0,void(r.height=0);let m=this._getRegionInPixels(_,v,this._scanRegion),w=this.getFrameSize(_,v,this._scanRegion,this.maxCvsSideLength),E=w.dWidth,x=w.dHeight;r.width==E&&r.height==x||(r.width=E,r.height=x);let A=window.getComputedStyle(this._video),D=parseFloat(A.width),I=parseFloat(A.height),z=D/I,se=_/v,ee,q,te,ce,K=1;S==="contain"?(z<se?(K=D/_,ee=0,q=(I-v*K)/2):(K=I/v,ee=(D-_*K)/2,q=0),ee+=m.regionLeft*K,q+=m.regionTop*K,te=(m.regionRight-m.regionLeft)*K,ce=(m.regionBottom-m.regionTop)*K):S==="cover"?(se>z?(K=I/v,ee=m.regionLeft*K-(_*K-D)/2,q=m.regionTop*K):(K=D/_,ee=m.regionLeft*K,q=m.regionTop*K-(v*K-I)/2),te=(m.regionRight-m.regionLeft)*K,ce=(m.regionBottom-m.regionTop)*K):(ee=0,q=0,te=0,ce=0),r.style.position="absolute",r.style.left=ee+"px",r.style.top=q+"px",r.style.width=te+"px",r.style.height=ce+"px"}showScanRegionOverlays(){this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.style.display=="none"&&(this._scanRegionOverlayContainer.style.display=""),this._recordedStates.overlayShow=!0)}hideScanRegionOverlays(){this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.style.display="none",this._recordedStates.overlayShow=!1)}setViewDecorator(r,u){if(!r)return void(this._cvsViewDecorator&&(this._cvsViewDecorator.remove(),this._cvsViewDecorator=null));this._assertOpen();let _=[];if(typeof r=="string"?_.push(r):Array.isArray(r)&&(_=JSON.parse(JSON.stringify(r))),!this._cvsViewDecorator){if(this._cvsViewDecorator=document.createElement("canvas"),this._cvsViewDecorator.style.pointerEvents="none",this._cvsScanRegion)this._cvsScanRegion.after(this._cvsViewDecorator);else if(this._scanRegionOverlayContainer)this._scanRegionOverlayContainer.after(this._cvsViewDecorator);else if(this._layerBaseCvs)this._layerBaseCvs.parentElement.after(this._cvsViewDecorator);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(this._cvsViewDecorator);else{if(!this._video)throw new Error("'video' is null.");this._video.after(this._cvsViewDecorator)}this._recordedStates.decoratorShow=!0}this._decoratorArea=JSON.parse(JSON.stringify(u)),this._decoratorType.length=0;let v=["rectangle","focus"],S=["crossline","crosshair"],m=!1,w=!1;for(let E of _)E=E.toLowerCase(),v.includes(E)&&!m&&(m=!0,this._decoratorType.push(E)),S.includes(E)&&!w&&(w=!0,!this._decoratorType.includes(E)&&this._decoratorType.push(E));this._updateViewDecorator()}getViewDecorator(){return{type:JSON.parse(JSON.stringify(this._decoratorType)),area:JSON.parse(JSON.stringify(this._decoratorArea)),canvas:this._cvsViewDecorator}}showViewDecorator(){this._cvsViewDecorator&&(this._cvsViewDecorator.style.display=="none"&&(this._cvsViewDecorator.style.display=""),this._recordedStates.decoratorShow=!0)}hideViewDecorator(){this._cvsViewDecorator&&(this._cvsViewDecorator.style.display="none",this._recordedStates.decoratorShow=!1)}setViewDecoratorLineWidth(r,u){if(typeof r!="string")throw new Error("The 'type' should be a string.");if(r=r.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(r))throw new Error(`The type of '${r}' doesn't exist.`);if(!this._viewDecoratorInfo[r].hasOwnProperty("lineWidth"))throw new Error(`It is not allowed to change the property 'lineWidth' when the decorator type is '${r}'.`);this._viewDecoratorInfo[r].lineWidth=u,this._updateViewDecorator()}setViewDecoratorStrokeStyle(r,u){if(typeof r!="string")throw new Error("The 'type' should be a string.");if(r=r.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(r))throw new Error(`The type of '${r}' doesn't exist.`);if(!this._viewDecoratorInfo[r].hasOwnProperty("strokeStyle"))throw new Error(`It is not allowed to change the property 'strokeStyle' when the decorator type is '${r}'.`);this._viewDecoratorInfo[r].strokeStyle=u,this._updateViewDecorator()}setViewDecoratorFillStyle(r,u){if(typeof r!="string")throw new Error("The 'type' should be a string.");if(r=r.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(r))throw new Error(`The type of '${r}' doesn't exist.`);if(!this._viewDecoratorInfo[r].hasOwnProperty("fillStyle"))throw new Error(`It is not allowed to change the property 'fillStyle' when the decorator type is '${r}'.`);this._viewDecoratorInfo[r].fillStyle=u,this._updateViewDecorator()}setViewDecoratorMaskFillStyle(r,u){if(typeof r!="string")throw new Error("The 'type' should be a string.");if(r=r.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(r))throw new Error(`The type of '${r}' doesn't exist.`);if(!this._viewDecoratorInfo[r].hasOwnProperty("maskFillStyle"))throw new Error(`It is not allowed to change the property 'maskFillStyle' when the decorator type is '${r}'.`);this._viewDecoratorInfo[r].maskFillStyle=u,this._updateViewDecorator()}_updateViewDecorator(){if(!this._bOpen||!this._cvsViewDecorator||!this._decoratorArea)return;let r;if(this.singleFrameMode)r="contain";else{if(!this._video)return;r=this.getVideoFit()}let u=this._cvsViewDecorator;u.style.position="absolute",u.style.width="100%",u.style.height="100%",u.style.left="0",u.style.top="0",u.style.objectFit=r;let _=this.getVisibleRegion(!0),v=_.regionRight-_.regionLeft,S=_.regionBottom-_.regionTop;if(u.width==v&&u.height==S||(u.width=v,u.height=S),v<=0||S<=0)return;let m=u.getContext("2d");m.clearRect(0,0,u.width,u.height);let w=this._decoratorArea.x/100*v,E=this._decoratorArea.y/100*S,x=this._decoratorArea.width/100*v,A=this._decoratorArea.height/100*S;for(let D of this._decoratorType){if(D==="rectangle"){m.fillStyle=this._viewDecoratorInfo.rectangle.maskFillStyle,m.fillRect(0,0,u.width,u.height),m.clearRect(Math.round(w),Math.round(E),Math.round(x),Math.round(A)),m.fillStyle=this._viewDecoratorInfo.rectangle.fillStyle,m.fillRect(Math.round(w),Math.round(E),Math.round(x),Math.round(A)),m.lineWidth=this._viewDecoratorInfo.rectangle.lineWidth,m.strokeStyle=this._viewDecoratorInfo.rectangle.strokeStyle;let I=m.lineWidth/2;m.strokeRect(Math.round(w-I),Math.round(E-I),Math.round(x+m.lineWidth),Math.round(A+m.lineWidth))}if(D==="focus"){m.fillStyle=this._viewDecoratorInfo.focus.maskFillStyle,m.fillRect(0,0,u.width,u.height),m.clearRect(Math.round(w),Math.round(E),Math.round(x),Math.round(A)),m.fillStyle=this._viewDecoratorInfo.focus.fillStyle,m.fillRect(Math.round(w),Math.round(E),Math.round(x),Math.round(A)),m.lineWidth=this._viewDecoratorInfo.focus.lineWidth,m.strokeStyle=this._viewDecoratorInfo.focus.strokeStyle;let I=m.lineWidth/2,z=[0,.25,.75,1],se=[0,.25,.75,1];m.beginPath();for(let ee=0;ee<z.length;ee++)if(ee==0||ee==3)for(let q=0;q<se.length;q+=2)m.moveTo(Math.round(w+z[ee]*x),Math.round(E+se[q]*A)),m.lineTo(Math.round(w+z[ee]*x),Math.round(E+se[q+1]*A));for(let ee=0;ee<se.length;ee++)if(ee==0||ee==3)for(let q=0;q<z.length;q+=2)m.moveTo(Math.round(w+z[q]*x-I),Math.round(E+se[ee]*A)),m.lineTo(Math.round(w+z[q+1]*x+I),Math.round(E+se[ee]*A));m.stroke()}if(D==="crossline"&&(m.beginPath(),m.lineWidth=this._viewDecoratorInfo.crossline.lineWidth,m.strokeStyle=this._viewDecoratorInfo.crossline.strokeStyle,m.moveTo(Math.round(w),Math.round(E+A/2)),m.lineTo(Math.round(w+x),Math.round(E+A/2)),m.moveTo(Math.round(w+x/2),Math.round(E)),m.lineTo(Math.round(w+x/2),Math.round(E+A)),m.stroke()),D==="crosshair"){m.beginPath();let I=.05*Math.min(x,A);m.lineWidth=this._viewDecoratorInfo.crosshair.lineWidth,m.strokeStyle=this._viewDecoratorInfo.crosshair.strokeStyle,m.moveTo(Math.round(w+(x-I)/2),Math.round(E+A/2)),m.lineTo(Math.round(w+(x+I)/2),Math.round(E+A/2)),m.moveTo(Math.round(w+x/2),Math.round(E+(A-I)/2)),m.lineTo(Math.round(w+x/2),Math.round(E+(A+I)/2)),m.stroke()}}}getVisibleRegion(r){this._assertOpen();let u=this._calculateCvsSize();if(!u)return null;let{width:_,height:v,objectFit:S}=u,m=(()=>{let w=parseFloat(window.getComputedStyle(this._video).width),E=parseFloat(window.getComputedStyle(this._video).height),x,A={regionBottom:v,regionRight:_,regionLeft:0,regionTop:0,regionMeasuredByPercentage:!1};return S==="cover"?w/E<_/v?(x=E/v,A.regionLeft=Math.floor((_-w/x)/2),A.regionRight=Math.ceil(_-A.regionLeft),A.regionTop=0,A.regionBottom=v):(x=w/_,A.regionTop=Math.floor((v-E/x)/2),A.regionBottom=Math.ceil(v-A.regionTop),A.regionLeft=0,A.regionRight=_):S==="none"&&(w<_&&E<v?(A.regionLeft=Math.floor((_-w)/2),A.regionRight=Math.ceil(_-A.regionLeft),A.regionTop=Math.floor((v-E)/2),A.regionBottom=Math.ceil(v-A.regionTop)):w<_?(A.regionLeft=Math.floor((_-w)/2),A.regionRight=Math.ceil(_-A.regionLeft),A.regionTop=0,A.regionBottom=v):E<v&&(A.regionTop=Math.floor((v-E)/2),A.regionBottom=Math.ceil(v-A.regionTop),A.regionLeft=0,A.regionRight=_)),A})();return r?m.regionMeasuredByPercentage=!1:(m.regionBottom=Math.ceil(m.regionBottom/v*100),m.regionRight=Math.ceil(m.regionRight/_*100),m.regionLeft=Math.floor(m.regionLeft/_*100),m.regionTop=Math.floor(m.regionTop/v*100),m.regionMeasuredByPercentage=!0),m}setScanRegionMaskStyle(r){r&&(r.fillStyle&&(this.regionMaskFillStyle=r.fillStyle),r.strokeStyle&&(this.regionMaskStrokeStyle=r.strokeStyle),r.lineWidth&&(this.regionMaskLineWidth=r.lineWidth),this._updateScanRegionCanvas())}_getRegionInPixels(r,u,_){if(!(r<=0||u<=0))return _?_.regionMeasuredByPercentage?{regionLeft:Math.round(_.regionLeft/100*r),regionTop:Math.round(_.regionTop/100*u),regionRight:Math.round(_.regionRight/100*r),regionBottom:Math.round(_.regionBottom/100*u),regionMeasuredByPercentage:!1}:JSON.parse(JSON.stringify(_)):{regionLeft:0,regionTop:0,regionRight:r,regionBottom:u,regionMeasuredByPercentage:!1}}_updateScanRegionCanvas(){if(!this._bOpen)return;let r=this._calculateCvsSize();if(!r)return;let{width:u,height:_,objectFit:v}=r;if(u<=0||_<=0)return void(this._cvsScanRegion&&(this._cvsScanRegion.width=0,this._cvsScanRegion.height=0));let S=this._getRegionInPixels(u,_,this._scanRegion);this._cvsScanRegion||(this._cvsScanRegion=document.createElement("canvas"),this._cvsScanRegion.style.pointerEvents="none",this._scanRegionOverlayContainer?this._scanRegionOverlayContainer.after(this._cvsScanRegion):this._layerBaseCvs?this._layerBaseCvs.parentElement.after(this._cvsScanRegion):this._cvsSingleFrameMode?this._cvsSingleFrameMode.after(this._cvsScanRegion):this._video.after(this._cvsScanRegion),this._recordedStates.maskShow=!0);let m=this._cvsScanRegion;m.style.position="absolute",m.style.width="100%",m.style.height="100%",m.style.left="0",m.style.top="0",m.style.objectFit=v,m.width==u&&m.height==_||(m.width=u,m.height=_);let w=m.getContext("2d");if(w.clearRect(0,0,m.width,m.height),S.regionLeft!=0||S.regionRight!=u||S.regionTop!=0||S.regionBottom!=_){let E=S.regionLeft,x=S.regionTop,A=S.regionRight-S.regionLeft,D=S.regionBottom-S.regionTop;w.fillStyle=this.regionMaskFillStyle,w.fillRect(0,0,m.width,m.height),w.clearRect(Math.round(E),Math.round(x),Math.round(A),Math.round(D)),w.strokeStyle=this.regionMaskStrokeStyle,w.lineWidth=this.regionMaskLineWidth;let I=w.lineWidth/2;w.strokeRect(Math.round(E-I),Math.round(x-I),Math.round(A+w.lineWidth),Math.round(D+w.lineWidth))}}_updateScanAreaDiv(){if(!this._bOpen)return;let r=this._calculateCvsSize();if(!r)return;let{width:u,height:_,objectFit:v}=r;if(!this._divScanArea)return;if(u<=0||_<=0)return this._divScanArea.style.width="0",void(this._divScanArea.style.height="0");let S=this._getRegionInPixels(u,_,this._scanRegion),m=window.getComputedStyle(this._video),w=parseFloat(m.width),E=parseFloat(m.height),x=w/E,A=u/_,D,I,z,se,ee=1;if(v==="contain")x<A?(ee=w/u,D=0,I=(E-_*ee)/2):(ee=E/_,D=(w-u*ee)/2,I=0),D+=S.regionLeft*ee,I+=S.regionTop*ee,z=(S.regionRight-S.regionLeft)*ee,se=(S.regionBottom-S.regionTop)*ee;else if(v==="cover")if(x<A){ee=E/_,D=S.regionLeft*ee-(u*ee-w)/2,D=Math.max(D,0),D=Math.min(D,parseFloat(m.width)),I=S.regionTop*ee;let q=S.regionRight*ee-(u*ee-w)/2;q=Math.max(q,0),q=Math.min(q,parseFloat(m.width)),z=q-D,se=(S.regionBottom-S.regionTop)*ee}else{ee=w/u,D=S.regionLeft*ee,I=S.regionTop*ee-(_*ee-E)/2,I=Math.max(I,0),I=Math.min(I,parseFloat(m.height));let q=S.regionBottom*ee-(_*ee-E)/2;q=Math.max(q,0),q=Math.min(q,parseFloat(m.height)),z=(S.regionRight-S.regionLeft)*ee,se=q-I}else D=0,I=0,z=0,se=0;this._divScanArea.style.left=D+"px",this._divScanArea.style.top=I+"px",this._divScanArea.style.width=z+"px",this._divScanArea.style.height=se+"px"}set croppingRegions(r){this._croppingRegions=r,this._bFetchingLoopStarted&&(this.bIncreaseRegionIndexAuto&&(this._croppingRegionIndex=0),this._fetchingLoop(!1))}get croppingRegions(){if(this._croppingRegions!==void 0)return this._croppingRegions;if(this._controler){let r=this._controler.getPropertyDisiredValue("croppingRegions");if(r&&r.length===1)return r[0]}return this._defaultCroppingRegions}set croppingRegionIndex(r){r<0?(this.bIncreaseRegionIndexAuto=!0,this._croppingRegionIndex=0):(this.bIncreaseRegionIndexAuto=!1,this._croppingRegionIndex=r)}get croppingRegionIndex(){return this._croppingRegionIndex}set loopInterval(r){if(r<0)throw new Error("'Invalid value.");this._loopInterval=r,this._bFetchingLoopStarted&&this._fetchingLoop(!1)}get loopInterval(){if(this._loopInterval!==void 0)return this._loopInterval;if(this._controler){let r=this._controler.getPropertyDisiredValue("loopInterval");if(r&&r.length===1)return r[0]}return this._defaultLoopInterval}set maxNumberOfFramesInBuffer(r){if(r<=0)throw new Error("Invalid value.");for(this._maxNumberOfFramesInBuffer=r;this._frameQueue&&this._frameQueue.length>this.maxNumberOfFramesInBuffer;)this._frameQueue.shift()}get maxNumberOfFramesInBuffer(){if(this._maxNumberOfFramesInBuffer!==void 0)return this._maxNumberOfFramesInBuffer;if(this._controler){let r=this._controler.getPropertyDisiredValue("maxNumberOfFramesInBuffer");if(r&&r.length===1)return r[0]}return this._defaultMaxNumberOfFramesInBuffer}get numberOfFramesInBuffer(){return this._frameQueue.length}set refreshInterval(r){this._refreshInterval=r}get refreshInterval(){if(this._refreshInterval!==void 0)return this._refreshInterval;if(this._controler){let r=this._controler.getPropertyDisiredValue("refreshInterval");if(r&&r.length===1)return r[0]}return this._defaultRefreshInterval}static createInstance(r){return ye(this,void 0,void 0,function*(){let u=new ae;(typeof r=="string"||r instanceof String)&&(r=JSON.parse(r));for(let _ in r)u[_]=r[_];return this._hasEngineResourceLoaded=!0,ae.onWarning&&(location&&location.protocol==="file:"?setTimeout(()=>{ae.onWarning&&ae.onWarning({id:1,message:"Not using HTTP protocol, the SDK may not work correctly."})},0):location&&location.protocol!=="https:"&&setTimeout(()=>{ae.onWarning&&ae.onWarning({id:2,message:"Not connected via SSL (HTTPS), the SDK may not work correctly."})},0)),u._drawingLayersManager=new Xt,u})}play(r,u,_,v){return ye(this,void 0,void 0,function*(){if(this._video&&this.videoSrc){yield new Promise((I,z)=>{this._video.onloadedmetadata=()=>ye(this,void 0,void 0,function*(){this._video&&(this._video.onloadedmetadata=null,yield this._video.play(),I())}),typeof this.videoSrc=="string"||this.videoSrc instanceof String?this._video.src=this.videoSrc:this._video.srcObject=this.videoSrc,setTimeout(()=>z(new Error("Failed to play video. Timeout.")),4e3)});let A={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};this.playCallbackInfo=JSON.parse(JSON.stringify(A));let D=this.mapCameraEvents.get("played");for(let I of D){if(!I)continue;let z=JSON.parse(JSON.stringify(A));setTimeout(()=>I.apply(this,[z]),0)}return this._recordedStates.videoPlaying=!0,A}if(this.singleFrameMode)return v&&v.notTriggerSingleFrameClick||this._clickIptSingleFrameMode(),this.playCallbackInfo={width:0,height:0,deviceId:null},JSON.parse(JSON.stringify(this.playCallbackInfo));if(!this._video)return this.playCallbackInfo=null,null;let S=++this.iPlayRound,m=null,w=0,E=0;if(this._currentCamera&&(m=this._currentCamera.deviceId),this._video&&(w=this._video.videoWidth,E=this._video.videoHeight),this.promisePlay&&(yield this.promisePlay,S<this.iPlayRound))return this.playCallbackInfo={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId},JSON.parse(JSON.stringify(this.playCallbackInfo));this.promisePlay=(()=>ye(this,void 0,void 0,function*(){var A;try{let fe=function(ne){return ye(this,void 0,void 0,function*(){for(let n of ce){D(),n&&(yield new Promise(i=>setTimeout(i,n))),D();{let i=ne.video.deviceId;Q=i?i.exact||i.ideal||i:null}try{ae._onLog&&ae._onLog("DCE: ask "+JSON.stringify(ne)),q=yield navigator.mediaDevices.getUserMedia(ne),D();break}catch(i){K=i,ae._onLog&&ae._onLog("DCE: "+i.message||i)}}})};this._video&&this._video.srcObject&&this.stop(),ae._onLog&&ae._onLog("DCE: ======before video========");let D=()=>{if(!this._video)throw q&&q.getTracks().forEach(ne=>{ne.stop()}),this._videoTrack=null,this._currentCamera=null,new Error("'video' is null.")},I=this.getVideoSettings(),z;typeof I.video=="boolean"&&(I.video={});let se=["rear","back","r\xFCck","arri\xE8re","trasera","tr\xE1s","traseira","posteriore","\u540E\u9762","\u5F8C\u9762","\u80CC\u9762","\u540E\u7F6E","\u5F8C\u7F6E","\u80CC\u7F6E","\u0437\u0430\u0434\u043D\u0435\u0439","\u0627\u0644\u062E\u0644\u0641\u064A\u0629","\uD6C4","arka","achterzijde","\u0E2B\u0E25\u0E31\u0E07","baksidan","bagside","sau","bak","tylny","takakamera","belakang","\u05D0\u05D7\u05D5\u05E8\u05D9\u05EA","\u03C0\u03AF\u03C3\u03C9","spate","h\xE1ts\xF3","zadn\xED","darrere","zadn\xE1","\u0437\u0430\u0434\u043D\u044F","stra\u017Enja","belakang","\u092C\u0948\u0915"],ee=()=>{for(let ne of this._allCameras){let n=ne.label.toLowerCase();if(n&&se.some(i=>n.indexOf(i)!=-1)&&/\b0(\b)?/.test(n)){delete I.video.facingMode,I.video.deviceId={ideal:ne.deviceId};break}}I.video.deviceId||["Android","HarmonyOS"].indexOf(be.OS)==-1||(delete I.video.facingMode,I.video.deviceId={ideal:this._allCameras[this._allCameras.length-1].deviceId})};if(r)delete I.video.facingMode,I.video.deviceId={exact:r};else if(!I.video.deviceId){if(this._lastDeviceId)delete I.video.facingMode,I.video.deviceId={exact:this._lastDeviceId};else if(this.ifSaveLastUsedCamera&&ae.isStorageAvailable&&window.localStorage.getItem("dce_last_camera_id")){delete I.video.facingMode,I.video.deviceId={exact:window.localStorage.getItem("dce_last_camera_id")};let ne=JSON.parse(window.localStorage.getItem("dce_last_apply_width")),n=JSON.parse(window.localStorage.getItem("dce_last_apply_height"));ne&&n&&(I.video.width=ne,I.video.height=n)}else if(!this.ifSkipCameraInspection){if(I.video.facingMode){if(be.OS!=="iPhone"&&be.OS!=="Mac"&&(yield this.getAllCameras(!0)),!this._video)return null;let ne=I.video.facingMode;ne instanceof Array&&ne.length&&(ne=ne[0]),ne=ne.exact||ne.ideal||ne,ne==="environment"&&(z=!!I.video.facingMode,ee())}}}let q;u&&(I.video.width={ideal:u}),_&&(I.video.height={ideal:_}),ae._onLog&&ae._onLog("DCE: ======try getUserMedia========");let te,ce=[0,500],K=null,Q=null;if(yield fe(I),q||(ae._onLog&&ae._onLog("DCE: ======try getUserMedia again========"),te=JSON.parse(JSON.stringify(I)),typeof te.video=="object"&&(be.OS=="iPhone"?(u>=1280||_>=1280?te.video.width=1280:u>=640||_>=640?te.video.width=640:(u<640||_<640)&&(te.video.width=320),delete te.video.height):z&&!I.video.deviceId?(delete te.video.facingMode,this._allCameras.length&&(te.video.deviceId={ideal:this._allCameras[this._allCameras.length-1].deviceId})):te.video=!0),ae._onLog&&ae._onLog("DCE: "+te),yield fe(te)),q||(ce=[1e3,2e3],yield fe(I)),q||(yield fe(te)),!q)throw K;let J=()=>{let ne=q.getVideoTracks(),n,i;if(ne.length&&(n=this._videoTrack=ne[0]),this._video&&n){let s=n.getSettings();if(s){for(let l of this._allCameras)if(s.deviceId===l.deviceId){l._checked=!0,l.label=n.label,i=l;break}}if(!i&&Q){for(let l of this._allCameras)if(Q==l.deviceId){n.label&&(l._checked=!0,l.label=n.label),i=l;break}}}this._currentCamera=i};if(yield this.getAllCameras(!0),D(),z){J(),ee();let ne=I.video.deviceId;ne&&(ne=ne.exact||ne.ideal||ne);let n=(A=this._currentCamera)===null||A===void 0?void 0:A.deviceId;!ne||n&&ne==n||(q.getTracks().forEach(i=>{i.stop()}),ce=[0,500,1e3,2e3],yield fe(I))}D(),yield(()=>ye(this,void 0,void 0,function*(){ae._onLog&&ae._onLog("======play video========"),yield new Promise((ne,n)=>{D(),this._video.onloadedmetadata=()=>ye(this,void 0,void 0,function*(){D(),this._video.onloadedmetadata=null,yield this._video.play(),ne()}),this._video.srcObject=q,setTimeout(()=>n(new Error("Failed to play video. Timeout.")),4e3)})}))(),D(),ae._onLog&&ae._onLog("DCE: ======played video========"),this._bgLoading&&(this._bgLoading.style.animationPlayState="paused");let g=this._video.videoWidth+"x"+this._video.videoHeight;this._optGotRsl&&(this._optGotRsl.setAttribute("data-width",this._video.videoWidth),this._optGotRsl.setAttribute("data-height",this._video.videoHeight),this._optGotRsl.innerText=g,this._selRsl&&this._optGotRsl.parentNode==this._selRsl&&(this._selRsl.value="got")),ae._onLog&&ae._onLog("DCE: got "+g),J(),D(),this._renderSelCameraInfo();let pe={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};pe.deviceId&&(this._lastDeviceId=pe.deviceId,this.ifSaveLastUsedCamera&&ae.isStorageAvailable&&(window.localStorage.setItem("dce_last_camera_id",this._lastDeviceId),I.video.width&&I.video.height&&(window.localStorage.setItem("dce_last_apply_width",JSON.stringify(I.video.width)),window.localStorage.setItem("dce_last_apply_height",JSON.stringify(I.video.height)))));let re=this.mapCameraEvents.get("played");for(let ne of re){if(!ne)continue;let n=JSON.parse(JSON.stringify(pe));setTimeout(()=>ne.apply(this,[n]),0)}if(m&&m!=pe.deviceId){let ne=this.mapCameraEvents.get("cameraChange");for(let n of ne){if(!n)continue;let i=JSON.parse(JSON.stringify(pe));setTimeout(()=>n.apply(this,[i]),0)}}if(w&&E&&(w!=pe.width||E!=pe.height)){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let n of this._arrScanRegionOverlays)n&&this._updateScanRegionOverlay(n);this._cvsOriginalImage||this._updateDrawingLayersSize();let ne=this.mapCameraEvents.get("resolutionChange");for(let n of ne){if(!n)continue;let i=JSON.parse(JSON.stringify(pe));setTimeout(()=>n.apply(this,[i]),0)}}return this.promisePlay=null,pe}catch(D){throw this.promisePlay=null,this._bgLoading&&(this._bgLoading.style.display="none"),D.name==="NotFoundError"&&(DOMException?D=new DOMException("No camera available, please use a device with an accessible camera.",D.name):(D=new Error("No camera available, please use a device with an accessible camera.")).name="NotFoundError"),D}}))();let x=yield this.promisePlay;return this.playCallbackInfo=JSON.parse(JSON.stringify(x)),this._recordedStates.videoPlaying=!0,x})}resume(){return ye(this,void 0,void 0,function*(){this._assertOpen(),yield this.play(),this.ifShowScanRegionLaser&&this.showScanRegionLaser()})}pause(){this._assertOpen(),this._video&&(this._video.pause(),this._recordedStates.videoPlaying=!1),this.ifShowScanRegionLaser&&this.hideScanRegionLaser()}_bindUI(){if(!this.UIElement)throw new Error("Need to define `UIElement` before opening.");let r=[this.UIElement];for(let u=0;u<r.length;++u)for(let _ of r[u].children)r.push(_);for(let u of r){if(!this._video&&u.classList.contains("dce-video-container")){this._divVideoContainer=u;let _=document.createElement("video");_.style.position="absolute",_.style.left="0",_.style.top="0",_.style.width="100%",_.style.height="100%",_.style.objectFit=this.getVideoFit(),_.setAttribute("playsinline","true"),_.setAttribute("muted","true"),u.prepend(_),this._video=_}else!this._divScanArea&&u.classList.contains("dce-scanarea")?this._divScanArea=u:!this._divScanLight&&u.classList.contains("dce-scanlight")?this._divScanLight=u:!this._bgLoading&&u.classList.contains("dce-bg-loading")?this._bgLoading=u:!this._bgCamera&&u.classList.contains("dce-bg-camera")?this._bgCamera=u:!this._selCam&&u.classList.contains("dce-sel-camera")?this._selCam=u:!this._selRsl&&u.classList.contains("dce-sel-resolution")?(this._selRsl=u,this.videoSrc||this.singleFrameMode||this._selRsl.options.length||(this._selRsl.innerHTML=[this._optGotRsl?"":'<option class="dce-opt-gotResolution" value="got"></option>','<option data-width="3840" data-height="2160">3840x2160</option>','<option data-width="1920" data-height="1080">1920x1080</option>','<option data-width="1280" data-height="720">1280x720</option>'].join(""),this._optGotRsl=this._optGotRsl||this._selRsl.options[0])):!this._optGotRsl&&u.classList.contains("dce-opt-gotResolution")?this._optGotRsl=u:!this._btnClose&&u.classList.contains("dce-btn-close")?this._btnClose=u:!this._selMinLtr&&u.classList.contains("dlr-sel-minletter")?(this._selMinLtr=u,this._selMinLtr.options.length||(this._selMinLtr.innerHTML=[this._optGotMinLtr?"":'<option class="dlr-opt-gotMinLtr" value="got"></option>','<option value="0" selected>any letter</option>','<option value="3">3+ letters</option>','<option value="5">5+ letters</option>','<option value="8">8+ letters</option>','<option value="12">12+ letters</option>','<option value="17">17+ letters</option>','<option value="30">30+ letters</option>','<option value="50">50+ letters</option>','<option value="80">80+ letters</option>','<option value="120">120+ letters</option>'].join(""),this._optGotMinLtr=this._optGotMinLtr||this._selMinLtr.options[0])):!this._optGotMinLtr&&u.classList.contains("dlr-opt-gotMinLtr")&&(this._optGotMinLtr=u);if(this.extraBindings&&this.extraBindings.length)for(let _ of this.extraBindings)try{_(u)}catch(v){}}if(!this._video)throw this._unbindUI(),Error("Can not find the video container element with class 'dce-video-container'");this.singleFrameMode?(this._video&&(this._video.addEventListener("click",this._clickIptSingleFrameMode),this._video.style.cursor="pointer",this._video.setAttribute("title","Take a photo")),this._selCam&&(this._selCam.style.display="none"),this._selRsl&&(this._selRsl.style.display="none"),this._selMinLtr&&(this._selMinLtr.style.display="none"),this._bgCamera&&(this._bgCamera.style.display="block")):(this._selCam&&(this._selCam.style.display="block",this._selCam.addEventListener("change",this._onCameraSelChange)),this._selRsl&&(this._selRsl.style.display="block",this._selRsl.addEventListener("change",this._onResolutionSelChange)),this._selMinLtr&&(this._selMinLtr.style.display="block"),this._bgLoading&&(this._bgLoading.style.display="block")),this._btnClose&&this._btnClose.addEventListener("click",this._onCloseBtnClick),document.addEventListener("visibilitychange",this._ev_documentHideEvent),window.ResizeObserver?(this._resizeObserver||(this._resizeObserver=new ResizeObserver(u=>{for(let _ of u)_.target===this._divVideoContainer&&this._updateLayers()})),this._divVideoContainer&&this._resizeObserver.observe(this._divVideoContainer)):window.addEventListener("resize",this._updateLayers)}_unbindUI(){this.singleFrameMode?(this._video&&(this._video.removeEventListener("click",this._clickIptSingleFrameMode),this._video.style.cursor="",this._video.removeAttribute("title")),this._bgCamera&&(this._bgCamera.style.display="none")):this._bgLoading&&(this._bgLoading.style.display="none"),this._selCam&&this._selCam.removeEventListener("change",this._onCameraSelChange),this._selRsl&&this._selRsl.removeEventListener("change",this._onResolutionSelChange),this._btnClose&&this._btnClose.removeEventListener("click",this._onCloseBtnClick),this.hideScanRegionLaser(),this.hideViewDecorator(),this.hideScanRegionOverlays(),this._drawingLayersManager.setVisible(!1),this._hideOriginalImageCvs(),this._video&&(this._video.onloadedmetadata=null,this._video.remove()),this._divVideoContainer=null,this._video=null,this._selCam=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._selMinLtr=null,this._optGotMinLtr=null,this._divScanArea=null,this._divScanLight=null,this._cvsScanRegion&&(this._cvsScanRegion.remove(),this._cvsScanRegion=null),this._singleFrameModeIpt&&(this._singleFrameModeIpt.remove(),this._singleFrameModeIpt=null),this._cvsSingleFrameMode&&(this._cvsSingleFrameMode.remove(),this._cvsSingleFrameMode=null),document.removeEventListener("visibilitychange",this._ev_documentHideEvent),window.ResizeObserver?this._resizeObserver&&this._resizeObserver.disconnect():window.removeEventListener("resize",this._updateLayers)}_assertOpen(){if(!this._bOpen)throw Error("The camera is not open.")}open(r){return ye(this,void 0,void 0,function*(){this.UIElement||(yield this.setUIElement(ae.defaultUIElementURL)),this._bindUI(),r&&this.appendAndShowUI();let u=yield this.play();this.bOpen=!0;let _=this.mapCameraEvents.get("cameraOpen");for(let v of _){if(!v)continue;let S=JSON.parse(JSON.stringify(u));setTimeout(()=>v.apply(this,[S]),0)}return u})}close(r){if(!this._video)return;this.stop(),this._hideOriginalImage(!1),this._unbindUI(),r&&this.hideUI(),this.stopFetchingLoop(),this.bOpen=!1;let u=this.mapCameraEvents.get("cameraClose");for(let _ of u){if(!_)continue;let v={width:0,height:0,deviceId:null};setTimeout(()=>_.apply(this,[v]),0)}}stop(){this._video&&this._video.srcObject&&(ae._onLog&&ae._onLog("DCE: ======stop video========"),this._video.srcObject.getTracks().forEach(r=>{r.stop()}),this._video.srcObject=null,this._videoTrack=null,this._currentCamera=null),this._video&&this.videoSrc&&(ae._onLog&&ae._onLog("DCE: ======stop existing video========"),this._video.pause(),this._video.currentTime=0),this._bgLoading&&(this._bgLoading.style.animationPlayState=""),this._frameQueue.length=0,this._reusedCvs&&this._reusedCvs.ctx2d&&this._reusedCvs.ctx2d.clearRect(0,0,this._reusedCvs.width,this._reusedCvs.height),this.forceLoseContext()}getAllCameras(r){return ye(this,void 0,void 0,function*(){let u=yield navigator.mediaDevices.enumerateDevices();if(!r&&u&&u.length&&!u[0].deviceId){let S=yield navigator.mediaDevices.getUserMedia({video:!0});u=yield navigator.mediaDevices.enumerateDevices(),S.getTracks().forEach(m=>{m.stop()}),S=null}let _=[],v=[];if(this._allCameras)for(let S of this._allCameras)S._checked&&v.push(S);for(let S=0;S<u.length;S++){let m,w=u[S];if(w.kind=="videoinput"){for(let E of v)w.deviceId==E.deviceId&&(m=E);m||(m={},m.deviceId=w.deviceId,m.label=w.label?w.label:"camera "+S),_.push(m)}}return this._allCameras=_,ae._onLog&&ae._onLog("DCE: "+JSON.stringify(this._allCameras)),Promise.resolve(_)})}_renderSelCameraInfo(){if(this._selCam&&(this._selCam.innerHTML=""),this._selCam){let r;for(let u of this._allCameras){let _=document.createElement("option");_.value=u.deviceId,_.innerText=u.label,this._selCam.append(_),u.deviceId&&this._currentCamera&&this._currentCamera.deviceId==u.deviceId&&(r=_)}this._selCam.value=r?r.value:""}}getSelectedCamera(){if(!this._bOpen){let r="",u=this.videoSettings.video.deviceId;u&&(r=u.exact||u.ideal||u);for(let _ of this._allCameras)if(_.deviceId===r)return JSON.parse(JSON.stringify(_));return{deviceId:r,label:"",_checked:!1}}return this._currentCamera}selectCamera(r){return ye(this,void 0,void 0,function*(){let u="";return r&&(u=r.deviceId||r),this.videoSettings.video.deviceId={exact:u},this._bOpen?yield this.play(r.deviceId||r):null})}getResolution(){if(this._bOpen)return[this._video.videoWidth,this._video.videoHeight];{let r=0,u=0,_=this.videoSettings.video.width,v=this.videoSettings.video.height;return _&&(r=_.exact||_.ideal||_),v&&(u=v.exact||v.ideal||v),[r,u]}}setResolution(r,u){return ye(this,void 0,void 0,function*(){let _,v;return r instanceof Array?(_=r[0],v=r[1]):(_=r,v=u),this.videoSettings.video.width={ideal:_},this.videoSettings.video.height={ideal:v},this._bOpen?yield this.play(null,_,v):null})}getResolutions(r){return ye(this,void 0,void 0,function*(){let u="",_=(S,m)=>{let w=this._mapCameraResolutions.get(S);if(!w||!w.length)return!1;for(let E of w)if(E[0]===m.width&&E[1]===m.height)return!0;return!1},v=(S,m,w)=>ye(this,void 0,void 0,function*(){let E={video:{deviceId:{exact:S},width:{ideal:m},height:{ideal:w}}},x=null;try{x=yield navigator.mediaDevices.getUserMedia(E)}catch(I){return null}if(!x)return null;let A=x.getVideoTracks(),D=null;try{let I=A[0].getSettings();D={width:I.width,height:I.height}}catch(I){let z=document.createElement("video");z.srcObject=x,D={width:z.videoWidth,height:z.videoHeight},z.srcObject=null}return A.forEach(I=>{I.stop()}),D});if(!this._bOpen){let S=this.videoSettings.video.deviceId;if(!S||(u=S.hasOwnProperty("exact")?this.videoSettings.video.deviceId.exact:S.hasOwnProperty("ideal")?this.videoSettings.video.deviceId.ideal:this.videoSettings.video.deviceId,!u))return null;let m=this._mapCameraResolutions.get(u);if(m&&!r)return this._mapCameraResolutions.get(u);this._mapCameraResolutions.set(u,[]),m=this._mapCameraResolutions.get(u);for(let w of this._predefinedResolutions){let E=yield v(u,w.width,w.height);E&&!_(u,E)&&m.push([E.width,E.height])}return m}if(this._currentCamera){u=this._currentCamera.deviceId;let S=this._mapCameraResolutions.get(u);if(S&&!r)return this._mapCameraResolutions.get(u);this._mapCameraResolutions.set(u,[]),S=this._mapCameraResolutions.get(u);let m=this.getConstraints();for(let w of this._predefinedResolutions){yield this._videoTrack.applyConstraints({width:{ideal:w.width},height:{ideal:w.height}});let E=this._videoTrack.getSettings(),x={width:E.width,height:E.height};_(u,x)||S.push([x.width,x.height])}return yield this._videoTrack.applyConstraints(m),S}return null})}on(r,u){if(!this.mapCameraEvents.has(r))throw new Error(`Event '${r}' is not exists.`);let _=this.mapCameraEvents.get(r);_.includes(u)||_.push(u)}off(r,u){if(!this.mapCameraEvents.has(r))throw new Error(`Event '${r}' is not exists.`);let _=this.mapCameraEvents.get(r),v=_.indexOf(u);v!==-1&&_.splice(v,1)}offAll(r){if(r){if(typeof r=="string"){let u=this.mapCameraEvents.get(r);u&&(u.length=0)}}else for(let u of this.mapCameraEvents.values())u&&(u.length=0)}getVideoSettings(){return JSON.parse(JSON.stringify(this.videoSettings))}updateVideoSettings(r){return this.videoSettings=JSON.parse(JSON.stringify(r)),this._lastDeviceId=null,this._bOpen?this.play():Promise.resolve()}isOpen(){return this._bOpen}getCapabilities(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getCapabilities()' is unavailable in singleFrameMode.");return this._videoTrack&&this._videoTrack.getCapabilities?this._videoTrack.getCapabilities():{}}getCameraSettings(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getCameraSettings()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings():null}getConstraints(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getConstraints()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getConstraints():null}applyConstraints(r){return ye(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'applyConstraints()' is unavailable in singleFrameMode.");if(!this._videoTrack)throw new Error('"_videoTrack" is null.');if(!this._videoTrack.applyConstraints)throw Error("Not supported.");return yield this._videoTrack.applyConstraints(r)})}turnOnTorch(){return ye(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'turnOnTorch()' is unavailable in singleFrameMode.");if(this.getCapabilities().torch)return yield this._videoTrack.applyConstraints({advanced:[{torch:!0}]});throw Error("Not supported.")})}turnOffTorch(){return ye(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'turnOffTorch()' is unavailable in singleFrameMode.");if(this.getCapabilities().torch)return yield this._videoTrack.applyConstraints({advanced:[{torch:!1}]});throw Error("Not supported.")})}setColorTemperature(r){return ye(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setColorTemperature()' is unavailable in singleFrameMode.");let u=this.getCapabilities().colorTemperature;if(!u)throw Error("Not supported.");return r<u.min?r=u.min:r>u.max&&(r=u.max),yield this._videoTrack.applyConstraints({advanced:[{colorTemperature:r}]})})}setExposureCompensation(r){return ye(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setExposureCompensation()' is unavailable in singleFrameMode.");let u=this.getCapabilities().exposureCompensation;if(!u)throw Error("Not supported.");return r<u.min?r=u.min:r>u.max&&(r=u.max),yield this._videoTrack.applyConstraints({advanced:[{exposureCompensation:r}]})})}setZoom(r){return ye(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setZoom()' is unavailable in singleFrameMode.");let u=this.getCapabilities().zoom;if(!u)throw Error("Not supported.");return r<u.min?r=u.min:r>u.max&&(r=u.max),yield this._videoTrack.applyConstraints({advanced:[{zoom:r}]})})}setFrameRate(r){return ye(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setFrameRate()' is unavailable in singleFrameMode.");let u=this.getCapabilities().frameRate;if(!u)throw Error("Not supported.");return r<u.min?r=u.min:r>u.max&&(r=u.max),yield this._videoTrack.applyConstraints({width:{ideal:Math.max(this._video.videoWidth,this._video.videoHeight)},frameRate:r})})}getFrameRate(){return this.getCameraSettings().frameRate}setFocus(r,u){return ye(this,void 0,void 0,function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setFocus()' is unavailable in singleFrameMode.");let _=this.getCapabilities().focusMode,v=this.getCapabilities().focusDistance;if(!_||!_.includes(r)||!v)throw Error("Not supported.");return u?(u<v.min?u=v.min:u>v.max&&(u=v.max),yield this._videoTrack.applyConstraints({advanced:[{focusMode:r,focusDistance:u}]})):yield this._videoTrack.applyConstraints({advanced:[{focusMode:r}]})})}getFocus(){let r=this.getCameraSettings().focusMode;return r==="continuous"?{mode:r}:{mode:r,distance:this.getCameraSettings().focusDistance}}getFrameSize(r,u,_,v){if(!r||!u)return null;let S,m,w,E,x=r,A=u,D={regionLeft:0,regionTop:0,regionRight:x,regionBottom:A,regionMeasuredByPercentage:!1};_?(_.regionMeasuredByPercentage?(D.regionLeft=_.regionLeft*x/100,D.regionTop=_.regionTop*A/100,D.regionRight=_.regionRight*x/100,D.regionBottom=_.regionBottom*A/100):(D.regionLeft=_.regionLeft,D.regionTop=_.regionTop,D.regionRight=_.regionRight,D.regionBottom=_.regionBottom),S=D.regionLeft,m=D.regionTop,x=Math.round(D.regionRight-D.regionLeft),A=Math.round(D.regionBottom-D.regionTop)):(S=0,m=0);let I=Math.max(x,A);if(v&&v>0&&I>v){let z=v/I;x>A?(w=v,E=Math.round(A*z)):(w=Math.round(x*z),E=v)}else w=x,E=A;return w<=0||E<=0?null:{sx:S,sy:m,sWidth:x,sHeight:A,dWidth:w,dHeight:E}}getFrame(){if(this.singleFrameMode)throw Error("'getFrame()' is unavailable in singleFrameMode.");if(this._assertOpen(),this.singleFrameMode)throw new Error("'getFrame()' is unavailable in singleFrameMode.");return this._getVideoFrame(this._scanRegion)}getImage(){let r=this.getFrame();return r.pixelFormat=r.colorMode,Object.assign(Object.assign({},r),{pixelFormat:r.colorMode})}_getVideoFrame(r,u){if(this.isDisposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(this._assertOpen(),this.singleFrameMode)throw new Error("'_getVideoFrame()' is unavailable in singleFrameMode.");let _=Date.now();ae._onLog&&ae._onLog("DCE: _getVideoFrame() START: "+_);let v=this._video.videoWidth,S=this._video.videoHeight;if(v===0||S===0)return null;let m=this.getFrameSize(v,S,r,this.maxCvsSideLength);if(!m)return null;let w,E;w=v!==m.sWidth||S!==m.sHeight,E=m.sWidth!==m.dWidth||m.sHeight!==m.dHeight;let x=(()=>!(!this._bWebGLSupported||E))(),A={data:null,region:r?JSON.parse(JSON.stringify(r)):null,sx:m.sx,sy:m.sy,width:m.dWidth,height:m.dHeight,colorMode:null,timeSpent:null,timeStamp:null,isCropped:w,toCanvas:this._toCanvas,_sWidth:m.sWidth,_sHeight:m.sHeight,_bUseWebGL:null},D;try{D=this._getImageData(this._video,v,S,m,u,{targetColorMode:this.frameColorMode,bUseWebGL:x})}catch(z){if(z.name!=="WebGLError")throw z;ae._onLog&&ae._onLog("DCE: get WebGLError, try again in canvas."),D=this._getImageData(this._video,v,S,m,u,{targetColorMode:this.frameColorMode,bUseWebGL:!1})}if(!D)return null;let I=Date.now();return ae._onLog&&ae._onLog("DCE: _getVideoFrame() END: "+I),A.data=D.data,A.colorMode=D.colorMode,A._bUseWebGL=D._bUseWebGL,A.timeSpent=I-_,A.timeStamp=I,A}_getImageData(r,u,_,v,S,m){if(this.isDisposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(!u||!_)return null;ae._onLog&&ae._onLog("DCE: _getImageData(), START: "+Date.now());let{sx:w,sy:E,sWidth:x,sHeight:A,dWidth:D,dHeight:I}=v,z;if(z=m&&m.targetColorMode?m.targetColorMode.toLowerCase():"rgba",m&&m.bUseWebGL){ae._onLog&&ae._onLog("DCE:  _getImageData() in WebGL."),this._reusedWebGLCvs||(this._reusedWebGLCvs=document.createElement("canvas"));let se=this._reusedWebGLCvs;se.width==u&&se.height==_||(se.width=u,se.height=_,this._reusedWebGLCtx&&this._reusedWebGLCtx.viewport(0,0,u,_));let ee=this._reusedWebGLCtx||se.getContext("webgl",{antialias:!1})||se.getContext("experimental-webgl",{antialias:!1});if(!ee){ae._onLog&&ae._onLog("DCE: WebGL unavailable."),this._reusedWebGLCtx=null,this._bWebGLSupported=!1;let K=new Error("WebGL error: unable to initialize WebGL. Your browser or machine may not support it.");throw K.name="WebGLError",K}if(ee.enable(ee.SCISSOR_TEST),ee.scissor(w,E,D,I),!this._reusedWebGLCtx||z!==this.currentFSColorMode){this._reusedWebGLCtx=ee;let K=re=>{let ne=re.createBuffer();re.bindBuffer(re.ARRAY_BUFFER,ne),re.bufferData(re.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,1,1,-1,1]),re.STATIC_DRAW);let n=re.createBuffer();return re.bindBuffer(re.ELEMENT_ARRAY_BUFFER,n),re.bufferData(re.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,0,2,3]),re.STATIC_DRAW),{position:ne,indices:n}},Q=re=>{let ne=re.createTexture();return re.bindTexture(re.TEXTURE_2D,ne),re.texParameteri(re.TEXTURE_2D,re.TEXTURE_MAG_FILTER,re.LINEAR),re.texParameteri(re.TEXTURE_2D,re.TEXTURE_MIN_FILTER,re.LINEAR),re.texParameteri(re.TEXTURE_2D,re.TEXTURE_WRAP_S,re.CLAMP_TO_EDGE),re.texParameteri(re.TEXTURE_2D,re.TEXTURE_WRAP_T,re.CLAMP_TO_EDGE),ne},fe=(re,ne,n)=>{let i=J(re,re.VERTEX_SHADER,ne),s=J(re,re.FRAGMENT_SHADER,n),l=re.createProgram();return re.attachShader(l,i),re.attachShader(l,s),re.linkProgram(l),re.getProgramParameter(l,re.LINK_STATUS)?l:(alert("Unable to initialize the shader program: "+re.getProgramInfoLog(l)),null)},J=(re,ne,n)=>{let i=re.createShader(ne);return re.shaderSource(i,n),re.compileShader(i),re.getShaderParameter(i,re.COMPILE_STATUS)?i:(alert("An error occurred compiling the shaders: "+re.getShaderInfoLog(i)),re.deleteShader(i),null)},le=`
                  attribute mediump vec2 aVertexPosition;
                  varying mediump vec2 vDirection;
          
                  void main( void )
                  {
                      gl_Position = vec4(aVertexPosition, 1.0, 1.0) * 2.0;
                      vDirection = aVertexPosition;
                  }
                `,g;g=["rgba","rbga","grba","gbra","brga","bgra"].includes(z)?z.slice(0,3):"rgb";let pe=fe(ee,le,`
                    precision mediump float;

                    varying mediump vec2 vDirection;
                    uniform sampler2D uSampler;
                    uniform lowp float uColorFactor;
            
                    void main(void)
                    {
                        vec4 sample = texture2D(uSampler, vec2(vDirection.x * 0.5 + 0.5, vDirection.y * 0.5 + 0.5));
                        lowp float grey = 0.21 * sample.r + 0.71 * sample.g + 0.07 * sample.b;
                        gl_FragColor = vec4(sample.${g} * (1.0 - uColorFactor) + (grey * uColorFactor), sample.a);
                    }
                `);this._webGLProgramInfo={program:pe,attribLocations:{vertexPosition:ee.getAttribLocation(pe,"aVertexPosition")},uniformLocations:{uSampler:ee.getUniformLocation(pe,"uSampler"),uColorFactor:ee.getUniformLocation(pe,"uColorFactor")}},this._webGLBuffers=K(ee),this._webGLTexture=Q(ee),this.currentFSColorMode=z}let q=(K,Q,fe)=>{let J=K.RGBA,le=K.RGBA,g=K.UNSIGNED_BYTE;K.bindTexture(K.TEXTURE_2D,Q),K.texImage2D(K.TEXTURE_2D,0,J,le,g,fe)},te=(K,Q,fe,J)=>{K.clearColor(0,0,0,1),K.clearDepth(1),K.enable(K.DEPTH_TEST),K.depthFunc(K.LEQUAL),K.clear(K.COLOR_BUFFER_BIT|K.DEPTH_BUFFER_BIT),K.bindBuffer(K.ELEMENT_ARRAY_BUFFER,fe.indices),K.useProgram(Q.program);{let pe=K.FLOAT,re=!1,ne=0,n=0;K.bindBuffer(K.ARRAY_BUFFER,fe.position),K.vertexAttribPointer(Q.attribLocations.vertexPosition,2,pe,re,ne,n),K.enableVertexAttribArray(Q.attribLocations.vertexPosition)}K.activeTexture(K.TEXTURE0),K.bindTexture(K.TEXTURE_2D,J),K.uniform1i(Q.uniformLocations.uSampler,0),K.uniform1f(Q.uniformLocations.uColorFactor,z==="grey"||z==="grey32"?1:0);let le=K.UNSIGNED_SHORT;K.drawElements(K.TRIANGLES,6,le,0)},ce;if(q(ee,this._webGLTexture,r),te(ee,this._webGLProgramInfo,this._webGLBuffers,this._webGLTexture),S){if(S.length<D*I*4)return null;ce=S}else this.ifReuseArrayBufferView||z==="grey"?(this._reusedDataContainer&&this._reusedDataContainer.length===D*I*4||(this._reusedDataContainer=new Uint8Array(D*I*4)),ce=this._reusedDataContainer):ce=new Uint8Array(D*I*4);if(ee.readPixels(w,E,D,I,ee.RGBA,ee.UNSIGNED_BYTE,ce),ee.disable(ee.SCISSOR_TEST),ce[3]!==255){ae._onLog&&ae._onLog("DCE: WebGL drawing incorrect."),this.forceLoseContext(),this._bWebGLSupported=!1;let K=new Error("WebGL error: incorrect WebGL drawing.");throw K.name="WebGLError",K}if(z==="grey"){let K=ae._onLog?Date.now():0;if(ce=new Uint8Array(new Uint32Array(ce.buffer)),S){if(S.length<ce.length)return null;S.set(ce)}ae._onLog&&ae._onLog("DCE: Extract grey cost: "+(Date.now()-K))}return ae._onLog&&ae._onLog("DCE: _getImageData() in WebGL, END: "+Date.now()),{data:ce,colorMode:z,_bUseWebGL:!0}}{ae._onLog&&ae._onLog("DCE:  _getImageData() in canvas."),this._reusedCvs||(this._reusedCvs=document.createElement("canvas"));let se=this._reusedCvs;se.width===D&&se.height===I||(se.width=D,se.height=I),se.ctx2d||(se.ctx2d=se.getContext("2d"));let ee=se.ctx2d;ee.drawImage(r,w,E,x,A,0,0,D,I);let q=ee.getImageData(0,0,se.width,se.height).data;if(["rbga","grba","gbra","brga","bgra"].includes(z)){let te=z.indexOf("r"),ce=z.indexOf("g"),K=z.indexOf("b"),Q=0;te===1||te===2?Q=te:ce===2&&(Q=ce);for(let fe=0;fe<q.length;fe+=4){let J;Q&&(J=q[fe+Q]),q[fe+te]=q[fe],q[fe+ce]=Q===1?J:q[fe+1],q[fe+K]=Q===2?J:q[fe+2]}}else if(z==="grey"||z==="grey32")for(let te=0;te<q.length;te+=4){let ce=.21*q[te]+.71*q[te+1]+.07*q[te+2];q[te]=ce,q[te+1]=ce,q[te+2]=ce}if(q=z==="grey"?new Uint8Array(new Uint32Array(q.buffer)):new Uint8Array(q.buffer),S){if(S.length<q.length)return null;S.set(q)}return ae._onLog&&ae._onLog("DCE: _getImageData() in canvas, END: "+Date.now()),{data:q,colorMode:z,_bUseWebGL:!1}}}getCurrentRegion(){let r=null;if(this._scanRegion)r=this._scanRegion;else if(this.croppingRegions){if(this._croppingRegionIndex>=this.croppingRegions.length||this._croppingRegionIndex<0)throw new Error("The 'croppingRegionIndex' is out of bounds.");r=this.croppingRegions[this._croppingRegionIndex],this.bIncreaseRegionIndexAuto&&++this._croppingRegionIndex>=this.croppingRegions.length&&(this._croppingRegionIndex=0)}return r}_fetchingLoop(r){if(this.isDisposed)return;if(!this._bOpen||!this.isFetchingLoopStarted())return void this.stopFetchingLoop();let u=()=>{ae._onLog&&ae._onLog("DCE: start fetching a frame: "+Date.now());let v=this.getCurrentRegion(),S=this._getVideoFrame(v);if(!S)return void(ae._onLog&&ae._onLog("DCE: get a invalid frame, abandon it: "+Date.now()));for(;this._frameQueue&&this._frameQueue.length>=this.maxNumberOfFramesInBuffer;)this._frameQueue.shift();this._frameQueue.push(S),ae._onLog&&ae._onLog("DCE: finish fetching a frame: "+Date.now());let m=this.mapCameraEvents.get("frameAddedToBuffer");for(let w of m)w&&setTimeout(w.bind(this),0)},_=()=>{this.isDisposed||(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this.refreshInterval<=0||(this._frameLoopTimeoutId2=setTimeout(()=>{this.isDisposed||(this._bOpen&&this.isFetchingLoopStarted()?(ae._onLog&&ae._onLog("DCE: second timeout executes: "+Date.now()),u(),_()):this.stopFetchingLoop())},this.refreshInterval)))};r&&(this._frameQueue.length<this.maxNumberOfFramesInBuffer?(u(),this.refreshInterval>0&&_()):this.refreshInterval>0?(u(),_()):this.refreshInterval===0?u():this.refreshInterval),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),this._frameLoopTimeoutId=setTimeout(()=>{this.isDisposed||this._fetchingLoop(!0)},this.loopInterval)}startFetchingLoop(){if(this.isDisposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(this._assertOpen(),this.singleFrameMode)throw Error("'startFetchingLoop()' is unavailable in singleFrameMode.");this.isFetchingLoopStarted()||(this._bFetchingLoopStarted=!0,this._recordedStates.fetchingLoopStart=!0,ae._onLog&&ae._onLog("start fetching loop: "+Date.now()),this._fetchingLoop(!0))}isFetchingLoopStarted(){return this._bFetchingLoopStarted}stopFetchingLoop(){this._bFetchingLoopStarted&&(ae._onLog&&ae._onLog("stop fetching loop: "+Date.now()),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),this._frameQueue.length=0,this._bFetchingLoopStarted=!1,this._recordedStates.fetchingLoopStart=!1)}getFrameFromBuffer(r){return this._frameQueue&&this._frameQueue.length?r?r<this._frameQueue.length?(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this._frameQueue.splice(r,1)[0]):void 0:(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this._frameQueue.shift()):null}forceLoseContext(){if(!this._reusedWebGLCtx)return;let r=this._reusedWebGLCtx;r&&!r.isContextLost()&&r.getExtension("WEBGL_lose_context")&&r.getExtension("WEBGL_lose_context").loseContext(),this._webGLTexture=null,this._webGLProgramInfo=null,this._webGLBuffers=null,this._reusedWebGLCtx=null,this._reusedWebGLCvs=null}_createDrawingLayerBaseCvs(){this._assertOpen();let r=this._calculateCvsSize();if(!r)throw new Error("Camera is not open.");let{width:u,height:_,objectFit:v}=r;if(u<=0||_<=0)throw new Error("Invalid dimension of video or image.");let S=document.createElement("canvas");if(S.width==u&&S.height==_||(S.width=u,S.height=_),S.style.objectFit=v,this._scanRegionOverlayContainer)this._scanRegionOverlayContainer.before(S);else if(this._cvsScanRegion)this._cvsScanRegion.before(S);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(S);else{if(!this._video)throw new Error("'_video' is lost.");this._video.after(S)}return S}_updateDrawingLayersSize(r){let u;if(u=r&&r.width&&r.height&&r.objectFit?{width:r.width,height:r.height,objectFit:r.objectFit}:this._calculateCvsSize(),!u)return;let{width:_,height:v,objectFit:S}=u;this._drawingLayersManager.setDimensions({width:_,height:v},{backstoreOnly:!0}),this._drawingLayersManager.setObjectFit(S)}_createDrawingLayer(r){this._layerBaseCvs||(this._layerBaseCvs=this._createDrawingLayerBaseCvs());let u=this._layerBaseCvs;return this._drawingLayersManager.createDrawingLayer(u,r)}createDrawingLayer(){return this._createDrawingLayer()}getDrawingLayer(r){return this._drawingLayersManager.getDrawingLayer(r)||([1,2,3].includes(r)?this._createDrawingLayer(r):null)}getDrawingLayers(){return this._drawingLayersManager.getDrawingLayers()}getSelectedDrawingItems(){return this._drawingLayersManager.getSelectedDrawingItems()}createDrawingStyle(r){return this._drawingLayersManager.createDrawingStyle(r)}getDrawingStyle(r){return this._drawingLayersManager.getDrawingStyle(r)}getDrawingStyles(){return this._drawingLayersManager.getDrawingStyles()}updateDrawingStyle(r,u){return this._drawingLayersManager.updateDrawingStyle(r,u)}clearDrawingLayers(){this._drawingLayersManager.clearDrawingLayers(),this._layerBaseCvs&&(this._layerBaseCvs.remove(),this._layerBaseCvs=null)}_createControler(){if(this._controler||(this._controler=new zt(this)),this._controler)return this._controler}_destroyControler(){this._controler=null}setOriginalImage(r,u,_){if(!r||!u||!_)throw new Error("Invalid arguments");this._originalImageData={imageData:r,width:u,height:_};let v=this._cvsOriginalImage;v||(v=document.createElement("canvas"),v.style.position="absolute",v.style.width="100%",v.style.height="100%",v.style.left="0",v.style.top="0",v.style.backgroundColor="white",v.style.objectFit="contain",this._cvsOriginalImage=v),v.width===u&&v.height===_||(v.width=u,v.height=_);let S=v.getContext("2d");S.clearRect(0,0,v.width,v.height),r instanceof Uint8Array||r instanceof Uint8ClampedArray?(r instanceof Uint8Array&&(r=new Uint8ClampedArray(r)),S.putImageData(new ImageData(r,u,_),0,0)):r instanceof HTMLCanvasElement&&S.drawImage(r,0,0),document.body.contains(v)&&v.style.display===""&&this._updateDrawingLayersSize({width:u,height:_,objectFit:"contain"})}getOriginalImage(){return this._originalImageData?Object.assign({},this._originalImageData):null}deleteOriginalImage(){return ye(this,void 0,void 0,function*(){yield this.hideOriginalImage(),this._cvsOriginalImage&&(this._cvsOriginalImage.remove(),this._cvsOriginalImage=null),this._originalImageData=null})}_showOriginalImageCvs(){this._cvsOriginalImage&&this._cvsOriginalImage.style.display=="none"&&(this._cvsOriginalImage.style.display="")}_hideOriginalImageCvs(){this._cvsOriginalImage&&(this._cvsOriginalImage.style.display="none")}showOriginalImage(){if(!this._originalImageData)throw new Error("No original image is set.");let r=this._cvsOriginalImage;if(r.style.display===""&&document.body.contains(r))return;let{width:u,height:_}=this._originalImageData;if(this._updateDrawingLayersSize({width:u,height:_,objectFit:"contain"}),this._bOpen&&(this._video&&!this._video.paused&&this._video.pause(),this._bFetchingLoopStarted&&(this.stopFetchingLoop(),this._recordedStates.fetchingLoopStart=!0),this.ifShowScanRegionMask&&this._cvsScanRegion&&(this._cvsScanRegion.style.display="none"),this.ifShowScanRegionLaser&&this._divScanLight&&(this._divScanLight.style.display="none"),this._cvsViewDecorator&&(this._cvsViewDecorator.style.display="none"),this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.style.display="none"),this._selCam&&(this._selCam.parentElement.style.display="none")),!document.body.contains(r))if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(r);else{if(!this._video)throw new Error("'video' is null.");this._video.after(r)}this._showOriginalImageCvs()}_hideOriginalImage(r){return ye(this,void 0,void 0,function*(){this._originalImageData&&this._cvsOriginalImage&&this._cvsOriginalImage.style.display!=="none"&&(this._updateDrawingLayersSize(),this._bOpen&&r&&(this._video&&this._recordedStates.videoPlaying&&(yield this.play(null,null,null,{notTriggerSingleFrameClick:!0})),this._recordedStates.fetchingLoopStart&&!this.singleFrameMode&&this.startFetchingLoop(),this.ifShowScanRegionMask&&this._cvsScanRegion&&this._recordedStates.maskShow&&this.showScanRegionMask(),this.ifShowScanRegionLaser&&this._divScanLight&&this._recordedStates.laserShow&&this.showScanRegionLaser(),this._cvsViewDecorator&&this._recordedStates.decoratorShow&&this.showViewDecorator(),this._scanRegionOverlayContainer&&this._recordedStates.overlayShow&&this.showScanRegionOverlays()),this._selCam&&(this._selCam.parentElement.style.display=""),this._hideOriginalImageCvs())})}hideOriginalImage(){return ye(this,void 0,void 0,function*(){return this._hideOriginalImage(!0)})}dispose(r){this.UIElement&&(this._uiOriginalState&&this._uiOriginalState.inDom?this.UIElement.style.display=this._uiOriginalState.display:this.UIElement.style.display="none"),this.clearDrawingLayers(),this.close(),this.forceLoseContext(),this.setViewDecorator(null,null),this._scanRegionOverlayContainer&&this._scanRegionOverlayContainer.remove(),this._arrScanRegionOverlays.length=0,r&&this.UIElement&&this.UIElement.remove(),this.__proto__=null;for(let u in this)delete this[u];Object.defineProperty(this,"isCameraEnhancer",{value:!0}),Object.defineProperty(this,"isDisposed",{value:!0})}};ae._jsVersion="3.0.1",ae._jsEditVersion="20220803",ae._version="JS "+ae._jsVersion+"."+ae._jsEditVersion,ae.browserInfo=be,ae._hasEngineResourceLoaded=!1,ae._engineResourcePath=vi,ae._defaultUIElementURL="@engineResourcePath/dce.ui.html";var _t,pt,mt,vt,yt,St,Ct,bt,wt,Tt,xt,At,Et,It,Ot,Dt,Rt,Lt,Mt,Pt,Ft,kt,Bt,Nt,jt,Vt,Ut;(function(a){a[a.BICM_DARK_ON_LIGHT=1]="BICM_DARK_ON_LIGHT",a[a.BICM_LIGHT_ON_DARK=2]="BICM_LIGHT_ON_DARK",a[a.BICM_DARK_ON_DARK=4]="BICM_DARK_ON_DARK",a[a.BICM_LIGHT_ON_LIGHT=8]="BICM_LIGHT_ON_LIGHT",a[a.BICM_DARK_LIGHT_MIXED=16]="BICM_DARK_LIGHT_MIXED",a[a.BICM_DARK_ON_LIGHT_DARK_SURROUNDING=32]="BICM_DARK_ON_LIGHT_DARK_SURROUNDING",a[a.BICM_SKIP=0]="BICM_SKIP",a[a.BICM_REV=2147483648]="BICM_REV"})(_t||(_t={})),function(a){a[a.BCM_AUTO=1]="BCM_AUTO",a[a.BCM_GENERAL=2]="BCM_GENERAL",a[a.BCM_SKIP=0]="BCM_SKIP",a[a.BCM_REV=2147483648]="BCM_REV"}(pt||(pt={})),function(a){a[a.BF2_NULL=0]="BF2_NULL",a[a.BF2_POSTALCODE=32505856]="BF2_POSTALCODE",a[a.BF2_NONSTANDARD_BARCODE=1]="BF2_NONSTANDARD_BARCODE",a[a.BF2_USPSINTELLIGENTMAIL=1048576]="BF2_USPSINTELLIGENTMAIL",a[a.BF2_POSTNET=2097152]="BF2_POSTNET",a[a.BF2_PLANET=4194304]="BF2_PLANET",a[a.BF2_AUSTRALIANPOST=8388608]="BF2_AUSTRALIANPOST",a[a.BF2_RM4SCC=16777216]="BF2_RM4SCC",a[a.BF2_DOTCODE=2]="BF2_DOTCODE",a[a.BF2_PHARMACODE_ONE_TRACK=4]="BF2_PHARMACODE_ONE_TRACK",a[a.BF2_PHARMACODE_TWO_TRACK=8]="BF2_PHARMACODE_TWO_TRACK",a[a.BF2_PHARMACODE=12]="BF2_PHARMACODE"}(mt||(mt={})),function(a){a[a.BM_AUTO=1]="BM_AUTO",a[a.BM_LOCAL_BLOCK=2]="BM_LOCAL_BLOCK",a[a.BM_SKIP=0]="BM_SKIP",a[a.BM_THRESHOLD=4]="BM_THRESHOLD",a[a.BM_REV=2147483648]="BM_REV"}(vt||(vt={})),function(a){a[a.ECCM_CONTRAST=1]="ECCM_CONTRAST"}(yt||(yt={})),function(a){a[a.CFM_GENERAL=1]="CFM_GENERAL"}(St||(St={})),function(a){a[a.CCM_AUTO=1]="CCM_AUTO",a[a.CCM_GENERAL_HSV=2]="CCM_GENERAL_HSV",a[a.CCM_SKIP=0]="CCM_SKIP",a[a.CCM_REV=2147483648]="CCM_REV"}(Ct||(Ct={})),function(a){a[a.CICM_GENERAL=1]="CICM_GENERAL",a[a.CICM_SKIP=0]="CICM_SKIP",a[a.CICM_REV=2147483648]="CICM_REV"}(bt||(bt={})),function(a){a[a.CM_IGNORE=1]="CM_IGNORE",a[a.CM_OVERWRITE=2]="CM_OVERWRITE"}(wt||(wt={})),function(a){a[a.DM_SKIP=0]="DM_SKIP",a[a.DM_DIRECT_BINARIZATION=1]="DM_DIRECT_BINARIZATION",a[a.DM_THRESHOLD_BINARIZATION=2]="DM_THRESHOLD_BINARIZATION",a[a.DM_GRAY_EQUALIZATION=4]="DM_GRAY_EQUALIZATION",a[a.DM_SMOOTHING=8]="DM_SMOOTHING",a[a.DM_MORPHING=16]="DM_MORPHING",a[a.DM_DEEP_ANALYSIS=32]="DM_DEEP_ANALYSIS",a[a.DM_SHARPENING=64]="DM_SHARPENING",a[a.DM_BASED_ON_LOC_BIN=128]="DM_BASED_ON_LOC_BIN",a[a.DM_SHARPENING_SMOOTHING=256]="DM_SHARPENING_SMOOTHING"}(Tt||(Tt={})),function(a){a[a.DRM_AUTO=1]="DRM_AUTO",a[a.DRM_GENERAL=2]="DRM_GENERAL",a[a.DRM_BROAD_WARP=4]="DRM_BROAD_WARP",a[a.DRM_LOCAL_REFERENCE=8]="DRM_LOCAL_REFERENCE",a[a.DRM_DEWRINKLE=16]="DRM_DEWRINKLE",a[a.DRM_SKIP=0]="DRM_SKIP",a[a.DRM_REV=2147483648]="DRM_REV"}(xt||(xt={})),function(a){a[a.DPMCRM_AUTO=1]="DPMCRM_AUTO",a[a.DPMCRM_GENERAL=2]="DPMCRM_GENERAL",a[a.DPMCRM_SKIP=0]="DPMCRM_SKIP",a[a.DPMCRM_REV=2147483648]="DPMCRM_REV"}(At||(At={})),function(a){a[a.GTM_INVERTED=1]="GTM_INVERTED",a[a.GTM_ORIGINAL=2]="GTM_ORIGINAL",a[a.GTM_SKIP=0]="GTM_SKIP",a[a.GTM_REV=2147483648]="GTM_REV"}(Et||(Et={})),function(a){a[a.IPM_AUTO=1]="IPM_AUTO",a[a.IPM_GENERAL=2]="IPM_GENERAL",a[a.IPM_GRAY_EQUALIZE=4]="IPM_GRAY_EQUALIZE",a[a.IPM_GRAY_SMOOTH=8]="IPM_GRAY_SMOOTH",a[a.IPM_SHARPEN_SMOOTH=16]="IPM_SHARPEN_SMOOTH",a[a.IPM_MORPHOLOGY=32]="IPM_MORPHOLOGY",a[a.IPM_SKIP=0]="IPM_SKIP",a[a.IPM_REV=2147483648]="IPM_REV"}(It||(It={})),function(a){a[a.IRSM_MEMORY=1]="IRSM_MEMORY",a[a.IRSM_FILESYSTEM=2]="IRSM_FILESYSTEM",a[a.IRSM_BOTH=4]="IRSM_BOTH"}(Ot||(Ot={})),function(a){a[a.IRT_NO_RESULT=0]="IRT_NO_RESULT",a[a.IRT_ORIGINAL_IMAGE=1]="IRT_ORIGINAL_IMAGE",a[a.IRT_COLOUR_CLUSTERED_IMAGE=2]="IRT_COLOUR_CLUSTERED_IMAGE",a[a.IRT_COLOUR_CONVERTED_GRAYSCALE_IMAGE=4]="IRT_COLOUR_CONVERTED_GRAYSCALE_IMAGE",a[a.IRT_TRANSFORMED_GRAYSCALE_IMAGE=8]="IRT_TRANSFORMED_GRAYSCALE_IMAGE",a[a.IRT_PREDETECTED_REGION=16]="IRT_PREDETECTED_REGION",a[a.IRT_PREPROCESSED_IMAGE=32]="IRT_PREPROCESSED_IMAGE",a[a.IRT_BINARIZED_IMAGE=64]="IRT_BINARIZED_IMAGE",a[a.IRT_TEXT_ZONE=128]="IRT_TEXT_ZONE",a[a.IRT_CONTOUR=256]="IRT_CONTOUR",a[a.IRT_LINE_SEGMENT=512]="IRT_LINE_SEGMENT",a[a.IRT_FORM=1024]="IRT_FORM",a[a.IRT_SEGMENTATION_BLOCK=2048]="IRT_SEGMENTATION_BLOCK",a[a.IRT_TYPED_BARCODE_ZONE=4096]="IRT_TYPED_BARCODE_ZONE",a[a.IRT_PREDETECTED_QUADRILATERAL=8192]="IRT_PREDETECTED_QUADRILATERAL"}(Dt||(Dt={})),function(a){a[a.LM_SKIP=0]="LM_SKIP",a[a.LM_AUTO=1]="LM_AUTO",a[a.LM_CONNECTED_BLOCKS=2]="LM_CONNECTED_BLOCKS",a[a.LM_LINES=8]="LM_LINES",a[a.LM_STATISTICS=4]="LM_STATISTICS",a[a.LM_SCAN_DIRECTLY=16]="LM_SCAN_DIRECTLY",a[a.LM_STATISTICS_MARKS=32]="LM_STATISTICS_MARKS",a[a.LM_STATISTICS_POSTAL_CODE=64]="LM_STATISTICS_POSTAL_CODE",a[a.LM_CENTRE=128]="LM_CENTRE",a[a.LM_ONED_FAST_SCAN=256]="LM_ONED_FAST_SCAN",a[a.LM_REV=2147483648]="LM_REV"}(Rt||(Rt={})),function(a){a[a.PDFRM_RASTER=1]="PDFRM_RASTER",a[a.PDFRM_AUTO=2]="PDFRM_AUTO",a[a.PDFRM_VECTOR=4]="PDFRM_VECTOR",a[a.PDFRM_REV=2147483648]="PDFRM_REV"}(Lt||(Lt={})),function(a){a[a.QRECL_ERROR_CORRECTION_H=0]="QRECL_ERROR_CORRECTION_H",a[a.QRECL_ERROR_CORRECTION_L=1]="QRECL_ERROR_CORRECTION_L",a[a.QRECL_ERROR_CORRECTION_M=2]="QRECL_ERROR_CORRECTION_M",a[a.QRECL_ERROR_CORRECTION_Q=3]="QRECL_ERROR_CORRECTION_Q"}(Mt||(Mt={})),function(a){a[a.RPM_AUTO=1]="RPM_AUTO",a[a.RPM_GENERAL=2]="RPM_GENERAL",a[a.RPM_GENERAL_RGB_CONTRAST=4]="RPM_GENERAL_RGB_CONTRAST",a[a.RPM_GENERAL_GRAY_CONTRAST=8]="RPM_GENERAL_GRAY_CONTRAST",a[a.RPM_GENERAL_HSV_CONTRAST=16]="RPM_GENERAL_HSV_CONTRAST",a[a.RPM_SKIP=0]="RPM_SKIP",a[a.RPM_REV=2147483648]="RPM_REV"}(Pt||(Pt={})),function(a){a[a.RCT_PIXEL=1]="RCT_PIXEL",a[a.RCT_PERCENTAGE=2]="RCT_PERCENTAGE"}(Ft||(Ft={})),function(a){a[a.RT_STANDARD_TEXT=0]="RT_STANDARD_TEXT",a[a.RT_RAW_TEXT=1]="RT_RAW_TEXT",a[a.RT_CANDIDATE_TEXT=2]="RT_CANDIDATE_TEXT",a[a.RT_PARTIAL_TEXT=3]="RT_PARTIAL_TEXT"}(kt||(kt={})),function(a){a[a.SUM_AUTO=1]="SUM_AUTO",a[a.SUM_LINEAR_INTERPOLATION=2]="SUM_LINEAR_INTERPOLATION",a[a.SUM_NEAREST_NEIGHBOUR_INTERPOLATION=4]="SUM_NEAREST_NEIGHBOUR_INTERPOLATION",a[a.SUM_SKIP=0]="SUM_SKIP",a[a.SUM_REV=2147483648]="SUM_REV"}(Bt||(Bt={})),function(a){a[a.TP_REGION_PREDETECTED=1]="TP_REGION_PREDETECTED",a[a.TP_IMAGE_PREPROCESSED=2]="TP_IMAGE_PREPROCESSED",a[a.TP_IMAGE_BINARIZED=4]="TP_IMAGE_BINARIZED",a[a.TP_BARCODE_LOCALIZED=8]="TP_BARCODE_LOCALIZED",a[a.TP_BARCODE_TYPE_DETERMINED=16]="TP_BARCODE_TYPE_DETERMINED",a[a.TP_BARCODE_RECOGNIZED=32]="TP_BARCODE_RECOGNIZED"}(Nt||(Nt={})),function(a){a[a.TFM_AUTO=1]="TFM_AUTO",a[a.TFM_GENERAL_CONTOUR=2]="TFM_GENERAL_CONTOUR",a[a.TFM_SKIP=0]="TFM_SKIP",a[a.TFM_REV=2147483648]="TFM_REV"}(jt||(jt={})),function(a){a[a.TROM_CONFIDENCE=1]="TROM_CONFIDENCE",a[a.TROM_POSITION=2]="TROM_POSITION",a[a.TROM_FORMAT=4]="TROM_FORMAT",a[a.TROM_SKIP=0]="TROM_SKIP",a[a.TROM_REV=2147483648]="TROM_REV"}(Vt||(Vt={})),function(a){a[a.TDM_AUTO=1]="TDM_AUTO",a[a.TDM_GENERAL_WIDTH_CONCENTRATION=2]="TDM_GENERAL_WIDTH_CONCENTRATION",a[a.TDM_SKIP=0]="TDM_SKIP",a[a.TDM_REV=2147483648]="TDM_REV"}(Ut||(Ut={}));k.engineResourcePath="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@9.3.1/dist/";k.license="DLS2eyJoYW5kc2hha2VDb2RlIjoiMTAxNTA3MDI4LVRYbFhaV0pRY205cVgyUmljZyIsIm9yZ2FuaXphdGlvbklEIjoiMTAxNTA3MDI4IiwiY2hlY2tDb2RlIjotOTE0NDIyMjIzfQ==";var rt=ni(qt());rt.CodeParser.engineResourcePath="https://cdn.jsdelivr.net/npm/dynamsoft-code-parser@1.1.0/dist/";rt.CodeParser.license="DLS2eyJoYW5kc2hha2VDb2RlIjoiMTAxNTA3MDI4LVRYbFhaV0pRY205cVgyUmljZyIsIm9yZ2FuaXphdGlvbklEIjoiMTAxNTA3MDI4IiwiY2hlY2tDb2RlIjotOTE0NDIyMjIzfQ==";(async()=>{try{await rt.CodeParser.loadWasm()}catch(a){let r=a.message||a;console.error(r),alert(r)}})();})();
/*!
 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
 *  
 *  howler.js v2.2.3
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */
/*!
 *  howler.js v2.2.3
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */
/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Barcode Reader JS Edition
 * @website http://www.dynamsoft.com
 * @copyright Copyright 2022, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 9.3.1 (js 20220930)
 * @fileoverview Dynamsoft JavaScript Library for Barcode Reader
 * More info on DBR JS: https://www.dynamsoft.com/barcode-reader/sdk-javascript/
 */
/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Camera Enhancer JS Edition
 * @website https://www.dynamsoft.com
 * @copyright Copyright 2022, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 3.0.1 (js 20220803)
 * @fileoverview Dynamsoft JavaScript Library for Camera Enhancer
 * More info on DCE JS: https://www.dynamsoft.com/camera-enhancer/docs/programming/javascript/?ver=latest
 */
/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Code Parser JS Edition
 * @website http://www.dynamsoft.com
 * @copyright Copyright 2022, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 1.1.0 (js 20220708)
 * @fileoverview Dynamsoft JavaScript Library for Barcode Reader
 * More info on dcp JS: https://www.dynamsoft.com/code-parser/sdk-javascript/
 */
//# sourceMappingURL=edispatch.bundle.2ZWAXIUY.js.map
